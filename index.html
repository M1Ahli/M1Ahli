<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ูุธุงู ุฅุฏุงุฑุฉ ุงูุนูุงุฑุงุช ุงููุชูุงูู</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            dark: {
              bg: '#111827',
              surface: '#1f2937',
              border: '#374151',
              text: '#f3f4f6',
              muted: '#9ca3af',
              input: '#111827'
            }
          }
        }
      }
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Tajawal:wght@400;500;700&display=swap');

    body {
      font-family: 'Tajawal','Cairo',system-ui,sans-serif;
      background:#f9fafb;
      color:#111827;
      transition: background-color 0.3s, color 0.3s;
    }

    /* --- ุงููุถุน ุงููููู --- */
    body.dark-mode {
      background-color: #111827;
      color: #f3f4f6;
    }

    body.dark-mode .bg-white,
    body.dark-mode .modal-content {
      background-color: #1f2937 !important;
      color: #f3f4f6 !important;
      border-color: #374151 !important;
    }

    body.dark-mode .bg-gray-50 { background-color: #111827 !important; }
    body.dark-mode .bg-gray-100 { background-color: #374151 !important; color: white !important; }

    /* ุงูุฌุฏุงูู ูู ุงููุถุน ุงููููู */
    body.dark-mode th {
      background-color: #1f2937 !important;
      color: #9ca3af !important;
      border-bottom-color: #374151 !important;
    }
    body.dark-mode td { border-bottom-color: #374151 !important; }

    /* ุงููุฏุฎูุงุช */
    body.dark-mode input,
    body.dark-mode select,
    body.dark-mode textarea {
      background-color: #111827 !important;
      border-color: #4b5563 !important;
      color: #fff !important;
    }
    body.dark-mode input::placeholder,
    body.dark-mode textarea::placeholder { color: #6b7280 !important; }

    /* ุฃููุงู ุงููุตูุต ูู ุงููุถุน ุงููููู */
    body.dark-mode .text-gray-900,
    body.dark-mode .text-gray-800 {
      color: #f9fafb !important;
    }
    body.dark-mode .text-gray-700 {
      color: #e5e7eb !important;
    }
    body.dark-mode .text-gray-600 {
      color: #d1d5db !important;
    }
    body.dark-mode .text-gray-500 {
      color: #9ca3af !important;
    }
    body.dark-mode .text-gray-400 {
      color: #6b7280 !important;
    }

    /* ุงููุงูุจุงุฑ */
    nav {
      background:#ffffff;
      border-radius:16px;
      box-shadow:0 4px 6px -1px rgba(0,0,0,0.05);
      padding:12px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-bottom: 20px;
      transition: background-color 0.3s;
    }
    body.dark-mode nav {
      background-color: #1f2937 !important;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.3);
    }

    .nav-btn {
      border-radius:8px;
      font-weight:600;
      padding:8px 16px;
      transition:all .2s;
      background:#f3f4f6;
      color:#4b5563;
      border: 1px solid transparent;
    }
    .nav-btn:hover {
      background:#e5e7eb;
      transform:translateY(-1px);
    }
    .nav-btn.active {
      background:#7c3aed;
      color:#fff;
      box-shadow:0 4px 12px rgba(124, 58, 237, 0.3);
    }

    body.dark-mode .nav-btn {
      background:#374151;
      color:#d1d5db;
    }
    body.dark-mode .nav-btn:hover {
      background:#4b5563;
      color: white;
    }
    body.dark-mode .nav-btn.active {
      background:#8b5cf6;
      color:#fff;
      box-shadow:0 4px 12px rgba(139, 92, 246, 0.4);
    }

    .bg-white {
      border-radius:16px;
      box-shadow:0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid rgba(0,0,0,0.05);
    }
    table {
      border-collapse:separate;
      border-spacing:0;
      width:100%;
      font-size:.9rem;
    }
    th {
      background:#f9fafb;
      font-weight:700;
      text-align:right;
      padding:12px 16px;
      border-bottom:2px solid #e5e7eb;
      color: #4b5563;
      text-transform: uppercase;
      font-size: 0.8rem;
      letter-spacing: 0.05em;
    }
    td {
      padding:12px 16px;
      border-bottom:1px solid #f3f4f6;
      vertical-align: middle;
    }

    .badge {
      padding:.25rem .6rem;
      border-radius:9999px;
      font-size:.7rem;
      font-weight:700;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .badge-green { background:#d1fae5; color:#047857; }
    .badge-red { background:#fee2e2; color:#b91c1c; }
    .badge-amber { background:#fef3c7; color:#b45309; }
    .badge-blue { background:#dbeafe; color:#1e40af; }

    button { border-radius:8px; font-weight:600; transition:all .2s; }
    button:active { transform: scale(0.98); }

    .hidden { display:none !important; }
    .table-wrap {
      overflow-x:auto;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
    }
    body.dark-mode .table-wrap { border-color: #374151; }

    .truncate-text {
      max-width: 120px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .rotate-0 { transform: rotate(0deg); }
    .-rotate-90 { transform: rotate(90deg); }

    @page {
      size: A4 portrait;
      margin: 10mm;
    }

    /* ุชุญุณูู ุงูุทุจุงุนุฉ ููุณูุฏุงุช ูุงูุชูุงุฑูุฑ */
    @media print {
      body {
        margin: 0;
      }
      body * {
        visibility: hidden;
      }

      #printable-area,
      #printable-area *,
      #printable-receipt,
      #printable-receipt * {
        visibility: visible;
      }

      #printable-area,
      #printable-receipt {
        position: absolute;
        inset: 0;
        margin: 0 auto;
        width: 190mm;
        page-break-inside: avoid;
      }

      .no-print {
        display: none !important;
      }
    }
  </style>
</head>
<body class="p-4 md:p-6 max-w-[1600px] mx-auto transition-colors duration-300">

  <nav>
    <button id="nav-dashboard" class="nav-btn active" onclick="showView('dashboard')">๐ ุงูุฑุฆูุณูุฉ</button>
    <button id="nav-properties" class="nav-btn" onclick="showView('properties')">๐ข ุงูุนูุงุฑุงุช</button>
    <button id="nav-leases" class="nav-btn" onclick="showView('leases')">๐ ุงูุนููุฏ</button>
    <button id="nav-tenants" class="nav-btn" onclick="showView('tenants')">๐ค ุงููุณุชุฃุฌุฑูู</button>
    <button id="nav-cheques" class="nav-btn" onclick="showView('cheques')">๐ณ ุงูุดููุงุช</button>
    <button id="nav-payments" class="nav-btn" onclick="showView('payments')">๐ฐ ุงูุฏูุนุงุช</button>
    <button id="nav-expenses" class="nav-btn" onclick="showView('expenses')">๐ธ ุงููุตุฑููุงุช</button>
    <button id="nav-salaries" class="nav-btn" onclick="showView('salaries')">๐จโ๐ง ุงูุฑูุงุชุจ</button>
    <button id="nav-receipts-history" class="nav-btn" onclick="showView('receipts-history')">๐งพ ุงูุณูุฏุงุช</button>
    <button id="nav-reports" class="nav-btn" onclick="showView('reports')">๐ ุงูุชูุงุฑูุฑ</button>
    <button id="nav-settings" class="nav-btn" onclick="showView('settings')">โ๏ธ ุงูุฅุนุฏุงุฏุงุช</button>
    <button class="nav-btn mr-auto" onclick="toggleDarkMode()">๐/โ๏ธ</button>
  </nav>

  <!-- ============= DASHBOARD ============= -->
  <section id="dashboard-view" class="view">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-gray-800 dark:text-white">ููุญุฉ ุงููุนูููุงุช</h2>
      <span class="text-sm text-gray-500 dark:text-gray-400" id="current-date-display"></span>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
      <div class="bg-white p-6 rounded-2xl border-r-4 border-emerald-500">
        <p class="text-gray-500 dark:text-gray-400 text-sm font-semibold mb-1">ุฅุฌูุงูู ุงูุฅูุฌุงุฑ ุงูุณููู</p>
        <p id="total-annual-rent" class="text-3xl font-bold text-gray-800 dark:text-white">0 AED</p>
      </div>
      <div class="bg-white p-6 rounded-2xl border-r-4 border-blue-500">
        <p class="text-gray-500 dark:text-gray-400 text-sm font-semibold mb-1">ุงูุนููุฏ ุงููุนุงูุฉ</p>
        <p id="active-leases-count" class="text-3xl font-bold text-gray-800 dark:text-white">0</p>
      </div>
      <div class="bg-white p-6 rounded-2xl border-r-4 border-rose-500">
        <p class="text-gray-500 dark:text-gray-400 text-sm font-semibold mb-1">ุงููุญุฏุงุช ุงูุดุงุบุฑุฉ</p>
        <p id="empty-units-count" class="text-3xl font-bold text-gray-800 dark:text-white">0</p>
      </div>
      <div class="bg-white p-6 rounded-2xl border-r-4 border-amber-500">
        <p class="text-gray-500 dark:text-gray-400 text-sm font-semibold mb-1">ุงููุณุชุฃุฌุฑูู ุงููุชุฃุฎุฑูู</p>
        <p id="late-tenants-count" class="text-3xl font-bold text-gray-800 dark:text-white">0</p>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
      <div class="bg-white p-6 rounded-2xl">
        <h3 class="font-bold mb-4 text-gray-700 dark:text-gray-200">ุชูุฒูุน ุญุงูุงุช ุงููุญุฏุงุช</h3>
        <div class="h-64"><canvas id="leasesChart"></canvas></div>
      </div>
      <div class="bg-white p-6 rounded-2xl">
        <h3 class="font-bold mb-4 text-gray-700 dark:text-gray-200">ุงููุถุน ุงููุงูู</h3>
        <div class="h-64"><canvas id="financeChart"></canvas></div>
      </div>
    </div>

    <div class="bg-white p-6 rounded-2xl">
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-gray-700 dark:text-gray-200">ุณุฌู ุงูุนูููุงุช ุงูุฃุฎูุฑ</h3>
        <button onclick="clearLogs()" class="text-xs text-rose-600 hover:underline">ูุณุญ ุงูุณุฌู</button>
      </div>
      <ul id="contractLogs" class="space-y-2 text-sm text-gray-600 dark:text-gray-400 max-h-48 overflow-y-auto pr-2"></ul>
    </div>
  </section>

  <!-- ============= PROPERTIES ============= -->
  <section id="properties-view" class="view hidden">
    <div class="flex flex-wrap items-center justify-between mb-6 gap-4">
      <h2 class="text-2xl font-bold text-gray-800 dark:text-white">ุงูุนูุงุฑุงุช ูุงููุญุฏุงุช</h2>

      <div class="flex flex-wrap gap-2 items-center">
        <div class="flex bg-white rounded-lg shadow border border-gray-100 dark:border-gray-700 p-0.5 ml-2">
          <button onclick="expandAllProperties()" class="px-3 py-1.5 text-xs font-bold text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" title="ุชูุณูุน ุงููู">
            ๐ฝ ุชูุณูุน
          </button>
          <div class="w-px bg-gray-200 dark:bg-gray-700 my-1"></div>
          <button onclick="collapseAllProperties()" class="px-3 py-1.5 text-xs font-bold text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" title="ุทู ุงููู">
            โ๏ธ ุทู
          </button>
        </div>

        <div class="relative">
          <input type="text" id="prop-search" placeholder="ุจุญุซ ุณุฑูุน..." class="pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 w-56 text-sm" oninput="renderProperties()">
          <span class="absolute left-3 top-2.5 text-gray-400 text-sm">๐</span>
        </div>

        <button onclick="openPropertyModal()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg shadow flex items-center gap-2 text-sm">
          <span>+</span> ุฅุถุงูุฉ ุนูุงุฑ
        </button>
      </div>
    </div>
    <div id="properties-container" class="space-y-6"></div>
  </section>

  <!-- ============= LEASES ============= -->
  <section id="leases-view" class="view hidden">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-2xl font-bold text-gray-800 dark:text-white">ุฅุฏุงุฑุฉ ุงูุนููุฏ</h2>
      <button onclick="openAddLeaseModal()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg shadow">ุฅุถุงูุฉ ุนูุฏ ุฌุฏูุฏ</button>
    </div>
    <div class="bg-white p-4 rounded-xl mb-4 flex flex-wrap gap-3 items-center">
      <span class="font-semibold text-gray-600 dark:text-gray-300">ูุฑุฒ ุญุณุจ:</span>
      <button onclick="setLeaseSort('end')" class="px-3 py-1 rounded bg-gray-100 dark:bg-gray-700 hover:bg-purple-100 hover:text-purple-700 text-sm">ุชุงุฑูุฎ ุงูุงูุชูุงุก</button>
      <button onclick="setLeaseSort('rent')" class="px-3 py-1 rounded bg-gray-100 dark:bg-gray-700 hover:bg-purple-100 hover:text-purple-700 text-sm">ุงููููุฉ</button>
      <button onclick="setLeaseSort('tenant')" class="px-3 py-1 rounded bg-gray-100 dark:bg-gray-700 hover:bg-purple-100 hover:text-purple-700 text-sm">ุงููุณุชุฃุฌุฑ</button>
      <div class="border-r h-6 mx-2 dark:border-gray-600"></div>
      <input id="lease-search-input" placeholder="ุจุญุซ ุจุฑูู ุงูุนูุฏ ุฃู ุงููุณุชุฃุฌุฑ..." class="border p-1 px-3 rounded text-sm w-64" oninput="renderLeases()">
    </div>
    <div class="table-wrap bg-white shadow-sm">
      <table class="min-w-full">
        <thead>
          <tr>
            <th class="w-1/6">ุงูุนูุงุฑ / ุงููุญุฏุฉ</th>
            <th class="w-1/6">ุงููุณุชุฃุฌุฑ</th>
            <th>ุงููููุฉ</th>
            <th>ุฑูู ุงูุนูุฏ</th>
            <th>ุงูุจุฏุงูุฉ</th>
            <th>ุงูููุงูุฉ</th>
            <th>ุงูุญุงูุฉ</th>
            <th>ุฅุฌุฑุงุกุงุช</th>
          </tr>
        </thead>
        <tbody id="leases-table-body"></tbody>
      </table>
    </div>
  </section>

  <!-- ============= TENANTS ============= -->
  <section id="tenants-view" class="view hidden">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-2xl font-bold text-gray-800 dark:text-white">ุณุฌู ุงููุณุชุฃุฌุฑูู</h2>
    </div>
    <div class="bg-white p-4 rounded-xl mb-4 shadow-sm">
      <input id="tenants-search" class="w-full border p-2 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none" placeholder="ุจุญุซ ุนู ูุณุชุฃุฌุฑ ุจุงูุงุณูุ ุงููุงุชู ุฃู ุงูุจุฑูุฏ..." oninput="renderTenants()">
    </div>
    <div class="table-wrap bg-white shadow-sm">
      <table class="min-w-full">
        <thead>
          <tr>
            <th>ุงูุงุณู</th>
            <th>ูุนูููุงุช ุงูุงุชุตุงู</th>
            <th>ุงููุญุฏุงุช</th>
            <th>ุงูุฅูุฌุงุฑ ุงูุณููู</th>
            <th>ุงููุฏููุน</th>
            <th>ุงูุฑุตูุฏ ุงููุชุจูู</th>
            <th>ุงูุฅุฌุฑุงุกุงุช</th>
          </tr>
        </thead>
        <tbody id="tenants-table-body"></tbody>
      </table>
    </div>
  </section>

  <!-- ============= CHEQUES ============= -->
  <section id="cheques-view" class="view hidden">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-2xl font-bold text-gray-800 dark:text-white">ุฅุฏุงุฑุฉ ุงูุดููุงุช</h2>
      <button onclick="openChequeModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow">ุฅุถุงูุฉ ุดูู ุฌุฏูุฏ</button>
    </div>
    <div class="table-wrap bg-white shadow-sm">
      <table class="min-w-full">
        <thead>
          <tr>
            <th>ุงูุญุงูุฉ</th>
            <th>ุงูุงุณุชุญูุงู</th>
            <th>ุงููุณุชุฃุฌุฑ</th>
            <th>ุงููููุฉ</th>
            <th>ุงูุจูู / ุฑูู ุงูุดูู</th>
            <th>ุตูุฑุฉ ุงูุดูู</th>
            <th>ุงูุฅุฌุฑุงุกุงุช</th>
          </tr>
        </thead>
        <tbody id="cheques-table-body"></tbody>
      </table>
    </div>
  </section>

  <!-- ============= PAYMENTS ============= -->
  <section id="payments-view" class="view hidden">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-2xl font-bold text-gray-800 dark:text-white">ุณุฌู ุงูุฏูุนุงุช ุงููุงููุฉ</h2>
      <button onclick="openPaymentModal()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg shadow">ุชุณุฌูู ุฏูุนุฉ ุฌุฏูุฏุฉ</button>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white p-4 rounded shadow border-t-4 border-emerald-500 text-center">
        <p class="text-xs text-gray-500 dark:text-gray-400">ุฅุฌูุงูู ุงูุฏูุนุงุช</p>
        <p id="payments-total" class="font-bold text-xl text-emerald-700 dark:text-emerald-400">0</p>
      </div>
    </div>
    <div class="table-wrap bg-white shadow-sm">
      <table class="min-w-full">
        <thead>
          <tr>
            <th>ุงูุชุงุฑูุฎ</th>
            <th>ุงููุณุชุฃุฌุฑ / ุงููุญุฏุฉ</th>
            <th>ุงูููุน</th>
            <th>ุงููุจูุบ</th>
            <th>ุงููุณุชุญู / ุงููุชุจูู</th>
            <th>ุงูุญุงูุฉ</th>
            <th>ุงูุณูุฏ</th>
          </tr>
        </thead>
        <tbody id="payments-table-body"></tbody>
      </table>
    </div>
  </section>

  <!-- ============= EXPENSES ============= -->
  <section id="expenses-view" class="view hidden">
    <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-white">ุงููุตุฑููุงุช</h2>
    <div class="grid md:grid-cols-3 gap-6">
      <form id="new-expense-form" class="bg-white p-6 rounded-xl shadow-sm space-y-4 h-fit">
        <h3 class="font-bold text-gray-700 dark:text-gray-200">ุฅุถุงูุฉ ูุตุฑูู ุฌุฏูุฏ</h3>
        <input id="expense-date" type="date" class="w-full border p-2 rounded" required>
        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">ููุน ุงููุตุฑูู</label>
          <select id="expense-type" class="w-full border p-2 rounded" required>
            <option value="">ุงุฎุชุฑ ุงูููุน...</option>
            <option value="ุตูุงูุฉ">ุตูุงูุฉ</option>
            <option value="ุฑุณูู ููุฑุจุงุก ููุงุก">ุฑุณูู ููุฑุจุงุก ููุงุก</option>
            <option value="ุฑุณูู ุจูุฏูุฉ">ุฑุณูู ุจูุฏูุฉ</option>
            <option value="ูุญููุฉ">ูุญููุฉ</option>
            <option value="ุฃุฎุฑู">ุฃุฎุฑู</option>
          </select>
        </div>
        <input id="expense-amount" type="number" placeholder="ุงููุจูุบ (AED)" class="w-full border p-2 rounded" required>
        <textarea id="expense-details" placeholder="ุชูุงุตูู ุงููุตุฑูู..." class="w-full border p-2 rounded h-24" required></textarea>
        <button class="w-full bg-rose-600 text-white py-2 rounded shadow">ุชุณุฌูู ุงููุตุฑูู</button>
      </form>
      <div class="md:col-span-2 table-wrap bg-white shadow-sm rounded-xl">
        <table class="min-w-full">
          <thead>
            <tr>
              <th>ุงูุชุงุฑูุฎ</th>
              <th>ุงูููุน</th>
              <th>ุงููุจูุบ</th>
              <th>ุงูุจูุงู</th>
              <th class="text-center">ุงูุณูุฏ / ุชุญูู</th>
            </tr>
          </thead>
          <tbody id="expenses-table-body"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ============= SALARIES ============= -->
  <section id="salaries-view" class="view hidden">
    <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-white">ุฑูุงุชุจ ุงูุญุงุฑุณ ูุงูุนูุงู</h2>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="md:col-span-1">
        <form id="salary-form" class="bg-white dark:bg-dark-surface p-6 rounded-xl shadow-sm space-y-4 sticky top-4">
          <h3 class="font-bold text-gray-700 dark:text-gray-200 border-b dark:border-dark-border pb-2">ุชุณุฌูู ุฑุงุชุจ ุฌุฏูุฏ</h3>

          <div>
            <label class="text-xs text-gray-500 dark:text-gray-400">ุงุณู ุงูููุธู</label>
            <input id="sal-name" class="w-full border p-2 rounded" placeholder="ูุซุงู: ูุญูุฏ ุนูู" required>
          </div>

          <div>
            <label class="text-xs text-gray-500 dark:text-gray-400">ุงููุธููุฉ</label>
            <select id="sal-role" class="w-full border p-2 rounded">
              <option value="ุญุงุฑุณ">ุญุงุฑุณ</option>
              <option value="ุนุงูู ูุธุงูุฉ">ุนุงูู ูุธุงูุฉ</option>
              <option value="ุตูุงูุฉ">ููู ุตูุงูุฉ</option>
              <option value="ุฅุฏุงุฑู">ุฅุฏุงุฑู</option>
              <option value="ุขุฎุฑ">ุขุฎุฑ</option>
            </select>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="text-xs text-gray-500 dark:text-gray-400">ุงููุจูุบ</label>
              <input id="sal-amount" type="number" class="w-full border p-2 rounded" required>
            </div>
            <div>
              <label class="text-xs text-gray-500 dark:text-gray-400">ุงูุชุงุฑูุฎ</label>
              <input id="sal-date" type="date" class="w-full border p-2 rounded" required>
            </div>
          </div>

          <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded border dark:border-gray-700">
            <label class="text-xs font-bold text-gray-700 dark:text-gray-300 block mb-2">ุฑุงุชุจ ุดูุฑ:</label>
            <div class="flex gap-2">
              <select id="sal-month" class="w-2/3 border p-2 rounded text-sm">
                <option value="ููุงูุฑ">ููุงูุฑ</option>
                <option value="ูุจุฑุงูุฑ">ูุจุฑุงูุฑ</option>
                <option value="ูุงุฑุณ">ูุงุฑุณ</option>
                <option value="ุฃุจุฑูู">ุฃุจุฑูู</option>
                <option value="ูุงูู">ูุงูู</option>
                <option value="ููููู">ููููู</option>
                <option value="ููููู">ููููู</option>
                <option value="ุฃุบุณุทุณ">ุฃุบุณุทุณ</option>
                <option value="ุณุจุชูุจุฑ">ุณุจุชูุจุฑ</option>
                <option value="ุฃูุชูุจุฑ">ุฃูุชูุจุฑ</option>
                <option value="ููููุจุฑ">ููููุจุฑ</option>
                <option value="ุฏูุณูุจุฑ">ุฏูุณูุจุฑ</option>
              </select>
              <select id="sal-year" class="w-1/3 border p-2 rounded text-sm"></select>
            </div>
          </div>

          <button class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded shadow transition-colors">ุชุณุฌูู ุงูุฑุงุชุจ</button>
        </form>
      </div>

      <div class="md:col-span-2 space-y-6">
        <div class="grid grid-cols-2 gap-4">
          <div class="bg-white dark:bg-dark-surface p-4 rounded-xl shadow border-r-4 border-indigo-500">
            <p class="text-xs text-gray-500 dark:text-gray-400">ุฅุฌูุงูู ุงูุฑูุงุชุจ ุงููุฏููุนุฉ</p>
            <p id="total-salaries" class="text-xl font-bold text-gray-800 dark:text-white">0 AED</p>
          </div>
          <div class="bg-white dark:bg-dark-surface p-4 rounded-xl shadow border-r-4 border-teal-500">
            <p class="text-xs text-gray-500 dark:text-gray-400">ุนุฏุฏ ุงูุนูููุงุช</p>
            <p id="count-salaries" class="text-xl font-bold text-gray-800 dark:text-white">0</p>
          </div>
        </div>

        <div class="table-wrap bg-white dark:bg-dark-surface shadow-sm rounded-xl">
          <table class="min-w-full">
            <thead class="bg-gray-50 dark:bg-dark-bg">
              <tr>
                <th class="py-3 px-4">ุงูุชุงุฑูุฎ</th>
                <th class="py-3 px-4">ุงูููุธู</th>
                <th class="py-3 px-4">ุงููุจูุบ</th>
                <th class="py-3 px-4">ุงูุจูุงู</th>
                <th class="py-3 px-4 text-center">ุงูุณูุฏ</th>
                <th class="py-3 px-4 text-center">ุญุฐู</th>
              </tr>
            </thead>
            <tbody id="salaries-table-body" class="divide-y divide-gray-100 dark:divide-gray-700"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- ============= RECEIPTS HISTORY ============= -->
  <section id="receipts-history-view" class="view hidden">
    <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-white">ุณุฌู ุงูุณูุฏุงุช (ูุจุถ ูุตุฑู)</h2>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="bg-white p-4 rounded-xl shadow border-r-4 border-emerald-500 text-center">
        <p class="text-xs text-gray-500 dark:text-gray-400">ุฅุฌูุงูู ุณูุฏุงุช ุงููุจุถ (ุงูุฏูุนุงุช)</p>
        <p id="total-receipt-vouchers" class="font-bold text-xl text-emerald-700 dark:text-emerald-400">0 AED</p>
      </div>
      <div class="bg-white p-4 rounded-xl shadow border-r-4 border-rose-500 text-center">
        <p class="text-xs text-gray-500 dark:text-gray-400">ุฅุฌูุงูู ุณูุฏุงุช ุงูุตุฑู (ุงูุฑูุงุชุจ ูุงููุตุฑููุงุช)</p>
        <p id="total-payment-vouchers" class="font-bold text-xl text-rose-700 dark:text-rose-400">0 AED</p>
      </div>
      <div class="bg-white p-4 rounded-xl shadow border-r-4 border-blue-500 text-center">
        <p class="text-xs text-gray-500 dark:text-gray-400">ุนุฏุฏ ุงูุณูุฏุงุช ุงูููู</p>
        <p id="total-vouchers-count" class="font-bold text-xl text-blue-700 dark:text-blue-400">0</p>
      </div>
    </div>

    <div class="table-wrap bg-white shadow-sm">
      <table class="min-w-full">
        <thead>
          <tr>
            <th class="w-[100px]">ุงูุชุงุฑูุฎ</th>
            <th class="w-[100px]">ุงูููุน</th>
            <th class="w-[120px]">ุงููุจูุบ</th>
            <th class="w-[200px]">ุงูุทุฑู ุงูุขุฎุฑ</th>
            <th>ุงูุจูุงู</th>
            <th class="w-[80px]">ุนุฑุถ ุงูุณูุฏ</th>
          </tr>
        </thead>
        <tbody id="receipts-history-table-body"></tbody>
      </table>
    </div>
  </section>

  <!-- ============= RECEIPT VIEW ============= -->
  <section id="receipt-view" class="view hidden">
    <div class="max-w-4xl mx-auto">
      <h2 id="receipt-main-title" class="text-2xl font-bold mb-6 text-gray-800 dark:text-white">ุฅุตุฏุงุฑ ุณูุฏ</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <form id="receipt-form" class="md:col-span-1 bg-white p-6 rounded-xl shadow-sm space-y-4 h-fit hidden">
          <button type="submit">generate</button>
        </form>

        <div class="md:col-span-3">
          <button onclick="showView('receipts-history')" id="back-to-source-btn" class="mb-4 bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded">โฉ๏ธ ุงูุนูุฏุฉ ูุณุฌู ุงูุณูุฏุงุช</button>

          <div id="receipt-preview" class="bg-white p-8 rounded shadow-lg border relative">
            <div id="printable-receipt" class="p-4 border-2 border-double border-gray-300 text-gray-800 bg-white">
              <div class="flex justify-between items-start border-b-2 border-gray-200 pb-4 mb-6">
                <div>
                  <h1 id="rv-building-name" class="text-xl font-bold text-gray-800">ุจูุงูุฉ ูุฑุซุฉ ุฌูุนุฉ ุนุจูุฏ ุฃุจูุงูุดูุงุฑุจ</h1>
                  <p id="rv-building-location" class="text-sm text-gray-600">ุงูุนููุ ุจุทุญุงุก ุงูุญุงุฆุฑ</p>
                  <p id="rv-building-phone" class="text-sm text-gray-600">00971503343600</p>
                </div>
                <div class="text-center">
                  <h2 id="rv-title" class="text-3xl font-black text-emerald-700 tracking-wider">ุณูุฏ ูุจุถ</h2>
                  <p id="rv-subtitle" class="text-xs uppercase tracking-widest text-gray-400">Receipt Voucher</p>
                </div>
              </div>

              <div class="flex justify-between mb-8 text-sm">
                <p><strong>ุฑูู ุงูุณูุฏ:</strong> <span id="rv-no" class="text-rose-600 font-mono font-bold text-lg"></span></p>
                <p><strong>ุงูุชุงุฑูุฎ:</strong> <span id="rv-date-out"></span></p>
              </div>
              <div class="space-y-4 mb-8">
                <div class="flex border-b border-dotted border-gray-300 pb-2">
                  <span id="rv-party-label" class="w-32 font-bold text-gray-700">ุงุณุชูููุง ูู:</span>
                  <span id="rv-tenant-out" class="flex-1 text-lg"></span>
                </div>
                <div class="flex border-b border-dotted border-gray-300 pb-2">
                  <span class="w-32 font-bold text-gray-700">ูุจูุบ ููุฏุฑู:</span>
                  <span class="flex-1 font-bold text-xl text-emerald-700"><span id="rv-amount-out"></span> AED</span>
                </div>
                <div class="flex border-b border-dotted border-gray-300 pb-2">
                  <span class="w-32 font-bold text-gray-700">ุทุฑููุฉ ุงูุฏูุน:</span>
                  <span id="rv-method-out" class="flex-1"></span>
                </div>
                <div class="flex border-b border-dotted border-gray-300 pb-2">
                  <span class="w-32 font-bold text-gray-700">ูุฐูู ุนู:</span>
                  <span id="rv-for-out" class="flex-1"></span>
                </div>
              </div>
              <div class="flex justify-between mt-12 pt-8 border-t border-gray-200">
                <div class="text-center w-1/3">
                  <p class="font-bold text-sm mb-4">ุงููุณุชูู / ุงููุญุงุณุจ</p>
                  <div class="h-0 border-b border-gray-400 w-2/3 mx-auto"></div>
                </div>
                <div class="text-center w-1/3">
                  <p class="font-bold text-sm mb-4">ุงูุชูููุน / ุงูุฎุชู</p>
                  <div class="w-20 h-20 border-2 border-gray-200 rounded-full mx-auto opacity-50"></div>
                </div>
              </div>
            </div>
            <div class="mt-6 flex justify-end gap-3 no-print">
              <button onclick="downloadReceiptPDF()" class="bg-rose-600 hover:bg-rose-700 text-white px-4 py-2 rounded flex items-center gap-2">๐ ุชุตุฏูุฑ PDF</button>
              <button onclick="window.print()" class="bg-gray-800 hover:bg-gray-900 text-white px-4 py-2 rounded flex items-center gap-2">๐จ๏ธ ุทุจุงุนุฉ</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ============= REPORTS ============= -->
  <section id="reports-view" class="view hidden">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-gray-800 dark:text-white">ุงูุชูุงุฑูุฑ ุงูุดุงููุฉ</h2>
      <div class="flex gap-2">
        <button onclick="window.print()" class="bg-gray-700 text-white px-4 py-2 rounded">๐จ๏ธ ุทุจุงุนุฉ ุงูุชูุฑูุฑ</button>
      </div>
    </div>
    <div id="printable-area" class="bg-white p-8 rounded shadow-lg space-y-8 text-gray-800">
      <div class="text-center border-b pb-4 mb-4">
        <h1 class="text-2xl font-bold text-emerald-700">ุชูุฑูุฑ ุงูุนูุงุฑุงุช ูุงููุณุชุฃุฌุฑูู</h1>
        <p class="text-gray-500">ุชู ุงูุงุณุชุฎุฑุงุฌ ุจุชุงุฑูุฎ: <span id="report-date"></span></p>
      </div>
      <div>
        <h3 class="font-bold text-lg mb-2 text-indigo-700 border-r-4 border-indigo-700 pr-2">ููุฎุต ุงููุญุฏุงุช ุญุณุจ ุงููุณุชุฃุฌุฑ</h3>
        <div id="tenants-summary-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mt-4"></div>
      </div>
      <hr>
      <div>
        <h3 class="font-bold text-lg mb-2 text-rose-700 border-r-4 border-rose-700 pr-2">ุงููุชุฃุฎุฑุงุช ุงููุงููุฉ</h3>
        <ul id="late-tenants-list" class="space-y-2 mt-2 text-sm bg-rose-50 p-4 rounded text-gray-800"></ul>
      </div>
    </div>
  </section>

  <!-- ============= SETTINGS ============= -->
  <section id="settings-view" class="view hidden">
    <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-white">ุฅุนุฏุงุฏุงุช ุงููุธุงู</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-white p-6 rounded-xl shadow-sm">
        <h3 class="font-bold mb-4 flex items-center gap-2">๐ฆ ุงููุณุฎ ุงูุงุญุชูุงุทู (Backup)</h3>
        <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">ูู ุจุชุตุฏูุฑ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจุงููุงูู ููุญูุงุธ ุนูููุง ุฃู ููููุง.</p>
        <div class="flex flex-wrap gap-2">
          <button onclick="exportBackupJSON()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow text-sm">ุชุตุฏูุฑ (JSON)</button>
          <button onclick="exportBackupExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow text-sm">ุชุตุฏูุฑ (Excel)</button>
        </div>
      </div>
      <div class="bg-white p-6 rounded-xl shadow-sm">
        <h3 class="font-bold mb-4 flex items-center gap-2">๐ฅ ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช</h3>
        <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">ุงุณุชุฑุฌุน ุจูุงูุงุชู ูู ููู JSON ูุญููุธ ูุณุจูุงู.</p>
        <input type="file" id="backup-file" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100 mb-3" onchange="importBackup(event)">
        <p id="backup-msg" class="text-xs h-4"></p>
      </div>
      <div class="bg-white p-6 rounded-xl shadow-sm border border-rose-100 dark:border-rose-900">
        <h3 class="font-bold mb-4 text-rose-700">โ๏ธ ููุทูุฉ ุงูุฎุทุฑ</h3>
        <button onclick="if(confirm('ูู ุฃูุช ูุชุฃูุฏ ุชูุงูุงูุ ุณูุชู ุญุฐู ูู ุดูุก ูุชูุฑูุบ ุงููุธุงู!')) clearAllData()" class="bg-rose-100 text-rose-700 hover:bg-rose-200 px-4 py-2 rounded w-full text-sm font-bold">ูุฑูุชู ุงููุธุงู (ุญุฐู ุฌููุน ุงูุจูุงูุงุช)</button>
      </div>
    </div>
  </section>

  <!-- ============= MODALS ============= -->

  <!-- Property Modal -->
  <div id="property-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white modal-content rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden animate-[fadeIn_0.2s_ease-out]">
      <div class="p-6 border-b bg-gray-50 dark:bg-gray-700 dark:border-gray-600 flex justify-between items-center">
        <h3 class="text-xl font-bold">ุฅุถุงูุฉ ุนูุงุฑ ุฌุฏูุฏ</h3>
        <button onclick="closePropertyModal()" class="text-gray-400 hover:text-gray-600">โ</button>
      </div>
      <form id="property-form" class="p-6 grid grid-cols-1 gap-4">
        <input id="prop-id" placeholder="ุฑูุฒ ุงูุนูุงุฑ (ูุซุงู: PRP001)" class="border p-2 rounded w-full" required>
        <input id="prop-name" placeholder="ุงุณู ุงูุนูุงุฑ" class="border p-2 rounded w-full" required>
        <div class="grid grid-cols-2 gap-4">
          <input id="prop-type" placeholder="ุงูููุน (ูููุง/ุจูุงูุฉ)" class="border p-2 rounded">
          <input id="prop-usage" placeholder="ุงูุงุณุชุฎุฏุงู" class="border p-2 rounded">
        </div>
        <input id="prop-location" placeholder="ุงููููุน" class="border p-2 rounded">
        <div class="flex justify-end gap-3 mt-4">
          <button type="button" onclick="closePropertyModal()" class="px-4 py-2 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded">ุฅูุบุงุก</button>
          <button class="px-6 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700 shadow">ุญูุธ</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Unit Modal -->
  <div id="unit-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white modal-content rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden">
      <div class="p-6 border-b bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
        <h3 class="text-xl font-bold">ุจูุงูุงุช ุงููุญุฏุฉ</h3>
      </div>
      <form id="unit-form" class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="hidden" id="unit-prop-id">
        <input type="hidden" id="unit-id">
        <div class="md:col-span-2">
          <label class="text-xs text-gray-500 dark:text-gray-400">ุงุณู/ุฑูู ุงููุญุฏุฉ</label>
          <input id="unit-name" class="border p-2 rounded w-full" required>
        </div>
        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">ุงูููุน</label>
          <input id="unit-type" class="border p-2 rounded w-full">
        </div>
        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">ุงูุงุณุชุฎุฏุงู</label>
          <input id="unit-usage" class="border p-2 rounded w-full">
        </div>
        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">ุงูุญุงูุฉ</label>
          <select id="unit-status" class="border p-2 rounded w-full">
            <option value="ุดุงุบุฑุฉ">ุดุงุบุฑุฉ</option>
            <option value="ูุคุฌุฑุฉ">ูุคุฌุฑุฉ</option>
            <option value="ููุชููุฉ">ููุชููุฉ</option>
          </select>
        </div>
        <div class="md:col-span-2 border-t dark:border-gray-600 pt-4 mt-2">
          <p class="font-bold text-gray-700 dark:text-gray-300 mb-2">ุจูุงูุงุช ุงูุนูุฏ ุงูุญุงูู (ุฅู ูุฌุฏ)</p>
        </div>
        <div class="md:col-span-2">
          <input id="unit-tenant" placeholder="ุงุณู ุงููุณุชุฃุฌุฑ" class="border p-2 rounded w-full">
        </div>
        <div>
          <input id="unit-rent" type="number" placeholder="ุงููููุฉ ุงูุฅูุฌุงุฑูุฉ" class="border p-2 rounded w-full">
        </div>
        <div>
          <input id="unit-contractNo" placeholder="ุฑูู ุงูุนูุฏ" class="border p-2 rounded w-full">
        </div>
        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">ุจุฏุงูุฉ ุงูุนูุฏ</label>
          <input id="unit-start" type="date" class="border p-2 rounded w-full">
        </div>
        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">ููุงูุฉ ุงูุนูุฏ</label>
          <input id="unit-end" type="date" class="border p-2 rounded w-full">
        </div>
        <div class="md:col-span-2 flex justify-end gap-3 mt-4 border-t dark:border-gray-600 pt-4">
          <button type="button" onclick="closeUnitModal()" class="px-4 py-2 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded">ุฅูุบุงุก</button>
          <button class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 shadow">ุญูุธ ุงูุชุบููุฑุงุช</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Lease Modal -->
  <div id="lease-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white modal-content rounded-xl shadow-2xl w-full max-w-lg">
      <form id="lease-form" class="p-6 space-y-4">
        <h3 class="font-bold text-lg mb-4">ุชุนุฏูู ุจูุงูุงุช ุงูุนูุฏ</h3>
        <input type="hidden" id="lease-prop-id">
        <input type="hidden" id="lease-unit-id">
        <input id="lease-tenant" class="w-full border p-2 rounded" placeholder="ุงููุณุชุฃุฌุฑ" required>
        <div class="grid grid-cols-2 gap-2">
          <input id="lease-rent" type="number" class="border p-2 rounded" placeholder="ุงููููุฉ">
          <input id="lease-contractNo" class="border p-2 rounded" placeholder="ุฑูู ุงูุนูุฏ">
        </div>
        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="text-xs">ูู</label>
            <input id="lease-start" type="date" class="w-full border p-2 rounded">
          </div>
          <div>
            <label class="text-xs">ุฅูู</label>
            <input id="lease-end" type="date" class="w-full border p-2 rounded">
          </div>
        </div>
        <select id="lease-status" class="w-full border p-2 rounded">
          <option value="ูุคุฌุฑุฉ">ูุคุฌุฑุฉ</option>
          <option value="ููุชููุฉ">ููุชููุฉ</option>
        </select>
        <div class="flex justify-between pt-4">
          <button type="button" onclick="cancelLease()" class="text-rose-600 hover:bg-rose-50 dark:hover:bg-rose-900/20 px-3 py-1 rounded">ุฅูุบุงุก ุงูุนูุฏ ูุฅุฎูุงุก ุงููุญุฏุฉ</button>
          <div class="flex gap-2">
            <button type="button" onclick="closeLeaseModal()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded text-gray-800">ุฅูุบุงุก</button>
            <button class="px-4 py-2 bg-blue-600 text-white rounded">ุญูุธ</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Lease Modal -->
  <div id="add-lease-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white modal-content rounded-xl shadow-2xl w-full max-w-lg">
      <form id="add-lease-form" class="p-6 space-y-4">
        <h3 class="font-bold text-xl mb-4">ุนูุฏ ุฌุฏูุฏ</h3>
        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">ุงูุนูุงุฑ</label>
          <select id="add-lease-prop" class="w-full border p-2 rounded"></select>
        </div>
        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">ุงููุญุฏุฉ</label>
          <select id="add-lease-unit" class="w-full border p-2 rounded"></select>
        </div>
        <input id="add-lease-tenant" class="w-full border p-2 rounded" placeholder="ุงุณู ุงููุณุชุฃุฌุฑ" required>
        <div class="grid grid-cols-2 gap-3">
          <input id="add-lease-rent" type="number" class="border p-2 rounded" placeholder="ุงููููุฉ ุงูุณูููุฉ">
          <input id="add-lease-contractNo" class="border p-2 rounded" placeholder="ุฑูู ุงูุนูุฏ">
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-xs text-gray-500 dark:text-gray-400">ุชุงุฑูุฎ ุงูุจุฏุก</label>
            <input id="add-lease-start" type="date" class="w-full border p-2 rounded">
          </div>
          <div>
            <label class="text-xs text-gray-500 dark:text-gray-400">ุชุงุฑูุฎ ุงูุงูุชูุงุก</label>
            <input id="add-lease-end" type="date" class="w-full border p-2 rounded">
          </div>
        </div>
        <div id="add-lease-errors" class="text-rose-600 text-sm"></div>
        <div class="flex justify-end gap-3 pt-4">
          <button type="button" onclick="closeAddLeaseModal()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded text-gray-800">ุฅูุบุงุก</button>
          <button class="px-6 py-2 bg-emerald-600 text-white rounded shadow">ุฅูุดุงุก ุงูุนูุฏ</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Payment Modal -->
  <div id="payment-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white modal-content rounded-xl shadow-2xl w-full max-w-lg">
      <form id="payment-form" class="p-6 space-y-4">
        <h3 class="font-bold text-lg">ุชุณุฌูู ุฏูุนุฉ ุฌุฏูุฏุฉ</h3>
        <input id="pay-date" type="date" class="w-full border p-2 rounded" required>
        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">ุงูุนูุฏ</label>
          <select id="pay-contract" class="w-full border p-2 rounded"></select>
        </div>
        <select id="pay-type" class="w-full border p-2 rounded">
          <option>ููุฏู</option>
          <option>ุดูู</option>
          <option>ุชุญููู ุจููู</option>
        </select>
        <input id="pay-amount" type="number" placeholder="ุงููุจูุบ (AED)" class="w-full border p-2 rounded font-bold text-lg" required>
        <input id="pay-desc" placeholder="ููุงุญุธุงุช / ูุตู" class="w-full border p-2 rounded">
        <div class="flex justify-end gap-3 pt-4">
          <button type="button" onclick="closePaymentModal()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded text-gray-800">ุฅูุบุงุก</button>
          <button class="px-6 py-2 bg-emerald-600 text-white rounded shadow">ุญูุธ ุงูุฏูุนุฉ</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Tenant Modal -->
  <div id="tenant-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white modal-content rounded-xl shadow-2xl w-full max-w-md p-6">
      <h3 class="font-bold text-lg mb-4">ุจูุงูุงุช ุงูุงุชุตุงู</h3>
      <form id="tenant-form" class="space-y-4">
        <input id="tenant-name" class="w-full border p-2 rounded bg-gray-100 dark:bg-gray-700" readonly>
        <input id="tenant-phone" class="w-full border p-2 rounded" placeholder="ุฑูู ุงููุงุชู">
        <input id="tenant-email" class="w-full border p-2 rounded" placeholder="ุงูุจุฑูุฏ ุงูุฅููุชุฑููู">
        <div class="flex justify-end gap-2 pt-2">
          <button type="button" onclick="closeTenantModal()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded text-gray-800">ุฅุบูุงู</button>
          <button class="px-4 py-2 bg-blue-600 text-white rounded">ุญูุธ</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Cheque Modal -->
  <div id="cheque-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white modal-content rounded-xl shadow-2xl w-full max-w-lg">
      <form id="new-cheque-form" class="p-6 space-y-4">
        <h3 class="font-bold text-lg border-b pb-2 dark:border-gray-600">ุชุณุฌูู ุดูู ุฌุฏูุฏ</h3>

        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">ุงููุณุชุฃุฌุฑ</label>
          <select id="cheque-tenant-select" class="w-full border p-2 rounded" onchange="toggleTenantInput()">
            <option value="">ุงุฎุชุฑ ูุณุชุฃุฌุฑ ุญุงูู...</option>
            <option value="other">-- ูุณุชุฃุฌุฑ ุฌุฏูุฏ / ุขุฎุฑ --</option>
          </select>
          <input id="cheque-tenant-manual" placeholder="ุฃุฏุฎู ุงุณู ุงููุณุชุฃุฌุฑ ูุฏููุงู" class="w-full border p-2 rounded mt-2 hidden">
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="text-xs text-gray-500 dark:text-gray-400">ุฑูู ุงูุดูู</label>
            <input id="cheque-number" class="w-full border p-2 rounded" required>
          </div>
          <div>
            <label class="text-xs text-gray-500 dark:text-gray-400">ุงููููุฉ</label>
            <input id="cheque-value" type="number" class="w-full border p-2 rounded" required>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="text-xs text-gray-500 dark:text-gray-400">ุชุงุฑูุฎ ุงูุงุณุชุญูุงู</label>
            <input id="cheque-due-date" type="date" class="w-full border p-2 rounded" required>
          </div>
          <div>
            <label class="text-xs text-gray-500 dark:text-gray-400">ุงูุจูู</label>
            <input id="cheque-bank" class="w-full border p-2 rounded">
          </div>
        </div>

        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400 block mb-1">ุตูุฑุฉ ุงูุดูู (ุงุฎุชูุงุฑู)</label>
          <input id="cheque-image" type="file" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
        </div>

        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">ููุงุญุธุงุช</label>
          <input id="cheque-purpose" class="w-full border p-2 rounded">
        </div>

        <div class="flex justify-end gap-3 pt-4 border-t dark:border-gray-700">
          <button type="button" onclick="closeChequeModal()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded text-gray-800">ุฅูุบุงุก</button>
          <button class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">ุญูุธ ุงูุดูู</button>
        </div>
      </form>
    </div>
  </div>

<script>
  // ================= DATA =================
  const initialProperties = [
    {
      "id": "PRP65351",
      "name": "ูููุง",
      "type": "ูููุง",
      "usage": "ุณูู ุฎุงุต",
      "location": "ูุฏููุฉ ุงูุนูู - ููุฌ ูุฒุงุน",
      "units": [
        {
          "id": "PRP65351_U1",
          "name": "ูููุง",
          "type": "ูููุง",
          "usage": "ุณููู",
          "status": "ูุคุฌุฑุฉ",
          "tenant": "HAMDAN ABDULLA ANAYAT GHULAM MOHAMMED",
          "rent": 100000,
          "contractNo": "202402876023",
          "start": "2024-10-15",
          "end": "2025-10-14"
        }
      ]
    },
    {
      "id": "PRP11751",
      "name": "ุจูุงุก ุฒูุฑุงุก ููุทููุฉ ูุนุงูุดุฉ ุนุจูุฏ ุจุงูุดูุงุฑุจ",
      "type": "ุจูุงูุฉ",
      "usage": "ุชุฌุงุฑู - ุตูุงุนู",
      "location": "ูุฏููุฉ ุงูุนูู - ุจุทุญุงุก ุงูุญุงุฆุฑ",
      "units": [
        { "id":"UNT83591","name":"10-A","type":"ููุชุจ","usage":"ุชุฌุงุฑู","status":"ุดุงุบุฑุฉ" },
        { "id":"UNT83609","name":"10-B","type":"ููุชุจ","usage":"ุชุฌุงุฑู","status":"ูุคุฌุฑุฉ","tenant":"KASHMIR AL KHDHRA TILES & PLASTER WORKS EST","rent":9000,"contractNo":"202501709877","start":"2025-03-01","end":"2026-02-28" }
      ]
    }
  ];

  let properties = [], cheques = [], expenses = [], payments = [], tenantsContacts = {}, salaries = [];
  let contractLogs = JSON.parse(localStorage.getItem('logs') || "[]");

  // Default header info
  const defaultHeader = {
    name: 'ุจูุงูุฉ ูุฑุซุฉ ุฌูุนุฉ ุนุจูุฏ ุฃุจูุงูุดูุงุฑุจ',
    location: 'ุงูุนููุ ุจุทุญุงุก ุงูุญุงุฆุฑ',
    phone: '00971503343600'
  };

  // Voucher counters (sequential numbers)
  let voucherCounters = { receipt: 1, expense: 1, salary: 1 };

  // ================= UTILS & LOCAL STORAGE =================
  function formatAED(n){ return (n||0).toLocaleString('en-US') + ' AED'; }

  function logAction(msg){
    contractLogs.unshift({m:msg, t:new Date().toISOString()});
    if(contractLogs.length>50) contractLogs.pop();
    localStorage.setItem('logs', JSON.stringify(contractLogs));
    renderLogs();
  }

  function clearLogs(){
    contractLogs=[];
    localStorage.setItem('logs','[]');
    renderLogs();
  }

  function saveToLocal(){
    localStorage.setItem('re_data_v2', JSON.stringify({ properties, cheques, expenses, payments, tenantsContacts, salaries }));
  }

  function loadFromLocal(){
    const d = localStorage.getItem('re_data_v2');
    if(d){
      try {
        const o = JSON.parse(d);
        if(o.properties) properties = o.properties;
        cheques = o.cheques || [];
        expenses = o.expenses || [];
        payments = o.payments || [];
        tenantsContacts = o.tenantsContacts || {};
        salaries = o.salaries || [];

        // Migration: ensure expenses have ID & type
        expenses = expenses.map(e => ({
          id: e.id || 'EXP-' + Date.now() + Math.floor(Math.random()*1000),
          date: e.date,
          type: e.type || 'ุฃุฎุฑู',
          amount: e.amount,
          details: e.details,
          voucherNo: e.voucherNo || null
        }));

        // Migration: ensure cheques have ID, status, imageUrl
        cheques = cheques.map(c => ({
          ...c,
          id: c.id || 'CHQ-' + Date.now() + Math.floor(Math.random()*1000),
          status: c.status || (new Date(c.dueDate) < new Date() ? 'ุฑุงุฌุน' : 'ุจุงูุชุธุงุฑ ุงูุตุฑู'),
          imageUrl: c.imageUrl || null
        }));
      } catch(e){
        console.error("Error loading data", e);
      }
    } else {
      properties = JSON.parse(JSON.stringify(initialProperties));
      saveToLocal();
    }
    ensureVoucherNumbers();
  }

  function extractVoucherNumber(code){
    if(!code) return null;
    const parts = String(code).split('-');
    const numPart = parts[parts.length - 1];
    const n = parseInt(numPart, 10);
    return isNaN(n) ? null : n;
  }

  function recomputeVoucherCounters(){
    voucherCounters = { receipt:1, expense:1, salary:1 };
    payments.forEach(p => {
      const n = extractVoucherNumber(p.voucherNo);
      if(n && n >= voucherCounters.receipt) voucherCounters.receipt = n + 1;
    });
    expenses.forEach(e => {
      const n = extractVoucherNumber(e.voucherNo);
      if(n && n >= voucherCounters.expense) voucherCounters.expense = n + 1;
    });
    salaries.forEach(s => {
      const n = extractVoucherNumber(s.voucherNo);
      if(n && n >= voucherCounters.salary) voucherCounters.salary = n + 1;
    });
  }

  function nextVoucherNumber(type){
    if(!voucherCounters[type]) voucherCounters[type] = 1;
    const prefixMap = { receipt:'R', expense:'P', salary:'S' };
    const prefix = prefixMap[type] || 'V';
    const n = voucherCounters[type]++;
    return `${prefix}-${String(n).padStart(4,'0')}`;
  }

  function ensureVoucherNumbers(){
    recomputeVoucherCounters();
    let updated = false;

    payments.forEach(p => {
      if(!p.voucherNo){
        p.voucherNo = nextVoucherNumber('receipt');
        updated = true;
      }
    });
    expenses.forEach(e => {
      if(!e.voucherNo){
        e.voucherNo = nextVoucherNumber('expense');
        updated = true;
      }
    });
    salaries.forEach(s => {
      if(!s.voucherNo){
        s.voucherNo = nextVoucherNumber('salary');
        updated = true;
      }
    });

    if(updated) saveToLocal();
  }

  // ================= VIEW LOGIC =================
  function showView(id){
    document.querySelectorAll('.view').forEach(v=>v.classList.add('hidden'));
    document.getElementById(id+'-view')?.classList.remove('hidden');
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById('nav-'+id)?.classList.add('active');

    if(id==='dashboard') updateDashboard();
    else if(id==='properties') renderProperties();
    else if(id==='leases') renderLeases();
    else if(id==='tenants') renderTenants();
    else if(id==='cheques') renderCheques();
    else if(id==='payments') renderPayments();
    else if(id==='expenses') renderExpenses();
    else if(id==='salaries') renderSalaries();
    else if(id==='receipts-history') renderReceiptsHistory();
    else if(id==='reports') renderReports();
  }

  // ================= DASHBOARD =================
  let leasesChart, financeChart;

  function updateDashboard(){
    document.getElementById('current-date-display').textContent =
      new Date().toLocaleDateString('ar-AE', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
    renderLogs();

    const stats = { active:0, empty:0, expired:0, totalRent:0 };
    properties.forEach(p=>p.units.forEach(u=>{
      if(u.status==='ูุคุฌุฑุฉ'){ stats.active++; stats.totalRent += (u.rent||0); }
      else if(u.status==='ููุชููุฉ') stats.expired++;
      else stats.empty++;
    }));

    const tenants = getTenantsData();
    const lateCount = tenants.filter(t => t.balance > 0).length;

    document.getElementById('total-annual-rent').textContent = formatAED(stats.totalRent);
    document.getElementById('active-leases-count').textContent = stats.active;
    document.getElementById('empty-units-count').textContent = stats.empty;
    document.getElementById('late-tenants-count').textContent = lateCount;

    const isDark = document.body.classList.contains('dark-mode');
    const textColor = isDark ? '#d1d5db' : '#666';
    const gridColor = isDark ? '#374151' : '#e5e5e5';

    if(leasesChart) leasesChart.destroy();
    leasesChart = new Chart(document.getElementById('leasesChart'), {
      type:'doughnut',
      data:{
        labels:['ูุคุฌุฑุฉ','ุดุงุบุฑุฉ','ููุชููุฉ'],
        datasets:[{
          data:[stats.active, stats.empty, stats.expired],
          backgroundColor:['#10b981','#e5e7eb','#f43f5e'],
          borderColor: isDark ? '#1f2937' : '#fff'
        }]
      },
      options:{
        plugins:{ legend:{ position:'left', labels:{ color:textColor } } }
      }
    });

    const collected = payments.reduce((s,p)=>s+p.amount,0);
    if(financeChart) financeChart.destroy();
    financeChart = new Chart(document.getElementById('financeChart'), {
      type:'bar',
      data:{
        labels:['ุงููุชููุน ุณูููุงู', 'ุงูููุจูุถ ูุนููุงู'],
        datasets:[{
          label:'AED',
          data:[stats.totalRent, collected],
          backgroundColor:['#3b82f6', '#10b981'],
          borderRadius: 6
        }]
      },
      options:{
        scales:{
          y:{ beginAtZero:true, grid:{ color:gridColor }, ticks:{ color:textColor } },
          x:{ ticks:{ color:textColor }, grid:{ display:false } }
        },
        plugins:{ legend:{ labels:{ color:textColor } } }
      }
    });
  }

  function renderLogs(){
    const el=document.getElementById('contractLogs');
    el.innerHTML='';
    contractLogs.forEach(l=>{
      const li=document.createElement('li');
      li.innerHTML = `<span class="text-xs text-gray-400 font-mono">[${new Date(l.t).toLocaleTimeString('ar-AE')}]</span> ${l.m}`;
      el.appendChild(li);
    });
  }

  // ================= PROPERTIES =================
  function renderProperties(){
    const container = document.getElementById('properties-container');
    container.innerHTML = '';
    const search = document.getElementById('prop-search').value.toLowerCase();

    properties.forEach(p=>{
      const filteredUnits = p.units.filter(u=>
        u.name.toLowerCase().includes(search) ||
        (u.tenant||'').toLowerCase().includes(search)
      );
      if(search && filteredUnits.length === 0) return;

      const contentId = `units-content-${p.id}`;
      const iconId = `icon-${p.id}`;

      const card = document.createElement('div');
      card.className = "bg-white dark:bg-dark-surface rounded-2xl shadow-sm border border-gray-100 dark:border-dark-border overflow-hidden transition-all duration-200 hover:shadow-md";

      card.innerHTML = `
        <div class="p-4 bg-gray-50 dark:bg-dark-surface border-b dark:border-dark-border flex justify-between items-center cursor-pointer select-none" onclick="toggleUnitVisibility('${p.id}')">
          <div class="flex items-center gap-3">
            <div id="${iconId}" class="transition-transform duration-300 transform rotate-0 text-gray-400">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </div>
            <div>
              <div class="flex items-center gap-2">
                <h3 class="text-lg font-bold text-gray-800 dark:text-white">${p.name}</h3>
                <span class="bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-[10px] px-2 py-0.5 rounded-full font-mono">${p.id}</span>
              </div>
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">๐ ${p.location||'ุบูุฑ ูุญุฏุฏ'} | ๐ข ${p.units.length} ูุญุฏุงุช</p>
            </div>
          </div>
          <div class="flex gap-2" onclick="event.stopPropagation()">
            <button onclick="openUnitModal('${p.id}')" class="bg-white dark:bg-dark-surface border border-emerald-200 dark:border-emerald-800 text-emerald-700 dark:text-emerald-400 hover:bg-emerald-50 dark:hover:bg-gray-700 px-3 py-1 rounded text-xs font-bold shadow-sm transition-colors">+ ูุญุฏุฉ</button>
            <button onclick="deleteProperty('${p.id}')" class="bg-white dark:bg-dark-surface border border-red-200 dark:border-red-900 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-gray-700 px-3 py-1 rounded text-xs font-bold shadow-sm transition-colors">ุญุฐู</button>
          </div>
        </div>

        <div id="${contentId}" class="p-4 transition-all duration-300 ease-in-out">
          <div class="table-wrap border dark:border-dark-border rounded-lg">
            <table class="w-full">
              <thead class="bg-gray-50 dark:bg-dark-bg text-xs text-gray-500 dark:text-gray-400 uppercase">
                <tr>
                  <th class="px-4 py-2">ุงููุญุฏุฉ</th>
                  <th class="px-4 py-2">ุงูููุน</th>
                  <th class="px-4 py-2">ุงูุญุงูุฉ</th>
                  <th class="px-4 py-2">ุงููุณุชุฃุฌุฑ</th>
                  <th class="px-4 py-2">ุงููููุฉ</th>
                  <th class="px-4 py-2">ุงูุนูุฏ</th>
                  <th class="px-4 py-2">ุงูุชูุงุฑูุฎ</th>
                  <th class="px-4 py-2">ุชุญูู</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                ${(search ? filteredUnits : p.units).map(u=>{
                  const statusClass =
                    u.status==='ูุคุฌุฑุฉ'
                      ? 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900 dark:text-emerald-200'
                      : (u.status==='ููุชููุฉ'
                        ? 'bg-rose-100 text-rose-800 dark:bg-rose-900 dark:text-rose-200'
                        : 'bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-200');
                  return `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors">
                      <td class="px-4 py-3 font-bold text-gray-700 dark:text-gray-200">${u.name}</td>
                      <td class="px-4 py-3 text-xs text-gray-500 dark:text-gray-400">${u.type||'-'}</td>
                      <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded text-[10px] font-bold ${statusClass}">${u.status}</span>
                      </td>
                      <td class="px-4 py-3 text-sm max-w-[150px] truncate" title="${u.tenant||''}">${u.tenant||'-'}</td>
                      <td class="px-4 py-3 font-mono text-emerald-700 dark:text-emerald-400 font-bold text-sm">${u.rent ? u.rent.toLocaleString() : '-'}</td>
                      <td class="px-4 py-3 text-xs font-mono truncate-text text-gray-500 dark:text-gray-400" title="${u.contractNo||''}">${u.contractNo||'-'}</td>
                      <td class="px-4 py-3 text-[10px] text-gray-400">
                        <div class="flex flex-col">
                          <span>${u.start||'--'}</span>
                          <span>${u.end||'--'}</span>
                        </div>
                      </td>
                      <td class="px-4 py-3">
                        <div class="flex gap-1">
                          <button onclick="openUnitModal('${p.id}','${u.id}')" class="p-1.5 hover:bg-blue-50 dark:hover:bg-gray-700 text-blue-600 dark:text-blue-400 rounded transition-colors" title="ุชุนุฏูู">โ๏ธ</button>
                          <button onclick="openLeaseModal('${p.id}','${u.id}')" class="p-1.5 hover:bg-purple-50 dark:hover:bg-gray-700 text-purple-600 dark:text-purple-400 rounded transition-colors" title="ุงูุนูุฏ">๐</button>
                          <button onclick="deleteUnit('${p.id}','${u.id}')" class="p-1.5 hover:bg-red-50 dark:hover:bg-gray-700 text-red-600 dark:text-red-400 rounded transition-colors" title="ุญุฐู ุงููุญุฏุฉ">๐๏ธ</button>
                        </div>
                      </td>
                    </tr>`;
                }).join('')}
              </tbody>
            </table>
          </div>
          ${p.units.length === 0 ? '<div class="text-center py-4 text-gray-400 text-sm">ูุง ุชูุฌุฏ ูุญุฏุงุช ูุถุงูุฉ ููุฐุง ุงูุนูุงุฑ</div>' : ''}
        </div>
      `;
      container.appendChild(card);
    });
  }

  function toggleUnitVisibility(propId) {
    const content = document.getElementById(`units-content-${propId}`);
    const icon = document.getElementById(`icon-${propId}`);
    if(!content || !icon) return;
    if (content.classList.contains('hidden')) {
      content.classList.remove('hidden');
      icon.classList.remove('-rotate-90');
      icon.classList.add('rotate-0');
    } else {
      content.classList.add('hidden');
      icon.classList.remove('rotate-0');
      icon.classList.add('-rotate-90');
    }
  }

  function expandAllProperties() {
    properties.forEach(p => {
      const content = document.getElementById(`units-content-${p.id}`);
      const icon = document.getElementById(`icon-${p.id}`);
      if(content && icon) {
        content.classList.remove('hidden');
        icon.classList.remove('-rotate-90');
        icon.classList.add('rotate-0');
      }
    });
  }

  function collapseAllProperties() {
    properties.forEach(p => {
      const content = document.getElementById(`units-content-${p.id}`);
      const icon = document.getElementById(`icon-${p.id}`);
      if(content && icon) {
        content.classList.add('hidden');
        icon.classList.remove('rotate-0');
        icon.classList.add('-rotate-90');
      }
    });
  }

  function deleteProperty(id){
    if(!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุนูุงุฑ ูุฌููุน ูุญุฏุงุชูุ ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก.')) return;
    const prop = properties.find(p=>p.id===id);
    properties = properties.filter(p => p.id !== id);
    saveToLocal();
    renderProperties();
    renderLeases();
    renderPayments();
    updateDashboard();
    logAction(`ุชู ุญุฐู ุงูุนูุงุฑ ${prop ? prop.name : id}`);
  }

  function deleteUnit(propId, unitId){
    if(!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐู ุงููุญุฏุฉุ ุณูุชู ุญุฐู ุนูุฏูุง ูุฏูุนุงุชูุง ุงููุฑุชุจุทุฉ ุจูุง ุฅู ููุฌุฏุช.')) return;
    const prop = properties.find(p=>p.id===propId);
    if(!prop) return;
    const unit = prop.units.find(u=>u.id===unitId);
    if(!unit) return;

    // ุญุฐู ุงูุฏูุนุงุช ุงููุฑุชุจุทุฉ ุจุงูุนูุฏ/ุงููุญุฏุฉ
    payments = payments.filter(p => !(p.unit === unit.name && p.contract === unit.contractNo));
    prop.units = prop.units.filter(u=>u.id!==unitId);

    saveToLocal();
    renderProperties();
    renderLeases();
    renderPayments();
    updateDashboard();
    logAction(`ุชู ุญุฐู ุงููุญุฏุฉ ${unit.name} ูู ุงูุนูุงุฑ ${prop.name}`);
  }

  // ================= LEASES =================
  let leaseSort={key:'end',dir:'asc'};

  function setLeaseSort(k){
    if(leaseSort.key===k) leaseSort.dir = leaseSort.dir==='asc'?'desc':'asc';
    else { leaseSort.key=k; leaseSort.dir='asc'; }
    renderLeases();
  }

  function renderLeases(){
    const tbody = document.getElementById('leases-table-body');
    tbody.innerHTML='';
    const search = document.getElementById('lease-search-input').value.toLowerCase();

    let allLeases = [];
    properties.forEach(p=>p.units.forEach(u=>{
      if(u.status!=='ุดุงุบุฑุฉ') allLeases.push({...u, propName:p.name, propId:p.id});
    }));

    if(search){
      allLeases = allLeases.filter(l=>
        (l.contractNo||'').includes(search) ||
        (l.tenant||'').toLowerCase().includes(search)
      );
    }

    allLeases.sort((a,b)=>{
      let va = a[leaseSort.key], vb = b[leaseSort.key];
      if(leaseSort.key==='rent')
        return leaseSort.dir==='asc' ? (va||0)-(vb||0) : (vb||0)-(va||0);
      return leaseSort.dir==='asc'
        ? (va||'').localeCompare(vb||'')
        : (vb||'').localeCompare(va||'');
    });

    allLeases.forEach(l=>{
      const tr = document.createElement('tr');
      tr.className = l.status==='ููุชููุฉ' ? 'bg-red-50 dark:bg-red-900/20' : '';
      tr.innerHTML = `
        <td>
          <div class="font-bold text-gray-800 dark:text-white">${l.name}</div>
          <div class="text-xs text-gray-500 dark:text-gray-400">${l.propName}</div>
        </td>
        <td class="text-sm font-semibold text-gray-700 dark:text-gray-300">${l.tenant}</td>
        <td class="font-mono text-emerald-600 dark:text-emerald-400">${formatAED(l.rent)}</td>
        <td class="text-xs font-mono bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded inline-block truncate-text" title="${l.contractNo}">${l.contractNo}</td>
        <td class="text-xs">${l.start||'-'}</td>
        <td class="text-xs ${new Date(l.end)<new Date() ? 'text-red-600 dark:text-red-400 font-bold':''}">${l.end||'-'}</td>
        <td><span class="badge ${l.status==='ูุคุฌุฑุฉ'?'badge-green':'badge-red'}">${l.status}</span></td>
        <td>
          <button onclick="openLeaseModal('${l.propId}','${l.id}')" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 text-sm font-bold">ุฅุฏุงุฑุฉ</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function openPropertyModal(){ document.getElementById('property-modal').classList.remove('hidden'); }
  function closePropertyModal(){ document.getElementById('property-modal').classList.add('hidden'); }

  document.getElementById('property-form').addEventListener('submit', e=>{
    e.preventDefault();
    properties.push({
      id: document.getElementById('prop-id').value,
      name: document.getElementById('prop-name').value,
      type: document.getElementById('prop-type').value,
      usage: document.getElementById('prop-usage').value,
      location: document.getElementById('prop-location').value,
      units: []
    });
    saveToLocal();
    closePropertyModal();
    renderProperties();
    updateDashboard();
    logAction('ุชูุช ุฅุถุงูุฉ ุนูุงุฑ ุฌุฏูุฏ');
  });

  function openUnitModal(propId, unitId){
    const m = document.getElementById('unit-modal');
    m.classList.remove('hidden');
    document.getElementById('unit-prop-id').value = propId;
    document.getElementById('unit-id').value = unitId || '';

    const p = properties.find(x=>x.id===propId);
    const u = unitId ? p.units.find(x=>x.id===unitId) : null;

    if(u){
      document.getElementById('unit-name').value = u.name;
      document.getElementById('unit-type').value = u.type||'';
      document.getElementById('unit-usage').value = u.usage||'';
      document.getElementById('unit-status').value = u.status;
      document.getElementById('unit-tenant').value = u.tenant||'';
      document.getElementById('unit-rent').value = u.rent||'';
      document.getElementById('unit-contractNo').value = u.contractNo||'';
      document.getElementById('unit-start').value = u.start||'';
      document.getElementById('unit-end').value = u.end||'';
    } else {
      document.getElementById('unit-form').reset();
      document.getElementById('unit-prop-id').value = propId;
    }
  }

  function closeUnitModal(){
    document.getElementById('unit-modal').classList.add('hidden');
  }

  document.getElementById('unit-form').addEventListener('submit', e=>{
    e.preventDefault();
    const pid = document.getElementById('unit-prop-id').value;
    const uid = document.getElementById('unit-id').value;
    const p = properties.find(x=>x.id===pid);

    const newUnit = {
      id: uid || 'U'+Date.now(),
      name: document.getElementById('unit-name').value,
      type: document.getElementById('unit-type').value,
      usage: document.getElementById('unit-usage').value,
      status: document.getElementById('unit-status').value,
      tenant: document.getElementById('unit-tenant').value,
      rent: parseInt(document.getElementById('unit-rent').value||0),
      contractNo: document.getElementById('unit-contractNo').value,
      start: document.getElementById('unit-start').value,
      end: document.getElementById('unit-end').value
    };

    if(uid){
      const idx = p.units.findIndex(x=>x.id===uid);
      p.units[idx] = newUnit;
    } else {
      p.units.push(newUnit);
    }
    saveToLocal();
    closeUnitModal();
    showView('properties');
    updateDashboard();
  });

  function openAddLeaseModal(){
    const m = document.getElementById('add-lease-modal');
    m.classList.remove('hidden');
    const propSelect = document.getElementById('add-lease-prop');
    propSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงูุนูุงุฑ...</option>';
    properties.forEach(p => {
      propSelect.innerHTML += `<option value="${p.id}">${p.name}</option>`;
    });
    document.getElementById('add-lease-unit').innerHTML = '<option value="">ุงุฎุชุฑ ุงูุนูุงุฑ ุฃููุงู</option>';
    document.getElementById('add-lease-form').reset();
  }

  function closeAddLeaseModal(){
    document.getElementById('add-lease-modal').classList.add('hidden');
  }

  document.getElementById('add-lease-prop').addEventListener('change', function(){
    const propId = this.value;
    const unitSelect = document.getElementById('add-lease-unit');
    unitSelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงููุญุฏุฉ...</option>';
    if(propId){
      const prop = properties.find(p => p.id === propId);
      const availableUnits = prop.units.filter(u => u.status !== 'ูุคุฌุฑุฉ');
      if(availableUnits.length === 0){
        unitSelect.innerHTML = '<option value="">ูุง ุชูุฌุฏ ูุญุฏุงุช ุดุงุบุฑุฉ</option>';
      } else {
        availableUnits.forEach(u => {
          unitSelect.innerHTML += `<option value="${u.id}">${u.name} (${u.status})</option>`;
        });
      }
    }
  });

  document.getElementById('add-lease-form').addEventListener('submit', e => {
    e.preventDefault();
    const propId = document.getElementById('add-lease-prop').value;
    const unitId = document.getElementById('add-lease-unit').value;
    if(!propId || !unitId){
      alert("ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุงูุนูุงุฑ ูุงููุญุฏุฉ");
      return;
    }
    const prop = properties.find(p => p.id === propId);
    const unit = prop.units.find(u => u.id === unitId);
    unit.status = 'ูุคุฌุฑุฉ';
    unit.tenant = document.getElementById('add-lease-tenant').value;
    unit.rent = parseFloat(document.getElementById('add-lease-rent').value || 0);
    unit.contractNo = document.getElementById('add-lease-contractNo').value;
    unit.start = document.getElementById('add-lease-start').value;
    unit.end = document.getElementById('add-lease-end').value;
    saveToLocal();
    closeAddLeaseModal();
    showView('leases');
    logAction(`ุชู ุฅูุดุงุก ุนูุฏ ุฌุฏูุฏ ูููุญุฏุฉ ${unit.name}`);
    updateDashboard();
  });

  function openLeaseModal(pid, uid){
    const m = document.getElementById('lease-modal');
    m.classList.remove('hidden');
    const u = properties.find(x=>x.id===pid).units.find(x=>x.id===uid);
    document.getElementById('lease-prop-id').value=pid;
    document.getElementById('lease-unit-id').value=uid;
    document.getElementById('lease-tenant').value=u.tenant||'';
    document.getElementById('lease-rent').value=u.rent||'';
    document.getElementById('lease-contractNo').value=u.contractNo||'';
    document.getElementById('lease-start').value=u.start||'';
    document.getElementById('lease-end').value=u.end||'';
    document.getElementById('lease-status').value=u.status;
  }

  function closeLeaseModal(){
    document.getElementById('lease-modal').classList.add('hidden');
  }

  document.getElementById('lease-form').addEventListener('submit', e=>{
    e.preventDefault();
    const pid = document.getElementById('lease-prop-id').value;
    const uid = document.getElementById('lease-unit-id').value;
    const p = properties.find(x=>x.id===pid);
    const u = p.units.find(x=>x.id===uid);

    u.tenant = document.getElementById('lease-tenant').value;
    u.rent = parseFloat(document.getElementById('lease-rent').value||0);
    u.contractNo = document.getElementById('lease-contractNo').value;
    u.start = document.getElementById('lease-start').value;
    u.end = document.getElementById('lease-end').value;
    u.status = document.getElementById('lease-status').value;

    saveToLocal();
    closeLeaseModal();
    renderLeases();
    renderProperties();
    updateDashboard();
    logAction(`ุชู ุชุนุฏูู ุจูุงูุงุช ุนูุฏ ุงููุญุฏุฉ ${u.name}`);
  });

  function cancelLease(){
    if(!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุฅูุบุงุก ุงูุนูุฏุ ุณูุชู ุชุญููู ุงููุญุฏุฉ ูุดุงุบุฑุฉ.')) return;
    const pid = document.getElementById('lease-prop-id').value;
    const uid = document.getElementById('lease-unit-id').value;
    const u = properties.find(x=>x.id===pid).units.find(x=>x.id===uid);
    u.status='ุดุงุบุฑุฉ';
    u.tenant='';
    u.rent=0;
    u.contractNo='';
    u.start='';
    u.end='';
    saveToLocal();
    closeLeaseModal();
    showView('leases');
    updateDashboard();
    logAction(`ุชู ุฅูุบุงุก ุนูุฏ ${u.name}`);
  }

  // ================= TENANTS =================
  function getTenantsData(){
    const map = {};
    properties.forEach(p=>p.units.forEach(u=>{
      if(u.status==='ูุคุฌุฑุฉ' && u.tenant){
        if(!map[u.tenant]) map[u.tenant] = { name:u.tenant, phone:'', email:'', units:[], rent:0, paid:0 };
        map[u.tenant].units.push(u.name);
        map[u.tenant].rent += (u.rent||0);
      }
    }));
    Object.keys(map).forEach(name=>{
      if(tenantsContacts[name]){
        map[name].phone = tenantsContacts[name].phone;
        map[name].email = tenantsContacts[name].email;
      }
    });
    payments.forEach(pay=>{
      if(map[pay.tenant]) map[pay.tenant].paid += pay.amount;
    });
    return Object.values(map).map(t=>({...t, balance: t.rent - t.paid}));
  }

  function getTenantNames(){
    return Object.keys(
      getTenantsData().reduce((acc, t)=>{
        if(t.units && t.units.length>0) acc[t.name]=true;
        return acc;
      }, {})
    );
  }

  function renderTenants(){
    const tbody = document.getElementById('tenants-table-body');
    tbody.innerHTML = '';
    const search = document.getElementById('tenants-search').value.toLowerCase();
    const data = getTenantsData().filter(t=> t.name.toLowerCase().includes(search));

    data.forEach(t=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="font-bold">${t.name}</td>
        <td class="text-sm">
          ๐ ${t.phone||'--'}<br>
          ๐ง ${t.email||'--'}
        </td>
        <td class="text-xs text-gray-500 dark:text-gray-400">${t.units.join(', ')}</td>
        <td class="font-mono">${formatAED(t.rent)}</td>
        <td class="font-mono text-green-600">${formatAED(t.paid)}</td>
        <td class="font-mono font-bold ${t.balance>0?'text-rose-600 dark:text-rose-400':'text-gray-400'}">${formatAED(t.balance)}</td>
        <td>
          <button onclick="openTenantModal('${t.name}')" class="text-blue-600 dark:text-blue-400 text-xs border border-blue-200 dark:border-blue-800 px-2 py-1 rounded">ุชุญุฏูุซ</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function openTenantModal(name=''){
    const modal = document.getElementById('tenant-modal');
    modal.classList.remove('hidden');

    const nameInput  = document.getElementById('tenant-name');
    const phoneInput = document.getElementById('tenant-phone');
    const emailInput = document.getElementById('tenant-email');

    nameInput.value = name || '';
    phoneInput.value = '';
    emailInput.value = '';

    if(name && tenantsContacts[name]){
      phoneInput.value = tenantsContacts[name].phone || '';
      emailInput.value = tenantsContacts[name].email || '';
    }
  }

  function closeTenantModal(){
    const name = document.getElementById('tenant-name').value;
    if(name){
      tenantsContacts[name] = {
        phone: document.getElementById('tenant-phone').value,
        email: document.getElementById('tenant-email').value
      };
      saveToLocal();
      renderTenants();
    }
    document.getElementById('tenant-modal').classList.add('hidden');
  }

  document.getElementById('tenant-form').addEventListener('submit', function(e){
    e.preventDefault();
    closeTenantModal();
  });

  // ================= PAYMENTS =================
  function openPaymentModal(){
    const m = document.getElementById('payment-modal');
    m.classList.remove('hidden');
    const sel = document.getElementById('pay-contract');
    sel.innerHTML='';
    properties.forEach(p=>p.units.forEach(u=>{
      if(u.status==='ูุคุฌุฑุฉ'){
        const opt = document.createElement('option');
        opt.value = JSON.stringify({t:u.tenant, u:u.name, c:u.contractNo, rent:u.rent});
        opt.textContent = `${u.tenant} - (${u.name})`;
        sel.appendChild(opt);
      }
    }));
  }

  function closePaymentModal(){
    document.getElementById('payment-modal').classList.add('hidden');
  }

  document.getElementById('payment-form').addEventListener('submit', e=>{
    e.preventDefault();
    const data = JSON.parse(document.getElementById('pay-contract').value);
    const amt = parseFloat(document.getElementById('pay-amount').value);
    const payObj = {
      id: 'PAY-'+Date.now(),
      date: document.getElementById('pay-date').value,
      tenant: data.t,
      unit: data.u,
      contract: data.c,
      due: data.rent,
      type: document.getElementById('pay-type').value,
      amount: amt,
      desc: document.getElementById('pay-desc').value,
      voucherNo: nextVoucherNumber('receipt')
    };
    payments.push(payObj);
    saveToLocal();
    closePaymentModal();
    renderPayments();
    updateDashboard();
    renderReceiptsHistory();
    logAction(`ุฏูุนุฉ ${amt} ูู ${data.t}`);
  });

  function renderPayments(){
    const tbody = document.getElementById('payments-table-body');
    tbody.innerHTML='';
    payments.sort((a,b)=> new Date(b.date)-new Date(a.date)).forEach(p=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="text-sm">${p.date}</td>
        <td>
          <div class="font-bold text-sm">${p.tenant}</div>
          <div class="text-xs text-gray-500 dark:text-gray-400">${p.unit}</div>
        </td>
        <td><span class="badge badge-blue">${p.type}</span></td>
        <td class="font-bold text-emerald-700 dark:text-emerald-400 font-mono">${formatAED(p.amount)}</td>
        <td class="text-xs text-gray-500 dark:text-gray-400 font-mono">${formatAED(p.due)} / <span class="text-rose-500 dark:text-rose-400">${formatAED(p.due-p.amount)}</span></td>
        <td>${p.amount>=p.due ? '<span class="badge badge-green">ููุชูู</span>' : '<span class="badge badge-amber">ุฌุฒุฆู</span>'}</td>
        <td><button onclick="previewReceipt('${p.id}', 'payment')" class="text-purple-600 dark:text-purple-400 hover:underline text-xs">ุนุฑุถ ุงูุณูุฏ</button></td>
      `;
      tbody.appendChild(tr);
    });
    const total = payments.reduce((s,p)=>s+p.amount,0);
    document.getElementById('payments-total').textContent = formatAED(total);
  }

  // ================= CHEQUES =================
  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      if (!file) {
        resolve(null);
        return;
      }
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = error => reject(error);
      reader.readAsDataURL(file);
    });
  }

  function toggleTenantInput() {
    const selectEl = document.getElementById('cheque-tenant-select');
    const manualEl = document.getElementById('cheque-tenant-manual');
    if (selectEl.value === 'other') {
      manualEl.classList.remove('hidden');
      manualEl.setAttribute('required', 'required');
    } else {
      manualEl.classList.add('hidden');
      manualEl.removeAttribute('required');
    }
  }

  function openChequeModal(){
    const m = document.getElementById('cheque-modal');
    m.classList.remove('hidden');
    document.getElementById('new-cheque-form').reset();

    const selectEl = document.getElementById('cheque-tenant-select');
    selectEl.innerHTML = '<option value="">ุงุฎุชุฑ ูุณุชุฃุฌุฑ ุญุงูู...</option>';

    getTenantNames().forEach(name => {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      selectEl.appendChild(opt);
    });
    selectEl.innerHTML += '<option value="other">-- ูุณุชุฃุฌุฑ ุฌุฏูุฏ / ุขุฎุฑ --</option>';

    toggleTenantInput();
  }

  function closeChequeModal(){
    document.getElementById('cheque-modal').classList.add('hidden');
  }

  document.getElementById('new-cheque-form').addEventListener('submit', async e=>{
    e.preventDefault();

    const tenantSelect = document.getElementById('cheque-tenant-select').value;
    const tenantManual = document.getElementById('cheque-tenant-manual').value;
    const tenantName = tenantSelect === 'other' ? tenantManual : tenantSelect;

    if (!tenantName) {
      alert("ุงูุฑุฌุงุก ุชุญุฏูุฏ ุฃู ุฅุฏุฎุงู ุงุณู ุงููุณุชุฃุฌุฑ.");
      return;
    }

    const imageFile = document.getElementById('cheque-image').files[0];
    const imageUrl = await fileToBase64(imageFile);

    cheques.push({
      id: 'CHQ-'+Date.now(),
      tenant: tenantName,
      chequeNo: document.getElementById('cheque-number').value,
      value: parseFloat(document.getElementById('cheque-value').value),
      dueDate: document.getElementById('cheque-due-date').value,
      bank: document.getElementById('cheque-bank').value,
      purpose: document.getElementById('cheque-purpose').value,
      status: 'ุจุงูุชุธุงุฑ ุงูุตุฑู',
      imageUrl: imageUrl
    });
    saveToLocal();
    closeChequeModal();
    renderCheques();
    logAction(`ุชู ุชุณุฌูู ุดูู ุฌุฏูุฏ ูููุณุชุฃุฌุฑ: ${tenantName}`);
  });

  function changeChequeStatus(id, newStatus) {
    const chequeIndex = cheques.findIndex(c => c.id === id);
    if (chequeIndex === -1) return;

    const cheque = cheques[chequeIndex];
    cheque.status = newStatus;

    if (newStatus === 'ูุตุฑูู') {
      const paymentExists = payments.some(p => p.chequeId === id);

      if (!paymentExists) {
        payments.push({
          id: 'PAY-CHQ-'+Date.now(),
          chequeId: id,
          date: new Date().toISOString().substring(0, 10),
          tenant: cheque.tenant,
          unit: 'ุดูู ูุตุฑู',
          contract: cheque.chequeNo,
          due: cheque.value,
          type: 'ุดูู ูุตุฑู',
          amount: cheque.value,
          desc: cheque.purpose || `ุชุญุตูู ุงูุดูู ุฑูู ${cheque.chequeNo} ูู ${cheque.tenant}`,
          voucherNo: nextVoucherNumber('receipt')
        });
        logAction(`ุชู ุตุฑู ุงูุดูู ุฑูู ${cheque.chequeNo} ูุชู ุชุณุฌููู ูุฏูุนุฉ ููุจูุถุฉ.`);
      }
    } else {
      payments = payments.filter(p => p.chequeId !== id);
    }

    saveToLocal();
    renderCheques();
    updateDashboard();
    renderPayments();
    renderReceiptsHistory();
  }

  function viewChequeImage(imageUrl) {
    if (!imageUrl) return;
    const w = window.open('', '_blank');
    w.document.write(`
      <!DOCTYPE html>
      <html lang="ar" dir="rtl">
      <head><title>ุตูุฑุฉ ุงูุดูู</title>
      <style>
        body{margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh;background:#111;}
        img{max-width:90vw;max-height:90vh;border:10px solid white;box-shadow:0 0 20px rgba(0,0,0,0.5);}
      </style>
      </head>
      <body><img src="${imageUrl}" alt="ุตูุฑุฉ ุงูุดูู"></body>
      </html>
    `);
    w.document.close();
  }

  function renderCheques(){
    const tbody = document.getElementById('cheques-table-body');
    tbody.innerHTML='';
    cheques.sort((a,b)=> new Date(b.dueDate)-new Date(a.dueDate)).forEach(c=>{
      let statusClass = 'badge-amber';
      if (c.status === 'ูุตุฑูู') statusClass = 'badge-green';
      else if (c.status === 'ุฑุงุฌุน') statusClass = 'badge-red';

      const statusOptions = ['ุจุงูุชุธุงุฑ ุงูุตุฑู', 'ูุตุฑูู', 'ุฑุงุฌุน'];
      const selectOptions = statusOptions.map(s =>
        `<option value="${s}" ${c.status === s ? 'selected' : ''}>${s}</option>`
      ).join('');

      const tr = document.createElement('tr');
      tr.innerHTML=`
        <td><span class="badge ${statusClass}">${c.status}</span></td>
        <td class="font-mono">${c.dueDate}</td>
        <td>${c.tenant}</td>
        <td class="font-bold">${formatAED(c.value)}</td>
        <td class="text-xs text-gray-500 dark:text-gray-400">${c.bank} - #${c.chequeNo}</td>
        <td>
          ${c.imageUrl ? `<button onclick="viewChequeImage('${c.imageUrl}')" class="text-purple-600 dark:text-purple-400 hover:underline text-xs">ุนุฑุถ ุงูุตูุฑุฉ</button>` : '-'}
        </td>
        <td>
          <select onchange="changeChequeStatus('${c.id}', this.value)" class="text-sm border p-1 rounded bg-white dark:bg-gray-800 dark:text-white">
            ${selectOptions}
          </select>
          <button onclick="deleteCheque('${c.id}')" class="text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 p-1 rounded transition ml-2" title="ุญุฐู">๐๏ธ</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function deleteCheque(id){
    if(!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุดููุ ุณูุชู ุญุฐูู ูู ุณุฌู ุงูุฏูุนุงุช ุฅุฐุง ูุงู ูุตุฑููุงู.')) return;
    cheques = cheques.filter(c => c.id !== id);
    payments = payments.filter(p => p.chequeId !== id);
    saveToLocal();
    renderCheques();
    renderPayments();
    updateDashboard();
    renderReceiptsHistory();
    logAction(`ุชู ุญุฐู ุงูุดูู ${id}`);
  }

  // ================= EXPENSES =================
  function renderExpenses(){
    const tbody = document.getElementById('expenses-table-body');
    if(!tbody) return;
    tbody.innerHTML='';
    expenses.sort((a,b)=> new Date(b.date)-new Date(a.date)).forEach((e,i)=>{
      const tr = document.createElement('tr');
      tr.className = "hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors";
      tr.innerHTML=`
        <td class="text-sm font-mono">${e.date}</td>
        <td class="text-sm font-bold text-indigo-700 dark:text-indigo-400">${e.type}</td>
        <td class="font-bold text-rose-600 dark:text-rose-400">${formatAED(e.amount)}</td>
        <td class="text-sm text-gray-600 dark:text-gray-300">${e.details}</td>
        <td class="text-center">
          <div class="flex items-center justify-center gap-2">
            <button onclick="previewReceipt('${e.id}', 'expense')" class="text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/30 px-2 py-1 rounded text-xs font-bold hover:bg-blue-100">๐จ๏ธ ุณูุฏ ุตุฑู</button>
            <button onclick="deleteExpense(${i})" class="text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 p-1 rounded transition" title="ุญุฐู">๐๏ธ</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function deleteExpense(index){
    if(!confirm('ุญุฐู ูุฐุง ุงููุตุฑููุ')) return;
    expenses.splice(index, 1);
    saveToLocal();
    renderExpenses();
    renderReceiptsHistory();
  }

  document.getElementById('new-expense-form').addEventListener('submit', e=>{
    e.preventDefault();
    expenses.push({
      id: 'EXP-'+Date.now(),
      date: document.getElementById('expense-date').value,
      type: document.getElementById('expense-type').value,
      amount: parseFloat(document.getElementById('expense-amount').value),
      details: document.getElementById('expense-details').value,
      voucherNo: nextVoucherNumber('expense')
    });
    saveToLocal();
    renderExpenses();
    renderReceiptsHistory();
    e.target.reset();
    logAction(`ุชู ุชุณุฌูู ูุตุฑูู ุฌุฏูุฏ ูู ููุน: ${document.getElementById('expense-type').value}`);
  });

  // ================= SALARIES =================
  function initSalaryYears(){
    const yearSel = document.getElementById('sal-year');
    if(!yearSel) return;
    const currentYear = new Date().getFullYear();
    yearSel.innerHTML = `
      <option value="${currentYear-1}">${currentYear-1}</option>
      <option value="${currentYear}" selected>${currentYear}</option>
      <option value="${currentYear+1}">${currentYear+1}</option>
    `;
  }

  function renderSalaries(){
    initSalaryYears();
    const tbody = document.getElementById('salaries-table-body');
    if(!tbody) return;
    tbody.innerHTML = '';

    let total = 0;
    salaries.sort((a,b)=> new Date(b.date) - new Date(a.date)).forEach((s,index)=>{
      total += (s.amount || 0);
      const tr = document.createElement('tr');
      tr.className = "hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors";
      tr.innerHTML = `
        <td class="px-4 py-3 text-sm font-mono text-gray-600 dark:text-gray-300">${s.date}</td>
        <td class="px-4 py-3 font-bold text-gray-800 dark:text-white">${s.name}</td>
        <td class="px-4 py-3 font-mono font-bold text-emerald-600 dark:text-emerald-400">${formatAED(s.amount)}</td>
        <td class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400">${s.notes || '-'}</td>
        <td class="px-4 py-3 text-center">
          <button onclick="previewReceipt('${s.id}', 'salary')" class="text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/30 px-2 py-1 rounded text-xs font-bold hover:bg-blue-100">๐จ๏ธ ุณูุฏ ุตุฑู ุฑุงุชุจ</button>
        </td>
        <td class="px-4 py-3 text-center">
          <button onclick="deleteSalary(${index})" class="text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/30 p-1 rounded transition">๐๏ธ</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
    document.getElementById('total-salaries').textContent = formatAED(total);
    document.getElementById('count-salaries').textContent = salaries.length;
  }

  document.getElementById('salary-form')?.addEventListener('submit', function(e){
    e.preventDefault();

    const month = document.getElementById('sal-month').value;
    const year = document.getElementById('sal-year').value;
    const notes = `ุฑุงุชุจ ุดูุฑ ${month} ูุณูุฉ ${year}`;

    const newSalary = {
      id: 'SAL-'+Date.now(),
      name: document.getElementById('sal-name').value,
      role: document.getElementById('sal-role').value,
      amount: parseFloat(document.getElementById('sal-amount').value),
      date: document.getElementById('sal-date').value,
      notes: notes,
      voucherNo: nextVoucherNumber('salary')
    };
    salaries.push(newSalary);
    saveToLocal();
    renderSalaries();
    renderReceiptsHistory();
    this.reset();
    logAction(`ุชู ุตุฑู ุฑุงุชุจ ููููุธู: ${newSalary.name}`);

    initSalaryYears();
    document.getElementById('sal-month').selectedIndex = 0;
  });

  function deleteSalary(index){
    if(!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ููุฏ ุงูุฑุงุชุจ ูุฐุงุ')) return;
    salaries.splice(index, 1);
    saveToLocal();
    renderSalaries();
    renderReceiptsHistory();
  }

  // ================= RECEIPTS HISTORY & PREVIEW =================
  function renderReceiptsHistory(){
    const tbody = document.getElementById('receipts-history-table-body');
    tbody.innerHTML = '';

    let allVouchers = [];
    let totalReceipts = 0;
    let totalSalariesAmt = 0;
    let totalExpensesAmt = 0;

    payments.forEach(p => {
      totalReceipts += p.amount;
      allVouchers.push({
        id: p.id,
        type: 'ูุจุถ',
        date: p.date,
        amount: p.amount,
        party: p.tenant,
        desc: p.desc || `ุฏูุนุฉ ุฅูุฌุงุฑ ูุญุฏุฉ ${p.unit}`,
        sourceType: 'payment'
      });
    });

    salaries.forEach(s => {
      totalSalariesAmt += s.amount;
      allVouchers.push({
        id: s.id,
        type: 'ุตุฑู ุฑุงุชุจ',
        date: s.date,
        amount: s.amount,
        party: s.name,
        desc: s.notes,
        sourceType: 'salary'
      });
    });

    expenses.forEach(e => {
      totalExpensesAmt += e.amount;
      allVouchers.push({
        id: e.id,
        type: 'ุตุฑู',
        date: e.date,
        amount: e.amount,
        party: e.type,
        desc: `${e.type}: ${e.details}`,
        sourceType: 'expense'
      });
    });

    allVouchers.sort((a,b)=> new Date(b.date) - new Date(a.date));

    allVouchers.forEach(v => {
      const isReceipt = v.sourceType === 'payment';
      const typeClass = isReceipt ? 'badge-green' : 'badge-red';
      const amountClass = isReceipt ? 'text-emerald-700 dark:text-emerald-400' : 'text-rose-700 dark:text-rose-400';
      const tr = document.createElement('tr');
      tr.className = "hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors";
      tr.innerHTML = `
        <td class="text-sm font-mono">${v.date}</td>
        <td><span class="badge ${typeClass}">${v.type}</span></td>
        <td class="font-bold font-mono ${amountClass}">${formatAED(v.amount)}</td>
        <td class="text-sm font-bold text-gray-700 dark:text-gray-300">${v.party}</td>
        <td class="text-xs text-gray-500 dark:text-gray-400 truncate-text max-w-[200px]" title="${v.desc}">${v.desc}</td>
        <td>
          <button onclick="previewReceipt('${v.id}', '${v.sourceType}')" class="text-purple-600 dark:text-purple-400 hover:underline text-xs">ุนุฑุถ</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById('total-receipt-vouchers').textContent = formatAED(totalReceipts);
    document.getElementById('total-payment-vouchers').textContent = formatAED(totalSalariesAmt + totalExpensesAmt);
    document.getElementById('total-vouchers-count').textContent = allVouchers.length;
  }

  function findPropertyForPayment(payment){
    if(!payment) return null;
    for(const p of properties){
      for(const u of p.units){
        if(payment.unit && u.name === payment.unit) return p;
        if(payment.contract && u.contractNo === payment.contract) return p;
      }
    }
    return null;
  }

  function setReceiptHeaderByProperty(prop){
    const nameEl = document.getElementById('rv-building-name');
    const locEl  = document.getElementById('rv-building-location');
    const phoneEl= document.getElementById('rv-building-phone');
    if(prop){
      nameEl.textContent = prop.name || defaultHeader.name;
      locEl.textContent  = prop.location || defaultHeader.location;
    } else {
      nameEl.textContent = defaultHeader.name;
      locEl.textContent  = defaultHeader.location;
    }
    phoneEl.textContent = defaultHeader.phone;
  }

  function previewReceipt(id, type='payment'){
    showView('receipt');

    const titleEl    = document.getElementById('rv-title');
    const subTitleEl = document.getElementById('rv-subtitle');
    const partyLabelEl = document.getElementById('rv-party-label');
    const mainTitleEl = document.getElementById('receipt-main-title');

    const btnBack = document.getElementById('back-to-source-btn');
    btnBack.onclick = function(){ showView('receipts-history'); };

    if(type === 'salary'){
      const item = salaries.find(x => x.id === id);
      if(!item) return;

      titleEl.textContent = "ุณูุฏ ุตุฑู ุฑุงุชุจ";
      titleEl.className = "text-3xl font-black text-rose-700 tracking-wider";
      subTitleEl.textContent = "Salary Payment Voucher";
      partyLabelEl.textContent = "ุงุตุฑููุง ููุณูุฏ/ุฉ:";
      mainTitleEl.textContent = "ุณูุฏ ุตุฑู ุฑุงุชุจ";

      setReceiptHeaderByProperty(null);

      document.getElementById('rv-no').textContent = item.voucherNo || '';
      document.getElementById('rv-date-out').textContent = item.date;
      document.getElementById('rv-tenant-out').textContent = `${item.name} (${item.role})`;
      document.getElementById('rv-amount-out').textContent = parseFloat(item.amount).toLocaleString();
      document.getElementById('rv-method-out').textContent = "ููุฏู / ุชุญููู";
      document.getElementById('rv-for-out').textContent = item.notes;

    } else if(type === 'expense'){
      const item = expenses.find(x => x.id === id);
      if(!item) return;

      titleEl.textContent = "ุณูุฏ ุตุฑู";
      titleEl.className = "text-3xl font-black text-rose-700 tracking-wider";
      subTitleEl.textContent = "Payment Voucher";
      partyLabelEl.textContent = "ุงุตุฑููุง ููุฌูุฉ:"; 
      mainTitleEl.textContent = "ุณูุฏ ุตุฑู";

      setReceiptHeaderByProperty(null);

      document.getElementById('rv-no').textContent = item.voucherNo || '';
      document.getElementById('rv-date-out').textContent = item.date;
      document.getElementById('rv-tenant-out').textContent = item.type;
      document.getElementById('rv-amount-out').textContent = parseFloat(item.amount).toLocaleString();
      document.getElementById('rv-method-out').textContent = "ููุฏู";
      document.getElementById('rv-for-out').textContent = `ุฏูุน ูุจูุบ ${item.amount.toLocaleString()} ุนู ${item.type}: ${item.details}`;

    } else {
      const item = payments.find(x => x.id === id || x.chequeId === id);
      if(!item) return;

      titleEl.textContent = "ุณูุฏ ูุจุถ";
      titleEl.className = "text-3xl font-black text-emerald-700 tracking-wider";
      subTitleEl.textContent = "Receipt Voucher";
      partyLabelEl.textContent = "ุงุณุชูููุง ูู:";
      mainTitleEl.textContent = "ุณูุฏ ูุจุถ";

      const prop = findPropertyForPayment(item);
      setReceiptHeaderByProperty(prop);

      document.getElementById('rv-no').textContent = item.voucherNo || '';
      document.getElementById('rv-date-out').textContent = item.date;
      document.getElementById('rv-tenant-out').textContent = item.tenant;
      document.getElementById('rv-amount-out').textContent = parseFloat(item.amount).toLocaleString();
      document.getElementById('rv-method-out').textContent = item.type;
      document.getElementById('rv-for-out').textContent = item.desc || `ุฏูุนุฉ ุฅูุฌุงุฑ ูุญุฏุฉ ${item.unit}`;
    }
  }

  function downloadReceiptPDF(){
    const element = document.getElementById('printable-receipt');
    const opt = {
      margin: 10,
      filename: 'Voucher.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().set(opt).from(element).save();
  }

  // ================= REPORTS =================
  function renderReports(){
    const date = new Date().toLocaleDateString('ar-AE');
    document.getElementById('report-date').textContent = date;
    const tenants = getTenantsData();
    const list = document.getElementById('tenants-summary-list');
    list.innerHTML='';
    tenants.forEach(t=>{
      const div = document.createElement('div');
      div.className = "border p-3 rounded bg-gray-50 flex justify-between";
      div.innerHTML = `<span><strong>${t.name}</strong> (${t.units.length} ูุญุฏุงุช)</span> <span class="font-bold text-emerald-700">${formatAED(t.rent)}</span>`;
      list.appendChild(div);
    });
    const lateList = document.getElementById('late-tenants-list');
    lateList.innerHTML='';
    const late = tenants.filter(t=>t.balance>0);
    if(late.length===0) lateList.innerHTML = '<li class="text-green-700">ูุง ููุฌุฏ ูุชุฃุฎุฑุงุช ูููู ุงูุญูุฏ</li>';
    else late.forEach(t=>{
      const li = document.createElement('li');
      li.innerHTML = `โ๏ธ <strong>${t.name}</strong> - ูุชุจูู ุนููู: <span class="font-bold text-red-700">${formatAED(t.balance)}</span>`;
      lateList.appendChild(li);
    });
  }

  // ================= SETTINGS & BACKUP =================
  function exportBackupJSON(){
    const data = { properties, cheques, expenses, payments, tenantsContacts, salaries };
    const blob = new Blob([JSON.stringify(data)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url;
    a.download='realestate_backup.json';
    a.click();
  }

  function exportBackupExcel(){
    const wb = XLSX.utils.book_new();
    const unitsData = [];
    properties.forEach(p=>p.units.forEach(u=> unitsData.push({...u, Property:p.name})));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(unitsData), "Units");
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(payments), "Payments");
    if(salaries.length > 0) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(salaries), "Salaries");
    if(expenses.length > 0) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(expenses), "Expenses");
    XLSX.writeFile(wb, "RealEstate_Data.xlsx");
  }

  function importBackup(e){
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(evt){
      try{
        const data = JSON.parse(evt.target.result);
        if(data.properties) properties = data.properties;
        if(data.payments) payments = data.payments;
        if(data.cheques) cheques = data.cheques;
        if(data.salaries) salaries = data.salaries;
        if(data.expenses) expenses = data.expenses;
        if(data.tenantsContacts) tenantsContacts = data.tenantsContacts;

        expenses = expenses.map(e => ({
          id: e.id || 'EXP-' + Date.now() + Math.floor(Math.random()*1000),
          date: e.date,
          type: e.type || 'ุฃุฎุฑู',
          amount: e.amount,
          details: e.details,
          voucherNo: e.voucherNo || null
        }));
        cheques = cheques.map(c => ({
          ...c,
          id: c.id || 'CHQ-' + Date.now() + Math.floor(Math.random()*1000),
          status: c.status || (new Date(c.dueDate) < new Date() ? 'ุฑุงุฌุน' : 'ุจุงูุชุธุงุฑ ุงูุตุฑู'),
          imageUrl: c.imageUrl || null
        }));

        saveToLocal();
        ensureVoucherNumbers();
        document.getElementById('backup-msg').textContent = "โ ุชู ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช ุจูุฌุงุญ!";
        setTimeout(()=>location.reload(), 1500);
      } catch(err){
        console.error(err);
        document.getElementById('backup-msg').textContent = "โ ููู ุบูุฑ ุตุงูุญ";
      }
    };
    reader.readAsText(file);
  }

  function clearAllData(){
    properties = [];
    cheques = [];
    expenses = [];
    payments = [];
    tenantsContacts = {};
    salaries = [];
    saveToLocal();
    location.reload();
  }

  // ================= THEME =================
  function toggleDarkMode(){
    const willBeDark = !document.body.classList.contains('dark-mode');

    if (willBeDark) {
      document.body.classList.add('dark-mode');
      document.documentElement.classList.add('dark');
      localStorage.setItem('re_dark_mode', '1');
    } else {
      document.body.classList.remove('dark-mode');
      document.documentElement.classList.remove('dark');
      localStorage.setItem('re_dark_mode', '0');
    }
    updateDashboard();
  }

  function initTheme(){
    const saved = localStorage.getItem('re_dark_mode');
    if (saved === '1') {
      document.body.classList.add('dark-mode');
      document.documentElement.classList.add('dark');
    } else {
      document.body.classList.remove('dark-mode');
      document.documentElement.classList.remove('dark');
    }
  }

  // ================= INIT =================
  window.onload = function(){
    initTheme();
    loadFromLocal();
    showView('dashboard');
  };
</script>

</body>
</html>

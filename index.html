
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            dark: {
              bg: '#111827',
              surface: '#1f2937',
              border: '#374151',
              text: '#f3f4f6',
              muted: '#9ca3af',
              input: '#111827'
            }
          }
        }
      }
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Tajawal:wght@400;500;700&display=swap');

    body {
      font-family: 'Tajawal','Cairo',system-ui,sans-serif;
      background:#f9fafb;
      color:#111827;
      transition: background-color 0.3s, color 0.3s;
    }

    /* --- Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ --- */
    body.dark-mode {
      background-color: #111827;
      color: #f3f4f6;
    }

    body.dark-mode .bg-white,
    body.dark-mode .modal-content {
      background-color: #1f2937 !important;
      color: #f3f4f6 !important;
      border-color: #374151 !important;
    }

    body.dark-mode .bg-gray-50 { background-color: #111827 !important; }
    body.dark-mode .bg-gray-100 { background-color: #374151 !important; color: white !important; }

    /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
    body.dark-mode th {
      background-color: #1f2937 !important;
      color: #9ca3af !important;
      border-bottom-color: #374151 !important;
    }
    body.dark-mode td { border-bottom-color: #374151 !important; }

    /* Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª */
    body.dark-mode input,
    body.dark-mode select,
    body.dark-mode textarea {
      background-color: #111827 !important;
      border-color: #4b5563 !important;
      color: #fff !important;
    }
    body.dark-mode input::placeholder,
    body.dark-mode textarea::placeholder { color: #6b7280 !important; }

    /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù†ØµÙˆØµ ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
    body.dark-mode .text-gray-900,
    body.dark-mode .text-gray-800 {
      color: #f9fafb !important;
    }
    body.dark-mode .text-gray-700 {
      color: #e5e7eb !important;
    }
    body.dark-mode .text-gray-600 {
      color: #d1d5db !important;
    }
    body.dark-mode .text-gray-500 {
      color: #9ca3af !important;
    }
    body.dark-mode .text-gray-400 {
      color: #6b7280 !important;
    }

    /* Ø§Ù„Ù†Ø§ÙØ¨Ø§Ø± */
    nav {
      background:#ffffff;
      border-radius:16px;
      box-shadow:0 4px 6px -1px rgba(0,0,0,0.05);
      padding:12px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-bottom: 20px;
      transition: background-color 0.3s;
    }
    body.dark-mode nav {
      background-color: #1f2937 !important;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.3);
    }

    .nav-btn {
      border-radius:8px;
      font-weight:600;
      padding:8px 16px;
      transition:all .2s;
      background:#f3f4f6;
      color:#4b5563;
      border: 1px solid transparent;
    }
    .nav-btn:hover {
      background:#e5e7eb;
      transform:translateY(-1px);
    }
    .nav-btn.active {
      background:#7c3aed;
      color:#fff;
      box-shadow:0 4px 12px rgba(124, 58, 237, 0.3);
    }

    body.dark-mode .nav-btn {
      background:#374151;
      color:#d1d5db;
    }
    body.dark-mode .nav-btn:hover {
      background:#4b5563;
      color: white;
    }
    body.dark-mode .nav-btn.active {
      background:#8b5cf6;
      color:#fff;
      box-shadow:0 4px 12px rgba(139, 92, 246, 0.4);
    }

    .bg-white {
      border-radius:16px;
      box-shadow:0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid rgba(0,0,0,0.05);
    }
    table {
      border-collapse:separate;
      border-spacing:0;
      width:100%;
      font-size:.9rem;
    }
    th {
      background:#f9fafb;
      font-weight:700;
      text-align:right;
      padding:12px 16px;
      border-bottom:2px solid #e5e7eb;
      color: #4b5563;
      text-transform: uppercase;
      font-size: 0.8rem;
      letter-spacing: 0.05em;
    }
    td {
      padding:12px 16px;
      border-bottom:1px solid #f3f4f6;
      vertical-align: middle;
    }

    .badge {
      padding:.25rem .6rem;
      border-radius:9999px;
      font-size:.7rem;
      font-weight:700;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .badge-green { background:#d1fae5; color:#047857; }
    .badge-red { background:#fee2e2; color:#b91c1c; }
    .badge-amber { background:#fef3c7; color:#b45309; }
    /* Ø¯Ù‚Ø© Ø£Ø¹Ù„Ù‰ Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¹Ù‚ÙˆØ¯ */
    .badge-orange { background:#ffedd5; color:#c2410c; }
    .badge-crimson { background:#ffe4e6; color:#9f1239; }
    .badge-emerald { background:#dcfce7; color:#15803d; }
    .badge-blue { background:#dbeafe; color:#1e40af; }

    button { border-radius:8px; font-weight:600; transition:all .2s; }
    button:active { transform: scale(0.98); }

    .hidden { display:none !important; }
    .table-wrap {
      overflow-x:auto;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
    }
    body.dark-mode .table-wrap { border-color: #374151; }

    .truncate-text {
      max-width: 120px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Ø³Ø·Ø±ÙŠÙ† ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰ Ù„Ù„Ù†ØµÙˆØµ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
    .clamp-2{
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }

    .rotate-0 { transform: rotate(0deg); }
    .-rotate-90 { transform: rotate(90deg); }

    @page {
      size: A4 portrait;
      margin: 10mm;
    }

    /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù„Ù„Ø³Ù†Ø¯Ø§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ± */
    
    .letter-title-ar{
      font-family:"Arabic Typesetting","Amiri","Noto Naskh Arabic",serif;
      font-size:28px;
      line-height:1.2;
      font-weight:700;
    }
    .letter-title-en{
      font-family:"Times New Roman", Georgia, serif;
      font-size:18px;
      line-height:1.25;
      margin-top:6px;
      font-weight:600;
      opacity:.95;
    }
    body.dark-mode .letter-title{
      border-bottom-color: rgba(255,255,255,0.18);
    }

@media print {
      body {
        margin: 0;
      }
      body * {
        visibility: hidden;
      }

      #printable-area,
      #printable-area *,
      #printable-receipt,
      #printable-receipt * {
        visibility: visible;
      }

      #printable-area,
      #printable-receipt {
        position: absolute;
        inset: 0;
        margin: 0 auto;
        width: 190mm;
        page-break-inside: avoid;
      }

      #notice-letter,
      #notice-letter * {
        visibility: visible;
      }

      #notice-letter {
        position: absolute;
        inset: 0;
        margin: 0 auto;
        width: 190mm;
        page-break-inside: avoid;
      }

      /* Print: ensure reports view can render even if it has Tailwind .hidden */
      #reports-view, #reports-view.hidden{ display:block !important; }
      /* If printable-area is inside a hidden container, force it visible for print */
      #printable-area{ display:block !important; }


      .no-print {
        display: none !important;
      }
    }
  
    /* =========================================================
       Enhanced Light/Dark Theme (Accessibility + Visual Comfort)
       ========================================================= */
    :root{
      --bg:#f8fafc;
      --surface:#ffffff;
      --surface-2:#f1f5f9;
      --border:rgba(15,23,42,.12);
      --text:#0f172a;
      --muted:#475569;
      --muted-2:#64748b;
      --shadow:0 1px 2px rgba(15,23,42,.06), 0 6px 18px rgba(15,23,42,.06);
      --focus:rgba(124,58,237,.35);
    }
    body.dark-mode{
      --bg:#0b1220;
      --surface:#0f172a;
      --surface-2:#111c33;
      --border:rgba(148,163,184,.18);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --muted-2:#64748b;
      --shadow:0 1px 2px rgba(0,0,0,.35), 0 10px 28px rgba(0,0,0,.35);
      --focus:rgba(139,92,246,.45);
    }

    body{
      background:var(--bg) !important;
      color:var(--text) !important;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Surfaces */
    nav{
      background:var(--surface) !important;
      border:1px solid var(--border);
      box-shadow:var(--shadow);
    }
    .bg-white,
    .modal-content{
      background-color:var(--surface) !important;
      color:var(--text) !important;
      border-color:var(--border) !important;
      box-shadow:var(--shadow);
    }
    body.dark-mode .bg-gray-50{ background-color:var(--bg) !important; }
    body.dark-mode .bg-gray-100{
      background-color:var(--surface-2) !important;
      color:var(--text) !important;
    }

    /* Navigation buttons */
    .nav-btn{
      background:var(--surface-2) !important;
      color:var(--muted) !important;
      border:1px solid var(--border);
    }
    .nav-btn:hover{
      background:rgba(148,163,184,.18) !important;
      transform:translateY(-1px);
    }
    body.dark-mode .nav-btn:hover{
      background:rgba(148,163,184,.22) !important;
      color:var(--text) !important;
    }

    /* Inputs */
    input, select, textarea{
      background-color:var(--surface) !important;
      color:var(--text) !important;
      border-color:var(--border) !important;
    }
    body.dark-mode input,
    body.dark-mode select,
    body.dark-mode textarea{
      background-color:var(--surface-2) !important;
      color:var(--text) !important;
      border-color:var(--border) !important;
    }
    input::placeholder, textarea::placeholder{
      color:var(--muted-2) !important;
    }
    input:focus, select:focus, textarea:focus{
      outline:none !important;
      box-shadow:0 0 0 3px var(--focus) !important;
    }

    /* Tables */
    th{
      background:var(--surface-2) !important;
      color:var(--muted) !important;
      border-bottom:1px solid var(--border) !important;
    }
    td{
      border-bottom:1px solid var(--border) !important;
      color:var(--text) !important;
    }
    tbody tr:hover td{
      background:rgba(15,23,42,.03) !important;
    }
    body.dark-mode tbody tr:hover td{
      background:rgba(148,163,184,.08) !important;
    }

    /* Common text utilities */
    .text-gray-900, .text-gray-800{ color:var(--text) !important; }
    .text-gray-700, .text-gray-600, .text-gray-500{ color:var(--muted) !important; }
    .text-gray-400{ color:var(--muted-2) !important; }

    /* Badges (softer in dark mode) */
    body.dark-mode .badge-green{ background:rgba(16,185,129,.18) !important; color:#34d399 !important; }
    body.dark-mode .badge-red{ background:rgba(244,63,94,.18) !important; color:#fb7185 !important; }
    body.dark-mode .badge-amber{ background:rgba(245,158,11,.18) !important; color:#fbbf24 !important; }
    body.dark-mode .badge-blue{ background:rgba(59,130,246,.18) !important; color:#93c5fd !important; }


    /* ===== ØªØ­Ø³ÙŠÙ† ØµÙØ­Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ ===== */
    body.dark-mode #reports-view .bg-rose-50{
      background-color: rgba(127,29,29,.22) !important;
      border: 1px solid rgba(248,113,113,.20) !important;
    }
    body.dark-mode #reports-view .text-rose-700{ color:#fca5a5 !important; }
    body.dark-mode #reports-view .border-rose-700{ border-color: rgba(248,113,113,.55) !important; }
    body.dark-mode #reports-view .text-red-700{ color:#fca5a5 !important; }
    body.dark-mode #reports-view .text-emerald-700{ color:#86efac !important; }
    body.dark-mode #reports-view .text-green-700{ color:#86efac !important; }


    /* ===== Letters / Notices (A4) ===== */
    .letter-paper{
      font-family:"Arabic Typesetting","Noto Naskh Arabic","Tahoma","Arial",sans-serif;
      background:#ffffff;
      color:#111827;
            font-size:20px;
border:1px solid rgba(0,0,0,0.10);
      border-radius:18px;
      padding:28px;
      max-width:920px;
      margin: 0 auto;
    }
    .letter-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      margin-bottom:14px;
    }
    .letter-head-lines{
      font-weight:700;
      line-height:1.45;
      font-size:15px;
    }
    .letter-date{
      font-weight:600;
      font-size:14px;
      opacity:.85;
      white-space:nowrap;
    }
    .letter-title{
      text-align:center;
      margin: 10px 0 14px;
      padding-bottom:12px;
      border-bottom: 2px solid rgba(0,0,0,0.12);
    }
    .letter-meta{
      display:flex;
      flex-wrap:wrap;
      justify-content:space-between;
      gap:10px;
      margin: 10px 0 18px;
      font-size:13px;
      opacity:.9;
    }
    .letter-columns{
      direction:rtl;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 0;
      border:1px solid rgba(0,0,0,0.10);
      border-radius:16px;
      overflow:hidden;
      background: rgba(255,255,255,0.65);
    }
    body.dark-mode .letter-columns{
      background: rgba(17,24,39,0.40);
      border-color: rgba(255,255,255,0.14);
    }
    .letter-col{
      padding:16px 18px;
      min-height: 380px;
    }
    .letter-col[dir="rtl"]{
      direction:rtl;
      font-family:"Arabic Typesetting","Amiri","Noto Naskh Arabic","Times New Roman",serif;
      font-size: 24px;
      line-height:2.0;
      border-left:1px solid rgba(0,0,0,0.10);
      border-right:none;
}
    body.dark-mode .letter-col[dir="rtl"]{
      border-left-color: rgba(255,255,255,0.14);
      border-right-color: transparent;
}
    .letter-col[dir="ltr"]{
      direction:ltr;
      font-family:"Times New Roman", Georgia, serif;
      font-size:15px;
      line-height:1.9;
    }
    .letter-p{
      margin:0 0 10px 0;
    }
    .letter-list{
      margin:0 0 12px 0;
      padding-left: 20px;
    }
    .letter-col[dir="rtl"] .letter-list{
      padding-left:0;
      padding-right: 22px;
    }
    .letter-list li{ margin: 0 0 6px 0; }
.letter-body{
      font-size:inherit;
      line-height:inherit;
      white-space:pre-wrap;
    }
    .letter-edit{ outline:none; }
    .letter-footer{
      margin-top: 26px;
      padding-top: 14px;
      border-top: 1px solid rgba(0,0,0,0.12);
      font-size:12.5px;
      line-height:1.6;
      opacity:.9;
    }
    .letter-footer .sig{
      font-weight:700;
      margin-bottom:6px;
    }

    
    /* Attachments & Signature */
    .letter-attachments{
      margin-top: 18px;
      padding-top: 12px;
      border-top: 1px dashed rgba(0,0,0,0.18);
    }
    .letter-attachments-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .letter-attachments-col{
      padding: 10px 12px;
      border: 1px solid rgba(0,0,0,0.10);
      border-radius: 14px;
      background: rgba(0,0,0,0.02);
    }
    body.dark-mode .letter-attachments-col{
      border-color: rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
    }
    .letter-attachments .att-title{
      font-size: 12.5px;
      font-weight: 800;
      margin: 0 0 6px 0;
      opacity: .95;
    }
    .letter-attachments ul{
      margin:0;
      padding-left: 18px;
      font-size: 12.5px;
      line-height: 1.6;
    }
    .letter-signature{
      margin-top: 20px;
      padding-top: 14px;
      border-top: 1px solid rgba(0,0,0,0.12);
      display:flex;
      justify-content:space-between;
      gap:16px;
      align-items:flex-end;
    }
    .seal-box{
      width: 170px;
      height: 110px;
      border: 1px dashed rgba(0,0,0,0.35);
      border-radius: 16px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 12px;
      opacity: .85;
      white-space:nowrap;
    }
    body.dark-mode .seal-box{ border-color: rgba(255,255,255,0.35); }
    .sig-lines{
      direction:ltr;
      text-align:right;
      font-size:12.5px;
      line-height:1.6;
      opacity:.95;
    }

.notice-cheque-table-wrap{
      margin-top: 14px;
    }
    .notice-cheque-table-title{
      font-size: 12px;
      font-weight: 700;
      margin: 0 0 6px 0;
      opacity: .9;
    }
    .notice-cheque-table{
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      line-height: 1.4;
    }
    .notice-cheque-table th,
    .notice-cheque-table td{
      border: 1px solid rgba(0,0,0,0.18);
      padding: 6px 8px;
      vertical-align: top;
    }
    .notice-cheque-table th{
      background: #f3f4f6;
      font-weight: 700;
    }

    @media print{
      @page { size: A4; margin: 14mm; }
      body{ background:#fff !important; }
      nav, .no-print{ display:none !important; }
      .view{ display:none !important; }
      #notices-view{ display:block !important; padding:0 !important; }
      #notice-preview{ border:none !important; background:transparent !important; padding:0 !important; min-height:auto !important; }

      /* Draft watermark */
      body.notice-draft-print .letter-paper{
        position: relative !important;
      }
      body.notice-draft-print .letter-paper::before{
        content: "DRAFT / Ù†Ø³Ø®Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©";
        position: absolute;
        top: 42%;
        left: 50%;
        transform: translate(-50%,-50%) rotate(-18deg);
        font-size: 54px;
        font-weight: 800;
        letter-spacing: 2px;
        color: rgba(0,0,0,0.12);
        pointer-events: none;
        white-space: nowrap;
      }
      .letter-paper{
        border:none !important;
        border-radius:0 !important;
        padding:0 !important;
        max-width:none !important;
        margin:0 !important;
      }
      .letter-col{ border:none !important; padding:0 !important; border-radius:0 !important; }
    }

    /* =========================================================
       Modal sizing + auto scroll (no need to drag first)
       ========================================================= */
    [id$="-modal"].fixed.inset-0{
      overflow-y:auto !important;
      align-items:flex-start !important; /* override items-center */
      justify-content:center !important;
      padding:16px !important;
    }
    [id$="-modal"] .modal-content{
      max-height: calc(100vh - 32px) !important;
      overflow:auto !important;
      overscroll-behavior: contain;
    }
    [id$="-modal"] .modal-content.overflow-hidden{
      overflow:auto !important;
    }

  
    /* ===== Receipts History Table - Consistent (keeps sort/search) ===== */
    #receipts-history-table{
      width:100% !important;
      table-layout:fixed !important;
      border-collapse:collapse !important;
    }
    #receipts-history-table th,
    #receipts-history-table td{
      vertical-align:top !important;
      background:transparent !important; /* ÙŠØ³Ù…Ø­ Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„ØµÙ Ø£Ù† ØªØ¸Ù‡Ø± Ø¨Ø´ÙƒÙ„ Ù…ÙˆØ­Ø¯ */
    }
    /* Zebra Ø¹Ù„Ù‰ Ø§Ù„ØµÙÙˆÙ (ÙˆØ§Ù„Ù€ td ØªØ±Ø«Ù‡Ø§ Ø¨Ø³Ø¨Ø¨ background: transparent) */
    #receipts-history-table tbody tr:nth-child(even){
      background:rgba(15,23,42,0.02);
    }
    body.dark-mode #receipts-history-table tbody tr:nth-child(even){
      background:rgba(255,255,255,0.03);
    }
    #receipts-history-table .cell-nowrap{ white-space:nowrap; }
    #receipts-history-table .cell-ltr{ direction:ltr; unicode-bidi:bidi-override; }
    #receipts-history-table .cell-2lines{
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      line-height:1.4;
      word-break:break-word;
    }
    /* ===== /Receipts History Table ===== */


    /* ===== Expenses Table - Consistent Layout ===== */
    #expenses-table{
      width:100% !important;
      table-layout:fixed !important;
      border-collapse:collapse !important;
    }
    #expenses-table th,
    #expenses-table td{
      padding:14px 16px !important;
      vertical-align:top !important;
      border-bottom:1px solid rgba(148,163,184,0.35) !important;
      background:transparent !important;
    }
    #expenses-table thead th{
      background:#f8fafc !important;
      color:#475569 !important;
      font-weight:700 !important;
      font-size:0.95rem !important;
    }
    #expenses-table tbody tr:nth-child(even){
      background:rgba(15,23,42,0.02);
    }
    body.dark-mode #expenses-table thead th{
      background:rgba(255,255,255,0.04) !important;
      color:rgba(226,232,240,0.9) !important;
    }
    body.dark-mode #expenses-table tbody tr:nth-child(even){
      background:rgba(255,255,255,0.03);
    }
    #expenses-table .cell-nowrap{ white-space:nowrap; }
    #expenses-table .cell-ltr{ direction:ltr; unicode-bidi:bidi-override; }
    #expenses-table .cell-2lines{
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      line-height:1.4;
      word-break:break-word;
    }
    /* ===== /Expenses Table ===== */


        
    
    /* ===== Glassmorphism (Robust) - Dashboard Cards ===== */
    /* ÙŠØ¬Ø¹Ù„ Ø§Ù„ØªØ£Ø«ÙŠØ± ÙˆØ§Ø¶Ø­Ø§Ù‹ Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… backdrop-filter */
    #dashboard-view{
      /* Ø®Ù„ÙÙŠØ© Ø®ÙÙŠÙØ© ØªØ³Ø§Ø¹Ø¯ Ø¹Ù„Ù‰ Ø¥Ø¨Ø±Ø§Ø² Ø§Ù„ØªØ£Ø«ÙŠØ± Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠ */
      background-image:
        radial-gradient(800px 300px at 20% 0%, rgba(59,130,246,0.06), transparent 60%),
        radial-gradient(700px 260px at 85% 10%, rgba(16,185,129,0.06), transparent 60%),
        radial-gradient(700px 260px at 60% 90%, rgba(244,63,94,0.05), transparent 60%);
    }

    #dashboard-view .glass-card{
      position: relative;
      overflow: hidden;
      background: rgba(255,255,255,0.38) !important;
      border: 1px solid rgba(255,255,255,0.55) !important;
      box-shadow: 0 14px 32px rgba(0,0,0,0.10) !important;
      transform: translateZ(0); /* ÙŠØ­Ø³Ù† Ø§Ù„Ø±Ù†Ø¯Ø± */
    }

    #dashboard-view .glass-card::before{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background:
        linear-gradient(135deg, rgba(255,255,255,0.55), rgba(255,255,255,0.15)),
        radial-gradient(420px 220px at 20% 15%, rgba(255,255,255,0.55), transparent 60%);
      opacity: 0.55;
      mix-blend-mode: overlay;
    }

    #dashboard-view .glass-card::after{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background: radial-gradient(700px 300px at 50% 0%, rgba(255,255,255,0.35), transparent 55%);
      opacity: 0.40;
    }

    /* ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø¨Ø§Ø¨ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø¯Ø¹ÙˆÙ…Ø© */
    @supports ((-webkit-backdrop-filter: blur(1px)) or (backdrop-filter: blur(1px))){
      #dashboard-view .glass-card{
        backdrop-filter: blur(18px) saturate(180%) !important;
        -webkit-backdrop-filter: blur(18px) saturate(180%) !important;
      }
    }

    body.dark-mode #dashboard-view{
      background-image:
        radial-gradient(800px 300px at 20% 0%, rgba(59,130,246,0.10), transparent 60%),
        radial-gradient(700px 260px at 85% 10%, rgba(16,185,129,0.10), transparent 60%),
        radial-gradient(700px 260px at 60% 90%, rgba(244,63,94,0.08), transparent 60%);
    }

    body.dark-mode #dashboard-view .glass-card{
      background: rgba(17,24,39,0.42) !important;
      border: 1px solid rgba(255,255,255,0.12) !important;
      box-shadow: 0 14px 32px rgba(0,0,0,0.38) !important;
    }
    body.dark-mode #dashboard-view .glass-card::before{
      background:
        linear-gradient(135deg, rgba(255,255,255,0.10), rgba(255,255,255,0.02)),
        radial-gradient(420px 220px at 20% 15%, rgba(255,255,255,0.10), transparent 60%);
      opacity: 0.60;
    }
    body.dark-mode #dashboard-view .glass-card::after{
      opacity: 0.25;
    }
    /* ===== /Glassmorphism (Robust) ===== */


    /* ===== Glassmorphism Utility (Cards) ===== */
    .glass-card{
      position: relative;
      overflow: hidden;
      background: rgba(255,255,255,0.38) !important;
      border: 1px solid rgba(255,255,255,0.55) !important;
      box-shadow: 0 14px 32px rgba(0,0,0,0.10) !important;
      transform: translateZ(0);
    }
    .glass-card::before{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background:
        linear-gradient(135deg, rgba(255,255,255,0.55), rgba(255,255,255,0.15)),
        radial-gradient(420px 220px at 20% 15%, rgba(255,255,255,0.55), transparent 60%);
      opacity: 0.55;
      mix-blend-mode: overlay;
    }
    .glass-card::after{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background: radial-gradient(700px 300px at 50% 0%, rgba(255,255,255,0.35), transparent 55%);
      opacity: 0.40;
    }
    .glass-card > *{
      position: relative;
      z-index: 1;
    }
    @supports ((-webkit-backdrop-filter: blur(1px)) or (backdrop-filter: blur(1px))){
      .glass-card{
        backdrop-filter: blur(18px) saturate(180%) !important;
        -webkit-backdrop-filter: blur(18px) saturate(180%) !important;
      }
    }
    body.dark-mode .glass-card{
      background: rgba(17,24,39,0.42) !important;
      border: 1px solid rgba(255,255,255,0.12) !important;
      box-shadow: 0 14px 32px rgba(0,0,0,0.38) !important;
    }
    body.dark-mode .glass-card::before{
      background:
        linear-gradient(135deg, rgba(255,255,255,0.10), rgba(255,255,255,0.02)),
        radial-gradient(420px 220px at 20% 15%, rgba(255,255,255,0.10), transparent 60%);
      opacity: 0.60;
    }
    body.dark-mode .glass-card::after{ opacity: 0.25; }
    /* ===== /Glassmorphism Utility ===== */


    /* ===== Unified Filter/Reset Buttons ===== */
    .btn-ui{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:10px 14px;
      border-radius:16px;
      font-weight:800;
      font-size:14px;
      line-height:1;
      transition: transform .15s ease, box-shadow .15s ease, background-color .15s ease, border-color .15s ease, color .15s ease;
      border:1px solid rgba(148,163,184,0.35);
      background: rgba(255,255,255,0.55);
      color:#0f172a;
      user-select:none;
    }
    .btn-ui:hover{
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(0,0,0,0.08);
    }
    .btn-ui:active{
      transform: translateY(0px);
      box-shadow: none;
    }

    .btn-filter{
      border-color: rgba(124,58,237,0.35);
      background: rgba(124,58,237,0.12);
      color:#6d28d9;
    }
    .btn-filter:hover{
      background: rgba(124,58,237,0.18);
      border-color: rgba(124,58,237,0.45);
    }

    .btn-reset{
      border-color: rgba(100,116,139,0.35);
      background: rgba(248,250,252,0.70);
      color:#334155;
    }
    .btn-reset:hover{
      background: rgba(241,245,249,0.85);
      border-color: rgba(100,116,139,0.45);
    }

    body.dark-mode .btn-ui{
      border-color: rgba(148,163,184,0.22);
      background: rgba(17,24,39,0.55);
      color: rgba(226,232,240,0.95);
    }
    body.dark-mode .btn-ui:hover{
      box-shadow: 0 10px 22px rgba(0,0,0,0.32);
    }
    body.dark-mode .btn-filter{
      border-color: rgba(167,139,250,0.30);
      background: rgba(124,58,237,0.20);
      color: rgba(237,233,254,0.95);
    }
    body.dark-mode .btn-filter:hover{
      background: rgba(124,58,237,0.26);
      border-color: rgba(167,139,250,0.38);
    }
    body.dark-mode .btn-reset{
      border-color: rgba(148,163,184,0.22);
      background: rgba(15,23,42,0.35);
      color: rgba(226,232,240,0.92);
    }
    body.dark-mode .btn-reset:hover{
      background: rgba(15,23,42,0.48);
    }
    /* ===== /Unified Buttons ===== */


    /* ===== Unified Inputs / Selects (Search + Sort) ===== */
    .ui-field{
      width: 100%;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(255,255,255,0.60);
      padding: 10px 12px;
      font-weight: 700;
      font-size: 14px;
      color: #0f172a;
      outline: none;
      transition: box-shadow .15s ease, border-color .15s ease, background-color .15s ease;
    }
    .ui-field::placeholder{
      color: rgba(100,116,139,0.9);
      font-weight: 600;
    }
    .ui-field:focus{
      border-color: rgba(124,58,237,0.55);
      box-shadow: 0 0 0 4px rgba(124,58,237,0.18);
      background: rgba(255,255,255,0.75);
    }

    .ui-select{
      appearance: none;
      padding-left: 36px; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ø³Ù‡Ù… */
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(100,116,139,0.95) 50%),
        linear-gradient(135deg, rgba(100,116,139,0.95) 50%, transparent 50%);
      background-position:
        14px 50%,
        20px 50%;
      background-size:
        6px 6px,
        6px 6px;
      background-repeat: no-repeat;
    }

    body.dark-mode .ui-field{
      border-color: rgba(148,163,184,0.22);
      background: rgba(17,24,39,0.55);
      color: rgba(226,232,240,0.95);
    }
    body.dark-mode .ui-field::placeholder{
      color: rgba(148,163,184,0.85);
    }
    body.dark-mode .ui-field:focus{
      border-color: rgba(167,139,250,0.55);
      box-shadow: 0 0 0 4px rgba(124,58,237,0.25);
      background: rgba(17,24,39,0.62);
    }
    body.dark-mode .ui-select{
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(148,163,184,0.95) 50%),
        linear-gradient(135deg, rgba(148,163,184,0.95) 50%, transparent 50%);
    }
    /* ===== /Unified Inputs / Selects ===== */


    /* ===== Unified Tables (All Pages) ===== */
    .ui-table{
      width: 100% !important;
      table-layout: fixed !important;
      border-collapse: collapse !important;
    }
    .ui-table th,
    .ui-table td{
      padding: 14px 16px !important;
      vertical-align: top !important;
      border-bottom: 1px solid rgba(148,163,184,0.35) !important;
      background: transparent !important; /* ÙŠØ³Ù…Ø­ Ù„Ù„Ù€ tr Ø¨ØªØ·Ø¨ÙŠÙ‚ zebra */
    }
    .ui-table thead th{
      background: #f8fafc !important;
      color: #475569 !important;
      font-weight: 800 !important;
      font-size: 0.95rem !important;
      white-space: nowrap;
    }
    .ui-table tbody tr:nth-child(even){
      background: rgba(15,23,42,0.02);
    }
    .ui-table tbody tr:hover{
      background: rgba(124,58,237,0.06);
    }

    body.dark-mode .ui-table thead th{
      background: rgba(255,255,255,0.04) !important;
      color: rgba(226,232,240,0.92) !important;
    }
    body.dark-mode .ui-table th,
    body.dark-mode .ui-table td{
      border-bottom-color: rgba(148,163,184,0.18) !important;
    }
    body.dark-mode .ui-table tbody tr:nth-child(even){
      background: rgba(255,255,255,0.03);
    }
    body.dark-mode .ui-table tbody tr:hover{
      background: rgba(167,139,250,0.10);
    }

    /* Ø£Ø±Ù‚Ø§Ù…/ØªÙˆØ§Ø±ÙŠØ® Ø«Ø§Ø¨ØªØ© */
    .ui-td-ltr{
      direction:ltr;
      unicode-bidi:bidi-override;
      white-space: nowrap;
    }
    /* Ù†Øµ Ø·ÙˆÙŠÙ„: Ø³Ø·Ø±ÙŠÙ† */
    .ui-td-2lines{
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      line-height:1.4;
      word-break:break-word;
    }
    /* ===== /Unified Tables ===== */


    /* ===== Unified Modals (Glass + Buttons + Fields) ===== */
    .modal-glass{
      position: relative;
      overflow: hidden;
    }
    /* Ø§Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ ØªØ£Ø«ÙŠØ± Ø§Ù„Ø²Ø¬Ø§Ø¬ ÙˆÙ„ÙƒÙ† Ù…Ø®ØµØµ Ù„Ù„Ù…ÙˆØ¯Ø§Ù„ */
    .modal-glass{
      background: rgba(255,255,255,0.38) !important;
      border: 1px solid rgba(255,255,255,0.55) !important;
      box-shadow: 0 18px 40px rgba(0,0,0,0.16) !important;
      transform: translateZ(0);
    }
    .modal-glass::before{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background:
        linear-gradient(135deg, rgba(255,255,255,0.55), rgba(255,255,255,0.12)),
        radial-gradient(520px 240px at 18% 12%, rgba(255,255,255,0.55), transparent 60%);
      opacity: 0.55;
      mix-blend-mode: overlay;
    }
    .modal-glass::after{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background: radial-gradient(900px 340px at 55% 0%, rgba(255,255,255,0.35), transparent 55%);
      opacity: 0.38;
    }
    .modal-glass > *{
      position: relative;
      z-index: 1;
    }
    @supports ((-webkit-backdrop-filter: blur(1px)) or (backdrop-filter: blur(1px))){
      .modal-glass{
        backdrop-filter: blur(18px) saturate(180%) !important;
        -webkit-backdrop-filter: blur(18px) saturate(180%) !important;
      }
    }
    body.dark-mode .modal-glass{
      background: rgba(17,24,39,0.42) !important;
      border: 1px solid rgba(255,255,255,0.12) !important;
      box-shadow: 0 18px 40px rgba(0,0,0,0.42) !important;
    }
    body.dark-mode .modal-glass::before{
      background:
        linear-gradient(135deg, rgba(255,255,255,0.10), rgba(255,255,255,0.02)),
        radial-gradient(520px 240px at 18% 12%, rgba(255,255,255,0.10), transparent 60%);
      opacity: 0.62;
    }
    body.dark-mode .modal-glass::after{ opacity: 0.22; }

    /* Header/Footer Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
    .modal-header-glass{
      background: rgba(255,255,255,0.22) !important;
      border-bottom: 1px solid rgba(255,255,255,0.28) !important;
    }
    body.dark-mode .modal-header-glass{
      background: rgba(255,255,255,0.06) !important;
      border-bottom-color: rgba(255,255,255,0.10) !important;
    }

    /* Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¨Ù†ÙØ³ Ù†Ø¸Ø§Ù… ui-field */
    .modal-content input:not([type="checkbox"]):not([type="radio"]):not([type="file"]),
    .modal-content select,
    .modal-content textarea{
      width: 100%;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(255,255,255,0.60);
      padding: 10px 12px;
      font-weight: 700;
      font-size: 14px;
      color: #0f172a;
      outline: none;
      transition: box-shadow .15s ease, border-color .15s ease, background-color .15s ease;
    }
    .modal-content input::placeholder,
    .modal-content textarea::placeholder{
      color: rgba(100,116,139,0.9);
      font-weight: 600;
    }
    .modal-content input:focus,
    .modal-content select:focus,
    .modal-content textarea:focus{
      border-color: rgba(124,58,237,0.55);
      box-shadow: 0 0 0 4px rgba(124,58,237,0.18);
      background: rgba(255,255,255,0.75);
    }
    body.dark-mode .modal-content input:not([type="checkbox"]):not([type="radio"]):not([type="file"]),
    body.dark-mode .modal-content select,
    body.dark-mode .modal-content textarea{
      border-color: rgba(148,163,184,0.22);
      background: rgba(17,24,39,0.55);
      color: rgba(226,232,240,0.95);
    }
    body.dark-mode .modal-content input::placeholder,
    body.dark-mode .modal-content textarea::placeholder{
      color: rgba(148,163,184,0.85);
    }
    body.dark-mode .modal-content input:focus,
    body.dark-mode .modal-content select:focus,
    body.dark-mode .modal-content textarea:focus{
      border-color: rgba(167,139,250,0.55);
      box-shadow: 0 0 0 4px rgba(124,58,237,0.25);
      background: rgba(17,24,39,0.62);
    }

    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
    .btn-success{
      border-color: rgba(16,185,129,0.35);
      background: rgba(16,185,129,0.14);
      color:#047857;
    }
    .btn-success:hover{
      background: rgba(16,185,129,0.18);
      border-color: rgba(16,185,129,0.45);
    }
    body.dark-mode .btn-success{
      border-color: rgba(110,231,183,0.22);
      background: rgba(16,185,129,0.18);
      color: rgba(209,250,229,0.95);
    }
    body.dark-mode .btn-success:hover{
      background: rgba(16,185,129,0.24);
      border-color: rgba(110,231,183,0.28);
    }

    .btn-danger{
      border-color: rgba(244,63,94,0.35);
      background: rgba(244,63,94,0.14);
      color:#be123c;
    }
    .btn-danger:hover{
      background: rgba(244,63,94,0.18);
      border-color: rgba(244,63,94,0.45);
    }
    body.dark-mode .btn-danger{
      border-color: rgba(253,164,175,0.20);
      background: rgba(244,63,94,0.16);
      color: rgba(255,228,230,0.95);
    }
    body.dark-mode .btn-danger:hover{
      background: rgba(244,63,94,0.22);
      border-color: rgba(253,164,175,0.26);
    }
    /* ===== /Unified Modals ===== */


/* Half-year contracts detail table: consistent layout */
.hy-contracts-table th{ white-space:normal; line-height:1.15; }
.hy-contracts-table td{ vertical-align:middle; }
.hy-contracts-table .cell-nowrap{ white-space:nowrap; }
.hy-contracts-table .cell-amount{ white-space:nowrap; }
.hy-contracts-table .cell-tenant{ min-width:0; }
.hy-contracts-table .cell-arrears{
  display:flex;
  flex-direction:row-reverse; /* RTL-friendly */
  align-items:center;
  justify-content:flex-start;
  gap:.5rem;
}


/* Print tuning for half-year A4 summary */
@media print{
  #reports-view .no-print, #reports-view .no-print * { display:none !important; }
  #hy-a4-summary{ break-inside: avoid; page-break-inside: avoid; }
  #hy-report-section{ page-break-before: auto; }
  .glass-card{ box-shadow:none !important; }
  body{ background:#fff !important; }
}


/* A4 multi-page print layout */
@page{
  size: A4;
  margin: 14mm 12mm 16mm 12mm;
}
@media print{
  /* Force visibility for print */
  #reports-view, #reports-view.hidden{ display:block !important; }
  #printable-area{ display:block !important; }

  /* Fixed header/footer */
  .print-header{
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    padding: 8mm 0 0 0;
  }
  .print-footer{
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 0 0 6mm 0;
  }

  /* Reserve space so content doesn't overlap header/footer */
  #printable-area{
    padding-top: 26mm !important;
    padding-bottom: 18mm !important;
  }

  /* Repeat table headers and avoid ugly splits */
  thead{ display: table-header-group; }
  tfoot{ display: table-footer-group; }
  tr, td, th{ page-break-inside: avoid; }
  .glass-card{ break-inside: avoid; page-break-inside: avoid; }

  /* Page numbering */
  body{ counter-reset: page; }
  .page-counter::before{
    content: "ØµÙØ­Ø© " counter(page);
  }
  .page-counter::after{
    content: " Ù…Ù† " counter(pages);
  }
}

</style>
</head>
<body class="p-4 md:p-6 max-w-[1600px] mx-auto transition-colors duration-300">

  <nav>
    <button id="nav-dashboard" class="nav-btn active" onclick="showView('dashboard')">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <button id="nav-properties" class="nav-btn" onclick="showView('properties')">ğŸ¢ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª</button>
    <button id="nav-leases" class="nav-btn" onclick="showView('leases')">ğŸ“‘ Ø§Ù„Ø¹Ù‚ÙˆØ¯</button>
    <button id="nav-tenants" class="nav-btn" onclick="showView('tenants')">ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ†</button>
    <button id="nav-cheques" class="nav-btn" onclick="showView('cheques')">ğŸ’³ Ø§Ù„Ø´ÙŠÙƒØ§Øª</button>
    <button id="nav-payments" class="nav-btn" onclick="showView('payments')">ğŸ’° Ø§Ù„Ø¯ÙØ¹Ø§Øª</button>
    <button id="nav-expenses" class="nav-btn" onclick="showView('expenses')">ğŸ’¸ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</button>
    <button id="nav-salaries" class="nav-btn" onclick="showView('salaries')">ğŸ‘¨â€ğŸ”§ Ø§Ù„Ø±ÙˆØ§ØªØ¨</button>
    <button id="nav-receipts-history" class="nav-btn" onclick="showView('receipts-history')">ğŸ§¾ Ø§Ù„Ø³Ù†Ø¯Ø§Øª</button>
    <button id="nav-reports" class="nav-btn" onclick="showView('reports')">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
    <button id="nav-notices" class="nav-btn" onclick="showView('notices')">ğŸ”” Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</button>
    <button id="nav-settings" class="nav-btn" onclick="showView('settings')">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    <button class="nav-btn mr-auto" onclick="toggleDarkMode()">ğŸŒ™/â˜€ï¸</button>
  </nav>

  <!-- ============= DASHBOARD ============= -->
  <section id="dashboard-view" class="view">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</h2>
      <span class="text-sm text-gray-500 dark:text-gray-400" id="current-date-display"></span>
    </div>

    
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
      <div class="glass-card p-5 rounded-2xl border-r-4 border-emerald-500">
        <p id="total-rent-label" class="text-gray-500 dark:text-gray-400 text-sm font-semibold mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø³Ù†ÙˆÙŠ</p>
        <p id="total-annual-rent" class="text-2xl md:text-3xl font-extrabold text-gray-800 dark:text-white">0 AED</p>
        <p class="mt-2 text-xs text-gray-400 dark:text-gray-500">ØªÙ‚Ø¯ÙŠØ±ÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</p>
      </div>


      
      <div class="glass-card p-5 rounded-2xl border-r-4 border-emerald-700">
        <p class="text-gray-500 dark:text-gray-400 text-sm font-semibold mb-1">Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</p>
        <p id="month-revenue-total" class="text-2xl md:text-3xl font-extrabold text-gray-800 dark:text-white">0 AED</p>
        <p class="mt-2 text-xs text-gray-400 dark:text-gray-500">Ø¹Ø¯Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù‚Ø¨Ø¶: <span id="month-revenue-count" class="font-mono">0</span></p>
      </div>

<div class="glass-card p-5 rounded-2xl border-r-4 border-slate-600">
        <p class="text-gray-500 dark:text-gray-400 text-sm font-semibold mb-1">Ù…ØµØ§Ø±ÙŠÙ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</p>
        <p id="month-expenses-total" class="text-2xl md:text-3xl font-extrabold text-gray-800 dark:text-white">0 AED</p>
        <p class="mt-2 text-xs text-gray-400 dark:text-gray-500">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª: <span id="month-expenses-count" class="font-mono">0</span></p>
      </div>

      <div class="glass-card p-5 rounded-2xl border-r-4 border-cyan-600">
        <p class="text-gray-500 dark:text-gray-400 text-sm font-semibold mb-1">Ø§Ù„Ø´ÙŠÙƒØ§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ø®Ù„Ø§Ù„ 30 ÙŠÙˆÙ…</p>
        <p id="upcoming-cheques-total" class="text-2xl md:text-3xl font-extrabold text-gray-800 dark:text-white">0 AED</p>
        <p class="mt-2 text-xs text-gray-400 dark:text-gray-500">Ø¹Ø¯Ø¯ Ø§Ù„Ø´ÙŠÙƒØ§Øª: <span id="upcoming-cheques-count" class="font-mono">0</span></p>
      </div>


      <div class="glass-card p-5 rounded-2xl border-r-4 border-amber-600">
        <p class="text-gray-500 dark:text-gray-400 text-sm font-semibold mb-1">Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©</p>
        <p id="overdue-payments-total" class="text-2xl md:text-3xl font-extrabold text-gray-800 dark:text-white">0 AED</p>
        <p class="mt-2 text-xs text-gray-400 dark:text-gray-500">Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„Ø§Øª: <span id="overdue-payments-count" class="font-mono">0</span></p>
      </div>




      <div class="glass-card p-5 rounded-2xl border-r-4 border-violet-600">
        <p class="text-gray-500 dark:text-gray-400 text-sm font-semibold mb-1">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ø´ØºØ§Ù„</p>
        <p id="occupancy-rate" class="text-2xl md:text-3xl font-extrabold text-gray-800 dark:text-white">0%</p>
        <div class="mt-3 h-2 rounded-full bg-gray-200/70 dark:bg-gray-700/60 overflow-hidden">
          <div id="occupancy-bar" class="h-2 rounded-full bg-violet-600" style="width:0%"></div>
        </div>
      </div>

      <div class="glass-card p-5 rounded-2xl border-r-4 border-slate-500">
        <p class="text-gray-500 dark:text-gray-400 text-sm font-semibold mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ­Ø¯Ø§Øª</p>
        <p id="total-units-count" class="text-2xl md:text-3xl font-extrabold text-gray-800 dark:text-white">0</p>
        <p class="mt-2 text-xs text-gray-400 dark:text-gray-500">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</p>
      </div>

      <div class="glass-card p-5 rounded-2xl border-r-4 border-rose-500">
        <p class="text-gray-500 dark:text-gray-400 text-sm font-semibold mb-1">Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø´Ø§ØºØ±Ø©</p>
        <p id="empty-units-count" class="text-2xl md:text-3xl font-extrabold text-gray-800 dark:text-white">0</p>
        <p class="mt-2 text-xs text-gray-400 dark:text-gray-500">Ù…ØªØ§Ø­Ø© Ù„Ù„ØªØ£Ø¬ÙŠØ±</p>
      </div>

      <div class="glass-card p-5 rounded-2xl border-r-4 border-blue-500">
        <p class="text-gray-500 dark:text-gray-400 text-sm font-semibold mb-1">Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„ÙØ¹Ø§Ù„Ø©</p>
        <p id="active-leases-count" class="text-2xl md:text-3xl font-extrabold text-gray-800 dark:text-white">0</p>
        <p class="mt-2 text-xs text-gray-400 dark:text-gray-500">Ø¹Ù‚ÙˆØ¯ Ø³Ø§Ø±ÙŠØ© (Ù…Ø¤Ø¬Ø±Ø©)</p>
      </div>

      <div class="glass-card p-5 rounded-2xl border-r-4 border-orange-500">
        <p class="text-gray-500 dark:text-gray-400 text-sm font-semibold mb-1">Ø¹Ù‚ÙˆØ¯ Ø´Ø§Ø±ÙØª Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ (30 ÙŠÙˆÙ…)</p>
        <p id="expiring-leases-count" class="text-2xl md:text-3xl font-extrabold text-gray-800 dark:text-white">0</p>
        <p class="mt-2 text-xs text-gray-400 dark:text-gray-500">ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø­Ø³Ø¨ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®</p>
      </div>

      <div class="glass-card p-5 rounded-2xl border-r-4 border-red-700">
        <p class="text-gray-500 dark:text-gray-400 text-sm font-semibold mb-1">Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©</p>
        <p id="ended-leases-count" class="text-2xl md:text-3xl font-extrabold text-gray-800 dark:text-white">0</p>
        <p class="mt-2 text-xs text-gray-400 dark:text-gray-500">ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø­Ø³Ø¨ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®</p>
      </div>

      <div class="glass-card p-5 rounded-2xl border-r-4 border-amber-500">
        <p class="text-gray-500 dark:text-gray-400 text-sm font-semibold mb-1">Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† Ø§Ù„Ù…ØªØ£Ø®Ø±ÙŠÙ†</p>
        <p id="late-tenants-count" class="text-2xl md:text-3xl font-extrabold text-gray-800 dark:text-white">0</p>
        <p class="mt-2 text-xs text-gray-400 dark:text-gray-500">Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙØ¹Ø§Øª/Ø§Ù„Ø´ÙŠÙƒØ§Øª</p>
      </div>
    </div>


    <div class="grid grid-cols-1 md:grid-cols-1 gap-6 mb-8">
      <div class="glass-card p-6 rounded-2xl">
        <h3 class="font-bold mb-4 text-gray-700 dark:text-gray-200">ØªÙˆØ²ÙŠØ¹ Ø­Ø§Ù„Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø§Øª</h3>
        <div class="h-64"><canvas id="leasesChart"></canvas></div>
      </div>
      <div class="glass-card p-6 rounded-2xl">
        <h3 class="font-bold mb-4 text-gray-700 dark:text-gray-200">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø§Ù„ÙŠ</h3>
        <div class="h-64"><canvas id="financeChart"></canvas></div>
      </div>
    </div>

    <div class="glass-card p-6 rounded-2xl">
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-gray-700 dark:text-gray-200">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø£Ø®ÙŠØ±</h3>
        <button onclick="clearLogs()" class="text-xs text-rose-600 hover:underline">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
      </div>
      <ul id="contractLogs" class="space-y-2 text-sm text-gray-600 dark:text-gray-400 max-h-48 overflow-y-auto pr-2"></ul>
    </div>
  </section>

  <!-- ============= PROPERTIES ============= -->
  <section id="properties-view" class="view hidden">
    <div class="flex flex-wrap items-center justify-between mb-6 gap-4">
      <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙˆØ§Ù„ÙˆØ­Ø¯Ø§Øª</h2>

      <div class="flex flex-wrap gap-2 items-center">
        <div class="flex bg-white rounded-lg shadow border border-gray-100 dark:border-gray-700 p-0.5 ml-2">
          <button onclick="expandAllProperties()" class="px-3 py-1.5 text-xs font-bold text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" title="ØªÙˆØ³ÙŠØ¹ Ø§Ù„ÙƒÙ„">
            ğŸ”½ ØªÙˆØ³ÙŠØ¹
          </button>
          <div class="w-px bg-gray-200 dark:bg-gray-700 my-1"></div>
          <button onclick="collapseAllProperties()" class="px-3 py-1.5 text-xs font-bold text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" title="Ø·ÙŠ Ø§Ù„ÙƒÙ„">
            â—€ï¸ Ø·ÙŠ
          </button>
        </div>

        <div class="relative">
          <input type="text" id="prop-search" placeholder="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹..." class="pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 w-56 text-sm" oninput="renderProperties()">
          <span class="absolute left-3 top-2.5 text-gray-400 text-sm">ğŸ”</span>
        </div>
        <button id="prop-filters-toggle" onclick="togglePropertiesUnitFilters()"
          class="btn-ui btn-filter">
          ğŸ§° ÙÙ„Ø§ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø§Øª
        </button>


        <div class="flex flex-wrap items-center gap-2 bg-white dark:bg-dark-surface border border-gray-100 dark:border-gray-700 rounded-lg p-1">
          <span class="text-[11px] text-gray-500 dark:text-gray-400 px-2">ÙØ±Ø²</span>

          <select id="prop-sort-by" onchange="onPropSortChanged()" class="text-xs px-2 py-1 rounded border border-gray-200 dark:border-gray-700 bg-white dark:bg-dark-bg text-gray-700 dark:text-gray-200">
            <option value="name">Ø§Ù„Ø¹Ù‚Ø§Ø±: Ø§Ù„Ø§Ø³Ù…</option>
            <option value="units">Ø§Ù„Ø¹Ù‚Ø§Ø±: Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª</option>
            <option value="location">Ø§Ù„Ø¹Ù‚Ø§Ø±: Ø§Ù„Ù…ÙˆÙ‚Ø¹</option>
            <option value="id">Ø§Ù„Ø¹Ù‚Ø§Ø±: Ø§Ù„Ù…Ø¹Ø±Ù</option>
          </select>
          <button id="prop-sort-dir" data-dir="asc" onclick="togglePropSortDir()" class="px-2 py-1 text-xs rounded border border-gray-200 dark:border-gray-700 bg-white dark:bg-dark-bg hover:bg-gray-50 dark:hover:bg-gray-800" title="Ø¹ÙƒØ³ ØªØ±ØªÙŠØ¨ ÙØ±Ø² Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª">â¬†ï¸</button>

          <div class="w-px bg-gray-200 dark:bg-gray-700 h-6 mx-1"></div>

          <select id="unit-sort-by" onchange="onUnitSortChanged()" class="text-xs px-2 py-1 rounded border border-gray-200 dark:border-gray-700 bg-white dark:bg-dark-bg text-gray-700 dark:text-gray-200">
            <option value="unitName">Ø§Ù„ÙˆØ­Ø¯Ø§Øª: Ø§Ø³Ù… Ø§Ù„ÙˆØ­Ø¯Ø©</option>
            <option value="unitId">Ø§Ù„ÙˆØ­Ø¯Ø§Øª: Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© (UNT)</option>
            <option value="status">Ø§Ù„ÙˆØ­Ø¯Ø§Øª: Ø§Ù„Ø­Ø§Ù„Ø©</option>
            <option value="tenant">Ø§Ù„ÙˆØ­Ø¯Ø§Øª: Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</option>
            <option value="rent">Ø§Ù„ÙˆØ­Ø¯Ø§Øª: Ø§Ù„Ù‚ÙŠÙ…Ø©</option>
          </select>
          <button id="unit-sort-dir" data-dir="asc" onclick="toggleUnitSortDir()" class="px-2 py-1 text-xs rounded border border-gray-200 dark:border-gray-700 bg-white dark:bg-dark-bg hover:bg-gray-50 dark:hover:bg-gray-800" title="Ø¹ÙƒØ³ ØªØ±ØªÙŠØ¨ ÙØ±Ø² Ø§Ù„ÙˆØ­Ø¯Ø§Øª">â¬†ï¸</button>
        </div>

        <button onclick="openPropertyModal()" class="btn-ui btn-success">
          <span>+</span> Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø§Ø±
        </button>
      </div>
    </div>
    
    <div id="prop-filters-panel" class="hidden mb-4 bg-white dark:bg-dark-surface border border-gray-100 dark:border-gray-700 rounded-2xl p-4">
      <div class="flex flex-wrap items-end gap-4">
        <div>
          <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ­Ø¯Ø©</label>
          <select id="unit-status-filter"
            class="p-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-dark-bg text-gray-700 dark:text-gray-200 text-sm min-w-[150px]">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            <option value="Ø´Ø§ØºØ±Ø©">Ø´Ø§ØºØ±Ø©</option>
            <option value="Ù…Ø¤Ø¬Ø±Ø©">Ù…Ø¤Ø¬Ø±Ø©</option>
            </select>
        </div>

        <div>
          <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯ (Ù…Ù†)</label>
          <input id="unit-end-from" type="date"
            class="p-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-dark-bg text-gray-700 dark:text-gray-200 text-sm" />
        </div>

        <div>
          <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯ (Ø¥Ù„Ù‰)</label>
          <input id="unit-end-to" type="date"
            class="p-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-dark-bg text-gray-700 dark:text-gray-200 text-sm" />
        </div>

        <button id="prop-filters-reset" onclick="resetPropertiesUnitFilters()"
          class="btn-ui btn-reset">
          Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·
        </button>

        <div id="prop-filters-hint" class="text-xs text-gray-500 dark:text-gray-400"></div>
      </div>
    </div>

    
    <!-- Quick Stats (Units) -->
    <div id="prop-units-stats" class="mb-4 grid grid-cols-2 md:grid-cols-3 gap-3">
      <div class="bg-white dark:bg-dark-surface border border-gray-100 dark:border-gray-700 rounded-2xl p-4 shadow-sm">
        <div class="flex items-center justify-between">
          <div class="text-xs text-gray-500 dark:text-gray-400">Ø´Ø§ØºØ±Ø©</div>
          <span class="h-2.5 w-2.5 rounded-full bg-amber-500"></span>
        </div>
        <div id="stat-vacant" class="mt-2 text-2xl font-extrabold text-gray-800 dark:text-white">0</div>
      </div>

      <div class="bg-white dark:bg-dark-surface border border-gray-100 dark:border-gray-700 rounded-2xl p-4 shadow-sm">
        <div class="flex items-center justify-between">
          <div class="text-xs text-gray-500 dark:text-gray-400">Ù…Ø¤Ø¬Ø±Ø©</div>
          <span class="h-2.5 w-2.5 rounded-full bg-emerald-500"></span>
        </div>
        <div id="stat-rented" class="mt-2 text-2xl font-extrabold text-gray-800 dark:text-white">0</div>
      </div>
<div class="bg-white dark:bg-dark-surface border border-gray-100 dark:border-gray-700 rounded-2xl p-4 shadow-sm">
        <div class="flex items-center justify-between">
          <div class="text-xs text-gray-500 dark:text-gray-400">Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©</div>
          <span class="text-[10px] text-gray-400 dark:text-gray-500 font-mono"><span id="stat-shown">0</span>/<span id="stat-total">0</span></span>
        </div>
        <div class="mt-2 text-2xl font-extrabold text-gray-800 dark:text-white"><span id="stat-shown-big">0</span></div>
      </div>
    </div>

    <div id="properties-container" class="space-y-6"></div>
  </section>

  <!-- ============= LEASES ============= -->
  <section id="leases-view" class="view hidden">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¯</h2>
      <button onclick="openAddLeaseModal()" class="btn-ui btn-success">Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯</button>
    </div>
    <div id="leases-advanced-bar" class="bg-white p-4 rounded-xl mb-4 shadow-sm">
      <div class="flex flex-col md:flex-row gap-3 items-stretch md:items-end md:justify-between">
        <div class="flex-1">
          <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ø¨Ø­Ø«</label>
          <div class="relative">
            <input id="lease-search-input" placeholder="Ø¨Ø­Ø«: Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ØŒ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ØŒ Ø§Ù„ÙˆØ­Ø¯Ø©ØŒ Ø§Ù„Ø¹Ù‚Ø§Ø±..." class="w-full border p-2 pr-10 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none" oninput="onLeaseAdvancedChanged()">
            <span class="absolute right-3 top-2.5 text-gray-400 text-sm">ğŸ”</span>
          </div>
        </div>

        <div class="w-full md:w-80">
          <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">ÙØ±Ø²</label>
          <div class="flex items-center gap-2">
            <select id="leases-sort-by" onchange="onLeaseAdvancedChanged()" class="ui-field ui-select">
              <option value="end">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</option>
              <option value="start">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</option>
              <option value="rent">Ø§Ù„Ù‚ÙŠÙ…Ø©</option>
              <option value="tenant">Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</option>
              <option value="unit">Ø§Ù„ÙˆØ­Ø¯Ø©</option>
              <option value="property">Ø§Ù„Ø¹Ù‚Ø§Ø±</option>
              <option value="contractNo">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯</option>
              <option value="status">Ø§Ù„Ø­Ø§Ù„Ø©</option>
            </select>
            <button id="leases-sort-dir" data-dir="asc" onclick="toggleLeaseSortDir()" class="px-3 py-2 text-sm rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-dark-bg hover:bg-gray-50 dark:hover:bg-gray-800" title="Ø¹ÙƒØ³ ØªØ±ØªÙŠØ¨ Ø§Ù„ÙØ±Ø²">â¬†ï¸</button>
          </div>
        </div>
      </div>

      <div class="mt-3 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
        <button id="leases-toggle-filters" type="button" onclick="toggleLeaseFilters()" class="btn-ui btn-filter">
          Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
        </button>

        <div class="text-xs text-gray-500 dark:text-gray-400">
          <span id="leases-filter-hint"></span>
        </div>
      </div>

      <div id="leases-filters-panel" class="hidden mt-3 p-3 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/40">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
          <div>
            <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ø§Ù„Ø­Ø§Ù„Ø©</label>
            <select id="leases-filter-status" onchange="onLeaseAdvancedChanged()" class="w-full text-sm px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-dark-bg text-gray-700 dark:text-gray-200">
              <option value="">Ø§Ù„ÙƒÙ„</option>
              <option value="Ø³Ø§Ø±ÙŠ">Ø³Ø§Ø±ÙŠ</option>
              <option value="Ø´Ø§Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡">Ø´Ø§Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ (30 ÙŠÙˆÙ…)</option>
              <option value="Ù…Ù†ØªÙ‡ÙŠ">Ù…Ù†ØªÙ‡ÙŠ</option>

            </select>
          </div>

          <div>
            <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ø§Ù„Ø¹Ù‚Ø§Ø± (Ø§Ø³Ù…)</label>
            <input id="leases-filter-prop" class="w-full border p-2 rounded-lg text-sm" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ù†Ø§ÙŠØ©..." oninput="onLeaseAdvancedChanged()">
          </div>

          <div>
            <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ø§Ù„ÙˆØ­Ø¯Ø© (Ø§Ø³Ù…/UNT)</label>
            <input id="leases-filter-unit" class="w-full border p-2 rounded-lg text-sm" placeholder="Ù…Ø«Ø§Ù„: 10-A Ø£Ùˆ UNT..." oninput="onLeaseAdvancedChanged()">
          </div>

          <div>
            <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</label>
            <input id="leases-filter-tenant" class="w-full border p-2 rounded-lg text-sm" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±..." oninput="onLeaseAdvancedChanged()">
          </div>

          <div>
            <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯</label>
            <input id="leases-filter-contract" class="w-full border p-2 rounded-lg text-sm font-mono" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯..." oninput="onLeaseAdvancedChanged()">
          </div>

          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ù‚ÙŠÙ…Ø© Ù…Ù†</label>
              <input id="leases-filter-rent-min" type="number" class="w-full border p-2 rounded-lg text-sm" placeholder="0" oninput="onLeaseAdvancedChanged()">
            </div>
            <div>
              <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ø¥Ù„Ù‰</label>
              <input id="leases-filter-rent-max" type="number" class="w-full border p-2 rounded-lg text-sm" placeholder="999999" oninput="onLeaseAdvancedChanged()">
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ø¨Ø¯Ø§ÙŠØ© Ù…Ù†</label>
              <input id="leases-filter-start-from" type="date" class="w-full border p-2 rounded-lg text-sm" onchange="onLeaseAdvancedChanged()">
            </div>
            <div>
              <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ø¥Ù„Ù‰</label>
              <input id="leases-filter-start-to" type="date" class="w-full border p-2 rounded-lg text-sm" onchange="onLeaseAdvancedChanged()">
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù†</label>
              <input id="leases-filter-end-from" type="date" class="w-full border p-2 rounded-lg text-sm" onchange="onLeaseAdvancedChanged()">
            </div>
            <div>
              <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ø¥Ù„Ù‰</label>
              <input id="leases-filter-end-to" type="date" class="w-full border p-2 rounded-lg text-sm" onchange="onLeaseAdvancedChanged()">
            </div>
          </div>
        </div>

        <div class="flex flex-wrap gap-2 mt-3">
          <button type="button" onclick="resetLeaseAdvanced()" class="btn-ui btn-reset">
            Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·
          </button>
        </div>
      </div>
    </div>
    <div class="table-wrap bg-white shadow-sm">
      <table class="ui-table min-w-full table-fixed text-right">
        <thead>
          <tr>
            <th class="w-1/6">Ø§Ù„Ø¹Ù‚Ø§Ø± / Ø§Ù„ÙˆØ­Ø¯Ø©</th>
            <th class="w-1/6">Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</th>
            <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
            <th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯</th>
            <th>Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th>
            <th>Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="leases-table-body"></tbody>
      </table>
    </div>
  </section>

  <!-- ============= TENANTS ============= -->
  <section id="tenants-view" class="view hidden">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ†</h2>
    </div>
    <div class="bg-white p-4 rounded-xl mb-4 shadow-sm">
      <div class="flex flex-col md:flex-row gap-3 items-stretch md:items-center">
      <input id="tenants-search" class="ui-field" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ£Ø¬Ø± Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙ Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯..." oninput="renderTenants()">
      <div class="flex items-center gap-2">
        <select id="tenants-sort-by" onchange="onTenantSortChanged()" class="ui-field ui-select">
          <option value="name">ÙØ±Ø²: Ø§Ù„Ø§Ø³Ù…</option>
          <option value="balance">ÙØ±Ø²: Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</option>
          <option value="rent">ÙØ±Ø²: Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø³Ù†ÙˆÙŠ</option>
          <option value="unitsCount">ÙØ±Ø²: Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª</option>
          <option value="idLabel">ÙØ±Ø²: Ø§Ù„Ù‡ÙˆÙŠØ©/Ø§Ù„Ø±Ø®ØµØ©</option>
        </select>
        <button id="tenants-sort-dir" data-dir="asc" onclick="toggleTenantSortDir()" class="px-3 py-2 text-xs rounded border border-gray-200 dark:border-gray-700 bg-white dark:bg-dark-bg hover:bg-gray-50 dark:hover:bg-gray-800" title="Ø¹ÙƒØ³ ØªØ±ØªÙŠØ¨ ÙØ±Ø² Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ†">â¬†ï¸</button>
      </div>
    </div>
    </div>
    <div class="table-wrap bg-white shadow-sm">
      <table class="ui-table min-w-full text-right">
        <thead>
          <tr>
            <th>Ø§Ù„Ø§Ø³Ù…</th>
            <th>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</th>
            <th>Ø§Ù„Ù‡ÙˆÙŠØ© / Ø§Ù„Ø±Ø®ØµØ©</th>
            <th>Ø§Ù„ÙˆØ­Ø¯Ø§Øª</th>
            <th>Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø³Ù†ÙˆÙŠ</th>
            <th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
            <th>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="tenants-table-body"></tbody>
      </table>
    </div>
  </section>

  <!-- ============= CHEQUES ============= -->
  <section id="cheques-view" class="view hidden">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´ÙŠÙƒØ§Øª</h2>
      <button onclick="openChequeModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow">Ø¥Ø¶Ø§ÙØ© Ø´ÙŠÙƒ Ø¬Ø¯ÙŠØ¯</button>
    </div>
    
    <!-- Advanced Search & Sort: Cheques -->
    <div id="cheques-advanced-bar" class="glass-card bg-transparent bg-white p-4 rounded-xl mb-4 shadow-sm">
      <div class="flex flex-col md:flex-row gap-3 items-stretch md:items-end md:justify-between">
        <div class="flex-1">
          <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ø¨Ø­Ø«</label>
          <div class="relative">
            <input id="cheques-search-input" placeholder="Ø¨Ø­Ø«: Ù…Ø³ØªØ£Ø¬Ø±ØŒ ÙˆØ­Ø¯Ø©ØŒ Ø¨Ù†ÙƒØŒ Ø±Ù‚Ù… Ø´ÙŠÙƒØŒ Ø­Ø§Ù„Ø©..." class="w-full border p-2 rounded-lg text-sm dark:bg-dark-bg dark:border-gray-700 bg-white dark:text-gray-200 outline-none focus:ring-2 focus:ring-blue-500" oninput="onChequesAdvancedChanged()">
            <span class="absolute right-3 top-2.5 text-gray-400 text-sm">ğŸ”</span>
          </div>
        </div>

        <div class="w-full md:w-80">
          <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">ÙØ±Ø²</label>
          <div class="flex items-center gap-2">
            <select id="cheques-sort-by" onchange="onChequesAdvancedChanged()" class="ui-field ui-select">
              <option value="due">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</option>
              <option value="amount">Ø§Ù„Ù‚ÙŠÙ…Ø©</option>
              <option value="tenant">Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</option>
              <option value="unit">Ø§Ù„ÙˆØ­Ø¯Ø©</option>
              <option value="bank">Ø§Ù„Ø¨Ù†Ùƒ</option>
              <option value="chequeNo">Ø±Ù‚Ù… Ø§Ù„Ø´ÙŠÙƒ</option>
              <option value="status">Ø§Ù„Ø­Ø§Ù„Ø©</option>
            </select>
            <button id="cheques-sort-dir" data-dir="desc" onclick="toggleChequesSortDir()" class="w-12 border p-2 rounded-lg text-sm dark:bg-dark-bg dark:border-gray-700 bg-white dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-800" title="Ø¹ÙƒØ³ ØªØ±ØªÙŠØ¨ ÙØ±Ø² Ø§Ù„Ø´ÙŠÙƒØ§Øª">â¬‡ï¸</button>
          </div>
        </div>
      </div>

      <div class="mt-3 flex items-center justify-between">
        <button id="cheques-toggle-filters" onclick="toggleChequesFiltersPanel()" class="btn-ui btn-filter">Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</button>
        <div id="cheques-filter-hint" class="text-xs text-gray-500 dark:text-gray-400"></div>
      </div>

      <div id="cheques-filters-panel" class="hidden mt-3 p-3 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/40">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
          <div>
            <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ø§Ù„Ø­Ø§Ù„Ø©</label>
            <select id="cheques-filter-status" onchange="onChequesAdvancedChanged()" class="w-full border p-2 rounded-lg text-sm dark:bg-dark-bg dark:border-gray-700 bg-white dark:text-gray-200">
              <option value="">Ø§Ù„ÙƒÙ„</option>
              <option value="Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØµØ±Ù">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØµØ±Ù</option>
              <option value="Ù…ØµØ±ÙˆÙ">Ù…ØµØ±ÙˆÙ</option>
              <option value="Ø±Ø§Ø¬Ø¹">Ø±Ø§Ø¬Ø¹</option>
            </select>
          </div>

          <div>
            <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</label>
            <input id="cheques-filter-tenant" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±" class="w-full border p-2 rounded-lg text-sm dark:bg-dark-bg dark:border-gray-700 bg-white dark:text-gray-200" oninput="onChequesAdvancedChanged()">
          </div>

          <div>
            <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ø§Ù„ÙˆØ­Ø¯Ø©</label>
            <input id="cheques-filter-unit" placeholder="Ø§Ø³Ù…/Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©" class="w-full border p-2 rounded-lg text-sm dark:bg-dark-bg dark:border-gray-700 bg-white dark:text-gray-200" oninput="onChequesAdvancedChanged()">
          </div>

          <div>
            <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ø±Ù‚Ù… Ø§Ù„Ø´ÙŠÙƒ</label>
            <input id="cheques-filter-chequeno" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø´ÙŠÙƒ" class="w-full border p-2 rounded-lg text-sm dark:bg-dark-bg dark:border-gray-700 bg-white dark:text-gray-200" oninput="onChequesAdvancedChanged()">
          </div>

          <div>
            <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ø§Ù„Ø¨Ù†Ùƒ</label>
            <input id="cheques-filter-bank" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ" class="w-full border p-2 rounded-lg text-sm dark:bg-dark-bg dark:border-gray-700 bg-white dark:text-gray-200" oninput="onChequesAdvancedChanged()">
          </div>

          <div>
            <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ø§Ù„Ù‚ÙŠÙ…Ø© (Ù…Ù† - Ø¥Ù„Ù‰)</label>
            <div class="flex gap-2">
              <input id="cheques-filter-amin" type="number" placeholder="Ù…Ù†" class="w-1/2 border p-2 rounded-lg text-sm dark:bg-dark-bg dark:border-gray-700 bg-white dark:text-gray-200" oninput="onChequesAdvancedChanged()">
              <input id="cheques-filter-amax" type="number" placeholder="Ø¥Ù„Ù‰" class="w-1/2 border p-2 rounded-lg text-sm dark:bg-dark-bg dark:border-gray-700 bg-white dark:text-gray-200" oninput="onChequesAdvancedChanged()">
            </div>
          </div>

          <div>
            <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ (Ù…Ù† - Ø¥Ù„Ù‰)</label>
            <div class="flex gap-2">
              <input id="cheques-filter-dfrom" type="date" class="w-1/2 border p-2 rounded-lg text-sm dark:bg-dark-bg dark:border-gray-700 bg-white dark:text-gray-200" onchange="onChequesAdvancedChanged()">
              <input id="cheques-filter-dto" type="date" class="w-1/2 border p-2 rounded-lg text-sm dark:bg-dark-bg dark:border-gray-700 bg-white dark:text-gray-200" onchange="onChequesAdvancedChanged()">
            </div>
          </div>
        </div>

        <div class="mt-3 flex justify-end">
          <button onclick="resetChequesAdvanced()" class="btn-ui btn-reset">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
        </div>
      </div>
    </div>

    <div class="table-wrap bg-white shadow-sm">
      <table class="ui-table min-w-full text-right">
        <thead>
          <tr>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th>
            <th>Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</th>
            <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
            <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
            <th>Ø§Ù„Ø¨Ù†Ùƒ / Ø±Ù‚Ù… Ø§Ù„Ø´ÙŠÙƒ</th>
            <th>ØµÙˆØ±Ø© Ø§Ù„Ø´ÙŠÙƒ</th>
            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="cheques-table-body"></tbody>
      </table>
    </div>
  </section>

  <!-- ============= PAYMENTS ============= -->
  <section id="payments-view" class="view hidden">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h2>
      <button onclick="openPaymentModal()" class="btn-ui btn-success">ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white p-4 rounded shadow border-t-4 border-emerald-500 text-center">
        <p class="text-xs text-gray-500 dark:text-gray-400">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙØ¹Ø§Øª</p>
        <p id="payments-total" class="font-bold text-xl text-emerald-700 dark:text-emerald-400">0</p>
      </div>
    </div>
    <div class="table-wrap bg-white shadow-sm">
      <table class="ui-table min-w-full text-right">
        <thead>
          <tr>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± / Ø§Ù„ÙˆØ­Ø¯Ø©</th>
            <th>Ø§Ù„Ù†ÙˆØ¹</th>
            <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
            <th>Ø§Ù„Ù…Ø³ØªØ­Ù‚ / Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø§Ù„Ø³Ù†Ø¯</th>
          </tr>
        </thead>
        <tbody id="payments-table-body"></tbody>
      </table>
    </div>
  </section>

  <!-- ============= EXPENSES ============= -->
  <section id="expenses-view" class="view hidden">
    <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-white">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h2>
    <div id="expenses-advanced-bar" class="glass-card bg-transparent bg-white p-4 rounded-xl mb-4 shadow-sm">
      <div class="flex flex-col md:flex-row gap-3 items-stretch md:items-end md:justify-between">
        <div class="flex-1">
          <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ø¨Ø­Ø«</label>
          <div class="relative">
            <input id="expenses-search-input" placeholder="Ø¨Ø­Ø«: Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ / Ø§Ù„Ø¨ÙŠØ§Ù† / Ø§Ù„ØªØ§Ø±ÙŠØ® / Ø§Ù„Ù…Ø¨Ù„Øº ..." class="w-full border p-2 pr-10 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none" oninput="onExpensesAdvancedChanged()">
            <span class="absolute right-3 top-2.5 text-gray-400 text-sm">ğŸ”</span>
          </div>
        </div>

        <div class="w-full md:w-80">
          <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">ÙØ±Ø²</label>
          <div class="flex items-center gap-2">
            <select id="expenses-sort-by" onchange="onExpensesAdvancedChanged()" class="ui-field ui-select">
              <option value="date">Ø§Ù„ØªØ§Ø±ÙŠØ®</option>
              <option value="amount">Ø§Ù„Ù…Ø¨Ù„Øº</option>
              <option value="type">Ø§Ù„Ù†ÙˆØ¹</option>
            </select>
            <button id="expenses-sort-dir" data-dir="desc" onclick="toggleExpensesSortDir()" class="border border-gray-200 dark:border-gray-700 bg-white hover:bg-gray-50 dark:bg-dark-bg dark:hover:bg-gray-800 px-3 py-2 rounded-lg" title="Ø¹ÙƒØ³ ØªØ±ØªÙŠØ¨ Ø§Ù„ÙØ±Ø²">â¬‡ï¸</button>
          </div>
        </div>
      </div>

      <div class="mt-3 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
        <button id="expenses-toggle-filters" type="button" onclick="toggleExpensesFilters()" class="btn-ui btn-filter">
          Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
        </button>
        <div id="expenses-filter-hint" class="text-xs text-gray-500 dark:text-gray-400"></div>
      </div>

      <div id="expenses-filters-panel" class="hidden mt-3 bg-gray-50 dark:bg-gray-800/40 rounded-lg p-4 border border-gray-200 dark:border-gray-700">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ø§Ù„Ù†ÙˆØ¹</label>
            <select id="expenses-filter-type" onchange="onExpensesAdvancedChanged()" class="w-full border p-2 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none bg-white dark:bg-dark-bg text-gray-700 dark:text-gray-200">
              <option value="">Ø§Ù„ÙƒÙ„</option>
              <option value="ØµÙŠØ§Ù†Ø©">ØµÙŠØ§Ù†Ø©</option>
              <option value="Ø±Ø³ÙˆÙ… ÙƒÙ‡Ø±Ø¨Ø§Ø¡ ÙˆÙ…Ø§Ø¡">Ø±Ø³ÙˆÙ… ÙƒÙ‡Ø±Ø¨Ø§Ø¡ ÙˆÙ…Ø§Ø¡</option>
              <option value="Ø±Ø³ÙˆÙ… Ø¨Ù„Ø¯ÙŠØ©">Ø±Ø³ÙˆÙ… Ø¨Ù„Ø¯ÙŠØ©</option>
              <option value="Ù…Ø­ÙƒÙ…Ø©">Ù…Ø­ÙƒÙ…Ø©</option>
              <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
            </select>
          </div>

          <div>
            <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ø§Ù„Ù…Ø¨Ù„Øº (Ù…Ù† - Ø¥Ù„Ù‰)</label>
            <div class="flex gap-2">
              <input id="expenses-filter-amount-min" type="number" placeholder="Ù…Ù†" class="w-full border p-2 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none" oninput="onExpensesAdvancedChanged()">
              <input id="expenses-filter-amount-max" type="number" placeholder="Ø¥Ù„Ù‰" class="w-full border p-2 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none" oninput="onExpensesAdvancedChanged()">
            </div>
          </div>

          <div>
            <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ø§Ù„ØªØ§Ø±ÙŠØ® (Ù…Ù† - Ø¥Ù„Ù‰)</label>
            <div class="flex gap-2">
              <input id="expenses-filter-date-from" type="date" class="w-full border p-2 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none" onchange="onExpensesAdvancedChanged()">
              <input id="expenses-filter-date-to" type="date" class="w-full border p-2 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none" onchange="onExpensesAdvancedChanged()">
            </div>
          </div>

          <div class="md:col-span-3 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 pt-1">
            <button type="button" onclick="resetExpensesAdvanced()" class="btn-ui btn-reset">
              Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·
            </button>
            <div class="text-xs text-gray-500 dark:text-gray-400">* ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ±Ø² ÙˆØ§Ù„Ø¨Ø­Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</div>
          </div>
        </div>
      </div>
    </div>

    <div class="grid md:grid-cols-3 gap-6">
      <form id="new-expense-form" class="bg-white p-6 rounded-xl shadow-sm space-y-4 h-fit">
        <h3 class="font-bold text-gray-700 dark:text-gray-200">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯</h3>
        <input id="expense-date" type="date" class="w-full border p-2 rounded" required>
        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ</label>
          <select id="expense-type" class="w-full border p-2 rounded" required>
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹...</option>
            <option value="ØµÙŠØ§Ù†Ø©">ØµÙŠØ§Ù†Ø©</option>
            <option value="Ø±Ø³ÙˆÙ… ÙƒÙ‡Ø±Ø¨Ø§Ø¡ ÙˆÙ…Ø§Ø¡">Ø±Ø³ÙˆÙ… ÙƒÙ‡Ø±Ø¨Ø§Ø¡ ÙˆÙ…Ø§Ø¡</option>
            <option value="Ø±Ø³ÙˆÙ… Ø¨Ù„Ø¯ÙŠØ©">Ø±Ø³ÙˆÙ… Ø¨Ù„Ø¯ÙŠØ©</option>
            <option value="Ù…Ø­ÙƒÙ…Ø©">Ù…Ø­ÙƒÙ…Ø©</option>
            <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
          </select>
        </div>
        <input id="expense-amount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº (AED)" class="w-full border p-2 rounded" required>
        <textarea id="expense-details" placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ..." class="w-full border p-2 rounded h-24" required></textarea>
        <button class="btn-ui btn-danger">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ</button>
      </form>
      <div class="md:col-span-2 table-wrap bg-white shadow-sm rounded-xl">
        <table id="expenses-table" class="ui-table min-w-full w-full text-right border-collapse">
          <colgroup>
            <col style="width:120px" />
            <col style="width:140px" />
            <col style="width:150px" />
            <col />
            <col style="width:170px" />
          </colgroup>

          <thead>
            <tr>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ø§Ù„Ù†ÙˆØ¹</th>
              <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
              <th>Ø§Ù„Ø¨ÙŠØ§Ù†</th>
              <th class="text-center">Ø§Ù„Ø³Ù†Ø¯ / ØªØ­ÙƒÙ…</th>
            </tr>
          </thead>
          <tbody id="expenses-table-body"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ============= SALARIES ============= -->
  <section id="salaries-view" class="view hidden">
    <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-white">Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ø­Ø§Ø±Ø³ ÙˆØ§Ù„Ø¹Ù…Ø§Ù„</h2>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="md:col-span-1">
        <form id="salary-form" class="bg-white dark:bg-dark-surface p-6 rounded-xl shadow-sm space-y-4 sticky top-4">
          <h3 class="font-bold text-gray-700 dark:text-gray-200 border-b dark:border-dark-border pb-2">ØªØ³Ø¬ÙŠÙ„ Ø±Ø§ØªØ¨ Ø¬Ø¯ÙŠØ¯</h3>

          <div>
            <label class="text-xs text-gray-500 dark:text-gray-400">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</label>
            <input id="sal-name" class="w-full border p-2 rounded" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ" required>
          </div>

          <div>
            <label class="text-xs text-gray-500 dark:text-gray-400">Ø§Ù„ÙˆØ¸ÙŠÙØ©</label>
            <select id="sal-role" class="w-full border p-2 rounded">
              <option value="Ø­Ø§Ø±Ø³">Ø­Ø§Ø±Ø³</option>
              <option value="Ø¹Ø§Ù…Ù„ Ù†Ø¸Ø§ÙØ©">Ø¹Ø§Ù…Ù„ Ù†Ø¸Ø§ÙØ©</option>
              <option value="ØµÙŠØ§Ù†Ø©">ÙÙ†ÙŠ ØµÙŠØ§Ù†Ø©</option>
              <option value="Ø¥Ø¯Ø§Ø±ÙŠ">Ø¥Ø¯Ø§Ø±ÙŠ</option>
              <option value="Ø¢Ø®Ø±">Ø¢Ø®Ø±</option>
            </select>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="text-xs text-gray-500 dark:text-gray-400">Ø§Ù„Ù…Ø¨Ù„Øº</label>
              <input id="sal-amount" type="number" class="w-full border p-2 rounded" required>
            </div>
            <div>
              <label class="text-xs text-gray-500 dark:text-gray-400">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
              <input id="sal-date" type="date" class="w-full border p-2 rounded" required>
            </div>
          </div>

          <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded border dark:border-gray-700">
            <label class="text-xs font-bold text-gray-700 dark:text-gray-300 block mb-2">Ø±Ø§ØªØ¨ Ø´Ù‡Ø±:</label>
            <div class="flex gap-2">
              <select id="sal-month" class="w-2/3 border p-2 rounded text-sm">
                <option value="ÙŠÙ†Ø§ÙŠØ±">ÙŠÙ†Ø§ÙŠØ±</option>
                <option value="ÙØ¨Ø±Ø§ÙŠØ±">ÙØ¨Ø±Ø§ÙŠØ±</option>
                <option value="Ù…Ø§Ø±Ø³">Ù…Ø§Ø±Ø³</option>
                <option value="Ø£Ø¨Ø±ÙŠÙ„">Ø£Ø¨Ø±ÙŠÙ„</option>
                <option value="Ù…Ø§ÙŠÙˆ">Ù…Ø§ÙŠÙˆ</option>
                <option value="ÙŠÙˆÙ†ÙŠÙˆ">ÙŠÙˆÙ†ÙŠÙˆ</option>
                <option value="ÙŠÙˆÙ„ÙŠÙˆ">ÙŠÙˆÙ„ÙŠÙˆ</option>
                <option value="Ø£ØºØ³Ø·Ø³">Ø£ØºØ³Ø·Ø³</option>
                <option value="Ø³Ø¨ØªÙ…Ø¨Ø±">Ø³Ø¨ØªÙ…Ø¨Ø±</option>
                <option value="Ø£ÙƒØªÙˆØ¨Ø±">Ø£ÙƒØªÙˆØ¨Ø±</option>
                <option value="Ù†ÙˆÙÙ…Ø¨Ø±">Ù†ÙˆÙÙ…Ø¨Ø±</option>
                <option value="Ø¯ÙŠØ³Ù…Ø¨Ø±">Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
              </select>
              <select id="sal-year" class="w-1/3 border p-2 rounded text-sm"></select>
            </div>
          </div>

          <button class="btn-ui btn-filter">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø±Ø§ØªØ¨</button>
        </form>
      </div>

      <div class="md:col-span-2 space-y-6">
        <div class="grid grid-cols-2 gap-4">
          <div class="bg-white dark:bg-dark-surface p-4 rounded-xl shadow border-r-4 border-indigo-500">
            <p class="text-xs text-gray-500 dark:text-gray-400">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©</p>
            <p id="total-salaries" class="text-xl font-bold text-gray-800 dark:text-white">0 AED</p>
          </div>
          <div class="bg-white dark:bg-dark-surface p-4 rounded-xl shadow border-r-4 border-teal-500">
            <p class="text-xs text-gray-500 dark:text-gray-400">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</p>
            <p id="count-salaries" class="text-xl font-bold text-gray-800 dark:text-white">0</p>
          </div>
        </div>

        <div class="table-wrap bg-white dark:bg-dark-surface shadow-sm rounded-xl">
          <table class="ui-table min-w-full text-right">
            <thead class="bg-gray-50 dark:bg-dark-bg">
              <tr>
                <th class="py-3 px-4">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th class="py-3 px-4">Ø§Ù„Ù…ÙˆØ¸Ù</th>
                <th class="py-3 px-4">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                <th class="py-3 px-4">Ø§Ù„Ø¨ÙŠØ§Ù†</th>
                <th class="py-3 px-4 text-center">Ø§Ù„Ø³Ù†Ø¯</th>
                <th class="py-3 px-4 text-center">Ø­Ø°Ù</th>
              </tr>
            </thead>
            <tbody id="salaries-table-body" class="divide-y divide-gray-100 dark:divide-gray-700"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- ============= RECEIPTS HISTORY ============= -->
  <section id="receipts-history-view" class="view hidden">
    <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-white">Ø³Ø¬Ù„ Ø§Ù„Ø³Ù†Ø¯Ø§Øª (Ù‚Ø¨Ø¶ ÙˆØµØ±Ù)</h2>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="glass-card bg-white p-4 rounded-xl shadow border-r-4 border-emerald-500 text-center bg-transparent">
        <p class="text-xs text-gray-500 dark:text-gray-400">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ù†Ø¯Ø§Øª Ø§Ù„Ù‚Ø¨Ø¶ (Ø§Ù„Ø¯ÙØ¹Ø§Øª)</p>
        <p id="total-receipt-vouchers" class="font-bold text-xl text-emerald-700 dark:text-emerald-400">0 AED</p>
      </div>
      <div class="glass-card bg-white p-4 rounded-xl shadow border-r-4 border-rose-500 text-center bg-transparent">
        <p class="text-xs text-gray-500 dark:text-gray-400">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ù†Ø¯Ø§Øª Ø§Ù„ØµØ±Ù (Ø§Ù„Ø±ÙˆØ§ØªØ¨ ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª)</p>
        <p id="total-payment-vouchers" class="font-bold text-xl text-rose-700 dark:text-rose-400">0 AED</p>
      </div>
      <div class="glass-card bg-white p-4 rounded-xl shadow border-r-4 border-blue-500 text-center bg-transparent">
        <p class="text-xs text-gray-500 dark:text-gray-400">Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ù†Ø¯Ø§Øª Ø§Ù„ÙƒÙ„ÙŠ</p>
        <p id="total-vouchers-count" class="font-bold text-xl text-blue-700 dark:text-blue-400">0</p>
      </div>
    </div>
    <!-- Advanced Search & Sort: Receipts History -->
    <div id="receipts-advanced-bar" class="glass-card bg-transparent bg-white p-4 rounded-xl mb-4 shadow-sm">
      <div class="flex flex-col md:flex-row gap-3 items-stretch md:items-end md:justify-between">
        <div class="flex-1">
          <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ø¨Ø­Ø«</label>
          <div class="relative">
            <input id="receipts-search-input" class="w-full border border-gray-300 dark:border-gray-700 rounded-lg px-3 py-2 text-sm bg-white dark:bg-dark-bg text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-purple-500 outline-none" placeholder="Ø¨Ø­Ø«: ØªØ§Ø±ÙŠØ®ØŒ Ù†ÙˆØ¹ØŒ Ù…Ø¨Ù„ØºØŒ Ø·Ø±ÙØŒ Ø¨ÙŠØ§Ù†..." oninput="onReceiptsAdvancedChanged()">
            <span class="absolute right-3 top-2.5 text-gray-400 text-sm">ğŸ”</span>
          </div>
        </div>

        <div class="w-full md:w-80">
          <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">ÙØ±Ø²</label>
          <div class="flex items-center gap-2">
            <select id="receipts-sort-by" onchange="onReceiptsAdvancedChanged()" class="ui-field ui-select">
              <option value="date">Ø§Ù„ØªØ§Ø±ÙŠØ®</option>
              <option value="amount">Ø§Ù„Ù…Ø¨Ù„Øº</option>
              <option value="type">Ø§Ù„Ù†ÙˆØ¹</option>
              <option value="party">Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±</option>
              <option value="source">Ø§Ù„Ù…ØµØ¯Ø±</option>
            </select>
            <button id="receipts-sort-dir" data-dir="desc" onclick="toggleReceiptsSortDir()" class="w-12 border p-2 rounded-lg text-sm dark:bg-dark-bg dark:border-gray-700 bg-white dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-800" title="Ø¹ÙƒØ³ ØªØ±ØªÙŠØ¨ ÙØ±Ø² Ø§Ù„Ø³Ù†Ø¯Ø§Øª">â¬‡ï¸</button>
          </div>
        </div>
      </div>

      <div class="flex items-center justify-between mt-3">
        <button id="receipts-toggle-filters" onclick="toggleReceiptsFiltersPanel()" class="btn-ui btn-filter">Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</button>
        <div id="receipts-advanced-hint" class="text-xs text-gray-500 dark:text-gray-400"></div>
      </div>

      <div id="receipts-filters-panel" class="hidden mt-3 p-3 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/40">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
          <div>
            <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ø§Ù„Ù†ÙˆØ¹</label>
            <select id="receipts-filter-type" class="w-full border p-2 rounded-lg text-sm dark:bg-dark-bg dark:border-gray-700 bg-white dark:text-gray-200" onchange="onReceiptsAdvancedChanged()">
              <option value="">Ø§Ù„ÙƒÙ„</option>
              <option value="Ù‚Ø¨Ø¶">Ù‚Ø¨Ø¶</option>
              <option value="ØµØ±Ù">ØµØ±Ù</option>
            </select>
          </div>

          <div>
            <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ø§Ù„Ù…ØµØ¯Ø±</label>
            <select id="receipts-filter-source" class="w-full border p-2 rounded-lg text-sm dark:bg-dark-bg dark:border-gray-700 bg-white dark:text-gray-200" onchange="onReceiptsAdvancedChanged()">
              <option value="">Ø§Ù„ÙƒÙ„</option>
              <option value="payment">Ø¯ÙØ¹Ø© (Ø¹Ù‚Ø¯)</option>
              <option value="salary">Ø±Ø§ØªØ¨</option>
              <option value="expense">Ù…ØµØ±ÙˆÙ</option>
            </select>
          </div>

          <div>
            <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±</label>
            <input id="receipts-filter-party" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±/Ø§Ù„Ø·Ø±Ù..." class="w-full border p-2 rounded-lg text-sm dark:bg-dark-bg dark:border-gray-700 bg-white dark:text-gray-200 outline-none" oninput="onReceiptsAdvancedChanged()">
          </div>

          <div>
            <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ø§Ù„Ø¨ÙŠØ§Ù†</label>
            <input id="receipts-filter-desc" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†..." class="w-full border p-2 rounded-lg text-sm dark:bg-dark-bg dark:border-gray-700 bg-white dark:text-gray-200 outline-none" oninput="onReceiptsAdvancedChanged()">
          </div>

          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ù‚ÙŠÙ…Ø© Ù…Ù†</label>
              <input id="receipts-filter-amin" type="number" class="w-full border p-2 rounded-lg text-sm dark:bg-dark-bg dark:border-gray-700 bg-white dark:text-gray-200 outline-none" placeholder="0" oninput="onReceiptsAdvancedChanged()">
            </div>
            <div>
              <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ø¥Ù„Ù‰</label>
              <input id="receipts-filter-amax" type="number" class="w-full border p-2 rounded-lg text-sm dark:bg-dark-bg dark:border-gray-700 bg-white dark:text-gray-200 outline-none" placeholder="999999" oninput="onReceiptsAdvancedChanged()">
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">ØªØ§Ø±ÙŠØ® Ù…Ù†</label>
              <input id="receipts-filter-dfrom" type="date" class="w-full border p-2 rounded-lg text-sm dark:bg-dark-bg dark:border-gray-700 bg-white dark:text-gray-200 outline-none" onchange="onReceiptsAdvancedChanged()">
            </div>
            <div>
              <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ø¥Ù„Ù‰</label>
              <input id="receipts-filter-dto" type="date" class="w-full border p-2 rounded-lg text-sm dark:bg-dark-bg dark:border-gray-700 bg-white dark:text-gray-200 outline-none" onchange="onReceiptsAdvancedChanged()">
            </div>
          </div>

          <div class="md:col-span-2 flex items-end justify-end">
            <button onclick="resetReceiptsAdvanced()" class="btn-ui btn-reset">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
          </div>
        </div>
      </div>
    </div>


    <div class="table-wrap bg-white shadow-sm">
      <table id="receipts-history-table" class="ui-table min-w-full table-fixed text-right">
        <colgroup>
          <col style="width:120px" />
          <col style="width:110px" />
          <col style="width:150px" />
          <col style="width:260px" />
          <col />
          <col style="width:90px" />
        </colgroup>

        <thead class="bg-gray-50">
          <tr>
            <th class="w-[120px] px-4 py-3 whitespace-nowrap text-right">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th class="w-[110px] px-4 py-3 whitespace-nowrap text-right">Ø§Ù„Ù†ÙˆØ¹</th>
            <th class="w-[150px] px-4 py-3 whitespace-nowrap text-right">Ø§Ù„Ù…Ø¨Ù„Øº</th>
            <th class="w-[260px] px-4 py-3 text-right">Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±</th>
            <th class="px-4 py-3 text-right">Ø§Ù„Ø¨ÙŠØ§Ù†</th>
            <th class="w-[90px] px-4 py-3 whitespace-nowrap text-center">Ø¹Ø±Ø¶</th>
          </tr>
        </thead>
        <tbody id="receipts-history-table-body"></tbody>
      </table>
    </div>
  </section>

  <!-- ============= RECEIPT VIEW ============= -->
  <section id="receipt-view" class="view hidden">
    <div class="max-w-4xl mx-auto">
      <h2 id="receipt-main-title" class="text-2xl font-bold mb-6 text-gray-800 dark:text-white">Ø¥ØµØ¯Ø§Ø± Ø³Ù†Ø¯</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <form id="receipt-form" class="md:col-span-1 bg-white p-6 rounded-xl shadow-sm space-y-4 h-fit hidden">
          <button type="submit">generate</button>
        </form>

        <div class="md:col-span-3">
          <button onclick="showView('receipts-history')" id="back-to-source-btn" class="mb-4 inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-gray-200 bg-white text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-emerald-500/40 dark:border-slate-700 dark:bg-slate-800 dark:text-gray-100 dark:hover:bg-slate-700">â†©ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø³Ø¬Ù„ Ø§Ù„Ø³Ù†Ø¯Ø§Øª</button>

          <div id="receipt-preview" class="bg-white p-8 rounded shadow-lg border relative">
            <div id="printable-receipt" class="p-4 border-2 border-double border-gray-300 text-gray-800 bg-white">
              <div class="flex justify-between items-start border-b-2 border-gray-200 pb-4 mb-6">
                <div>
                  <h1 id="rv-building-name" class="text-xl font-bold text-gray-800">Ø¨Ù†Ø§ÙŠØ© ÙˆØ±Ø«Ø© Ø¬Ù…Ø¹Ø© Ø¹Ø¨ÙŠØ¯ Ø£Ø¨ÙˆØ§Ù„Ø´ÙˆØ§Ø±Ø¨</h1>
                  <p id="rv-building-location" class="text-sm text-gray-600">Ø§Ù„Ø¹ÙŠÙ†ØŒ Ø¨Ø·Ø­Ø§Ø¡ Ø§Ù„Ø­Ø§Ø¦Ø±</p>
                  <p id="rv-building-phone" class="text-sm text-gray-600">00971503343600</p>
                </div>
                <div class="text-center">
                  <h2 id="rv-title" class="text-3xl font-black text-emerald-700 tracking-wider">Ø³Ù†Ø¯ Ù‚Ø¨Ø¶</h2>
                  <p id="rv-subtitle" class="text-xs uppercase tracking-widest text-gray-400">Receipt Voucher</p>
                </div>
              </div>

              <div class="flex justify-between mb-8 text-sm">
                <p><strong>Ø±Ù‚Ù… Ø§Ù„Ø³Ù†Ø¯:</strong> <span id="rv-no" class="text-rose-600 font-mono font-bold text-lg"></span></p>
                <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> <span id="rv-date-out"></span></p>
              </div>
              <div class="space-y-4 mb-8">
                <div class="flex border-b border-dotted border-gray-300 pb-2">
                  <span id="rv-party-label" class="w-32 font-bold text-gray-700">Ø§Ø³ØªÙ„Ù…Ù†Ø§ Ù…Ù†:</span>
                  <span id="rv-tenant-out" class="flex-1 text-lg"></span>
                </div>
                <div class="flex border-b border-dotted border-gray-300 pb-2">
                  <span class="w-32 font-bold text-gray-700">Ù…Ø¨Ù„Øº ÙˆÙ‚Ø¯Ø±Ù‡:</span>
                  <span class="flex-1 font-bold text-xl text-emerald-700"><span id="rv-amount-out"></span> AED</span>
                </div>
                <div class="flex border-b border-dotted border-gray-300 pb-2">
                  <span class="w-32 font-bold text-gray-700">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</span>
                  <span id="rv-method-out" class="flex-1"></span>
                </div>
                <div class="flex border-b border-dotted border-gray-300 pb-2">
                  <span class="w-32 font-bold text-gray-700">ÙˆØ°Ù„Ùƒ Ø¹Ù†:</span>
                  <span id="rv-for-out" class="flex-1"></span>
                </div>
              </div>
              <div class="flex justify-between mt-12 pt-8 border-t border-gray-200">
                <div class="text-center w-1/3">
                  <p class="font-bold text-sm mb-4">Ø§Ù„Ù…Ø³ØªÙ„Ù… / Ø§Ù„Ù…Ø­Ø§Ø³Ø¨</p>
                  <div class="h-0 border-b border-gray-400 w-2/3 mx-auto"></div>
                </div>
                <div class="text-center w-1/3">
                  <p class="font-bold text-sm mb-4">Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ / Ø§Ù„Ø®ØªÙ…</p>
                  <div class="w-20 h-20 border-2 border-gray-200 rounded-full mx-auto opacity-50"></div>
                </div>
              </div>
            </div>
            <div class="mt-6 flex justify-end gap-3 no-print">
              <button onclick="downloadReceiptPDF()" class="btn-ui btn-danger">ğŸ“„ ØªØµØ¯ÙŠØ± PDF</button>
              <button onclick="printCurrentReport()" class="bg-gray-800 hover:bg-gray-900 text-white px-4 py-2 rounded flex items-center gap-2">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù„Ø§Ùƒ (Ù†ØµÙ Ø³Ù†ÙˆÙŠ)</button>

        

            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ============= REPORTS ============= -->
  <section id="reports-view" class="view hidden">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„Ø©</h2>
      <div class="flex flex-col sm:flex-row gap-2 items-stretch sm:items-center">
        <button onclick="printCurrentReport()" class="bg-gray-800 hover:bg-gray-900 text-white px-4 py-2 rounded flex items-center gap-2">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù„Ø§Ùƒ (Ù†ØµÙ Ø³Ù†ÙˆÙŠ)</button>
<div class="flex flex-col sm:flex-row gap-2 items-stretch sm:items-center ml-2 no-print">
          <select id="report-month" class="ui-field ui-select w-40" aria-label="Ø§Ù„Ø´Ù‡Ø±"></select>
          <select id="report-year" class="ui-field ui-select w-32" aria-label="Ø§Ù„Ø³Ù†Ø©"></select>
          <button id="report-refresh" onclick="renderReports()" class="btn-ui btn-filter">ØªØ­Ø¯ÙŠØ«</button>
        </div>

        <div class="mt-3 sm:mt-0 flex flex-col sm:flex-row gap-2 items-stretch sm:items-center no-print">
          <div class="text-sm font-bold text-gray-600 dark:text-gray-300 sm:ml-2">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù„Ø§Ùƒ (Ù†ØµÙ Ø³Ù†ÙˆÙŠ) â€” Ø³Ù†Ø© Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ±Ø©:</div>
          <select id="hy-cycle" class="ui-field ui-select w-52" aria-label="Ø§Ù„Ø¯ÙˆØ±Ø©">
            <option value="mar">Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ (1 Ù…Ø§Ø±Ø³ â†’ 31 Ø£ØºØ³Ø·Ø³)</option>
            <option value="sep">Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© (1 Ø³Ø¨ØªÙ…Ø¨Ø± â†’ 28/29 ÙØ¨Ø±Ø§ÙŠØ±)</option>
          </select>
          <select id="hy-year" class="ui-field ui-select w-32" aria-label="Ø§Ù„Ø³Ù†Ø©"></select>
          <button id="hy-refresh" onclick="renderHalfYearOwnersReport()" class="btn-ui btn-filter">ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        </div>

</div>
    </div>
    <div id="printable-area" class="bg-white p-8 rounded shadow-lg space-y-8 text-gray-800">
      <!-- Print Header/Footer (A4) -->
      <div id="print-header" class="print-header hidden print:block">
        <div class="flex items-center justify-between gap-4">
          <div class="text-sm font-extrabold text-gray-900">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª â€” ØªÙ‚Ø±ÙŠØ±</div>
          <div class="text-xs text-gray-600">
            <span id="print-header-period" class="font-bold">â€”</span>
            <span class="mx-2">|</span>
            <span id="print-header-date" class="font-bold">â€”</span>
          </div>
        </div>
        <div class="h-px bg-gray-300 mt-2"></div>
      </div>

      <div id="print-footer" class="print-footer hidden print:block">
        <div class="h-px bg-gray-300 mb-2"></div>
        <div class="flex items-center justify-between text-xs text-gray-600">
          <div>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</div>
          <div class="page-counter"></div>
        </div>
      </div>
      <!-- /Print Header/Footer -->

      <div id="monthly-report-section" class="monthly-report-section">
<div class="text-center border-b pb-4 mb-4">
        <h1 class="text-2xl font-bold text-emerald-700">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙˆØ§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ†</h1>
        <p class="text-gray-500">ØªÙ… Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨ØªØ§Ø±ÙŠØ®: <span id="report-date"></span></p>
        <p class="text-gray-500">Ø§Ù„ÙØªØ±Ø©: <span id="report-period" class="font-bold text-gray-700"></span></p>
      </div>

      <!-- Report KPIs (Selected Month/Year) -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="glass-card p-5 rounded-2xl border-r-4 border-emerald-700">
          <p class="text-gray-500 dark:text-gray-400 text-sm font-semibold mb-1">Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙØªØ±Ø©</p>
          <p id="report-kpi-revenue" class="text-2xl md:text-3xl font-extrabold text-gray-800 dark:text-white">0 AED</p>
          <p class="mt-2 text-xs text-gray-400 dark:text-gray-500">Ø¹Ù…Ù„ÙŠØ§Øª Ù‚Ø¨Ø¶: <span id="report-kpi-revenue-count" class="font-mono">0</span></p>
        </div>

        <div class="glass-card p-5 rounded-2xl border-r-4 border-rose-500">
          <p class="text-gray-500 dark:text-gray-400 text-sm font-semibold mb-1">Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ÙØªØ±Ø©</p>
          <p id="report-kpi-expenses" class="text-2xl md:text-3xl font-extrabold text-gray-800 dark:text-white">0 AED</p>
          <p class="mt-2 text-xs text-gray-400 dark:text-gray-500">Ø¹Ù…Ù„ÙŠØ§Øª: <span id="report-kpi-expenses-count" class="font-mono">0</span></p>
        </div>

        <div class="glass-card p-5 rounded-2xl border-r-4 border-violet-600">
          <p class="text-gray-500 dark:text-gray-400 text-sm font-semibold mb-1">ØµØ§ÙÙŠ Ø§Ù„ÙØªØ±Ø©</p>
          <p id="report-kpi-net" class="text-2xl md:text-3xl font-extrabold text-gray-800 dark:text-white">0 AED</p>
          <p class="mt-2 text-xs text-gray-400 dark:text-gray-500">Ø¥ÙŠØ±Ø§Ø¯Ø§Øª âˆ’ Ù…ØµØ§Ø±ÙŠÙ</p>
        </div>

        <div class="glass-card p-5 rounded-2xl border-r-4 border-slate-500">
          <p class="text-gray-500 dark:text-gray-400 text-sm font-semibold mb-1">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ø´ØºØ§Ù„</p>
          <p id="report-kpi-occupancy" class="text-2xl md:text-3xl font-extrabold text-gray-800 dark:text-white">0%</p>
          <p class="mt-2 text-xs text-gray-400 dark:text-gray-500">Ø´Ø§ØºØ±Ø©: <span id="report-kpi-vacant" class="font-mono">0</span> / <span id="report-kpi-totalunits" class="font-mono">0</span></p>
        </div>
      </div>

      
      <!-- Half-Year Owners Distribution Report -->
      
</div>
<div id="hy-report-section" class="mt-10 space-y-6">

        <!-- A4 summary header for half-year report -->
        <div id="hy-a4-summary" class="glass-card p-6 rounded-2xl border border-white/30 print:border-gray-300">
          <div class="flex items-start justify-between gap-6">
            <div class="space-y-1">
              <div class="text-2xl font-extrabold text-gray-900">ØªÙ‚Ø±ÙŠØ± Ù†ØµÙ Ø³Ù†ÙˆÙŠ Ù„ØµØ±Ù Ø§Ù„Ù…Ù„Ø§Ùƒ</div>
              <div class="text-sm text-gray-600">Ø§Ù„ÙØªØ±Ø©: <span id="hy-a4-period" class="font-bold text-gray-800">â€”</span></div>
              <div class="text-sm text-gray-600">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±: <span id="hy-a4-issued" class="font-bold text-gray-800">â€”</span></div>
            </div>

            <div class="flex gap-3 items-stretch">
              <div class="w-36 h-20 rounded-xl border border-dashed border-gray-300 flex items-center justify-center text-xs text-gray-500">
                Ø®Ø§Ù†Ø© Ø§Ù„Ø®ØªÙ…
              </div>
              <div class="w-36 h-20 rounded-xl border border-dashed border-gray-300 flex items-center justify-center text-xs text-gray-500">
                Ø®Ø§Ù†Ø© Ø§Ù„ØªÙˆÙ‚ÙŠØ¹
              </div>
            </div>
          </div>

          <div class="mt-5 grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="p-4 rounded-xl bg-white/60 dark:bg-white/10 border border-white/30">
              <div class="text-xs text-gray-500 mb-1">Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ù…Ø­ØµÙ„Ø©</div>
              <div id="hy-a4-collected" class="text-lg font-extrabold ui-td-ltr">0 AED</div>
            </div>
            <div class="p-4 rounded-xl bg-white/60 dark:bg-white/10 border border-white/30">
              <div class="text-xs text-gray-500 mb-1">Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ÙØªØ±Ø©</div>
              <div id="hy-a4-expenses" class="text-lg font-extrabold ui-td-ltr">0 AED</div>
            </div>
            <div class="p-4 rounded-xl bg-white/60 dark:bg-white/10 border border-white/30">
              <div class="text-xs text-gray-500 mb-1">Ù…ØªØ£Ø®Ø±Ø§Øª</div>
              <div id="hy-a4-arrears" class="text-lg font-extrabold ui-td-ltr">0 AED</div>
            </div>
            <div class="p-4 rounded-xl bg-white/60 dark:bg-white/10 border border-white/30">
              <div class="text-xs text-gray-500 mb-1">ØµØ§ÙÙŠ Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙˆØ²ÙŠØ¹</div>
              <div id="hy-a4-net" class="text-lg font-extrabold ui-td-ltr">0 AED</div>
            </div>
          </div>

          <div class="mt-5 grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
            <div class="rounded-xl border border-gray-200/70 bg-white/60 dark:bg-white/10 p-4">
              <div class="text-xs text-gray-500 mb-2">ØªÙ… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙˆØ§Ø³Ø·Ø©</div>
              <div class="h-9 border-b border-gray-300"></div>
            </div>
            <div class="rounded-xl border border-gray-200/70 bg-white/60 dark:bg-white/10 p-4">
              <div class="text-xs text-gray-500 mb-2">ØªÙ…Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨ÙˆØ§Ø³Ø·Ø©</div>
              <div class="h-9 border-b border-gray-300"></div>
            </div>
            <div class="rounded-xl border border-gray-200/70 bg-white/60 dark:bg-white/10 p-4">
              <div class="text-xs text-gray-500 mb-2">ØªÙ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¨ÙˆØ§Ø³Ø·Ø©</div>
              <div class="h-9 border-b border-gray-300"></div>
            </div>
          </div>
        </div>
        <!-- /A4 summary header -->


        <div class="flex items-start justify-between gap-3">
          <div>
            <h2 class="text-xl font-extrabold text-gray-800">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù„Ø§Ùƒ â€“ Ù†ØµÙ Ø³Ù†ÙˆÙŠ (Ù„Ù„ØµØ±Ù Ø´Ù‡Ø± 3 / Ø´Ù‡Ø± 9)</h2>
            <p class="text-gray-500 text-sm">Ø§Ù„ÙØªØ±Ø©: <span id="hy-period-label" class="font-bold text-gray-700">â€”</span></p>
          </div>
          <div class="text-xs text-gray-400">ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙØ¹Ø§Øª ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ù…Ø³Ø¬Ù„Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø¸Ø§Ù…</div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="glass-card p-5 rounded-2xl border-r-4 border-emerald-700">
            <p class="text-gray-500 text-sm font-semibold mb-1">Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ù…Ø­ØµÙ„Ø©</p>
            <p id="hy-collected" class="text-2xl font-extrabold text-gray-800">0 AED</p>
            <p class="mt-2 text-xs text-gray-400">Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª: <span id="hy-collected-count" class="font-mono">0</span></p>
          </div>

          <div class="glass-card p-5 rounded-2xl border-r-4 border-slate-500">
            <p class="text-gray-500 text-sm font-semibold mb-1">Ø¥ÙŠØ¬Ø§Ø±Ø§Øª Ù…Ø³ØªØ­Ù‚Ø© (ØªÙ‚Ø¯ÙŠØ±ÙŠ)</p>
            <p id="hy-due" class="text-2xl font-extrabold text-gray-800">0 AED</p>
            <p class="mt-2 text-xs text-gray-400">Ø­Ø³Ø¨ ØªØ¯Ø§Ø®Ù„ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ù…Ø¹ Ø§Ù„ÙØªØ±Ø©</p>
          </div>

          <div class="glass-card p-5 rounded-2xl border-r-4 border-rose-600">
            <p class="text-gray-500 text-sm font-semibold mb-1">Ù…ØªØ£Ø®Ø±Ø§Øª</p>
            <p id="hy-arrears" class="text-2xl font-extrabold text-gray-800">0 AED</p>
            <p class="mt-2 text-xs text-gray-400">Ù…Ø³ØªØ­Ù‚ âˆ’ Ù…Ø³ØªÙ„Ù… (Ø¥Ù† ÙˆØ¬Ø¯)</p>
          </div>

          <div class="glass-card p-5 rounded-2xl border-r-4 border-violet-600">
            <p class="text-gray-500 text-sm font-semibold mb-1">ØµØ§ÙÙŠ Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙˆØ²ÙŠØ¹</p>
            <p id="hy-net" class="text-2xl font-extrabold text-gray-800">0 AED</p>
            <p class="mt-2 text-xs text-gray-400">Ù…Ø³ØªÙ„Ù… âˆ’ Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ÙØªØ±Ø©</p>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-1 gap-6">
          <div class="glass-card p-5 rounded-2xl">
            <h3 class="font-extrabold text-gray-800 mb-3">Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø­Ø³Ø¨ Ø§Ù„Ø¨Ù†Ø¯</h3>
            <table class="ui-table">
              <thead>
                <tr>
                  <th>Ø§Ù„Ø¨Ù†Ø¯</th>
                  <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                  <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</th>
                </tr>
              </thead>
              <tbody id="hy-expenses-by-type-body"></tbody>
            </table>
            <div class="mt-3 text-sm text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ: <span id="hy-expenses-total" class="font-bold ui-td-ltr">0 AED</span></div>
          </div>

          
        </div>

        <div class="glass-card p-5 rounded-2xl">
          <h3 class="font-extrabold text-gray-800 mb-2">ØµØ§ÙÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ²Ø¹Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ø§Ùƒ</h3>
          <p class="text-sm text-gray-600 mb-3">Ø³ÙŠØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ù†ØµÙŠØ¨ ÙƒÙ„ Ù…Ø§Ù„Ùƒ ÙˆÙÙ‚ Ù†Ø³Ø¨ Ø§Ù„Ù…Ù„ÙƒÙŠØ© (ÙŠÙØ¶Ø§Ù Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¶Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª). Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ù†Ø³Ø¨ØŒ Ø³ÙŠØ¸Ù‡Ø± ØªÙ†Ø¨ÙŠÙ‡.</p>
          <table class="ui-table">
            <thead>
              <tr>
                <th>Ø§Ù„Ù…Ø§Ù„Ùƒ</th>
                <th>Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ù„ÙƒÙŠØ©</th>
                <th>Ø§Ù„Ù…Ø³ØªØ­Ù‚ Ù„Ù„ØµØ±Ù</th>
              </tr>
            </thead>
            <tbody id="hy-owners-body"></tbody>
          </table>
        </div>

        
        <div class="glass-card p-5 rounded-2xl">
          <div class="flex items-start justify-between gap-3 mb-3">
            <div>
              <h3 class="font-extrabold text-gray-800 mb-1">ØªÙØµÙŠÙ„ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±Ø§Øª (Ù…Ø³ØªØ­Ù‚ Ù…Ù‚Ø§Ø¨Ù„ Ù…Ø³ØªÙ„Ù…) Ù„ÙƒÙ„ Ø¹Ù‚Ø¯</h3>
              <p class="text-sm text-gray-600">ÙŠØ¹Ø±Ø¶ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„ØªÙŠ ØªØªØ¯Ø§Ø®Ù„ Ù…Ø¹ ÙØªØ±Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±ØŒ Ù…Ø¹ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª (Ø¥Ù† ÙˆØ¬Ø¯Øª) Ø®Ù„Ø§Ù„ Ø§Ù„ÙØªØ±Ø©.</p>
            </div>
            <div class="text-xs text-gray-400">Ø§Ù„Ø§Ø­ØªØ³Ø§Ø¨: Proâ€‘rata Ø­Ø³Ø¨ Ø£ÙŠØ§Ù… Ø§Ù„ØªØ¯Ø§Ø®Ù„</div>
          </div>
          <table class="ui-table hy-contracts-table w-full table-fixed">
            <thead>
              <tr>
                <th class="w-[14%]">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯</th>
                <th class="w-[7%]">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                <th class="w-[19%]">Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</th>
                <th class="w-[9%]">Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯</th>
                <th class="w-[9%]">Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯</th>
                <th class="w-[12%]">Ø§Ù„Ù…Ø³ØªØ­Ù‚ ÙÙŠ Ø§Ù„ÙØªØ±Ø©</th>
                <th class="w-[12%]">Ø§Ù„Ù…Ø³ØªÙ„Ù… ÙÙŠ Ø§Ù„ÙØªØ±Ø©</th>
                <th class="w-[14%]">Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª</th>
</tr>
            </thead>
            <tbody id="hy-contracts-body"></tbody>
          </table>
          <div class="mt-3 text-sm text-gray-600">
            Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ­Ù‚ (Ù…Ù† Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù‚ÙˆØ¯): <span id="hy-contracts-due-total" class="font-bold">0 AED</span> â€”
            Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªÙ„Ù…: <span id="hy-contracts-rec-total" class="font-bold">0 AED</span> â€”
            Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª: <span id="hy-contracts-arr-total" class="font-bold">0 AED</span>
          </div>
        </div>


<div class="glass-card p-5 rounded-2xl">
          <h3 class="font-extrabold text-gray-800 mb-2">Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØªÙˆØµÙŠØ§Øª</h3>
          <ul class="list-disc pr-6 text-sm text-gray-700 space-y-1">
            <li id="hy-note-arrears">â€”</li>
            <li>ØªÙˆØµÙŠØ©: ØªÙØ¹ÙŠÙ„ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª ÙˆØ¥Ø±Ø³Ø§Ù„ Ø¥Ù†Ø°Ø§Ø±Ø§Øª Ù…Ø¨ÙƒØ±Ø© Ù‚Ø¨Ù„ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯/Ø§Ù„Ø¯ÙØ¹.</li>
            <li>ØªÙˆØµÙŠØ©: ØªØµÙ†ÙŠÙ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø¨Ø¯Ù‚Ø© (ØµÙŠØ§Ù†Ø©/Ø®Ø¯Ù…Ø§Øª/Ø¥Ø¯Ø§Ø±ÙŠØ©/Ø¶Ø±Ø§Ø¦Ø¨) Ù„ØªØ­Ø³ÙŠÙ† Ù‚Ø±Ø§Ø± Ø§Ù„ØµØ±Ù Ù„Ù„Ù…Ù„Ø§Ùƒ.</li>
          </ul>
        </div>
      </div>
      <!-- /Half-Year Owners Distribution Report -->

      
      <!-- Sections removed -->
      <div class="hidden">
        <div id="tenants-summary-list"></div>
        <ul id="late-tenants-list"></ul>
      </div>
      <!-- /Hidden placeholders -->
<div class="mt-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3">
          <h3 class="font-bold text-lg text-indigo-700 border-r-4 border-indigo-700 pr-2">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù‚ÙˆØ¯ (Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ø³Ø§Ø¨Ù‚Ø©)</h3>
          <div class="flex flex-col sm:flex-row gap-2 sm:items-center">
            <select id="report-lease-status-filter" class="border p-2 rounded text-sm bg-white dark:bg-gray-800 dark:border-gray-600">
              <option value="all">Ø§Ù„ÙƒÙ„</option>
              <option value="Ù…Ø¤Ø¬Ø±Ø©">Ù…Ø¤Ø¬Ø±Ø©</option>
              <option value="Ù…Ù„ØºØ§Ø©">Ù…Ù„ØºØ§Ø©</option>
              <option value="ØªØ¬Ø¯ÙŠØ¯ Ø¹Ù‚Ø¯">ØªØ¬Ø¯ÙŠØ¯ Ø¹Ù‚Ø¯</option>
              <option value="Ù…Ø®Ù„Ù‰">Ù…Ø®Ù„Ù‰</option>
            </select>
            <input id="report-lease-search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± / Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ / Ø§Ù„ÙˆØ­Ø¯Ø©..." class="border p-2 rounded text-sm w-full sm:w-72 bg-white dark:bg-gray-800 dark:border-gray-600" />
          </div>
        </div>

        <div class="flex flex-wrap gap-3 text-xs mb-3">
          <span id="report-leases-counts" class="px-3 py-1 rounded bg-indigo-50 text-indigo-700 border border-indigo-200 dark:bg-indigo-900/20 dark:text-indigo-200 dark:border-indigo-800"></span>
          <span class="px-3 py-1 rounded bg-gray-50 text-gray-700 border border-gray-200 dark:bg-gray-800 dark:text-gray-200 dark:border-gray-700">
            Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ù…Ù„ØºØ§Ø©/Ø§Ù„Ù…Ø¬Ø¯Ø¯Ø© ÙŠØªÙ… Ø­ÙØ¸Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¶Ù…Ù† Ø§Ù„Ø³Ø¬Ù„
          </span>
        </div>

        <div class="table-wrap bg-white shadow-sm">
          <table class="ui-table min-w-full text-right">
            <thead>
              <tr>
                <th class="w-[170px]">Ø§Ù„Ø¹Ù‚Ø§Ø± / Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                <th class="w-[220px]">Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</th>
                <th class="w-[140px]">Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                <th class="w-[180px]">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯</th>
                <th class="w-[110px]">Ù…Ù†</th>
                <th class="w-[110px]">Ø¥Ù„Ù‰</th>
                <th class="w-[90px]">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
                <th class="w-[130px]">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£Ø±Ø´ÙØ©</th>
              </tr>
            </thead>
            <tbody id="report-leases-body" class="divide-y divide-gray-100 dark:divide-gray-700"></tbody>
          </table>
        </div>
        <p id="report-leases-empty" class="hidden mt-3 text-sm text-gray-600 dark:text-gray-300"></p>
      </div>

    </div>
  </section>


  <!-- ============= NOTICES ============= -->
  <section id="notices-view" class="view hidden">
    <div class="flex flex-wrap items-center justify-between mb-6 gap-3 no-print">
      <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª</h2>
      <p class="text-sm text-gray-500 dark:text-gray-400">Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø·Ø§Ø¨Ø§Øª Ø±Ø³Ù…ÙŠØ© Ù…ÙˆØ¬Ù‡Ø© Ù„Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† ÙˆØ·Ø¨Ø§Ø¹ØªÙ‡Ø§</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø·Ø§Ø¨ -->
      <div class="bg-white p-6 rounded-2xl no-print">
        <h3 class="font-bold mb-4 text-gray-700 dark:text-gray-200">Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø·Ø§Ø¨</h3>

        <div class="space-y-3">
          <div>
            <label class="block text-sm font-semibold mb-1">Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</label>
            <select id="notice-tenant-select" class="w-full border p-2 rounded-lg" onchange="onNoticeTenantChange()">
              <option value="">Ø§Ø®ØªØ± Ù…Ø³ØªØ£Ø¬Ø±...</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-semibold mb-1">Ø§Ù„ÙˆØ­Ø¯Ø©</label>
            <select id="notice-unit-select" class="w-full border p-2 rounded-lg" disabled>
              <option value="">Ø§Ø®ØªØ± ÙˆØ­Ø¯Ø©...</option>
            </select>
            <p class="text-[11px] text-gray-400 mt-1">Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØ­Ø¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±.</p>
          </div>

          <div>
            <label class="block text-sm font-semibold mb-1">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø§Ø¨</label>
            <select id="notice-template-select" class="w-full border p-2 rounded-lg" onchange="resetNoticePreview()">
              <option value="blank">Ø®Ø·Ø§Ø¨ Ø±Ø³Ù…ÙŠ ÙØ§Ø±Øº (ÙŠÙÙƒØªØ¨ Ø­Ø³Ø¨ Ø±ØºØ¨Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„)</option>
              <option value="eviction">Ø¥Ø®Ø·Ø§Ø± Ø¨Ø¹Ø¯Ù… Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ ÙˆØ¥Ø®Ù„Ø§Ø¡ Ø§Ù„Ø¹ÙŠÙ† + Ø¨Ø±Ø§Ø¡Ø© Ø°Ù…Ø© ÙƒÙ‡Ø±Ø¨Ø§Ø¡/Ù…ÙŠØ§Ù‡</option>
              <option value="increase5">Ø¥Ø´Ø¹Ø§Ø± Ø²ÙŠØ§Ø¯Ø© Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚Ø¯ 5%</option>
                          <option value="arrearsRenew">Ø¥Ù†Ø°Ø§Ø± Ø¯ÙØ¹ Ù…ØªØ£Ø®Ø±Ø§Øª Ø¥ÙŠØ¬Ø§Ø±ÙŠØ© + ØªØ¬Ø¯ÙŠØ¯ Ø¹Ù‚Ø¯</option>
              <option value="arrearsCheque">Ø¥Ù†Ø°Ø§Ø± Ø¯ÙØ¹ Ù…ØªØ£Ø®Ø±Ø§Øª (Ø´ÙŠÙƒ Ø±Ø§Ø¬Ø¹/Ø¯ÙØ¹Ø© Ø£ÙˆÙ„Ù‰)</option>
</select>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
            <div>
              <label class="block text-sm font-semibold mb-1">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
              <input id="notice-date" type="date" class="w-full border p-2 rounded-lg dark:bg-gray-800 dark:text-white" onchange="resetNoticePreview()">
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">Ø±Ù‚Ù… Ø§Ù„Ø®Ø·Ø§Ø¨</label>
              <input id="notice-ref" class="w-full border p-2 rounded-lg bg-gray-50 dark:bg-gray-800 dark:text-white" placeholder="NT-00001" oninput="resetNoticePreview()">
            </div>
          </div>

          <div class="flex items-center gap-2 pt-1">
            <input id="notice-bilingual" type="checkbox" class="h-4 w-4" onchange="resetNoticePreview()">
            <label for="notice-bilingual" class="text-sm">Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø³Ø®Ø© English (Ø¹Ù…ÙˆØ¯ÙŠÙ†)</label>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 pt-2">
            <label class="flex items-center gap-2 text-sm">
              <input id="notice-show-signature" type="checkbox" class="h-4 w-4" checked onchange="persistNoticeUiPrefs(); resetNoticePreview();">
              <span>Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ ÙˆØ¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„</span>
            </label>
            <label class="flex items-center gap-2 text-sm">
              <input id="notice-show-seal" type="checkbox" class="h-4 w-4" checked onchange="persistNoticeUiPrefs(); resetNoticePreview();">
              <span>Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø®ØªÙ… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span>
            </label>
            <label class="flex items-center gap-2 text-sm sm:col-span-2">
              <input id="notice-show-attachments" type="checkbox" class="h-4 w-4" checked onchange="persistNoticeUiPrefs(); resetNoticePreview();">
              <span>Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</span>
            </label>
            <div class="sm:col-span-2">
              <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ù…Ø±ÙÙ‚Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø³Ø·Ø± Ù„ÙƒÙ„ Ù…Ø±ÙÙ‚)</label>
              <textarea id="notice-attachments-custom" rows="2" class="w-full border p-2 rounded-lg" placeholder="Ù…Ø«Ø§Ù„: ØµÙˆØ±Ø© Ø§Ù„Ù‡ÙˆÙŠØ©&#10;Ù…Ø«Ø§Ù„: ÙƒØ´Ù Ø­Ø³Ø§Ø¨" oninput="persistNoticeUiPrefs(); resetNoticePreview();"></textarea>
            </div>
          </div>

          <div id="notice-extra-options" class="hidden p-3 rounded-xl border border-gray-200 dark:border-gray-700 space-y-3">
            <!-- Ø®ÙŠØ§Ø±Ø§Øª Ø²ÙŠØ§Ø¯Ø© 5% -->
            <div id="notice-extra-increase5">
              <div class="flex items-center gap-2">
                <input id="notice-no-reply-accept" type="checkbox" class="h-4 w-4" checked onchange="resetNoticePreview()">
                <label for="notice-no-reply-accept" class="text-sm">Ø§Ø¹ØªØ¨Ø§Ø± Ø¹Ø¯Ù… Ø§Ù„Ø±Ø¯ Ø®Ù„Ø§Ù„ 7 Ø£ÙŠØ§Ù… Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø²ÙŠØ§Ø¯Ø©</label>
              </div>
            </div>

            <!-- Ø®ÙŠØ§Ø±Ø§Øª Ø¥Ù†Ø°Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª -->
            <div id="notice-extra-arrears" class="hidden space-y-3">
                            <div class="p-3 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/40">
                <div class="flex items-start gap-2">
                  <input id="notice-arrears-autofill" type="checkbox" class="h-4 w-4 mt-1" checked>
                  <div class="flex-1">
                    <label for="notice-arrears-autofill" class="text-sm font-semibold">ØªØ¹Ø¨Ø¦Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…</label>
                    <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">ÙŠØ­Ø³Ø¨ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª Ù…Ù† Ø§Ù„Ø¯ÙØ¹Ø§Øª/Ø§Ù„Ø´ÙŠÙƒØ§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ÙˆÙ‡Ø°Ù‡ Ø§Ù„ÙˆØ­Ø¯Ø©. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©.</div>
                    <button type="button" onclick="autofillNoticeArrears(true)" class="mt-2 px-3 py-1.5 rounded-lg border text-sm hover:bg-gray-100 dark:hover:bg-gray-700">ğŸ”„ ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>
                  </div>
                </div>
              </div>
<div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                <div>
                  <label class="block text-sm font-semibold mb-1">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚Ø¯</label>
                  <input id="notice-contract-value" type="number" class="w-full border p-2 rounded-lg dark:bg-gray-800 dark:text-white" placeholder="Ù…Ø«Ø§Ù„: 47500" oninput="resetNoticePreview()">
                </div>
                <div>
                  <label class="block text-sm font-semibold mb-1">Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª / Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</label>
                  <input id="notice-arrears-amount" type="number" class="w-full border p-2 rounded-lg dark:bg-gray-800 dark:text-white" placeholder="Ù…Ø«Ø§Ù„: 14000" oninput="resetNoticePreview()">
                </div>
              </div>

              <div>
                <label class="block text-sm font-semibold mb-1">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input id="notice-arrears-details" class="w-full border p-2 rounded-lg dark:bg-gray-800 dark:text-white" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ (Ø´ÙŠÙƒ Ø±Ø§Ø¬Ø¹ Ù„Ø¹Ø¯Ù… ÙƒÙØ§ÙŠØ© Ø§Ù„Ø±ØµÙŠØ¯)" oninput="resetNoticePreview()">
              </div>
            </div>
          </div>

<div>
            <label class="block text-sm font-semibold mb-1">Ø¹Ù†ÙˆØ§Ù†/Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø®Ø·Ø§Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="notice-subject" class="w-full border p-2 rounded-lg" placeholder="Ù…Ø«Ø§Ù„: Ø¥Ù†Ø°Ø§Ø± Ø±Ø³Ù…ÙŠ..." oninput="resetNoticePreview()">
          </div>

          
<div class="grid grid-cols-1 sm:grid-cols-3 gap-2 pt-2">
  <button id="notice-preview-btn" type="button" class="btn-ui btn-filter">Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
  <button id="notice-print-draft-btn" type="button" class="bg-slate-600 hover:bg-slate-700 text-white py-2 rounded-lg shadow disabled:opacity-50" disabled>ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©</button>
  <button id="notice-print-final-btn" type="button" class="btn-ui btn-success" disabled>âœ… Ø§Ø¹ØªÙ…Ø§Ø¯ ÙˆØ·Ø¨Ø§Ø¹Ø©</button>
</div>

<div class="text-xs text-gray-500 dark:text-gray-400 leading-relaxed">
            Ù…Ù„Ø§Ø­Ø¸Ø©: ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ© ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙØ­Ø© ÙˆØ±Ø¨Ø·Ù‡Ø§ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù…. <b>Ù†ØµÙˆØµ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ø±Ø³Ù…ÙŠØ© ÙˆØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</b> Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„Ù‡Ø§ ÙÙŠ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ© Ø­Ø³Ø¨ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø®Ø·Ø§Ø¨ Ø§Ù„Ù…Ø±ÙÙ‚.
          </div>
        </div>
      </div>

      <!-- Ù…Ø¹Ø§ÙŠÙ†Ø© -->
      <div class="bg-white p-6 rounded-2xl lg:col-span-2">
        <div class="flex items-center justify-between mb-3 no-print">
          <h3 class="font-bold text-gray-700 dark:text-gray-200">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø®Ø·Ø§Ø¨</h3>
          <span id="notice-preview-status" class="text-xs text-gray-500 dark:text-gray-400"></span>
        </div>

        <div id="notice-preview" class="border rounded-2xl p-6 min-h-[460px] bg-gray-50 dark:bg-gray-900/20">
          <div class="text-center text-gray-500 dark:text-gray-400">
            Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ÙˆÙ†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø§Ø¨ Ø«Ù… Ø§Ø¶ØºØ· <b>Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø§ÙŠÙ†Ø©</b>.
          </div>
        </div>
      </div>
    </div>
  
      <div class="mt-4 no-print">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-2 mb-2">
          <h3 class="font-bold text-gray-700 dark:text-gray-200">Ø³Ø¬Ù„ Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©</h3>
          <div class="flex items-center gap-2">
            <input id="notice-log-search" type="text" class="ui-field" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø®Ø·Ø§Ø¨ Ø£Ùˆ Ø§Ù„ÙˆØ­Ø¯Ø©..." />
            <button id="notice-undo-last-btn" type="button" class="text-sm bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 px-3 py-2 rounded-xl">
              â†©ï¸ ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø¢Ø®Ø± Ø§Ø¹ØªÙ…Ø§Ø¯
            </button>
          </div>
        </div>
        <div id="notice-log" class="border rounded-2xl p-4 bg-gray-50 dark:bg-gray-900/20 text-sm text-gray-700 dark:text-gray-200">
          <div class="text-gray-500 dark:text-gray-400">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ù†Ø°Ø§Ø±Ø§Øª Ù…Ø¹ØªÙ…Ø¯Ø© Ø¨Ø¹Ø¯.</div>
        </div>
        <p class="mt-2 text-[11px] text-gray-500 dark:text-gray-400">
          Ù…Ù„Ø§Ø­Ø¸Ø©: <b>Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©</b> Ù„Ø§ ØªØ³ØªÙ‡Ù„Ùƒ Ø±Ù‚Ù… Ø®Ø·Ø§Ø¨ ÙˆÙ„Ø§ ØªÙØ³Ø¬Ù‘ÙÙ„ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„. Ø£Ù…Ø§ <b>Ø§Ø¹ØªÙ…Ø§Ø¯ ÙˆØ·Ø¨Ø§Ø¹Ø©</b> ÙÙŠØªÙ… Ø­ÙØ¸Ù‡Ø§ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ Ù…Ø¹ Ø§Ù„Ø±Ù‚Ù….
        </p>
      </div>

</section>


  <!-- ============= SETTINGS ============= -->
  <section id="settings-view" class="view hidden">
    <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-white">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h2>
    <div class="grid grid-cols-1 md:grid-cols-1 gap-6">
      <div class="bg-white p-6 rounded-xl shadow-sm">
        <h3 class="font-bold mb-4 flex items-center gap-2">ğŸ“¦ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ (Backup)</h3>
        <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Ù‚Ù… Ø¨ØªØµØ¯ÙŠØ± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„ÙŠÙ‡Ø§ Ø£Ùˆ Ù†Ù‚Ù„Ù‡Ø§.</p>
        <div class="flex flex-wrap gap-2">
          <button onclick="exportBackupJSON()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow text-sm">ØªØµØ¯ÙŠØ± (JSON)</button>
          <button onclick="exportBackupExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow text-sm">ØªØµØ¯ÙŠØ± (Excel)</button>
        </div>
      </div>
      <div class="bg-white p-6 rounded-xl shadow-sm">
        <h3 class="font-bold mb-4 flex items-center gap-2">ğŸ“¥ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
        <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Ø§Ø³ØªØ±Ø¬Ø¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ù† Ù…Ù„Ù JSON Ù…Ø­ÙÙˆØ¸ Ù…Ø³Ø¨Ù‚Ø§Ù‹.</p>
        <input type="file" id="backup-file" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100 mb-3" onchange="importBackup(event)">
        <p id="backup-msg" class="text-xs h-4"></p>
      </div>
      <div class="bg-white p-6 rounded-xl shadow-sm">
        <h3 class="font-bold mb-4 flex items-center gap-2">ğŸ’° Ø·Ø±ÙŠÙ‚Ø© Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±</h3>
        <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Ø§Ø®ØªØ± Ù‡Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ù…Ø¯Ø®Ù„Ø© Ù„Ù„ÙˆØ­Ø¯Ø© ØªÙ…Ø«Ù„ Ù…Ø¨Ù„ØºÙ‹Ø§ Ø³Ù†ÙˆÙŠÙ‹Ø§ Ø£Ù… Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚Ø¯ ÙƒØ§Ù…Ù„Ø©. Ø³ÙŠØ¤Ø«Ø± Ù‡Ø°Ø§ Ø¹Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±.</p>
        <label class="block text-sm font-semibold mb-2">Ø§Ù„Ù‚ÙŠÙ…Ø© ØªÙ…Ø«Ù„</label>
        <select id="rent-basis-select" class="w-full border border-gray-200 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-gray-800 dark:text-white" onchange="saveRentBasisSetting()">
          <option value="total">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚Ø¯ ÙƒØ§Ù…Ù„Ø©</option>
          <option value="annual">Ø¥ÙŠØ¬Ø§Ø± Ø³Ù†ÙˆÙŠ</option>
        </select>
        <p class="text-xs text-gray-400 mt-2">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¥Ø°Ø§ Ø§Ø®ØªØ±Øª "Ø¥ÙŠØ¬Ø§Ø± Ø³Ù†ÙˆÙŠ" ÙØ³ÙŠØªÙ… Ø¶Ø±Ø¨Ù‡ ÙÙŠ Ù…Ø¯Ø© Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„ÙØ¹Ù„ÙŠØ©.</p>
      </div>

      <div class="bg-white p-6 rounded-xl shadow-sm border border-rose-100 dark:border-rose-900">
        <h3 class="font-bold mb-4 text-rose-700">âš ï¸ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø®Ø·Ø±</h3>
        <button onclick="if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ ØªÙ…Ø§Ù…Ø§Ù‹ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø´ÙŠØ¡ ÙˆØªÙØ±ÙŠØº Ø§Ù„Ù†Ø¸Ø§Ù…!')) clearAllData()" class="bg-rose-100 text-rose-700 hover:bg-rose-200 px-4 py-2 rounded w-full text-sm font-bold">ÙØ±Ù…ØªÙ‡ Ø§Ù„Ù†Ø¸Ø§Ù… (Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)</button>
      </div>
    </div>
  </section>

  <!-- ============= MODALS ============= -->

  <!-- Property Modal -->
  <div id="property-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="modal-content modal-glass rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden animate-[fadeIn_0.2s_ease-out]">
      <div class="modal-header-glass p-6 border-b bg-gray-50 dark:bg-gray-700 dark:border-gray-600 flex justify-between items-center">
        <h3 class="text-xl font-bold">Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø§Ø± Ø¬Ø¯ÙŠØ¯</h3>
        <button onclick="closePropertyModal()" class="text-gray-400 hover:text-gray-600">âœ•</button>
      </div>
      <form id="property-form" class="p-6 grid grid-cols-1 gap-4">
        <input id="prop-id" placeholder="Ø±Ù…Ø² Ø§Ù„Ø¹Ù‚Ø§Ø± (Ù…Ø«Ø§Ù„: PRP001)" class="border p-2 rounded w-full" required>
        <input id="prop-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±" class="border p-2 rounded w-full" required>
        <div class="grid grid-cols-2 gap-4">
          <input id="prop-type" placeholder="Ø§Ù„Ù†ÙˆØ¹ (ÙÙŠÙ„Ø§/Ø¨Ù†Ø§ÙŠØ©)" class="border p-2 rounded">
          <input id="prop-usage" placeholder="Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…" class="border p-2 rounded">
        </div>
        <input id="prop-location" placeholder="Ø§Ù„Ù…ÙˆÙ‚Ø¹" class="border p-2 rounded">
        <div class="modal-actions flex justify-end gap-3 mt-4">
          <button type="button" onclick="closePropertyModal()" class="btn-ui btn-reset">Ø¥Ù„ØºØ§Ø¡</button>
          <button class="btn-ui btn-success">Ø­ÙØ¸</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Unit Modal -->
  <div id="unit-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="modal-content modal-glass rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden">
      <div class="modal-header-glass p-6 border-b bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
        <h3 class="text-xl font-bold">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©</h3>
      </div>
      <form id="unit-form" class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="hidden" id="unit-prop-id">
        <input type="hidden" id="unit-id">
        
        <div class="md:col-span-2">
          <label class="text-xs text-gray-500 dark:text-gray-400">Ø§Ø³Ù… Ø§Ù„ÙˆØ­Ø¯Ø©</label>
          <input id="unit-name" class="border p-2 rounded w-full" placeholder="Ù…Ø«Ø§Ù„: 10-A">
        </div>
        <div class="md:col-span-2">
          <label class="text-xs text-gray-500 dark:text-gray-400">Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©</label>
          <input id="unit-code" class="border p-2 rounded w-full font-mono" placeholder="Ù…Ø«Ø§Ù„: UNT83609">
        </div>


        
        <div class="md:col-span-2 border-t dark:border-gray-600 pt-4 mt-2">
          <p class="font-bold text-gray-700 dark:text-gray-300 mb-2">Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø¯Ù…Ø§Øª</p>
        </div>
        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">Ø±Ù‚Ù… Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</label>
          <input id="unit-elec-meter-no" class="border p-2 rounded w-full font-mono" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ">
        </div>
        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">Ø±Ù‚Ù… Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ÙŠØ§Ù‡</label>
          <input id="unit-water-meter-no" class="border p-2 rounded w-full font-mono" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ">
        </div>

        <div class="md:col-span-2">
          <label class="text-xs text-gray-500 dark:text-gray-400">Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ù‚Ø§Ø± (Ø·Ø§Ù‚Ø©)</label>
          <input id="unit-property-id" class="border p-2 rounded w-full font-mono bg-gray-50 dark:bg-gray-800 dark:text-gray-100" placeholder="Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºÙ‹Ø§ Ø§Ù„Ø¢Ù† (Ø³ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„Ù‡ Ù„Ø§Ø­Ù‚Ù‹Ø§)">
        </div>




        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">Ø§Ù„Ù†ÙˆØ¹</label>
          <input id="unit-type" class="border p-2 rounded w-full">
        </div>
        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</label>
          <input id="unit-usage" class="border p-2 rounded w-full">
        </div>
        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">Ø§Ù„Ø­Ø§Ù„Ø©</label>
          <select id="unit-status" class="border p-2 rounded w-full">
            <option value="Ø´Ø§ØºØ±Ø©">Ø´Ø§ØºØ±Ø©</option>
            <option value="Ù…Ø¤Ø¬Ø±Ø©">Ù…Ø¤Ø¬Ø±Ø©</option>
          </select>
        </div>
        <div class="md:col-span-2 border-t dark:border-gray-600 pt-4 mt-2">
          <p class="font-bold text-gray-700 dark:text-gray-300 mb-2">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø¥Ù† ÙˆØ¬Ø¯)</p>
        </div>
        <div class="md:col-span-2 text-xs text-gray-500 dark:text-gray-400 -mt-2">
          Ø³ÙŠØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø´ÙƒÙ„: <span class="font-semibold" id="unit-display-preview">10-A</span>
        </div>
        <div class="md:col-span-2">
          <input id="unit-tenant" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±" class="border p-2 rounded w-full">
        </div>
        <div>
          <input id="unit-rent" type="number" placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±ÙŠØ©" class="border p-2 rounded w-full">
        </div>
        <div>
          <input id="unit-contractNo" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯" class="border p-2 rounded w-full">
        </div>
        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯</label>
          <input id="unit-start" type="date" class="border p-2 rounded w-full">
        </div>
        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯</label>
          <input id="unit-end" type="date" class="border p-2 rounded w-full">
        </div>
        <div class="md:col-span-2 flex justify-end gap-3 mt-4 border-t dark:border-gray-600 pt-4">
          <button type="button" onclick="closeUnitModal()" class="btn-ui btn-reset">Ø¥Ù„ØºØ§Ø¡</button>
          <button class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 shadow">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Lease Modal -->
  <div id="lease-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="modal-content modal-glass rounded-xl shadow-2xl w-full max-w-lg">
      <form id="lease-form" class="p-6 space-y-4">
        <h3 class="font-bold text-lg mb-4">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯</h3>
        <input type="hidden" id="lease-prop-id">
        <input type="hidden" id="lease-unit-id">
        <input id="lease-tenant" class="w-full border p-2 rounded" placeholder="Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±" required>
        <div class="grid grid-cols-2 gap-2">
          <input id="lease-phone" class="border p-2 rounded" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
          <input id="lease-email" type="email" class="border p-2 rounded" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
        </div>
        <div class="grid grid-cols-2 gap-2">
          <input id="lease-paymentsCount" type="number" min="0" class="border p-2 rounded" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª">
          <input id="lease-chequesCount" type="number" min="0" class="border p-2 rounded" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø´ÙŠÙƒØ§Øª">
        </div>
        <div class="grid grid-cols-2 gap-2">
          <input id="lease-bankGuarantee" type="number" min="0" class="border p-2 rounded" placeholder="Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¨Ù†ÙƒÙŠ">
          <select id="lease-tenantType" class="border p-2 rounded">
            <option value="">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±...</option>
            <option value="company">Ø´Ø±ÙƒØ©</option>
            <option value="individual">ÙØ±Ø¯</option>
          </select>
        </div>
        <div id="lease-companyFields" class="hidden">
          <input id="lease-tradeLicense" class="w-full border p-2 rounded" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø±Ø®ØµØ© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ© (Ù„Ù„Ø´Ø±ÙƒØ§Øª)">
        </div>
        <div id="lease-personFields" class="hidden">
          <input id="lease-idNumber" class="w-full border p-2 rounded" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© (Ù„Ù„Ø£ÙØ±Ø§Ø¯)">
        </div>

        <div class="grid grid-cols-2 gap-2">
          <input id="lease-rent" type="number" class="border p-2 rounded" placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø©">
          <input id="lease-contractNo" class="border p-2 rounded" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯">
        </div>
        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="text-xs">Ù…Ù†</label>
            <input id="lease-start" type="date" class="w-full border p-2 rounded">
          </div>
          <div>
            <label class="text-xs">Ø¥Ù„Ù‰</label>
            <input id="lease-end" type="date" class="w-full border p-2 rounded">
          </div>
        </div>
        <select id="lease-status" class="w-full border p-2 rounded">
          <option value="Ù…Ø¤Ø¬Ø±Ø©">Ù…Ø¤Ø¬Ø±Ø©</option>
        </select>
        <div class="flex justify-between pt-4">
          <button type="button" onclick="cancelLease()" class="text-rose-600 hover:bg-rose-50 dark:hover:bg-rose-900/20 px-3 py-1 rounded">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù‚Ø¯ ÙˆØ¥Ø®Ù„Ø§Ø¡ Ø§Ù„ÙˆØ­Ø¯Ø©</button>
          <div class="flex gap-2">
            <button type="button" onclick="closeLeaseModal()" class="btn-ui btn-reset">Ø¥Ù„ØºØ§Ø¡</button>
            <button class="btn-ui btn-success">Ø­ÙØ¸</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Lease Modal -->
  <div id="add-lease-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="modal-content modal-glass rounded-xl shadow-2xl w-full max-w-lg">
      <form id="add-lease-form" class="p-6 space-y-4">
        <h3 class="font-bold text-xl mb-4">Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯</h3>
        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">Ø§Ù„Ø¹Ù‚Ø§Ø±</label>
          <select id="add-lease-prop" class="w-full border p-2 rounded"></select>
        </div>
        
        <div class="border border-gray-200 dark:border-gray-700 rounded-xl p-3 bg-white/50 dark:bg-white/5">
          <div class="flex items-center justify-between gap-3">
            <label class="text-xs text-gray-500 dark:text-gray-400">ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯ (ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† ÙˆØ­Ø¯Ø©)</label>
            <button type="button" onclick="addLeaseUnitRow()" class="btn-ui btn-secondary no-print">+ Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø¯Ø©</button>
          </div>

          <div class="mt-2 overflow-auto">
            <table class="min-w-full text-sm">
              <thead>
                <tr class="text-xs text-gray-500 dark:text-gray-400 border-b border-gray-200 dark:border-gray-700">
                  <th class="text-right py-2 px-2 w-2/3">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                  <th class="text-right py-2 px-2 w-1/3">Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø³Ù†ÙˆÙŠ (AED)</th>
                  <th class="py-2 px-2 w-10"></th>
                </tr>
              </thead>
              <tbody id="add-lease-units-body"></tbody>
            </table>
          </div>

          <div class="mt-2 flex items-center justify-between text-sm">
            <div class="text-gray-600 dark:text-gray-300">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø³Ù†ÙˆÙŠ</div>
            <div id="add-lease-total-rent" class="font-extrabold text-gray-900 dark:text-white">0</div>
          </div>
          <div id="add-lease-units-error" class="text-rose-600 text-sm mt-2"></div>
        </div>

        <input id="add-lease-tenant" class="w-full border p-2 rounded" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±" required>
        <div class="grid grid-cols-2 gap-3">
          <input id="add-lease-phone" class="border p-2 rounded" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
          <input id="add-lease-email" type="email" class="border p-2 rounded" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
        </div>
        <div class="grid grid-cols-2 gap-3">
          <input id="add-lease-paymentsCount" type="number" min="0" class="border p-2 rounded" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª">
          <input id="add-lease-chequesCount" type="number" min="0" class="border p-2 rounded" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø´ÙŠÙƒØ§Øª">
        </div>
        <div class="grid grid-cols-2 gap-3">
          <input id="add-lease-bankGuarantee" type="number" min="0" class="border p-2 rounded" placeholder="Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¨Ù†ÙƒÙŠ">
          <select id="add-lease-tenantType" class="border p-2 rounded">
            <option value="">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±...</option>
            <option value="company">Ø´Ø±ÙƒØ©</option>
            <option value="individual">ÙØ±Ø¯</option>
          </select>
        </div>
        <div id="add-lease-companyFields" class="hidden">
          <input id="add-lease-tradeLicense" class="w-full border p-2 rounded" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø±Ø®ØµØ© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ© (Ù„Ù„Ø´Ø±ÙƒØ§Øª)">
        </div>
        <div id="add-lease-personFields" class="hidden">
          <input id="add-lease-idNumber" class="w-full border p-2 rounded" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© (Ù„Ù„Ø£ÙØ±Ø§Ø¯)">
        </div>

        <div>
          <input id="add-lease-contractNo" class="w-full border p-2 rounded" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯">
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-xs text-gray-500 dark:text-gray-400">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡</label>
            <input id="add-lease-start" type="date" class="w-full border p-2 rounded">
          </div>
          <div>
            <label class="text-xs text-gray-500 dark:text-gray-400">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</label>
            <input id="add-lease-end" type="date" class="w-full border p-2 rounded">
          </div>
        </div>
        <div id="add-lease-errors" class="text-rose-600 text-sm"></div>
        <div class="flex justify-end gap-3 pt-4">
          <button type="button" onclick="closeAddLeaseModal()" class="btn-ui btn-reset">Ø¥Ù„ØºØ§Ø¡</button>
          <button class="btn-ui btn-success">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø¯</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Payment Modal -->
  <div id="payment-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="modal-content modal-glass rounded-xl shadow-2xl w-full max-w-lg">
      <form id="payment-form" class="p-6 space-y-4">
        <h3 class="font-bold text-lg">ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
        <input id="pay-date" type="date" class="w-full border p-2 rounded" required>
        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">Ø§Ù„Ø¹Ù‚Ø¯</label>
          <select id="pay-contract" class="w-full border p-2 rounded"></select>
        </div>
        <select id="pay-type" class="w-full border p-2 rounded">
          <option>Ù†Ù‚Ø¯ÙŠ</option>
          <option>Ø´ÙŠÙƒ</option>
          <option>ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option>
        </select>
        <input id="pay-amount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº (AED)" class="w-full border p-2 rounded font-bold text-lg" required>
        <input id="pay-desc" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª / ÙˆØµÙ" class="w-full border p-2 rounded">
        <div class="flex justify-end gap-3 pt-4">
          <button type="button" onclick="closePaymentModal()" class="btn-ui btn-reset">Ø¥Ù„ØºØ§Ø¡</button>
          <button class="btn-ui btn-success">Ø­ÙØ¸ Ø§Ù„Ø¯ÙØ¹Ø©</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Tenant Modal -->
  <div id="tenant-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="modal-content modal-glass rounded-xl shadow-2xl w-full max-w-md p-6">
      <h3 class="font-bold text-lg mb-4">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</h3>
      <form id="tenant-form" class="space-y-4">
        <input id="tenant-name" class="w-full border p-2 rounded bg-gray-100 dark:bg-gray-700" readonly>
        <input id="tenant-phone" class="w-full border p-2 rounded" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
        <input id="tenant-email" class="w-full border p-2 rounded" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
        <select id="tenant-type" class="w-full border p-2 rounded">
          <option value="">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±...</option>
          <option value="company">Ø´Ø±ÙƒØ©</option>
          <option value="individual">ÙØ±Ø¯</option>
        </select>
        <div id="tenant-companyFields" class="hidden">
          <input id="tenant-tradeLicense" class="w-full border p-2 rounded" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø±Ø®ØµØ© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ© (Ù„Ù„Ø´Ø±ÙƒØ§Øª)">
        </div>
        <div id="tenant-personFields" class="hidden">
          <input id="tenant-idNumber" class="w-full border p-2 rounded" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© (Ù„Ù„Ø£ÙØ±Ø§Ø¯)">
        </div>

        <div class="flex justify-end gap-2 pt-2">
          <button type="button" onclick="closeTenantModal()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded text-gray-800">Ø¥ØºÙ„Ø§Ù‚</button>
          <button class="btn-ui btn-success">Ø­ÙØ¸</button>
        </div>
        <div id="tenant-save-status" class="text-xs text-gray-500 text-right"></div>
      </form>
    </div>
  </div>

  <!-- Cheque Modal -->
  <div id="cheque-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="modal-content modal-glass rounded-xl shadow-2xl w-full max-w-lg">
      <form id="new-cheque-form" class="p-6 space-y-4">
        <h3 id="cheque-modal-title" class="font-bold text-lg border-b pb-2 dark:border-gray-600">ØªØ³Ø¬ÙŠÙ„ Ø´ÙŠÙƒ Ø¬Ø¯ÙŠØ¯</h3>

        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</label>
          <select id="cheque-tenant-select" class="w-full border p-2 rounded" onchange="toggleTenantInput()">
            <option value="">Ø§Ø®ØªØ± Ù…Ø³ØªØ£Ø¬Ø± Ø­Ø§Ù„ÙŠ...</option>
            <option value="other">-- Ù…Ø³ØªØ£Ø¬Ø± Ø¬Ø¯ÙŠØ¯ / Ø¢Ø®Ø± --</option>
          </select>
          <input id="cheque-tenant-manual" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ÙŠØ¯ÙˆÙŠØ§Ù‹" class="w-full border p-2 rounded mt-2 hidden">
        </div>

        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">Ø§Ù„ÙˆØ­Ø¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <select id="cheque-unit-select" class="w-full border p-2 rounded" disabled>
            <option value="">â€” Ø¨Ø¯ÙˆÙ† Ø±Ø¨Ø· ÙˆØ­Ø¯Ø© â€”</option>
          </select>
          <p class="text-[11px] text-gray-500 dark:text-gray-400 mt-1">Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª Ø¨Ø¯Ù‚Ø©ØŒ ÙŠÙÙØ¶Ù‘Ù„ Ø±Ø¨Ø· Ø§Ù„Ø´ÙŠÙƒ Ø¨ÙˆØ­Ø¯Ø© Ù…Ø­Ø¯Ø¯Ø©.</p>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="text-xs text-gray-500 dark:text-gray-400">Ø±Ù‚Ù… Ø§Ù„Ø´ÙŠÙƒ</label>
            <input id="cheque-number" class="w-full border p-2 rounded" required>
          </div>
          <div>
            <label class="text-xs text-gray-500 dark:text-gray-400">Ø§Ù„Ù‚ÙŠÙ…Ø©</label>
            <input id="cheque-value" type="number" class="w-full border p-2 rounded" required>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="text-xs text-gray-500 dark:text-gray-400">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</label>
            <input id="cheque-due-date" type="date" class="w-full border p-2 rounded" required>
          </div>
          <div>
            <label class="text-xs text-gray-500 dark:text-gray-400">Ø§Ù„Ø¨Ù†Ùƒ</label>
            <input id="cheque-bank" class="w-full border p-2 rounded">
          </div>
        </div>

        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400 block mb-1">ØµÙˆØ±Ø© Ø§Ù„Ø´ÙŠÙƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="cheque-image" type="file" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
        </div>

        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
          <input id="cheque-purpose" class="w-full border p-2 rounded">
        </div>

        <div class="flex justify-end gap-3 pt-4 border-t dark:border-gray-700">
          <button type="button" onclick="closeChequeModal()" class="btn-ui btn-reset">Ø¥Ù„ØºØ§Ø¡</button>
          <button class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded" id="cheque-modal-save-btn">Ø­ÙØ¸ Ø§Ù„Ø´ÙŠÙƒ</button>
        </div>
      </form>
    </div>
  
  <!-- ============= CHEQUE LINK MODAL (Link cheque to unit) ============= -->
  <div id="cheque-link-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="modal-content modal-glass rounded-xl shadow-2xl w-full max-w-lg">
      <div class="p-6 space-y-4">
        <h3 class="font-bold text-lg border-b pb-2 dark:border-gray-600">Ø±Ø¨Ø· Ø§Ù„Ø´ÙŠÙƒ Ø¨ÙˆØ­Ø¯Ø©</h3>
        <div id="cheque-link-info" class="text-sm text-gray-600 dark:text-gray-300"></div>
        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø©</label>
          <select id="cheque-link-unit-select" class="w-full border p-2 rounded"></select>
          <p class="text-[11px] text-gray-500 dark:text-gray-400 mt-1">Ø§Ù„Ø±Ø¨Ø· ÙŠØ³Ø§Ø¹Ø¯ ÙÙŠ Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø®Ø§ØµØ© Ø¨ÙƒÙ„ ÙˆØ­Ø¯Ø©.</p>
        </div>
        <div class="flex justify-end gap-3 pt-4 border-t dark:border-gray-700">
          <button type="button" onclick="closeChequeLinkModal()" class="btn-ui btn-reset">Ø¥Ù„ØºØ§Ø¡</button>
          <button type="button" onclick="confirmChequeLink()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">Ø­ÙØ¸ Ø§Ù„Ø±Ø¨Ø·</button>
        </div>
      </div>
    </div>
  <!-- Lease Payment Modal (Multi-unit contract payments) -->
  <div id="lease-payment-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="modal-content relative max-w-4xl mx-auto mt-10 bg-white dark:bg-dark-surface rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700 overflow-hidden">
      <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between gap-3">
        <div class="font-extrabold text-gray-800 dark:text-white" id="lease-pay-title">ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø©</div>
        <button class="px-3 py-1.5 rounded-lg text-sm font-bold bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600"
                onclick="document.getElementById('lease-payment-modal').classList.add('hidden')">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>

      <div class="p-4 max-h-[70vh] overflow-auto">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
          <div>
            <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹Ø©</label>
            <input id="lease-pay-date" type="date" class="w-full px-3 py-2 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-dark-surface" />
          </div>
          <div>
            <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</label>
            <input id="lease-pay-total" type="text" placeholder="Ù…Ø«Ø§Ù„: 190000" class="w-full px-3 py-2 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-dark-surface" oninput="updateLeasePaySum()" />
          </div>
          <div>
            <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
            <select id="lease-pay-method" class="w-full px-3 py-2 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-dark-surface">
              <option>ØªØ­ÙˆÙŠÙ„</option>
              <option>Ù†Ù‚Ø¯</option>
              <option>Ø´ÙŠÙƒ</option>
              <option>Ø£Ø®Ø±Ù‰</option>
            </select>
          </div>
          <div>
            <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Ù…Ø±Ø¬Ø¹</label>
            <input id="lease-pay-ref" type="text" placeholder="Ø±Ù‚Ù… Ø­ÙˆØ§Ù„Ø© / Ø´ÙŠÙƒ" class="w-full px-3 py-2 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-dark-surface" />
          </div>
        </div>

        <div class="mt-4 flex items-center justify-between gap-3">
          <div class="text-sm font-bold text-gray-700 dark:text-gray-200">
            Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ØªÙˆØ²ÙŠØ¹: <span id="lease-pay-sum" class="font-mono">0 AED</span>
            <span class="mx-2">|</span>
            Ø§Ù„ÙØ±Ù‚: <span id="lease-pay-diff" class="font-mono text-red-600 dark:text-red-300">0 AED</span>
          </div>
          <div class="flex items-center gap-2">
            <button class="px-3 py-2 rounded-xl bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-sm font-bold"
                    onclick="autoDistributeLeasePayment()">ØªÙˆØ²ÙŠØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>
          </div>
        </div>

        <div class="mt-3 rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden">
          <div class="bg-gray-50 dark:bg-gray-800 px-3 py-2 text-sm font-extrabold text-gray-700 dark:text-gray-200">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¯ÙØ¹Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø§Øª</div>
          <div class="overflow-x-auto">
            <table class="min-w-full text-right text-sm">
              <thead class="bg-white dark:bg-dark-surface">
                <tr class="text-xs text-gray-500 dark:text-gray-400">
                  <th class="py-2 px-2">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                  <th class="py-2 px-2">Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                  <th class="py-2 px-2">Ø§Ù„Ù…Ø³ØªÙ„Ù… Ø³Ø§Ø¨Ù‚Ø§Ù‹</th>
                  <th class="py-2 px-2">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                  <th class="py-2 px-2">Ù…Ø¨Ù„Øº Ù…Ø®ØµØµ</th>
                </tr>
              </thead>
              <tbody id="lease-pay-units-body"></tbody>
            </table>
          </div>
        </div>

        <div class="mt-4 flex items-center justify-end gap-2">
          <button class="px-4 py-2 rounded-xl bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 font-bold"
                  onclick="document.getElementById('lease-payment-modal').classList.add('hidden')">Ø¥Ù„ØºØ§Ø¡</button>
          <button class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white font-extrabold"
                  onclick="saveLeasePayment()">Ø­ÙØ¸ Ø§Ù„Ø¯ÙØ¹Ø©</button>
        </div>
      </div>
    </div>
  </div>


  </div>

</div>

<script>
  // ================= DATA =================
  const initialProperties = [
    {
      "id": "PRP65351",
      "name": "ÙÙŠÙ„Ø§",
      "type": "ÙÙŠÙ„Ø§",
      "usage": "Ø³ÙƒÙ† Ø®Ø§Øµ",
      "location": "Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø¹ÙŠÙ† - ÙÙ„Ø¬ Ù‡Ø²Ø§Ø¹",
      "units": [
        {
          "id": "PRP65351_U1",
          "name": "ÙÙŠÙ„Ø§",
          "type": "ÙÙŠÙ„Ø§",
          "usage": "Ø³ÙƒÙ†ÙŠ",
          "status": "Ù…Ø¤Ø¬Ø±Ø©",
          "tenant": "HAMDAN ABDULLA ANAYAT GHULAM MOHAMMED",
          "rent": 100000,
          "contractNo": "202402876023",
          "start": "2024-10-15",
          "end": "2025-10-14"
        }
      ]
    },
    {
      "id": "PRP11751",
      "name": "Ø¨Ù†Ø§Ø¡ Ø²Ù‡Ø±Ø§Ø¡ ÙˆÙ„Ø·ÙŠÙØ© ÙˆØ¹Ø§ÙŠØ´Ø© Ø¹Ø¨ÙŠØ¯ Ø¨Ø§Ù„Ø´ÙˆØ§Ø±Ø¨",
      "type": "Ø¨Ù†Ø§ÙŠØ©",
      "usage": "ØªØ¬Ø§Ø±ÙŠ - ØµÙ†Ø§Ø¹ÙŠ",
      "location": "Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø¹ÙŠÙ† - Ø¨Ø·Ø­Ø§Ø¡ Ø§Ù„Ø­Ø§Ø¦Ø±",
      "units": [
        { "id":"UNT83591","name":"10-A","type":"Ù…ÙƒØªØ¨","usage":"ØªØ¬Ø§Ø±ÙŠ","status":"Ø´Ø§ØºØ±Ø©" },
        { "id":"UNT83609","name":"10-B","type":"Ù…ÙƒØªØ¨","usage":"ØªØ¬Ø§Ø±ÙŠ","status":"Ù…Ø¤Ø¬Ø±Ø©","tenant":"KASHMIR AL KHDHRA TILES & PLASTER WORKS EST","rent":9000,"contractNo":"202501709877","start":"2025-03-01","end":"2026-02-28" }
      ]
    }
  ];

  let properties = [], cheques = [], expenses = [], payments = [], leasePayments = [], leaseAllocations = [], tenantsContacts = {}, salaries = [];
  let editingChequeId = null;
  let pendingChequeAfterEditId = null;
  let pendingChequeAfterEditStatus = '';

  let currentTenantKey = null; // internal: active tenant key for modal

  let contractLogs = JSON.parse(localStorage.getItem('logs') || "[]");

  // Default header info
  const defaultHeader = {
    name: 'Ø¨Ù†Ø§ÙŠØ© ÙˆØ±Ø«Ø© Ø¬Ù…Ø¹Ø© Ø¹Ø¨ÙŠØ¯ Ø£Ø¨ÙˆØ§Ù„Ø´ÙˆØ§Ø±Ø¨',
    location: 'Ø§Ù„Ø¹ÙŠÙ†ØŒ Ø¨Ø·Ø­Ø§Ø¡ Ø§Ù„Ø­Ø§Ø¦Ø±',
    phone: '00971503343600'
  };

  // Voucher counters (sequential numbers)
  let voucherCounters = { receipt: 1, expense: 1, salary: 1 };

  // ================= UTILS & LOCAL STORAGE =================
  function formatAED(n){ return (n||0).toLocaleString('en-US') + ' AED'; }
  function tenantKey(name){ return String(name||'').trim().replace(/\s+/g,' ').toLowerCase(); }

  function parseAED(v){
    if(v===null||v===undefined) return 0;
    const s = String(v).replace(/,/g,'').replace(/[^\d.\-]/g,'').trim();
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  }

  function sumLeasePaidForUnit(contractNo, propId, unitId){
    const cn = String(contractNo||'');
    return (leaseAllocations||[]).filter(a=>String(a.contractNo||'')===cn && String(a.propId||'')===String(propId||'') && String(a.unitId||'')===String(unitId||''))
      .reduce((s,a)=>s + (Number(a.amount)||0), 0);
  }

  function sumLeasePaidForContract(contractNo){
    const cn = String(contractNo||'');
    return (leaseAllocations||[]).filter(a=>String(a.contractNo||'')===cn)
      .reduce((s,a)=>s + (Number(a.amount)||0), 0);
  }


  // ===== Tenant type UI (company / individual) =====
  function applyTenantTypeUI(prefix){
    // prefix could be: 'add-lease', 'lease', 'tenant'
    const typeEl = document.getElementById(prefix + (prefix==='tenant' ? '-type' : '-tenantType'));
    const type = (typeEl?.value || '').trim();
    const companyBox = document.getElementById(prefix + (prefix==='tenant' ? '-companyFields' : '-companyFields'));
    const personBox  = document.getElementById(prefix + (prefix==='tenant' ? '-personFields' : '-personFields'));
    if(companyBox) companyBox.classList.toggle('hidden', type !== 'company');
    if(personBox)  personBox.classList.toggle('hidden', type !== 'individual');
  }

  // ===== Units schema (Unit No / Unit Name / Unique UID) =====
  function genUnitId(){
    // Generate municipality-style unit id: UNT + 5 digits (unique in current data)
    const used = new Set();
    try{
      (properties||[]).forEach(p=> (p.units||[]).forEach(u=>{
        const id = String(u.id||'').trim();
        if(id) used.add(id);
      }));
    }catch(e){}
    let tries = 0;
    while(tries < 5000){
      const num = Math.floor(10000 + Math.random()*90000); // 5 digits
      const id = 'UNT' + num;
      if(!used.has(id)) return id;
      tries++;
    }
    // fallback
    return 'UNT' + String(Date.now()).slice(-5);
  }

  function unitLabel(u){
    if(!u) return '';
    const nm = String(u.unitName || u.name || '').trim();
    if(nm) return nm;
    const no = String(u.unitNo || '').trim();
    const title = String(u.unitTitle || '').trim();
    if(no && title) return `${no}-${title}`;
    if(no) return no;
    if(title) return title;
    return '';
  }

  function ensureUnitFields(u){
    if(!u) return;
    if(u.id == null) u.id = '';

// If new fields missing, infer from legacy "name"
    const hasNew = (u.unitNo != null) || (u.unitTitle != null) || (u.unitName != null);
    if(!hasNew){
      const raw = String(u.name || '').trim();
      if(raw.includes('-')){
        const parts = raw.split('-').map(s=>s.trim()).filter(Boolean);
        u.unitNo = parts[0] || '';
        u.unitTitle = parts.slice(1).join(' - ');
      } else {
        // If looks like a code (contains digits) treat as Unit No; otherwise treat as Unit Name
        if(/[0-9]/.test(raw) || /^[A-Za-z]{1,3}\s*\d+/.test(raw)){
          u.unitNo = raw;
          u.unitTitle = '';
        } else {
          u.unitNo = '';
          u.unitTitle = raw;
        }
      }
    }

    // âœ… Normalize combined unit name (Ù…Ø«Ù„ Ø§Ù„Ø¨Ù„Ø¯ÙŠØ©: 10-A)
    if(u.unitName == null || String(u.unitName).trim()===''){
      const no = String(u.unitNo||'').trim();
      const title = String(u.unitTitle||'').trim();
      if(no && title) u.unitName = `${no}-${title}`.replace(/\s*-\s*/g,'-');
      else u.unitName = (no || title || String(u.name||'').trim());
    } else {
      u.unitName = String(u.unitName).trim().replace(/\s*-\s*/g,'-');
    }

    // Ø§Ø´ØªÙ‚Ø§Ù‚ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ù„Ù„ØªÙˆØ§ÙÙ‚
    if((u.unitNo == null || String(u.unitNo).trim()==='') && u.unitName.includes('-')){
      const parts = u.unitName.split('-').map(s=>s.trim()).filter(Boolean);
      if(parts.length>=2){
        u.unitNo = parts[0];
        u.unitTitle = parts.slice(1).join('-');
      }
    }

    if(u.unitNo == null) u.unitNo = '';
    if(u.unitTitle == null) u.unitTitle = '';

    // âœ… Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø¯Ù…Ø§Øª (Ø§ÙØªØ±Ø§Ø¶ÙŠ)
    if(u.elecMeterNo == null) u.elecMeterNo = '';
    if(u.waterMeterNo == null) u.waterMeterNo = '';
    if(u.taqaPropertyId == null) u.taqaPropertyId = '';
    // Keep legacy display name in sync for existing UI parts
    u.name = unitLabel(u);
  }

  function ensureUnitsSchema(){
    if(!Array.isArray(properties)) return;
    properties.forEach(p=>{
      if(!p.units) p.units = [];
      p.units.forEach(u=>{
        ensureUnitFields(u);
        if(!Array.isArray(u.leaseHistory)) u.leaseHistory = [];
      });
    });
  }


  function normalizeChequeStatus(status){
    const s = String(status ?? '').trim();
    if(!s) return '';
    const ns = s.toLowerCase();

    // Arabic / English mappings
    if(ns.includes('Ù…ØµØ±ÙˆÙ') || ns.includes('ØªÙ… Ø§Ù„ØµØ±Ù') || ns.includes('ØµØ±Ù') || ns.includes('cashed') || ns.includes('cleared') || ns.includes('paid')) return 'Ù…ØµØ±ÙˆÙ';
    if(ns.includes('Ø±Ø§Ø¬Ø¹') || ns.includes('Ù…Ø±ØªØ¬Ø¹') || ns.includes('Ù…Ø±ÙÙˆØ¶') || ns.includes('returned') || ns.includes('bounce') || ns.includes('bounced')) return 'Ø±Ø§Ø¬Ø¹';
    if(ns.includes('Ø¨Ø§Ù†ØªØ¸Ø§Ø±') || ns.includes('Ù‚ÙŠØ¯') || ns.includes('pending') || ns.includes('await') || ns.includes('waiting') || ns.includes('not cashed')) return 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØµØ±Ù';

    // Already canonical?
    if(s === 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØµØ±Ù' || s === 'Ù…ØµØ±ÙˆÙ' || s === 'Ø±Ø§Ø¬Ø¹') return s;

    return s; // keep as-is (won't match buckets unless mapped above)
  }

  function normalizeChequeRecord(c){
    const out = { ...(c||{}) };

    // Normalize common field names from older versions
    out.id = out.id || out.chequeId || out.checkId || ('CHQ-' + Date.now() + Math.floor(Math.random()*1000));
    out.tenant = out.tenant || out.tenantName || out.tenant_name || out.name || out.client || '';
    out.chequeNo = out.chequeNo || out.number || out.chequeNumber || out.cheque_number || out.no || '';
    out.value = Number(out.value ?? out.amount ?? out.due ?? out.total ?? 0) || 0;
    out.dueDate = out.dueDate || out.date || out.due_date || out.due_at || '';
    out.bank = out.bank || out.bankName || out.bank_name || '';
    out.purpose = out.purpose || out.desc || out.description || '';
    out.unitId = out.unitId || out.unit || out.unit_id || out.unitID || '';
    out.unitLabel = out.unitLabel || out.unitName || out.unit_name || '';
    out.imageUrl = out.imageUrl || out.image || out.imgUrl || null;

    out.status = normalizeChequeStatus(out.status);
    if(!out.status){
      // Default based on due date (if any)
      try{
        out.status = (out.dueDate && new Date(out.dueDate) < new Date()) ? 'Ø±Ø§Ø¬Ø¹' : 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØµØ±Ù';
      }catch(e){
        out.status = 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØµØ±Ù';
      }
    }
    return out;
  }

  function chequeStatusBucket(status){
    const s = normalizeChequeStatus(status);
    if(s === 'Ø±Ø§Ø¬Ø¹') return 'returned';
    if(s === 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØµØ±Ù') return 'pending';
    if(s === 'Ù…ØµØ±ÙˆÙ') return 'cashed';
    return 'other';
  }



  function chequeStatusLabelEn(status){
    const s = normalizeChequeStatus(status);
    if(s === 'Ø±Ø§Ø¬Ø¹') return 'Returned';
    if(s === 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØµØ±Ù') return 'Pending';
    if(s === 'Ù…ØµØ±ÙˆÙ') return 'Cashed';
    return 'Other';
  }

  




  

  // ======= Lease duration helpers (for reports: contract full value) =======
  function toUTCDate(dateStr){
    if(!dateStr) return null;
    const parts = String(dateStr).split('-').map(Number);
    if(parts.length !== 3) return null;
    const [y,m,d] = parts;
    if(!y || !m || !d) return null;
    // noon UTC to avoid timezone edge cases
    return new Date(Date.UTC(y, m-1, d, 12, 0, 0));
  }

  // Returns contract duration in years (can be fractional). End date is treated as inclusive.
  function contractYears(startStr, endStr){
    const start = toUTCDate(startStr);
    const end = toUTCDate(endStr);
    if(!start || !end) return 1;

    const endPlus1 = new Date(end.getTime());
    endPlus1.setUTCDate(endPlus1.getUTCDate() + 1);

    // If aligned on same day-of-month => exact month count (handles leap years cleanly)
    if(endPlus1.getUTCDate() === start.getUTCDate()){
      const months = (endPlus1.getUTCFullYear() - start.getUTCFullYear()) * 12
                   + (endPlus1.getUTCMonth() - start.getUTCMonth());
      const years = months / 12;
      return years > 0 ? years : 1;
    }

    const msPerDay = 24 * 60 * 60 * 1000;
    const days = Math.round((endPlus1 - start) / msPerDay);
    const years = days / 365.25;
    return years > 0 ? years : 1;
  }

  function calcContractValueFromAnnual(annualRent, startStr, endStr){
    const annual = Number(annualRent) || 0;
    return annual * contractYears(startStr, endStr);
  }


  // ================= RENT BASIS (annual vs total) =================
  function getRentBasis(){
    return localStorage.getItem('re_rent_basis') || 'total'; // 'total' | 'annual'
  }

  function calcUnitContractValue(u){
    const rent = (u && u.rent) ? Number(u.rent) : 0;
    if(!rent) return 0;
    const basis = getRentBasis();
    if(basis === 'annual'){
      return calcContractValueFromAnnual(rent, u.start, u.end);
    }
    return rent; // total contract value
  }

  function updateRentLabels(){
    const basis = getRentBasis();
    const lbl = document.getElementById('total-rent-label');
    if(lbl){
      lbl.textContent = (basis === 'annual')
        ? 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¯ (Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø³Ù†ÙˆÙŠ Ã— Ù…Ø¯Ø© Ø§Ù„Ø¹Ù‚Ø¯)'
        : 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¯';
    }
  }

  function loadRentBasisSetting(){
    const sel = document.getElementById('rent-basis-select');
    if(sel) sel.value = getRentBasis();
    updateRentLabels();
  }

  function saveRentBasisSetting(){
    const sel = document.getElementById('rent-basis-select');
    if(!sel) return;
    localStorage.setItem('re_rent_basis', sel.value);
    updateRentLabels();
    updateDashboard();
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ù„Ùˆ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø© Ø£Ùˆ Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù†Øª Ù…Ø®ÙÙŠØ©
    try{ renderReports(); } catch(e){}
  }


  // ===== Lease History (Keep old contracts in reports) =====
  function ensureLeaseHistory(u){
    if(!u) return;
    if(!Array.isArray(u.leaseHistory)) u.leaseHistory = [];
  }

  function unitHasLeaseData(u){
    if(!u) return false;
    const hasMoney = Number(u.rent || 0) > 0;
    const hasText = !!(u.tenant || u.contractNo || u.start || u.end);
    return hasMoney || hasText;
  }

  function archiveUnitLease(u, reason, statusOverride){
    if(!u) return false;
    if(!unitHasLeaseData(u)) return false;
    ensureLeaseHistory(u);

    const entry = {
      tenant: u.tenant || '',
      rent: Number(u.rent || 0),
      contractNo: u.contractNo || '',
      start: u.start || '',
      end: u.end || '',
      status: normalizeLeaseStatus(statusOverride || (u.status || '')),
      prevStatus: u.status || '',
      reason: reason || '',
      archivedAt: new Date().toISOString()
    };
    u.leaseHistory.push(entry);
    return true;
  }

  function getAllLeaseRecords(){
    const records = [];
    (properties || []).forEach(p=>{
      (p.units || []).forEach(u=>{
        // current
        if(u.status !== 'Ø´Ø§ØºØ±Ø©' && unitHasLeaseData(u)){
          records.push({
            propId: p.id,
            propName: p.name,
            unitId: u.id,
            unitName: u.name,
            tenant: u.tenant || '',
            rent: Number(u.rent || 0),
            contractNo: u.contractNo || '',
            start: u.start || '',
            end: u.end || '',
            status: normalizeLeaseStatus(u.status || ''),
            reason: 'Ø­Ø§Ù„ÙŠ',
            archivedAt: ''
          });
        }
        // history
        ensureLeaseHistory(u);
        u.leaseHistory.forEach(h=>{
          records.push({
            propId: p.id,
            propName: p.name,
            unitId: u.id,
            unitName: u.name,
            tenant: h.tenant || '',
            rent: Number(h.rent || 0),
            contractNo: h.contractNo || '',
            start: h.start || '',
            end: h.end || '',
            status: normalizeLeaseStatus(h.status || ''),
            reason: h.reason || '',
            archivedAt: h.archivedAt || ''
          });
        });
      });
    });
    // sort: newest first (by archivedAt, else end, else start)
    records.sort((a,b)=>{
      const da = a.archivedAt ? new Date(a.archivedAt) : (a.end ? new Date(a.end) : (a.start ? new Date(a.start) : new Date(0)));
      const db = b.archivedAt ? new Date(b.archivedAt) : (b.end ? new Date(b.end) : (b.start ? new Date(b.start) : new Date(0)));
      return db - da;
    });
    return records;
  }

  function normalizeLeaseStatus(status){
    const s = (status || '').trim();
    if(s === 'Ù…Ø³ØªØ¨Ø¯Ù„Ø©' || s === 'Ø§Ø³ØªØ¨Ø¯Ø§Ù„') return 'ØªØ¬Ø¯ÙŠØ¯ Ø¹Ù‚Ø¯';
    return s;
  }

  // ===== Lease computed status (based on dates) =====
  function _leaseDateLocalNum(s){
    const v = (s||'').toString().slice(0,10);
    if(!v) return NaN;
    const d = new Date(v + 'T00:00:00');
    const t = d.getTime();
    return Number.isFinite(t) ? t : NaN;
  }

  function leaseContractStatusFromDates(start, end){
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
    const e = _leaseDateLocalNum(end);
    if(!Number.isFinite(e)) return 'Ø³Ø§Ø±ÙŠ';
    if(e < today) return 'Ù…Ù†ØªÙ‡ÙŠ';
    const daysLeft = Math.floor((e - today) / 86400000);
    if(daysLeft <= 30) return 'Ø´Ø§Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡';
    return 'Ø³Ø§Ø±ÙŠ';
  }

  function leaseContractStatusOrder(label){
    if(label === 'Ù…Ù†ØªÙ‡ÙŠ') return 0;
    if(label === 'Ø´Ø§Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡') return 1;
    return 2; // Ø³Ø§Ø±ÙŠ
  }

  function leaseContractBadgeClass(label){
    if(label === 'Ù…Ù†ØªÙ‡ÙŠ') return 'badge badge-crimson';
    if(label === 'Ø´Ø§Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡') return 'badge badge-orange';
    return 'badge badge-emerald';
  }
  // ===== /Lease computed status =====



  function leaseStatusLabel(status){
    return normalizeLeaseStatus(status);
  }

  function leaseStatusBadge(status){
    status = normalizeLeaseStatus(status);
    if(status === 'Ù…Ø¤Ø¬Ø±Ø©') return 'badge badge-green';
    if(status === 'Ù…Ù†ØªÙ‡ÙŠØ©') return 'badge badge-red';
    if(status === 'Ù…Ù„ØºØ§Ø©') return 'badge badge-red';
    if(status === 'ØªØ¬Ø¯ÙŠØ¯ Ø¹Ù‚Ø¯') return 'badge badge-amber';
    if(status === 'Ù…Ø³ØªØ¨Ø¯Ù„Ø©') return 'badge badge-amber';
    if(status === 'Ù…Ø®Ù„Ù‰') return 'badge badge-red';
    return 'badge';
  }

  function renderLeaseArchiveReport(){
    const tbody = document.getElementById('report-leases-body');
    if(!tbody) return;

    const statusSel = document.getElementById('report-lease-status-filter');
    const qInput = document.getElementById('report-lease-search');
    const empty = document.getElementById('report-leases-empty');
    const counts = document.getElementById('report-leases-counts');

    // bind once
    if(statusSel && !statusSel.dataset.bound){
      statusSel.dataset.bound = '1';
      statusSel.addEventListener('change', renderLeaseArchiveReport);
    }
    if(qInput && !qInput.dataset.bound){
      qInput.dataset.bound = '1';
      qInput.addEventListener('input', renderLeaseArchiveReport);
    }

    const statusFilter = statusSel ? statusSel.value : 'all';
    const q = (qInput ? qInput.value : '').trim().toLowerCase();

    let recs = getAllLeaseRecords();

    // counts
    const c = { all: recs.length, active:0, ended:0, cancelled:0, renewed:0, vacated:0 };
    recs.forEach(r=>{
      if(normalizeLeaseStatus(r.status)==='Ù…Ø¤Ø¬Ø±Ø©') c.active++;
      else if(normalizeLeaseStatus(r.status)==='Ù…Ù†ØªÙ‡ÙŠØ©') c.ended++;
      else if(normalizeLeaseStatus(r.status)==='Ù…Ù„ØºØ§Ø©') c.cancelled++;
      else if(normalizeLeaseStatus(r.status)==='ØªØ¬Ø¯ÙŠØ¯ Ø¹Ù‚Ø¯') c.renewed++;
      else if(normalizeLeaseStatus(r.status)==='Ù…Ø®Ù„Ù‰') c.vacated++;
    });
    if(counts){
      counts.textContent = `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${c.all} â€¢ Ù…Ø¤Ø¬Ø±Ø©: ${c.active} â€¢ Ù…Ù†ØªÙ‡ÙŠØ©: ${c.ended} â€¢ Ù…Ù„ØºØ§Ø©: ${c.cancelled} â€¢ ØªØ¬Ø¯ÙŠØ¯ Ø¹Ù‚Ø¯: ${c.renewed} â€¢ Ù…Ø®Ù„Ù‰: ${c.vacated}`;
    }

    if(statusFilter !== 'all'){
      recs = recs.filter(r => normalizeLeaseStatus(r.status) === statusFilter);
    }

    if(q){
      recs = recs.filter(r=>{
        const hay = `${r.propName} ${r.unitName} ${r.tenant} ${r.contractNo}`.toLowerCase();
        return hay.includes(q);
      });
    }

    tbody.innerHTML = '';
    if(empty) empty.classList.add('hidden');

    if(recs.length === 0){
      if(empty){
        empty.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚ÙˆØ¯ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«/Ø§Ù„ÙÙ„ØªØ±.';
        empty.classList.remove('hidden');
      }
      return;
    }

    recs.forEach(r=>{
      const tr = document.createElement('tr');
      const archivedDate = r.archivedAt ? (new Date(r.archivedAt).toLocaleDateString('ar-AE')) : '-';
      tr.innerHTML = `
        <td class="px-3 py-3">
          <div class="font-bold text-gray-800 dark:text-white">${r.unitName || '-'}</div>
          <div class="text-xs text-gray-500 dark:text-gray-400">${r.propName || '-'}</div>
        </td>
        <td class="px-3 py-3 text-sm">${r.tenant || '-'}</td>
        <td class="px-3 py-3 font-mono text-emerald-700 dark:text-emerald-400">${formatAED(r.rent || 0)}</td>
        <td class="px-3 py-3 text-xs font-mono bg-gray-100 dark:bg-gray-800 rounded truncate-text" title="${r.contractNo || ''}">${r.contractNo || '-'}</td>
        <td class="px-3 py-3 text-xs">${r.start || '-'}</td>
        <td class="px-3 py-3 text-xs">${r.end || '-'}</td>
        <td class="px-3 py-3"><span class="${leaseStatusBadge(r.status)}">${leaseStatusLabel(r.status) || '-'}</span></td>
        <td class="px-3 py-3 text-xs text-gray-700 dark:text-gray-300">${r.reason || '-'}</td>
        <td class="px-3 py-3 text-xs">${archivedDate}</td>
      `;
      tbody.appendChild(tr);
    });
  }


function logAction(msg){
    contractLogs.unshift({m:msg, t:new Date().toISOString()});
    if(contractLogs.length>50) contractLogs.pop();
    localStorage.setItem('logs', JSON.stringify(contractLogs));
    renderLogs();
  }

  function clearLogs(){
    contractLogs=[];
    localStorage.setItem('logs','[]');
    renderLogs();
  }

  function saveToLocal(){
    localStorage.setItem('re_data_v2', JSON.stringify({ properties, cheques, expenses, payments, leasePayments, leaseAllocations, tenantsContacts, salaries }));
  }

  function loadFromLocal(){
    const d = localStorage.getItem('re_data_v2');
    if(d){
      try {
        const o = JSON.parse(d);
        if(o.properties) properties = o.properties;
        
        // Migration: ensure unit schema (unitNo/unitTitle/uid) + leaseHistory array
        ensureUnitsSchema();
cheques = o.cheques || [];
        expenses = o.expenses || [];
        payments = o.payments || [];
        
        if(o.leasePayments) leasePayments = o.leasePayments;
        if(o.leaseAllocations) leaseAllocations = o.leaseAllocations;
// migrate tenantsContacts to normalized keys for reliable saving/loading
        const rawContacts = o.tenantsContacts || {};
        tenantsContacts = {};
        Object.keys(rawContacts).forEach(k=>{
          const v = rawContacts[k] || {};
          const nk = tenantKey(v.name || k);
          if(!nk) return;
          if(!tenantsContacts[nk]){
            tenantsContacts[nk] = {
              name: v.name || k,
              phone: v.phone || '',
              email: v.email || '',
              tenantType: v.tenantType || v.type || '',
              tradeLicenseNo: v.tradeLicenseNo || v.tradeLicense || '',
              idNumber: v.idNumber || v.idNo || ''
            };
          } else {
            // merge (keep existing if already set)
            tenantsContacts[nk].phone = tenantsContacts[nk].phone || (v.phone||'');
            tenantsContacts[nk].email = tenantsContacts[nk].email || (v.email||'');
            tenantsContacts[nk].tenantType = tenantsContacts[nk].tenantType || (v.tenantType || v.type || '');
            tenantsContacts[nk].tradeLicenseNo = tenantsContacts[nk].tradeLicenseNo || (v.tradeLicenseNo || v.tradeLicense || '');
            tenantsContacts[nk].idNumber = tenantsContacts[nk].idNumber || (v.idNumber || v.idNo || '');
          }
        });
        salaries = o.salaries || [];

        // Migration: ensure expenses have ID & type
        expenses = expenses.map(e => ({
          id: e.id || 'EXP-' + Date.now() + Math.floor(Math.random()*1000),
          date: e.date,
          type: e.type || 'Ø£Ø®Ø±Ù‰',
          amount: e.amount,
          details: e.details,
          voucherNo: e.voucherNo || null
        }));

        // Migration: normalize cheques (compatibility across versions)
        cheques = (o.cheques || []).map(normalizeChequeRecord);
        // Auto-infer unit link for cheques when the tenant has exactly one leased unit
        cheques = cheques.map(c=>{
          const nc = normalizeChequeRecord(c);
          if(!nc.unitId){
            const inferred = inferSingleLeasedUnitIdForTenant(nc.tenant);
            if(inferred) nc.unitId = inferred;
          }
          if(nc.unitId && !nc.unitLabel){
            nc.unitLabel = getUnitDisplayById(nc.unitId);
          }
          return nc;
        });

        // Migrate old cheque-linked payments to the proper unit label/unitId (if possible)
        (payments||[]).forEach(p=>{
          if(p && p.chequeId){
            migrateChequePaymentsToUnit(p.chequeId);
          }
        });

} catch(e){
        console.error("Error loading data", e);
      }
    } else {
      properties = JSON.parse(JSON.stringify(initialProperties));
      ensureUnitsSchema();
      saveToLocal();
    }
    ensureVoucherNumbers();
  }

  function extractVoucherNumber(code){
    if(!code) return null;
    const parts = String(code).split('-');
    const numPart = parts[parts.length - 1];
    const n = parseInt(numPart, 10);
    return isNaN(n) ? null : n;
  }

  function recomputeVoucherCounters(){
    voucherCounters = { receipt:1, expense:1, salary:1 };
    payments.forEach(p => {
      const n = extractVoucherNumber(p.voucherNo);
      if(n && n >= voucherCounters.receipt) voucherCounters.receipt = n + 1;
    });
    expenses.forEach(e => {
      const n = extractVoucherNumber(e.voucherNo);
      if(n && n >= voucherCounters.expense) voucherCounters.expense = n + 1;
    });
    salaries.forEach(s => {
      const n = extractVoucherNumber(s.voucherNo);
      if(n && n >= voucherCounters.salary) voucherCounters.salary = n + 1;
    });
  }

  function nextVoucherNumber(type){
    if(!voucherCounters[type]) voucherCounters[type] = 1;
    const prefixMap = { receipt:'R', expense:'P', salary:'S' };
    const prefix = prefixMap[type] || 'V';
    const n = voucherCounters[type]++;
    return `${prefix}-${String(n).padStart(4,'0')}`;
  }

  function ensureVoucherNumbers(){
    recomputeVoucherCounters();
    let updated = false;

    payments.forEach(p => {
      if(!p.voucherNo){
        p.voucherNo = nextVoucherNumber('receipt');
        updated = true;
      }
    });
    expenses.forEach(e => {
      if(!e.voucherNo){
        e.voucherNo = nextVoucherNumber('expense');
        updated = true;
      }
    });
    salaries.forEach(s => {
      if(!s.voucherNo){
        s.voucherNo = nextVoucherNumber('salary');
        updated = true;
      }
    });

    if(updated) saveToLocal();
  }

  // ================= VIEW LOGIC =================
  function showView(id){
    // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡ÙˆÙŠØ©/Ø§Ù„Ø±Ø®ØµØ© Ù„Ù„Ù…Ø³ØªØ£Ø¬Ø± Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ù…ÙØªÙˆØ­Ø©
    try{
      const tm = document.getElementById('tenant-modal');
      if(tm && !tm.classList.contains('hidden')){
        persistTenantContact({silent:true});
      }
    }catch(e){}
    document.querySelectorAll('.view').forEach(v=>v.classList.add('hidden'));
    document.getElementById(id+'-view')?.classList.remove('hidden');
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById('nav-'+id)?.classList.add('active');

    if(id==='dashboard') updateDashboard();
    else if(id==='properties') renderProperties();
    else if(id==='leases') renderLeases();
    else if(id==='tenants') renderTenants();
    else if(id==='cheques') renderCheques();
    else if(id==='payments') renderPayments();
    else if(id==='expenses') renderExpenses();
    else if(id==='salaries') renderSalaries();
    else if(id==='receipts-history') renderReceiptsHistory();
    else if(id==='reports') renderReports();
    else if(id==='notices') renderNotices();
  }


  // ================= NOTICES / LETTERS =================

  const NOTICE_LETTERHEAD = {
    topLines: [
      'Ø¨Ù†Ø§ÙŠØ© ÙˆØ±Ø«Ø© Ø¬Ù…Ø¹Ø© Ø¹Ø¨ÙŠØ¯ Ø£Ø¨Ùˆ Ø§Ù„Ø´ÙˆØ§Ø±Ø¨',
      'Ø§Ù„Ø¹ÙŠÙ†ØŒ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ©ØŒ Ø¨Ø·Ø­Ø§Ø¡ Ø§Ù„Ø­Ø§Ø¦Ø±',
      '24-04-014-18'
    ],
    footerLines: [
      'Mohammed Abdulrahim Ahli',
      'UAE, Al Ain',
      'Po Box: 1148',
      '+971503343600',
      'Mohd_Ahli@live.com'
    ]
  };

  // Notices UI preferences (signature/attachments)
  function persistNoticeUiPrefs(){
    try{
      const prefs = {
        showSig: document.getElementById('notice-show-signature')?.checked ?? true,
        showSeal: document.getElementById('notice-show-seal')?.checked ?? true,
        showAtt: document.getElementById('notice-show-attachments')?.checked ?? true,
        attCustom: document.getElementById('notice-attachments-custom')?.value || ''
      };
      localStorage.setItem('re_notice_prefs', JSON.stringify(prefs));
    }catch(e){}
  }
  function loadNoticeUiPrefs(){
    let prefs = {};
    try{ prefs = JSON.parse(localStorage.getItem('re_notice_prefs') || '{}') || {}; }catch(e){ prefs = {}; }

    const sig = document.getElementById('notice-show-signature');
    const seal = document.getElementById('notice-show-seal');
    const att = document.getElementById('notice-show-attachments');
    const custom = document.getElementById('notice-attachments-custom');

    if(sig) sig.checked = (prefs.showSig !== false);
    if(seal) seal.checked = (prefs.showSeal !== false);
    if(att) att.checked = (prefs.showAtt !== false);
    if(custom) custom.value = (prefs.attCustom || '');
  }

  function getDefaultNoticeAttachments(tpl){
    if(tpl === 'eviction'){
      return {
        ar: ['Ø¨Ø±Ø§Ø¡Ø© Ø°Ù…Ø© ÙƒÙ‡Ø±Ø¨Ø§Ø¡/Ù…ÙŠØ§Ù‡ Ù…Ù† Ø·Ø§Ù‚Ø© Ù„Ù„ØªÙˆØ²ÙŠØ¹ (TAQA Distribution).'],
        en: ['TAQA Distribution clearance certificate (Electricity/Water).']
      };
    }
    if(tpl === 'increase5'){
      return {
        ar: ['Ù…Ù„Ø­Ù‚/Ø¥Ø´Ø¹Ø§Ø± Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø¨Ù†Ø³Ø¨Ø© 5% (Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©).'],
        en: ['5% rent increase addendum/notice (as per applicable procedures).']
      };
    }
    if(tpl === 'arrearsRenew'){
      return {
        ar: ['ÙƒØ´Ù Ø­Ø³Ø§Ø¨/Ø¨ÙŠØ§Ù† Ø¨Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª ÙˆØ§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©.'],
        en: ['Statement of arrears / remaining balance.']
      };
    }
    if(tpl === 'arrearsCheque'){
      return {
        ar: ['ØµÙˆØ±Ø© Ø§Ù„Ø´ÙŠÙƒ Ø§Ù„Ø±Ø§Ø¬Ø¹ (Ø¥Ù† ÙˆØ¬Ø¯).','ÙƒØ´Ù Ø­Ø³Ø§Ø¨/Ø¨ÙŠØ§Ù† Ø¨Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª.'],
        en: ['Copy of returned cheque (if any).','Statement of arrears.']
      };
    }
    return { ar: [], en: [] };
  }

  function parseCustomAttachments(){
    const t = document.getElementById('notice-attachments-custom')?.value || '';
    return t.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
  }



  function getRentBasisSetting(){ return localStorage.getItem('re_rent_basis') || 'total'; }

  
  function getUsedNoticeRefs(){
    try { return JSON.parse(localStorage.getItem('re_notice_used_refs') || '[]') || []; }
    catch(e){ return []; }
  }
  function setUsedNoticeRefs(arr){
    try { localStorage.setItem('re_notice_used_refs', JSON.stringify((arr||[]).slice(-2000))); }
    catch(e){}
  }
  function formatNoticeCode(n){
    return 'NT-' + String(n).padStart(5,'0');
  }
  function getNoticeCounter(){
    let n = parseInt(localStorage.getItem('re_notice_counter') || '1', 10);
    if(!n || n < 1) n = 1;
    return n;
  }
  function setNoticeCounter(n){
    localStorage.setItem('re_notice_counter', String(n));
  }
  // Returns the next available notice number WITHOUT consuming it (no increment).
  function getNextAvailableNoticeNo(){
    let n = getNoticeCounter();
    const used = getUsedNoticeRefs();
    let code = formatNoticeCode(n);
    while(used.includes(code)){
      n += 1;
      code = formatNoticeCode(n);
    }
    // Keep counter aligned to the first available value (not yet committed)
    setNoticeCounter(n);
    return code;
  }
  // Backward compatible alias
  function getNextNoticeNo(){
    return getNextAvailableNoticeNo();
  }
  // Commit the current reference so it won't be reused, and advance counter.
  function commitNoticeNo(ref){
    const code = String(ref || '').trim();
    if(!code) return;

    const used = getUsedNoticeRefs();
    if(!used.includes(code)){
      used.push(code);
      setUsedNoticeRefs(used);
    }

    const m = /^NT-(\d{5})$/.exec(code);
    if(m){
      const num = parseInt(m[1], 10);
      let counter = getNoticeCounter();
      if(num >= counter) counter = num + 1;
      setNoticeCounter(counter);
    }
  }


  function formatEnglishDate(dateStr){
    const d = dateStr ? new Date(dateStr) : new Date();
    if(isNaN(d)) return '';
    return d.toLocaleDateString('en-GB', { day:'2-digit', month:'long', year:'numeric' });
  }

  function formatArabicDate(dateStr){
    const d = dateStr ? new Date(dateStr) : new Date();
    if(isNaN(d)) return '';
    return d.toLocaleDateString('ar-AE', { year:'numeric', month:'long', day:'numeric' });
  }

  function formatDMY(dateStr){
    const d = dateStr ? new Date(dateStr) : new Date();
    if(isNaN(d)) return '';
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const yyyy = d.getFullYear();
    return `${dd}-${mm}-${yyyy}`;
  }


  function findUnitByComposite(composite){
    if(!composite) return { prop:null, unit:null };
    const [pid, uid] = String(composite).split('::');
    const prop = properties.find(p => String(p.id) === String(pid)) || null;
    const unit = prop?.units?.find(u => String(u.id) === String(uid)) || null;
    return { prop, unit };
  }

  function textToHtml(s){
    const raw = String(s||'').replace(/\r\n/g,'\n').trim();
    if(!raw) return '';
    const blocks = raw.split(/\n\s*\n+/g);
    const out = [];
    for(const b of blocks){
      const lines = b.split('\n').map(x=>x.trim()).filter(Boolean);
      if(!lines.length) continue;
      const isList = lines.every(l => /^[-â€¢*]\s+/.test(l));
      if(isList){
        const items = lines.map(l => escHtml(l.replace(/^[-â€¢*]\s+/, '').trim()));
        out.push('<ul class="letter-list">' + items.map(i=>`<li>${i}</li>`).join('') + '</ul>');
      }else{
        const txt = escHtml(lines.join(' '));
        out.push(`<p class="letter-p">${txt}</p>`);
      }
    }
    return out.join('');
  }

  function updateNoticeExtraOptions(){
    const tpl = document.getElementById('notice-template-select')?.value || 'blank';
    const box = document.getElementById('notice-extra-options');
    if(!box) return;

    const isIncrease = tpl === 'increase5';
    const isArrears = (tpl === 'arrearsRenew' || tpl === 'arrearsCheque');

    box.classList.toggle('hidden', !(isIncrease || isArrears));

    const incBox = document.getElementById('notice-extra-increase5');
    if(incBox) incBox.classList.toggle('hidden', !isIncrease);

    const arrBox = document.getElementById('notice-extra-arrears');
    if(arrBox) arrBox.classList.toggle('hidden', !isArrears);
  }


  // ===== Notices: Auto arrears calculation =====
  function normalizeMatchStr(v){
    return String(v||'')
      .toLowerCase()
      .replace(/\s+/g,'')
      .replace(/[â€“â€”\-_/\\]+/g,'');
  }

  function noticeUnitMatchTokens(ctx, unit, prop){
    const strict = [];
    const loose = [];
    const add = (arr, x)=>{ if(x!==undefined && x!==null && String(x).trim()) arr.push(String(x).trim()); };

    // Strict identifiers (reduce false matches)
    add(strict, unit?.id);
    add(strict, unit?.code);
    add(strict, unit?.unitCode);
    add(strict, unit?.name);
    add(strict, ctx?.contractNo);

    // Loose identifiers (fallback if no matches found)
    strict.forEach(x=> add(loose, x));
    add(loose, prop?.id);
    add(loose, prop?.name);

    const uniq = (arr)=> Array.from(new Set(arr));
    return { strict: uniq(strict), loose: uniq(loose) };
  }

  function paymentMatchesNoticeUnit(p, tokens){
    const hay = normalizeMatchStr([p.unit, p.contract, p.desc, p.type, p.voucherNo].filter(Boolean).join(' | '));
    if(!hay) return false;
    return tokens.some(t=>{
      const nt = normalizeMatchStr(t);
      return nt && hay.includes(nt);
    });
  }

  function chequeMatchesUnitTokens(c, tokens){
    const hay = normalizeMatchStr([c.tenant, c.purpose, c.chequeNo, c.bank].filter(Boolean).join(' | '));
    if(!hay) return false;
    return tokens.some(t=>{
      const nt = normalizeMatchStr(t);
      return nt && hay.includes(nt);
    });
  }

  function computeNoticeUnitPaid(ctx, unit, prop){
    const tokenSets = noticeUnitMatchTokens(ctx, unit, prop);
    const tkey = tenantKey(ctx?.tenantName);

    const matchTokens = (tokens)=> payments.filter(p=>{
      if(tenantKey(p.tenant) !== tkey) return false;

      // Direct unitId match (best signal when available)
      if(p.unitId && unit && unit.id && p.unitId === unit.id) return true;

      // Direct match (unit/contract/description)
      if(paymentMatchesNoticeUnit(p, tokens)) return true;

      // If this payment came from a cashed cheque, try to match on cheque purpose too
      if(p.chequeId){
        const chRaw = cheques.find(c=>c.id === p.chequeId);
        const ch = chRaw ? normalizeChequeRecord(chRaw) : null;
        if(ch){
          const hay2 = normalizeMatchStr([ch.purpose, ch.chequeNo, ch.bank].filter(Boolean).join(' | '));
          return tokens.some(t=>{
            const nt = normalizeMatchStr(t);
            return nt && hay2.includes(nt);
          });
        }
      }
      return false;
    });

    // Prefer strict matching; if nothing found, fallback to loose matching
    let matchedPayments = matchTokens(tokenSets.strict);
    if(matchedPayments.length === 0){
      matchedPayments = matchTokens(tokenSets.loose);
    }

    let paid = matchedPayments.reduce((s,p)=> s + Number(p.amount||0), 0);

    // ---- Cheques suggestions (returned / pending) ----
    // We primarily filter by the same tenant; if we can match by unit tokens (purpose/cheque text), we prefer that.
    const tenantChequesAll = cheques
      .map(normalizeChequeRecord)
      .filter(c => tenantKey(c.tenant) === tkey);

    const unitId = unit && unit.id ? unit.id : '';
    const linked = unitId ? tenantChequesAll.filter(c=> (c.unitId||'') === unitId) : [];
    const tenantCheques = linked.length ? linked : tenantChequesAll;

    // ---- Include cashed cheques as paid when no payment record exists (legacy/imported data) ----
    // Some older data may have cheques marked as "Ù…ØµØ±ÙˆÙ" without a corresponding payment entry.
    // To keep notices accurate, we add those cheque values to paid (while avoiding double counting).
    const pickCashed = (tokens)=>{
      const list = tenantCheques.filter(c => chequeStatusBucket(c.status) === 'cashed');
      if(list.length === 0) return [];
      const matched = list.filter(c => {
        // Direct unitId match is best when available
        if(unitId && (c.unitId||'') && (c.unitId||'') === unitId) return true;
        return chequeMatchesUnitTokens(c, tokens);
      });
      return matched;
    };

    let cashedCheques = pickCashed(tokenSets.strict);
    if(cashedCheques.length === 0) cashedCheques = pickCashed(tokenSets.loose);

    const cashedMissingPayment = cashedCheques.filter(c => !(payments||[]).some(p => p.chequeId === c.id));
    const cashedExtraPaid = cashedMissingPayment.reduce((s,c)=> s + Number(c.value||0), 0);
    if(cashedExtraPaid) paid += cashedExtraPaid;


    const pickCheques = (bucket, tokens)=>{
      const list = tenantCheques.filter(c => chequeStatusBucket(c.status) === bucket);
      if(list.length === 0) return [];

      const matched = list.filter(c => {
        // âœ… Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø´ÙŠÙƒ Ù…Ø±Ø¨ÙˆØ·Ù‹Ø§ Ø¨Ù†ÙØ³ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©ØŒ Ø§Ø¹ØªØ¨Ø±Ù‡ Ù…Ø·Ø§Ø¨Ù‚ Ù…Ø¨Ø§Ø´Ø±Ø©
        if(unitId && String(c.unitId || '') === String(unitId)) return true;
        // âœ… Ø§Ø­ØªÙŠØ§Ø·ÙŠØ§Ù‹: Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¨Ø§Ù„Ù†Øµ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø±Ø¨Ø· Ù„Ù„ÙˆØ­Ø¯Ø©
        return chequeMatchesUnitTokens(c, tokens);
      });

      return matched;
    };

    // Prefer strict tokens; fallback to loose
    let returnedCheques = pickCheques('returned', tokenSets.strict);
    let pendingCheques  = pickCheques('pending',  tokenSets.strict);
    if(returnedCheques.length === 0 && pendingCheques.length === 0){
      returnedCheques = pickCheques('returned', tokenSets.loose);
      pendingCheques  = pickCheques('pending',  tokenSets.loose);
    }

    returnedCheques = returnedCheques.slice().sort((a,b)=> new Date(b.dueDate||'1970-01-01') - new Date(a.dueDate||'1970-01-01'));
    pendingCheques  = pendingCheques.slice().sort((a,b)=> new Date(b.dueDate||'1970-01-01') - new Date(a.dueDate||'1970-01-01'));

    const suggestedDetailsAr = [];
    const suggestedDetailsEn = [];

    returnedCheques.slice(0,5).forEach(c=>{
      const extra = c.purpose ? ` â€” ${c.purpose}` : '';
      const dueAr = c.dueDate ? formatArabicDate(c.dueDate) : '';
      suggestedDetailsAr.push(`Ø´ÙŠÙƒ Ø±Ø§Ø¬Ø¹ Ø±Ù‚Ù… ${c.chequeNo||'â€”'} Ø¨Ù‚ÙŠÙ…Ø© ${formatAED(c.value||0)} Ù…Ø³ØªØ­Ù‚ ${dueAr}${extra}`.trim());
      const dueEn = c.dueDate ? formatEnglishDate(c.dueDate) : 'â€”';
      let reasonEn = '';
      const p = String(c.purpose||'').trim();
      if(p){
        const hasAr = /[\u0600-\u06FF]/.test(p);
        if(hasAr){
          if(p.includes('Ø¹Ø¯Ù… ÙƒÙØ§ÙŠØ© Ø§Ù„Ø±ØµÙŠØ¯')) reasonEn = ' â€” Reason: Insufficient Funds';
        }else{
          reasonEn = ` â€” Reason: ${p}`;
        }
      }
      suggestedDetailsEn.push(`Returned Cheque No. ${c.chequeNo||'â€”'} â€” ${formatAED(c.value||0)} â€” Due: ${dueEn}${reasonEn}`.trim());
    });

    pendingCheques.slice(0,5).forEach(c=>{
      const extra = c.purpose ? ` â€” ${c.purpose}` : '';
      const dueAr = c.dueDate ? formatArabicDate(c.dueDate) : '';
      suggestedDetailsAr.push(`Ø´ÙŠÙƒ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØµØ±Ù Ø±Ù‚Ù… ${c.chequeNo||'â€”'} Ø¨Ù‚ÙŠÙ…Ø© ${formatAED(c.value||0)} Ù…Ø³ØªØ­Ù‚ ${dueAr}${extra}`.trim());
      const dueEn = c.dueDate ? formatEnglishDate(c.dueDate) : 'â€”';
      suggestedDetailsEn.push(`Cheque Pending Clearance No. ${c.chequeNo||'â€”'} â€” ${formatAED(c.value||0)} â€” Due: ${dueEn}`.trim());
    });

    const suggestedAr = suggestedDetailsAr.join('Ø› ');
    const suggestedEn = suggestedDetailsEn.join('; ');

    return {
      paid, matchedPayments, returnedCheques, pendingCheques, cashedCheques, cashedMissingPayment, cashedExtraPaid,
      suggestedDetailsText: suggestedAr,
      suggestedDetailsTextAr: suggestedAr,
      suggestedDetailsTextEn: suggestedEn
    };
  }

  function autofillNoticeArrears(force=false){
    const tplSel = document.getElementById('notice-template-select');
    const tenantSel = document.getElementById('notice-tenant-select');
    const unitSel = document.getElementById('notice-unit-select');
    if(!tplSel || !tenantSel || !unitSel) return;

    const template = tplSel.value;
    if(!(template === 'arrearsRenew' || template === 'arrearsCheque')) return;

    const autoEl = document.getElementById('notice-arrears-autofill');
    const autoOn = autoEl ? autoEl.checked : true;
    if(!autoOn && !force) return;

    const tenantKeyVal = tenantSel.value || '';
    const unitVal = unitSel.value || '';
    if(!tenantKeyVal || !unitVal) return;

    const [propId, unitId] = unitVal.split('::');
    const prop = properties.find(p=> String(p.id)===String(propId));
    const unit = prop?.units?.find(u=> String(u.id)===String(unitId));
    if(!prop || !unit) return;

    const ctx = {
      tenantName: unit?.tenant || '',
      propName: prop?.name || '',
      unitName: unit?.name || '',
      contractNo: unit?.contractNo || '',
      start: unit?.start || '',
      end: unit?.end || '',
      rent: unit?.rent || 0
    };

    const basis = getRentBasisSetting(); // 'total' | 'annual'
    const oldVal = Number(ctx.rent || 0);
    const contractTotal = (basis === 'annual') ? calcContractValueFromAnnual(oldVal, ctx.start, ctx.end) : oldVal;

    const info = computeNoticeUnitPaid(ctx, unit, prop);
    const balance = Math.max(0, Number(contractTotal||0) - Number(info.paid||0));

    const contractValueInput = document.getElementById('notice-contract-value');
    const arrearsAmountInput = document.getElementById('notice-arrears-amount');
    const arrearsDetailsInput = document.getElementById('notice-arrears-details');

    if(contractValueInput && (force || !contractValueInput.value || Number(contractValueInput.value)===0)){
      if(contractTotal) contractValueInput.value = Math.round(Number(contractTotal));
    }
    if(arrearsAmountInput && (force || !arrearsAmountInput.value || Number(arrearsAmountInput.value)===0)){
      arrearsAmountInput.value = Math.round(Number(balance));
    }

    // For arrears templates, propose details automatically (returned/pending cheques)
// Note: we keep user edits. If the field was auto-generated before, we keep updating it automatically.
// If user types manually, it stops auto-updating until they click "ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ".
    if(arrearsDetailsInput){
      const wasAuto = arrearsDetailsInput.dataset.autogen === '1';
      const shouldUpdateDetails = force || !arrearsDetailsInput.value.trim() || wasAuto;
      if(shouldUpdateDetails){
        arrearsDetailsInput.value = info.suggestedDetailsTextAr || info.suggestedDetailsText || '';
        arrearsDetailsInput.dataset.autogen = '1';
      }
    }

    const status = document.getElementById('notice-preview-status');
    if(status){
      status.textContent = `ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ â€” Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª: ${formatAED(info.paid)} ØŒ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${formatAED(balance)} ØŒ Ø´ÙŠÙƒØ§Øª Ø±Ø§Ø¬Ø¹Ø©: ${info.returnedCheques.length} ØŒ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØµØ±Ù: ${info.pendingCheques.length}`;
    }
  }



  let noticePreviewReady = false;
let noticeLoadedFromLog = false;

  function escHtml(v){
    return String(v ?? '')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  function renderNotices(){
    const tenantSel = document.getElementById('notice-tenant-select');
    if(!tenantSel) return;


    // Bind buttons (safe to call multiple times)
    const prevBtn = document.getElementById('notice-preview-btn');
    if(prevBtn) prevBtn.onclick = buildNoticePreview;

    const draftBtn = document.getElementById('notice-print-draft-btn');
    if(draftBtn) draftBtn.onclick = printNoticeDraft;

    const finalBtn = document.getElementById('notice-print-final-btn');
    if(finalBtn) finalBtn.onclick = printNoticeFinal;

    const undoBtn = document.getElementById('notice-undo-last-btn');
    if(undoBtn) undoBtn.onclick = undoLastFinalNotice;

    renderNoticeLog();


    // defaults
    const dateEl = document.getElementById('notice-date');
    if(dateEl && !dateEl.value){
      const d = new Date();
      dateEl.value = new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10);
    }


    // âœ… Ø±Ù‚Ù… Ø®Ø·Ø§Ø¨ Ø§ÙØªØ±Ø§Ø¶ÙŠ (Ø¨Ø¯ÙˆÙ† Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ) Ù„ØªÙØ§Ø¯ÙŠ Ø§Ù„ØªÙƒØ±Ø§Ø±
    const refEl = document.getElementById('notice-ref');
    if(refEl && !(refEl.value||'').trim()){
      refEl.value = getNextAvailableNoticeNo();
    }

    updateNoticeExtraOptions();

    const current = tenantSel.value || '';
    const tenants = getTenantsData()
      .slice()
      .sort((a,b)=> String(a.name||'').localeCompare(String(b.name||'')));

    tenantSel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù…Ø³ØªØ£Ø¬Ø±...</option>'
      + tenants.map(t => `<option value="${escHtml(t.key)}">${escHtml(t.name)}</option>`).join('');

    if(current && tenants.some(t => t.key === current)) tenantSel.value = current;

    // Units depend on tenant
    onNoticeTenantChange(false);
    loadNoticeUiPrefs();
    resetNoticePreview();
  }

function onNoticeTenantChange(resetPreview=true){
    const tenantSel = document.getElementById('notice-tenant-select');
    const unitSel = document.getElementById('notice-unit-select');
    if(!tenantSel || !unitSel) return;

    const selectedKey = tenantSel.value || '';
    if(!selectedKey){
      unitSel.innerHTML = '<option value="">Ø§Ø®ØªØ± ÙˆØ­Ø¯Ø©...</option>';
      unitSel.disabled = true;
      if(resetPreview) resetNoticePreview();
      return;
    }

    const units = [];
    properties.forEach(p => (p.units||[]).forEach(u => {
      if(u.status === 'Ù…Ø¤Ø¬Ø±Ø©' && u.tenant && tenantKey(u.tenant) === selectedKey){
        units.push({
          value: `${p.id}::${u.id}`,
          label: `${p.name} - ${u.name}`
        });
      }
    }));

    unitSel.disabled = false;
    unitSel.innerHTML = '<option value="">Ø§Ø®ØªØ± ÙˆØ­Ø¯Ø©...</option>'
      + units.map(x => `<option value="${escHtml(x.value)}">${escHtml(x.label)}</option>`).join('');

    if(resetPreview) resetNoticePreview();
  }

  function resetNoticePreview(){
    noticePreviewReady = false;
    updateNoticeExtraOptions();
    autofillNoticeArrears(false);
    const preview = document.getElementById('notice-preview');
    const status = document.getElementById('notice-preview-status');
    const draftBtn = document.getElementById('notice-print-draft-btn');
    const finalBtn = document.getElementById('notice-print-final-btn');
    if(draftBtn) draftBtn.disabled = true;
    if(finalBtn) finalBtn.disabled = true;

    if(status) status.textContent = '';
    if(preview){
      preview.innerHTML = `
        <div class="text-center text-gray-500 dark:text-gray-400">
          Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ÙˆÙ†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø§Ø¨ Ø«Ù… Ø§Ø¶ØºØ· <b>Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø§ÙŠÙ†Ø©</b>.
        </div>
      `;
    }
  }

  
  function buildNoticePreview(){
    updateNoticeExtraOptions();
    autofillNoticeArrears(false);

    const tenantSel = document.getElementById('notice-tenant-select');
    const unitSel = document.getElementById('notice-unit-select');
    const tplSel = document.getElementById('notice-template-select');
    const subjectInput = document.getElementById('notice-subject');
    const dateEl = document.getElementById('notice-date');
    const refEl = document.getElementById('notice-ref');
    const bilingualEl = document.getElementById('notice-bilingual');
    const noReplyEl = document.getElementById('notice-no-reply-accept');

    const preview = document.getElementById('notice-preview');
    const status = document.getElementById('notice-preview-status');
    const draftBtn = document.getElementById('notice-print-draft-btn');
    const finalBtn = document.getElementById('notice-print-final-btn');

    const tenantKeyVal = tenantSel?.value || '';
    if(!tenantKeyVal){
      alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ø£ÙˆÙ„Ø§Ù‹.');
      return;
    }

    const template = tplSel?.value || 'blank';
    const bilingual = !!(bilingualEl && bilingualEl.checked);

    // Require unit for eviction / increase
    const unitVal = unitSel?.value || '';
    if((template === 'eviction' || template === 'increase5') && !unitVal){
      alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØ­Ø¯Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø®Ø·Ø§Ø¨.');
      return;
    }

    const tenant = getTenantsData().find(t => t.key === tenantKeyVal);
    const { prop, unit } = findUnitByComposite(unitVal);

    // default subject
    if(subjectInput && !(subjectInput.value||'').trim()){
      if(template === 'eviction') subjectInput.value = 'Ø¥Ø®Ø·Ø§Ø± Ø¨Ø¹Ø¯Ù… ØªØ¬Ø¯ÙŠØ¯ Ø¹Ù‚Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± ÙˆØ¥Ø®Ù„Ø§Ø¡ Ø§Ù„Ø¹ÙŠÙ† Ø§Ù„Ù…Ø¤Ø¬Ø±Ø©';
      else if(template === 'increase5') subjectInput.value = 'Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±ÙŠØ© Ø¨Ù†Ø³Ø¨Ø© 5%';
      else subjectInput.value = '';
    }

    const subject = (subjectInput?.value || '').trim();
    const dateStr = (dateEl?.value || '');
    const dateDMY = formatDMY(dateStr);

    if(refEl && !(refEl.value||'').trim()){
      refEl.value = getNextAvailableNoticeNo();
    }
    const refNo = (refEl?.value || '').trim();

    // Keep edited text if user re-builds
    const prevAr = document.getElementById('notice-body-ar')?.innerText || '';
    const prevEn = document.getElementById('notice-body-en')?.innerText || '';

    const ctx = {
      tenantName: tenant?.name || '',
      propName: prop?.name || '',
      unitName: unit?.name || '',
      contractNo: unit?.contractNo || '',
      start: unit?.start || '',
      end: unit?.end || '',
      rent: unit?.rent || 0
    };

    // Compute 5% increase numbers
    const basis = getRentBasisSetting(); // 'total' | 'annual'
    const years = (ctx.start && ctx.end) ? contractYears(ctx.start, ctx.end) : 1;
    const oldVal = Number(ctx.rent || 0);
    const newVal = Math.round(oldVal * 1.05);

    const oldAnnual = basis === 'annual' ? oldVal : (years ? (oldVal / years) : oldVal);
    const newAnnual = Math.round(oldAnnual * 1.05);

    // ---- Arrears defaults (auto-fill inputs) ----
    const unitCode = (unit && (unit.id || unit.code || unit.unitCode)) ? (unit.id || unit.code || unit.unitCode) : (unit?.name || '');
    const contractTotal = (basis === 'annual') ? calcContractValueFromAnnual(oldVal, ctx.start, ctx.end) : oldVal;

    const contractValueInput = document.getElementById('notice-contract-value');
    const arrearsAmountInput = document.getElementById('notice-arrears-amount');
    const arrearsDetailsInput = document.getElementById('notice-arrears-details');

    // compute paid/balance for this unit (from recorded payments/cheques)
    const paidInfo = computeNoticeUnitPaid(ctx, unit, prop);
    const unitPaid = Number(paidInfo.paid||0);
    const unitBalance = Math.max(0, (Number(contractTotal||0) - Number(unitPaid||0)));

    if(contractValueInput && (!contractValueInput.value || Number(contractValueInput.value)===0)){
      if(contractTotal) contractValueInput.value = Math.round(Number(contractTotal));
    }
    if(arrearsAmountInput && (!arrearsAmountInput.value || Number(arrearsAmountInput.value)===0)){
      if(unitBalance) arrearsAmountInput.value = Math.round(Number(unitBalance));
    }

    // Templates
    let titleAr = 'Ø®Ø·Ø§Ø¨ Ø±Ø³Ù…ÙŠ';
    let titleEn = 'Official Letter';
    let bodyAr = '';
    let bodyEn = '';

    if(template === 'blank'){
      titleAr = 'Ø®Ø·Ø§Ø¨ Ø±Ø³Ù…ÙŠ';
      titleEn = 'Official Letter';
      bodyAr = prevAr.trim() || (
`Ø¹Ø²ÙŠØ²ÙŠ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±/Ø§Ù„Ø³Ø§Ø¯Ø©: ${ctx.tenantName || '______________'}\n\n` +
`Ø¨Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ Ø¹Ù‚Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø±Ù‚Ù… ${ctx.contractNo || 'â€”'} Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹ÙŠÙ† Ø§Ù„Ù…Ø¤Ø¬Ø±Ø© (${ctx.propName} - ${ctx.unitName})ØŒ Ù†ÙˆØ¯ Ø¥Ø´Ø¹Ø§Ø±ÙƒÙ… Ø¨Ø£Ù†Ù‡ ØªÙ‚Ø±Ø± ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±ÙŠØ© Ø¨Ù†Ø³Ø¨Ø© 5% ÙˆÙÙ‚Ù‹Ø§ Ù„Ø¨Ù†ÙˆØ¯ Ø¹Ù‚Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±.\n\n` +
`Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${formatAED(oldAnnual)}\n` +
`Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø²ÙŠØ§Ø¯Ø© (5%): ${formatAED(newAnnual)}\n\n` +
`ØªØ§Ø±ÙŠØ® Ø³Ø±ÙŠØ§Ù† Ø§Ù„Ø²ÙŠØ§Ø¯Ø©: Ø¹Ù†Ø¯ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ / Ù„Ù„ÙØªØ±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ØªØ¨Ø¹Ø©.\n\n` +
`ÙŠØ±Ø¬Ù‰ ØªØ²ÙˆÙŠØ¯Ù†Ø§ Ø¨Ù…ÙˆØ§ÙÙ‚ØªÙƒÙ… Ø£Ùˆ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒÙ… Ø®Ù„Ø§Ù„ 7 Ø£ÙŠØ§Ù… Ù…Ù† ØªØ§Ø±ÙŠØ® Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±ØŒ ÙˆÙÙŠ Ø­Ø§Ù„ Ø¹Ø¯Ù… Ø§Ù„Ø±Ø¯ Ø®Ù„Ø§Ù„ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…Ø°ÙƒÙˆØ±Ø© Ø³ÙŠÙØ¹ØªØ¨Ø± Ø°Ù„Ùƒ Ù‚Ø¨ÙˆÙ„Ø§Ù‹ Ø¶Ù…Ù†ÙŠÙ‹Ø§ Ø¨Ø§Ù„Ø²ÙŠØ§Ø¯Ø©.\n\n` +
`ÙˆØªÙØ¶Ù„ÙˆØ§ Ø¨Ù‚Ø¨ÙˆÙ„ ÙØ§Ø¦Ù‚ Ø§Ù„Ø§Ø­ØªØ±Ø§Ù… ÙˆØ§Ù„ØªÙ‚Ø¯ÙŠØ±ØŒØŒ`
      );
      bodyEn = prevEn.trim() || (
`Dear Tenant,\n\n${ctx.tenantName || '______________'}\n\n` +
`With reference to Lease Agreement No. ${ctx.contractNo || 'â€”'} for the leased premises (${ctx.propName} - ${ctx.unitName}), please be informed that the rental value will be increased by 5% in accordance with the lease terms.\n\n` +
`Current rental value: ${formatAED(oldAnnual)}\n` +
`New rental value (5% increase): ${formatAED(newAnnual)}\n\n` +
`Effective date: upon renewal / next rental period as per the applicable procedures.\n\n` +
`Kindly provide your confirmation or remarks within 7 days from the date of this notice. Failure to respond within the said period shall be deemed as acceptance of the increase.\n\n` +
`Regards ,,`
      );
} 
else if(template === 'eviction'){
      titleAr = 'Ø¥Ø®Ø·Ø§Ø± Ø±Ø³Ù…ÙŠ Ø¨Ø¹Ø¯Ù… ØªØ¬Ø¯ÙŠØ¯ Ø¹Ù‚Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± ÙˆØ¥Ø®Ù„Ø§Ø¡ Ø§Ù„Ø¹ÙŠÙ† Ø§Ù„Ù…Ø¤Ø¬Ø±Ø©';
      titleEn = 'Eviction Notice and Non-Renewal of Lease Agreement';
      bodyAr = prevAr.trim() || (
`Ø¹Ø²ÙŠØ²ÙŠ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ØŒ\n\n${ctx.tenantName || '______________'}\n\n` +
`Ø¨Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ Ø¹Ù‚Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø±Ù‚Ù… ${ctx.contractNo || 'â€”'} Ø§Ù„Ù…Ø¨Ø±Ù… Ø¨ÙŠÙ†ÙƒÙ… ÙˆØ¨ÙŠÙ† Ø§Ù„Ù…Ù„Ø§Ùƒ Ø¨Ø®ØµÙˆØµ Ø§Ù„Ø¹ÙŠÙ† Ø§Ù„Ù…Ø¤Ø¬Ø±Ø© (${ctx.propName} - ${ctx.unitName})ØŒ ÙˆØ§Ù„ØªÙŠ Ø³ÙŠÙ†ØªÙ‡ÙŠ Ø¹Ù‚Ø¯Ù‡Ø§ Ø¨ØªØ§Ø±ÙŠØ® ${ctx.end || 'â€”'}ØŒ Ù†ÙˆØ¯ Ø¥Ù†Ø°Ø§Ø±ÙƒÙ… Ø¨Ù…Ø§ ÙŠÙ„ÙŠ:\n\n` +
`Ù‚Ø±Ø± Ø§Ù„Ù…Ù„Ø§Ùƒ Ø¹Ø¯Ù… ØªØ¬Ø¯ÙŠØ¯ Ø¹Ù‚Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¦Ù‡ØŒ ÙˆÙŠÙØ¹Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø®Ø·Ø§Ø± Ø¥Ù†Ø°Ø§Ø±Ù‹Ø§ Ø±Ø³Ù…ÙŠÙ‹Ø§ ÙˆÙ†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ Ø¨ÙˆØ¬ÙˆØ¨ Ø§Ù„Ø¥Ø®Ù„Ø§Ø¡.\n\n` +
`ÙˆØ¹Ù„ÙŠÙ‡ØŒ ÙŠÙØ·Ù„Ø¨ Ù…Ù†ÙƒÙ…:\n\n` +
`- Ø¥Ø®Ù„Ø§Ø¡ Ø§Ù„Ø¹ÙŠÙ† Ø§Ù„Ù…Ø¤Ø¬Ø±Ø© ÙˆØªØ³Ù„ÙŠÙ…Ù‡Ø§ Ø®Ø§Ù„ÙŠØ© Ù…Ù† Ø£ÙŠ Ø¥Ø´ØºØ§Ù„ ÙÙŠ Ù…ÙˆØ¹Ø¯ Ø£Ù‚ØµØ§Ù‡ ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø¯.\n` +
`- ØªÙ‚Ø¯ÙŠÙ… Ø¨Ø±Ø§Ø¡Ø© Ø°Ù…Ø© Ù…Ù† Ø·Ø§Ù‚Ø© Ù„Ù„ØªÙˆØ²ÙŠØ¹ (ÙƒÙ‡Ø±Ø¨Ø§Ø¡/Ù…ÙŠØ§Ù‡) ØªÙÙŠØ¯ Ø¨Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø£ÙŠ Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ù…Ø§Ù„ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„ØªØ³Ù„ÙŠÙ….\n` +
`- ØªØ³ÙˆÙŠØ© Ø£ÙŠ Ù…Ø³ØªØ­Ù‚Ø§Øª Ù…ØªØ£Ø®Ø±Ø©ØŒ ÙˆØªØ³Ù„ÙŠÙ… Ø§Ù„Ù…ÙØ§ØªÙŠØ­ ÙˆÙƒØ§ÙØ© Ø§Ù„Ù…Ù„Ø­Ù‚Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„ØªØ³Ù„ÙŠÙ….\n\n` +
`ÙˆÙ†Ø¤ÙƒØ¯ Ø£Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ù†Ø°Ø§Ø± ÙŠÙØ¹ØªØ¨Ø± Ù…Ù„Ø²Ù…Ù‹Ø§ØŒ ÙˆÙÙŠ Ø­Ø§Ù„ Ø¹Ø¯Ù… Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ù…Ø§ ÙˆØ±Ø¯ Ø£Ø¹Ù„Ø§Ù‡ØŒ Ø³ÙŠØ¶Ø·Ø± Ø§Ù„Ù…Ù„Ø§Ùƒ Ø¥Ù„Ù‰ Ø§ØªØ®Ø§Ø° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© Ø§Ù„Ù„Ø§Ø²Ù…Ø© ÙˆÙÙ‚Ù‹Ø§ Ù„Ù„Ù‚ÙˆØ§Ù†ÙŠÙ† ÙˆØ§Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…Ø¹Ù…ÙˆÙ„ Ø¨Ù‡Ø§ ÙÙŠ Ø¯ÙˆÙ„Ø© Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ù…ØªØ­Ø¯Ø©.\n\n` +
`ÙˆØªÙØ¶Ù„ÙˆØ§ Ø¨Ù‚Ø¨ÙˆÙ„ ÙØ§Ø¦Ù‚ Ø§Ù„Ø§Ø­ØªØ±Ø§Ù… ÙˆØ§Ù„ØªÙ‚Ø¯ÙŠØ±ØŒØŒ`
      );
      bodyEn = prevEn.trim() || (
`Dear Tenant,\n\n${ctx.tenantName || '______________'}\n\n` +
`Referring to Lease Agreement No. ${ctx.contractNo || 'â€”'}, concluded between you and the landlords regarding the leased premises (${ctx.propName} - ${ctx.unitName}), which will expire on ${ctx.end || 'â€”'}, we hereby notify you of the following:\n\n` +
`The landlords have decided not to renew the lease agreement after its expiry date, and this notice shall be considered an official and final warning requiring eviction.\n\n` +
`Therefore, you are required to:\n\n` +
`- Vacate the leased premises and hand them over free of any occupation no later than the expiry date.\n` +
`- Provide a clearance certificate from TAQA Distribution confirming that no financial obligations remain outstanding prior to handover.\n` +
`- Settle any outstanding dues and hand over keys and all related attachments upon handover.\n\n` +
`We emphasize that this notice is binding, and in the event of non-compliance, the landlords will be compelled to take legal action in accordance with the applicable laws and regulations of the United Arab Emirates.\n\n` +
`Regards ,,`
      );
} else if(template === 'increase5'){
      titleAr = 'Ø¥Ø´Ø¹Ø§Ø± Ø±Ø³Ù…ÙŠ Ø¨Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±ÙŠØ© Ø¨Ù†Ø³Ø¨Ø© 5%';
      titleEn = 'Notice of 5% Rent Increase';

      const noReplyClause = !!(noReplyEl && noReplyEl.checked);

      const oldStr = basis === 'annual'
        ? `Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±ÙŠØ© Ø§Ù„Ø³Ù†ÙˆÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${formatAED(oldVal)}`
        : `Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${formatAED(oldVal)}`;

      const newStr = basis === 'annual'
        ? `Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±ÙŠØ© Ø§Ù„Ø³Ù†ÙˆÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø²ÙŠØ§Ø¯Ø© (5%): ${formatAED(newAnnual)}`
        : `Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ø¹Ø¯ Ø§Ù„Ø²ÙŠØ§Ø¯Ø© (5%): ${formatAED(newVal)}`;

      bodyAr = prevAr.trim() || (
`Ø¹Ø²ÙŠØ²ÙŠ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±/Ø§Ù„Ø³Ø§Ø¯Ø©: ${ctx.tenantName}\n\n` +
`Ø¨Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ Ø¹Ù‚Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø±Ù‚Ù… ${ctx.contractNo || 'â€”'} Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹ÙŠÙ† Ø§Ù„Ù…Ø¤Ø¬Ø±Ø© (${ctx.propName} - ${ctx.unitName})ØŒ Ù†ÙˆØ¯ Ø¥Ø´Ø¹Ø§Ø±ÙƒÙ… Ø¨Ù…Ø§ ÙŠÙ„ÙŠ:\n\n` +
`${oldStr}\n${newStr}\n\n` +
`ÙˆØ³ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø²ÙŠØ§Ø¯Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ / Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ØªØ¨Ø¹Ø©.\n` +
(noReplyClause ? `\nØ¹Ø¯Ù… Ø§Ù„Ø±Ø¯ Ø®Ù„Ø§Ù„ (7) Ø£ÙŠØ§Ù… Ù…Ù† ØªØ§Ø±ÙŠØ® Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø³ÙŠÙØ¹ØªØ¨Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.\n` : ``) +
`\nÙˆØªÙØ¶Ù„ÙˆØ§ Ø¨Ù‚Ø¨ÙˆÙ„ ÙØ§Ø¦Ù‚ Ø§Ù„Ø§Ø­ØªØ±Ø§Ù… ÙˆØ§Ù„ØªÙ‚Ø¯ÙŠØ± ØŒØŒ`
      );

      bodyEn = prevEn.trim() || (
`Dear Tenant,\n\n` +
`Referring to Lease Agreement No. ${ctx.contractNo || 'â€”'} for the leased premises (${ctx.propName} - ${ctx.unitName}), please be advised:\n\n` +
(basis === 'annual'
  ? `Current annual rent: ${formatAED(oldVal)}\nNew annual rent (+5%): ${formatAED(newAnnual)}\n\n`
  : `Current contract value: ${formatAED(oldVal)}\nNew contract value (+5%): ${formatAED(newVal)}\n\n`
) +
`The increase will be applied upon renewal / the upcoming period as per applicable procedures.\n` +
(noReplyClause ? `\nNo response within 7 days from this notice date shall be considered acceptance.\n` : ``) +
`\nRegards ,,`
      );
    }
else if(template === 'arrearsRenew'){
      titleAr = 'Ø¥Ù†Ø°Ø§Ø± Ø¯ÙØ¹ Ù…ØªØ£Ø®Ø±Ø§Øª Ø¥ÙŠØ¬Ø§Ø±ÙŠØ©';
      titleEn = 'Rental Arrears Notice';

      const cv = Number(contractValueInput?.value || contractTotal || 0);
      const arAmt = Number(arrearsAmountInput?.value || unitBalance || 0);
      const details = String(arrearsDetailsInput?.value || '').trim();
      const detailsEn = String(paidInfo?.suggestedDetailsTextEn || '').trim();
      const unitLabel = unitCode || ctx.unitName || 'â€”';

      bodyAr = prevAr.trim() || (
`Ø¹Ø²ÙŠØ²ÙŠ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ØŒ\n\n${ctx.tenantName || '______________'}\n\n` +
`Ø¨Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ù…Ø´Ø§Ø± Ø¥Ù„ÙŠÙ‡ Ø£Ø¹Ù„Ø§Ù‡ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙƒØ±Ù… Ø¨Ø¯ÙØ¹ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±ÙŠØ© Ø¹Ù„Ù‰ Ø¹Ù‚Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ù„Ù„ÙˆØ­Ø¯Ø© ${unitLabel} ÙˆØ§Ù„Ù…Ø¤Ø¬Ø±Ø© Ù„ÙƒÙ…ØŒ ÙˆØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ù…Ù†ØªÙ‡ÙŠ Ø¨ØªØ§Ø±ÙŠØ® ${ctx.end || 'â€”'} Ø®Ù„Ø§Ù„ Ù…Ø¯Ø© Ø£Ù‚ØµØ§Ù‡Ø§ Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ† Ù…Ù† ØªØ§Ø±ÙŠØ®Ù‡.\n\n` +
`ÙˆØ¹Ù„ÙŠÙ‡ØŒ ÙŠØ¬Ø¨ Ø³Ø¯Ø§Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ£Ø®Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ù…ÙˆØ«Ù‚ ÙÙŠ Ø¨Ù„Ø¯ÙŠØ© Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø¹ÙŠÙ† ÙˆØ±Ù‚Ù…Ù‡ (${ctx.contractNo || 'â€”'}) ÙˆØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ø£Ø³Ø±Ø¹ ÙˆÙ‚Øª Ù…Ù…ÙƒÙ† Ø­ØªÙ‰ Ù„Ø§ Ù†Ø¶Ø·Ø± Ø¢Ø³ÙÙŠÙ† Ù„Ø§ØªØ®Ø§Ø° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© Ø¶Ø¯ÙƒÙ….\n\n` +
`Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚Ø¯: ${cv ? cv.toLocaleString('en-US') : 'â€”'} Ø¯Ø±Ù‡Ù…\n` +
`Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${arAmt ? arAmt.toLocaleString('en-US') : 'â€”'} Ø¯Ø±Ù‡Ù…\n` +
(details ? `\nØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª: ${details}\n` : ``) +
`\nÙÙŠ Ø­Ø§Ù„ ØªØ¹Ø°Ø±ÙƒÙ… Ø¹Ù† Ø§Ù„Ø³Ø¯Ø§Ø¯ Ø®Ù„Ø§Ù„ Ø§Ù„Ù…Ù‡Ù„Ø© Ø§Ù„Ù…Ù…Ù†ÙˆØ­Ø© Ù„ÙƒÙ… Ø³ÙŠØªÙ… Ø§ØªØ®Ø§Ø° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© Ø¶Ø¯ÙƒÙ… Ù…Ù…Ø§ ÙŠØªØ±ØªØ¨ Ø¹Ù„ÙŠÙƒÙ… Ø³Ø¯Ø§Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ£Ø®Ø±Ø© Ù…Ù† ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ù…Ø°ÙƒÙˆØ± Ø£Ø¹Ù„Ø§Ù‡ ÙˆØ­ØªÙ‰ Ø§Ù„Ø¥Ø®Ù„Ø§Ø¡ Ø§Ù„ÙØ¹Ù„ÙŠØŒ ÙˆØªØ³Ù„ÙŠÙ… Ø¨Ø±Ø§Ø¡Ø© Ø°Ù…Ø© Ø§Ù„Ù…Ø§Ø¡ ÙˆØ§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ ÙˆØµÙŠØ§Ù†Ø© Ø§Ù„Ø¹ÙŠÙ† Ø§Ù„Ù…Ø¤Ø¬Ø±Ø©.\n\n` +
`Ø´Ø§ÙƒØ±ÙŠÙ† Ù„ÙƒÙ… Ø­Ø³Ù† ØªØ¹Ø§ÙˆÙ†ÙƒÙ… Ù…Ø¹Ù†Ø§ØŒØŒ\nÙˆØªÙØ¶Ù„ÙˆØ§ Ø¨Ù‚Ø¨ÙˆÙ„ ÙØ§Ø¦Ù‚ Ø§Ù„Ø§Ø­ØªØ±Ø§Ù… ÙˆØ§Ù„ØªÙ‚Ø¯ÙŠØ± ØŒØŒ`
      );

      bodyEn = prevEn.trim() || (
`Dear Tenant,\n\n${ctx.tenantName || '______________'}\n\n` +
`With reference to the above subject, kindly pay the rental arrears for the lease contract of Unit ${unitLabel} leased to you, and renew the lease contract expired on ${ctx.end || 'â€”'} within a maximum period of two weeks.\n\n` +
`Accordingly, you must pay the late rents on the contract documented in Al Ain Municipality No. (${ctx.contractNo || 'â€”'}) and renew the contract as soon as possible so that we do not have to take legal action against you.\n\n` +
`Rental Value: ${cv ? cv.toLocaleString('en-US') : 'â€”'} AED\n` +
`Remaining: ${arAmt ? arAmt.toLocaleString('en-US') : 'â€”'} AED\n` +
(detailsEn ? `\nArrears details: ${detailsEn}\n` : ``) +
`\nIf you fail to pay within the period given to you, legal action will be taken against you. You will have to pay the late rents from the contract expiry date mentioned above until the actual eviction, provide the water and electricity clearance, and maintain the leased property.\n\n` +
`Thank you for your cooperation with us,,\nRegards ,,`
      );

    } else if(template === 'arrearsCheque'){
      titleAr = 'Ø¥Ù†Ø°Ø§Ø± Ø¯ÙØ¹ Ù…ØªØ£Ø®Ø±Ø§Øª Ø¥ÙŠØ¬Ø§Ø±ÙŠØ©';
      titleEn = 'Legal Notice - Rental Arrears';

      const cv = Number(contractValueInput?.value || contractTotal || 0);
      const arAmt = Number(arrearsAmountInput?.value || unitBalance || 0);
      const details = String(arrearsDetailsInput?.value || '').trim();
      const detailsEn = String(paidInfo?.suggestedDetailsTextEn || '').trim();
      const unitLabel = unitCode || ctx.unitName || 'â€”';

      bodyAr = prevAr.trim() || (
`Ø¹Ø²ÙŠØ²ÙŠ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ØŒ\n\n${ctx.tenantName || '______________'}\n\n` +
`Ø¨Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ù…Ø´Ø§Ø± Ø¥Ù„ÙŠÙ‡ Ø£Ø¹Ù„Ø§Ù‡ØŒ ÙŠØ¹Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ù†Ø°Ø§Ø± Ù„ÙƒÙ… Ù„Ø¯ÙØ¹ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ£Ø®Ø±Ø© Ø¹Ù„Ù‰ Ø¹Ù‚Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ù…ÙˆØ«Ù‚ Ø§Ù„Ø®Ø§Øµ Ø¨ÙƒÙ… ÙˆØ±Ù‚Ù…Ù‡: ${ctx.contractNo || 'â€”'} Ù„Ù„ÙˆØ­Ø¯Ø© Ø±Ù‚Ù…: ${unitLabel} Ø®Ù„Ø§Ù„ Ù…Ø¯Ø© Ø£Ù‚ØµØ§Ù‡Ø§ Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ† Ù…Ù† ØªØ§Ø±ÙŠØ®Ù‡.\n\n` +
`ÙˆØ¹Ù„ÙŠÙ‡ØŒ ÙŠØ¬Ø¨ Ø§Ù„Ù…Ø¨Ø§Ø¯Ø±Ø© ÙˆØ³Ø¯Ø§Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ£Ø®Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ù…ÙˆØ«Ù‚ ÙÙŠ Ø¨Ù„Ø¯ÙŠØ© Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø¹ÙŠÙ† Ø¨Ø£Ø³Ø±Ø¹ ÙˆÙ‚Øª Ù…Ù…ÙƒÙ† Ø­ØªÙ‰ Ù„Ø§ Ù†Ø¶Ø·Ø± Ø¢Ø³ÙÙŠÙ† Ù„Ø§ØªØ®Ø§Ø° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© Ø¶Ø¯ÙƒÙ….\n\n` +
`Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚Ø¯: ${cv ? cv.toLocaleString('en-US') : 'â€”'} Ø¯Ø±Ù‡Ù…\n` +
`Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª: ${details ? details : (arAmt ? arAmt.toLocaleString('en-US') + ' Ø¯Ø±Ù‡Ù…' : 'â€”')}\n\n` +
`ÙÙŠ Ø­Ø§Ù„ ØªØ¹Ø°Ø±ÙƒÙ… Ø¹Ù† Ø§Ù„Ø³Ø¯Ø§Ø¯ Ø®Ù„Ø§Ù„ Ø§Ù„Ù…Ù‡Ù„Ø© Ø§Ù„Ù…Ù…Ù†ÙˆØ­Ø© Ù„ÙƒÙ… Ø³ÙŠØªÙ… Ø§ØªØ®Ø§Ø° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© Ø¶Ø¯ÙƒÙ… Ù…Ù…Ø§ ÙŠØªØ±ØªØ¨ Ø¹Ù„ÙŠÙƒÙ… Ø³Ø¯Ø§Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ£Ø®Ø±Ø© Ø§Ù„Ù…Ø°ÙƒÙˆØ±Ø© Ø£Ø¹Ù„Ø§Ù‡ ÙˆØ­ØªÙ‰ Ø§Ù„Ø¥Ø®Ù„Ø§Ø¡ Ø§Ù„ÙØ¹Ù„ÙŠØŒ ÙˆØªØ³Ù„ÙŠÙ… Ø¨Ø±Ø§Ø¡Ø© Ø°Ù…Ø© Ø§Ù„Ù…Ø§Ø¡ ÙˆØ§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ ÙˆØµÙŠØ§Ù†Ø© Ø§Ù„Ø¹ÙŠÙ† Ø§Ù„Ù…Ø¤Ø¬Ø±Ø©.\n\n` +
`Ø´Ø§ÙƒØ±ÙŠÙ† Ù„ÙƒÙ… Ø­Ø³Ù† ØªØ¹Ø§ÙˆÙ†ÙƒÙ… Ù…Ø¹Ù†Ø§ØŒØŒ\nÙˆØªÙØ¶Ù„ÙˆØ§ Ø¨Ù‚Ø¨ÙˆÙ„ ÙØ§Ø¦Ù‚ Ø§Ù„Ø§Ø­ØªØ±Ø§Ù… ÙˆØ§Ù„ØªÙ‚Ø¯ÙŠØ± ØŒØŒ`
      );

      bodyEn = prevEn.trim() || (
`Dear Tenant,\n\n${ctx.tenantName || '______________'}\n\n` +
`With reference to the above subject matter, this is the notice to pay overdue rents on your tenancy lease: ${ctx.contractNo || 'â€”'}\n` +
`Unit No.: ${unitLabel}\nwithin a maximum period of two weeks.\n\n` +
`Accordingly, you must pay the arrears on the contract documented in Al Ain Municipality as soon as possible so that we do not have to take legal action against you.\n\n` +
`Contract Value: ${cv ? cv.toLocaleString('en-US') : 'â€”'} AED\n` +
`Arrears: ${detailsEn ? detailsEn : (arAmt ? arAmt.toLocaleString('en-US') + ' AED' : 'â€”')}\n\n` +
`If you fail to pay within the period given to you, legal action will be taken against you. You will have to pay the late rents mentioned above until the actual eviction, provide the water and electricity clearance, and maintain the leased property.\n\n` +
`Thank you for your cooperation with us,,\nRegards ,,`
      );
    }


    const headerLinesHtml = NOTICE_LETTERHEAD.topLines.map(l => `<div>${escHtml(l)}</div>`).join('');
    const footerLinesHtml = NOTICE_LETTERHEAD.footerLines.map((l,i) => (i===0 ? `<div class="sig">${escHtml(l)}</div>` : `<div>${escHtml(l)}</div>`)).join('');

    // UI toggles
    const uiShowSig = document.getElementById('notice-show-signature')?.checked ?? true;
    const uiShowSeal = document.getElementById('notice-show-seal')?.checked ?? true;
    const uiShowAtt = document.getElementById('notice-show-attachments')?.checked ?? true;

    const attDefault = getDefaultNoticeAttachments(template);
    const attCustom = parseCustomAttachments();
    const attAr = [...(attDefault.ar||[]), ...attCustom];
    const attEn = [...(attDefault.en||[]), ...attCustom];

    const attachmentsHtml = (!uiShowAtt || (attAr.length===0 && attEn.length===0)) ? '' : (bilingual
      ? `
        <div class="letter-attachments">
          <div class="letter-attachments-grid">
            <div class="letter-attachments-col" dir="rtl">
              <div class="att-title">Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</div>
              <ul class="letter-list">${attAr.map(a => `<li>${escHtml(a)}</li>`).join('')}</ul>
            </div>
            <div class="letter-attachments-col" dir="ltr">
              <div class="att-title">Required Attachments</div>
              <ul class="letter-list">${attEn.map(a => `<li>${escHtml(a)}</li>`).join('')}</ul>
            </div>
          </div>
        </div>
      `
      : `
        <div class="letter-attachments">
          <div class="letter-attachments-col" dir="rtl">
            <div class="att-title">Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</div>
            <ul class="letter-list">${attAr.map(a => `<li>${escHtml(a)}</li>`).join('')}</ul>
          </div>
        </div>
      `);

    const signatureHtml = !uiShowSig ? '' : `
      <div class="letter-signature">
        ${uiShowSeal ? `<div class="seal-box">Ø§Ù„Ø®ØªÙ… / Seal</div>` : `<div></div>`}
        <div class="sig-lines">${footerLinesHtml}</div>
      </div>
    `;



    const titleHtml = `
      <div class="letter-title-ar">${escHtml(titleAr || '')}</div>
      ${bilingual ? `<div class="letter-title-en" dir="ltr">${escHtml(titleEn || '')}</div>` : ''}
    `;

    const metaHtml = `
      <div><b>Ø±Ù‚Ù… Ø§Ù„Ø®Ø·Ø§Ø¨:</b> ${escHtml(refNo || 'â€”')}</div>
      <div><b>Ø§Ù„ØªØ§Ø±ÙŠØ®:</b> ${escHtml(dateDMY || '')}</div>
      ${subject ? `<div style="flex-basis:100%"><b>Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹:</b> ${escHtml(subject)}</div>` : ''}
    `;
    const bodyHtml = bilingual ? `
      <div class="letter-columns">
        <div class="letter-col" dir="rtl">
          <div id="notice-body-ar" class="letter-body letter-edit" contenteditable="true">${textToHtml(bodyAr)}</div>
        </div>
        <div class="letter-col" dir="ltr">
          <div id="notice-body-en" class="letter-body letter-edit" contenteditable="true">${textToHtml(bodyEn)}</div>
        </div>
      </div>
    ` : `
      <div id="notice-body-ar" class="letter-body letter-edit" dir="rtl" contenteditable="true">${textToHtml(bodyAr)}</div>
    `;
preview.innerHTML = `
      <div class="letter-paper" id="notice-letter">
        <div class="letter-head">
          <div class="letter-head-lines">${headerLinesHtml}</div>
        </div>

        <div class="letter-title">${titleHtml}</div>

        <div class="letter-meta">${metaHtml}</div>

        ${bodyHtml}
        ${attachmentsHtml}
        ${signatureHtml}
      </div>
    `;

    noticeLoadedFromLog = false;
    noticePreviewReady = true;
    if(draftBtn) draftBtn.disabled = false;
    if(finalBtn) finalBtn.disabled = false;
    if(status) status.textContent = 'Ø¬Ø§Ù‡Ø² Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© â€” ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ù†Øµ Ø§Ù„Ø®Ø·Ø§Ø¨ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©.';
  }

  
function getNoticeLog(){
  try { return JSON.parse(localStorage.getItem('re_notice_log') || '[]') || []; }
  catch(e){ return []; }
}
function setNoticeLog(arr){
  try { localStorage.setItem('re_notice_log', JSON.stringify((arr||[]).slice(-2000))); } catch(e){}
}
function addNoticeLogEntry(entry){
  const log = getNoticeLog();
  log.push(entry);
  setNoticeLog(log);
  return log;
}
function templateLabel(tpl){
  if(tpl==='blank') return 'Ø®Ø·Ø§Ø¨ Ø±Ø³Ù…ÙŠ (ÙØ§Ø±Øº)';
  if(tpl==='eviction') return 'Ø¥Ø®Ù„Ø§Ø¡ / Ø¹Ø¯Ù… ØªØ¬Ø¯ÙŠØ¯';
  if(tpl==='increase5') return 'Ø²ÙŠØ§Ø¯Ø© 5%';
  if(tpl==='arrearsRenew') return 'Ø¥Ù†Ø°Ø§Ø± Ù…ØªØ£Ø®Ø±Ø§Øª + ØªØ¬Ø¯ÙŠØ¯ Ø¹Ù‚Ø¯';
  if(tpl==='arrearsCheque') return 'Ø¥Ù†Ø°Ø§Ø± Ù…ØªØ£Ø®Ø±Ø§Øª (Ø´ÙŠÙƒ Ø±Ø§Ø¬Ø¹/Ø¯ÙØ¹Ø© Ø£ÙˆÙ„Ù‰)';
  return tpl || '';
}
function captureNoticePaperHtml(){
  const preview = document.getElementById('notice-preview');
  if(!preview) return '';
  const paper = preview.querySelector('.letter-paper');
  return paper ? paper.outerHTML : preview.innerHTML;
}
function restoreNoticePaperHtml(html){
  const preview = document.getElementById('notice-preview');
  const status = document.getElementById('notice-preview-status');
  if(!preview) return;
  preview.innerHTML = html || '';
  noticePreviewReady = !!html;
  const draftBtn = document.getElementById('notice-print-draft-btn');
  const finalBtn = document.getElementById('notice-print-final-btn');
  if(draftBtn) draftBtn.disabled = !noticePreviewReady;
  if(finalBtn) finalBtn.disabled = !noticePreviewReady;
  if(status) status.textContent = noticePreviewReady ? 'Ø¬Ø§Ù‡Ø² Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© â€” ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Øµ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø®Ø·Ø§Ø¨ Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©' : '';
}
function renderNoticeLog(){
  const box = document.getElementById('notice-log');
  const undoBtn = document.getElementById('notice-undo-last-btn');
  const searchEl = document.getElementById('notice-log-search');
  if(!box) return;

  // bind search once
  if(searchEl && !searchEl.dataset.bound){
    searchEl.addEventListener('input', ()=> renderNoticeLog());
    searchEl.dataset.bound = '1';
  }

  const log = getNoticeLog();
  const last = log.length ? log[log.length-1] : null;

  if(undoBtn){
    undoBtn.disabled = !(last && last.status==='FINAL');
    undoBtn.style.opacity = undoBtn.disabled ? '0.5' : '1';
  }

  if(!log.length){
    box.innerHTML = '<div class="text-gray-500 dark:text-gray-400">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ù†Ø°Ø§Ø±Ø§Øª Ù…Ø¹ØªÙ…Ø¯Ø© Ø¨Ø¹Ø¯.</div>';
    return;
  }

  const q = (searchEl?.value || '').trim().toLowerCase();

  // Keep indices for actions
  let entries = log.map((e,i)=>({e,i}));

  if(q){
    entries = entries.filter(({e})=>{
      const hay = [
        e.ref, e.dateDMY, e.tenantName, e.unitLabel, templateLabel(e.template),
        e.subject, e.template
      ].filter(Boolean).join(' ').toLowerCase();
      return hay.includes(q);
    });
  }

  if(!entries.length){
    box.innerHTML = '<div class="text-gray-500 dark:text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©.</div>';
    return;
  }

  const view = entries.slice(-200).reverse();

  const rows = view.map(({e,i}) => {
    const st = e.status==='VOID' ? 'Ù…Ù„ØºÙŠ' : 'Ù…Ø¹ØªÙ…Ø¯';
    const stClass = e.status==='VOID' ? 'text-red-600' : 'text-emerald-600';
    const safeTenant = escHtml(e.tenantName || '');
    const safeUnit = escHtml(e.unitLabel || '');
    const safeType = escHtml(templateLabel(e.template));
    const safeDate = escHtml(e.dateDMY || '');
    const safeRef = escHtml(e.ref || '');

    const canReprint = (e.status==='FINAL');

    return `
      <tr class="border-b last:border-0 border-gray-200 dark:border-gray-800">
        <td class="py-2 pe-2 font-mono">${safeRef}</td>
        <td class="py-2 pe-2">${safeDate}</td>
        <td class="py-2 pe-2">${safeTenant}</td>
        <td class="py-2 pe-2">${safeUnit}</td>
        <td class="py-2 pe-2">${safeType}</td>
        <td class="py-2 pe-2 ${stClass} font-semibold">${st}</td>
        <td class="py-2 text-end whitespace-nowrap">
          <button data-idx="${i}" class="notice-log-view text-xs bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 px-2 py-1 rounded">Ø¹Ø±Ø¶</button>
          <button data-idx="${i}" class="btn-ui btn-filter" ${canReprint?'':'disabled'}>Ø¥Ø¹Ø§Ø¯Ø© Ø·Ø¨Ø§Ø¹Ø©</button>
          <button data-idx="${i}" class="btn-ui btn-danger" ${e.status==='VOID'?'disabled':''}>Ø¥Ø¨Ø·Ø§Ù„</button>
        </td>
      </tr>
    `;
  }).join('');

  box.innerHTML = `
    <div class="overflow-auto">
      <table class="w-full text-xs">
        <thead>
          <tr class="text-gray-500 dark:text-gray-400 border-b border-gray-200 dark:border-gray-800">
            <th class="text-start py-2 pe-2">Ø±Ù‚Ù…</th>
            <th class="text-start py-2 pe-2">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th class="text-start py-2 pe-2">Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</th>
            <th class="text-start py-2 pe-2">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
            <th class="text-start py-2 pe-2">Ø§Ù„Ù†ÙˆØ¹</th>
            <th class="text-start py-2 pe-2">Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th class="text-end py-2">Ø¥Ø¬Ø±Ø§Ø¡</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  `;

  function loadEntry(i){
    const entry = getNoticeLog()[i];
    if(!entry) return null;

    const refEl = document.getElementById('notice-ref');
    const dateEl = document.getElementById('notice-date');
    if(refEl) refEl.value = entry.ref || refEl.value;
    if(dateEl && entry.dateISO) dateEl.value = entry.dateISO;

    restoreNoticePaperHtml(entry.html || '');
    noticeLoadedFromLog = true;

    const status = document.getElementById('notice-preview-status');
    if(status) status.textContent = 'Ù‡Ø°Ù‡ Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ø³Ø¬Ù„. Ø§Ø³ØªØ®Ø¯Ù… (Ø¥Ø¹Ø§Ø¯Ø© Ø·Ø¨Ø§Ø¹Ø©) Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± Ø§Ù„ØªØ³Ù„Ø³Ù„.';
    return entry;
  }

  // attach actions
  box.querySelectorAll('.notice-log-view').forEach(btn=>{
    btn.onclick = ()=>{
      const i = parseInt(btn.getAttribute('data-idx'), 10);
      const entry = loadEntry(i);
      if(!entry) return;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };
  });

  box.querySelectorAll('.notice-log-reprint').forEach(btn=>{
    btn.onclick = ()=>{
      const i = parseInt(btn.getAttribute('data-idx'), 10);
      const entry = loadEntry(i);
      if(!entry || entry.status!=='FINAL') return;
      markDraftPrint(false);
      window.print();
    };
  });

  box.querySelectorAll('.notice-log-void').forEach(btn=>{
    btn.onclick = ()=>{
      const i = parseInt(btn.getAttribute('data-idx'), 10);
      const log2 = getNoticeLog();
      const entry = log2[i];
      if(!entry || entry.status==='VOID') return;
      if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¨Ø·Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ù†Ø°Ø§Ø±ØŸ Ø³ÙŠØªÙ… Ø¥Ø¨Ù‚Ø§Ø¤Ù‡ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ ÙƒÙ€ (Ù…Ù„ØºÙŠ) ÙˆÙ„Ù† ÙŠØªØºÙŠØ± Ø§Ù„ØªØ³Ù„Ø³Ù„.')) return;
      entry.status = 'VOID';
      entry.voidAt = new Date().toISOString();
      setNoticeLog(log2);
      renderNoticeLog();
    };
  });
}

function printNoticeDraft(){
  if(!noticePreviewReady){
    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø£ÙˆÙ„Ø§Ù‹.');
    return;
  }
  const refEl = document.getElementById('notice-ref');
  const originalRef = refEl ? refEl.value : '';
  // Ù„Ø§ Ù†Ø³ØªÙ‡Ù„Ùƒ Ø§Ù„Ø±Ù‚Ù… ÙÙŠ Ø§Ù„ØªØ¬Ø±Ø¨Ø©
  if(refEl){
    refEl.value = 'DRAFT';
  }
  markDraftPrint(true);
  window.print();
  setTimeout(()=>{
    markDraftPrint(false);
    if(refEl) refEl.value = originalRef;
  }, 50);
}

function printNoticeFinal(){
  if(!noticePreviewReady){
    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø£ÙˆÙ„Ø§Ù‹.');
    return;
  }
    if(noticeLoadedFromLog){
    alert('Ù‡Ø°Ø§ Ø¥Ù†Ø°Ø§Ø± Ù…Ø­ÙÙˆØ¸ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„. Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø·Ø¨Ø§Ø¹ØªÙ‡ Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± "Ø¥Ø¹Ø§Ø¯Ø© Ø·Ø¨Ø§Ø¹Ø©" Ù…Ù† Ø§Ù„Ø³Ø¬Ù„ØŒ Ø£Ùˆ Ø£Ù†Ø´Ø¦ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¬Ø¯ÙŠØ¯Ø©.');
    return;
  }

if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø¹ØªÙ…Ø§Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ù†Ø°Ø§Ø± Ø±Ø³Ù…ÙŠÙ‹Ø§ ÙˆØ­ÙØ¸Ù‡ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ØŸ')) return;

  const refEl = document.getElementById('notice-ref');
  const ref = (refEl?.value || '').trim() || getNextAvailableNoticeNo();

  // âœ… Ø§Ø­ÙØ¸ Ø§Ù„Ø±Ù‚Ù… ÙƒÙ€ "Ù…Ø³ØªØ®Ø¯Ù…" Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±
  commitNoticeNo(ref);

  // âœ… Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¥Ù†Ø°Ø§Ø± ÙÙŠ Ø§Ù„Ø³Ø¬Ù„
  addNoticeLogEntry(collectNoticeLogEntry(ref));
  renderNoticeLog();

  markDraftPrint(false);
  window.print();

  // Ø¨Ø¹Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: Ø¬Ù‡Ù‘Ø² Ø±Ù‚Ù… Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø®Ø·Ø§Ø¨ Ø§Ù„Ù‚Ø§Ø¯Ù…
  setTimeout(() => {
    if(refEl){
      refEl.value = getNextAvailableNoticeNo();
    }
  }, 50);
}

function undoLastFinalNotice(){
  const log = getNoticeLog();
  if(!log.length){
    alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ù†Ø°Ø§Ø±Ø§Øª Ù…Ø¹ØªÙ…Ø¯Ø© Ù„Ù„ØªØ±Ø§Ø¬Ø¹.');
    return;
  }
  const last = log[log.length-1];
  if(!last || last.status!=='FINAL'){
    alert('Ø¢Ø®Ø± Ø³Ø¬Ù„ Ù„ÙŠØ³ (Ù…Ø¹ØªÙ…Ø¯) Ø£Ùˆ ØªÙ… Ø¥Ø¨Ø·Ø§Ù„Ù‡ Ø¨Ø§Ù„ÙØ¹Ù„.');
    return;
  }
  if(!confirm('ØªØ£ÙƒÙŠØ¯: ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø¢Ø®Ø± Ø§Ø¹ØªÙ…Ø§Ø¯ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ ÙˆØ¥Ø±Ø¬Ø§Ø¹ Ø±Ù‚Ù… Ø§Ù„Ø®Ø·Ø§Ø¨ Ù„ÙŠÙØ³ØªØ®Ø¯Ù… Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.')) return;

  // Remove from used refs only if it's the latest used ref
  const used = getUsedNoticeRefs();
  const lastUsed = used.length ? used[used.length-1] : null;

  if(lastUsed !== last.ref){
    alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ù„Ø£Ù† Ù‡Ù†Ø§Ùƒ Ø£Ø±Ù‚Ø§Ù… Ù„Ø§Ø­Ù‚Ø© ØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯Ù‡Ø§. (Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±)');
    return;
  }

  used.pop();
  setUsedNoticeRefs(used);

  // Roll back counter to this number
  const m = /^NT-(\d{5})$/.exec(last.ref || '');
  if(m){
    const num = parseInt(m[1], 10);
    if(num && num > 0) setNoticeCounter(num);
  }

  log.pop();
  setNoticeLog(log);
  renderNoticeLog();

  const refEl = document.getElementById('notice-ref');
  if(refEl){
    refEl.value = getNextAvailableNoticeNo();
  }
}


// Backward compatible alias
function printNotice(){
  return printNoticeFinal();
}


// ================= DASHBOARD =================
  let leasesChart, financeChart;

  function updateDashboard(){
    document.getElementById('current-date-display').textContent =
      new Date().toLocaleDateString('ar-AE', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
    renderLogs();

    const stats = { active:0, empty:0, expired:0, totalRent:0, expiring:0, endedByDate:0, totalUnits:0 };
    properties.forEach(p=>p.units.forEach(u=>{
      stats.totalUnits++;

      if(u.status==='Ù…Ø¤Ø¬Ø±Ø©'){ stats.active++; stats.totalRent += calcUnitContractValue(u); }
      else if(u.status==='Ù…Ù†ØªÙ‡ÙŠØ©') stats.expired++;
      else stats.empty++;

      // Ø§Ø­ØªØ³Ø§Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù‚Ø¯ Ù…Ù† Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® (Ù„Ø§ ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ status Ø§Ù„Ù…Ø®Ø²Ù†)
      if(u.contractNo || u.end){
        const cs = leaseContractStatusFromDates(u.start, u.end);
        if(cs === 'Ø´Ø§Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡') stats.expiring++;
        else if(cs === 'Ù…Ù†ØªÙ‡ÙŠ') stats.endedByDate++;
      }
    }));

    const tenants = getTenantsData();
    const lateCount = tenants.filter(t => t.balance > 0).length;

    const lateTenants = tenants.filter(t => (Number(t.balance)||0) > 0);
    const overduePaymentsTotal = lateTenants.reduce((sum,t)=> sum + (Number(t.balance)||0), 0);
    const overduePaymentsCount = lateTenants.length;



    // ===== Dashboard: Monthly Expenses + Upcoming Cheques (30 days) =====
    const now = new Date();
    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1); monthStart.setHours(0,0,0,0);
    const nextMonthStart = new Date(now.getFullYear(), now.getMonth()+1, 1); nextMonthStart.setHours(0,0,0,0);

    
    let monthRevenueTotal = 0;
    let monthRevenueCount = 0;
    (payments||[]).forEach(pm=>{
      const d = _leaseDateLocalNum(pm?.date);
      if(Number.isFinite(d) && d >= monthStart.getTime() && d < nextMonthStart.getTime()){
        monthRevenueTotal += Number(pm?.amount||0) || 0;
        monthRevenueCount++;
      }
    });

let monthExpensesTotal = 0;
    let monthExpensesCount = 0;
    (expenses||[]).forEach(ex=>{
      const d = _leaseDateLocalNum(ex?.date);
      if(Number.isFinite(d) && d >= monthStart.getTime() && d < nextMonthStart.getTime()){
        monthExpensesTotal += Number(ex?.amount||0) || 0;
        monthExpensesCount++;
      }
    });

    const today = new Date(); today.setHours(0,0,0,0);
    const next30 = new Date(today); next30.setDate(next30.getDate()+30);

    let upcomingChequesTotal = 0;
    let upcomingChequesCount = 0;
    (cheques||[]).forEach(c0=>{
      const c = normalizeChequeRecord(c0);
      const d = _leaseDateLocalNum(c?.dueDate);
      if(Number.isFinite(d) && d >= today.getTime() && d <= next30.getTime()){
        const st = normalizeChequeStatus(c?.status);
        if(st !== 'Ù…ØµØ±ÙˆÙ'){ // Ø§Ù„Ù‚Ø§Ø¯Ù… = ØºÙŠØ± Ù…ØµØ±ÙˆÙ
          upcomingChequesTotal += Number(c?.value||0) || 0;
          upcomingChequesCount++;
        }
      }
    });


    document.getElementById('total-annual-rent').textContent = formatAED(stats.totalRent);

const monthRevenueTotalEl = document.getElementById('month-revenue-total');
    if(monthRevenueTotalEl) monthRevenueTotalEl.textContent = formatAED(monthRevenueTotal);
    const monthRevenueCountEl = document.getElementById('month-revenue-count');
    if(monthRevenueCountEl) monthRevenueCountEl.textContent = String(monthRevenueCount);

const monthExpTotalEl = document.getElementById('month-expenses-total');
    if(monthExpTotalEl) monthExpTotalEl.textContent = formatAED(monthExpensesTotal);
    const monthExpCountEl = document.getElementById('month-expenses-count');
    if(monthExpCountEl) monthExpCountEl.textContent = String(monthExpensesCount);
    const upcomingChequesTotalEl = document.getElementById('upcoming-cheques-total');
    if(upcomingChequesTotalEl) upcomingChequesTotalEl.textContent = formatAED(upcomingChequesTotal);
    const upcomingChequesCountEl = document.getElementById('upcoming-cheques-count');
    if(upcomingChequesCountEl) upcomingChequesCountEl.textContent = String(upcomingChequesCount);

    const overduePaymentsTotalEl = document.getElementById('overdue-payments-total');
    if(overduePaymentsTotalEl) overduePaymentsTotalEl.textContent = formatAED(overduePaymentsTotal);
    const overduePaymentsCountEl = document.getElementById('overdue-payments-count');
    if(overduePaymentsCountEl) overduePaymentsCountEl.textContent = String(overduePaymentsCount);

document.getElementById('active-leases-count').textContent = stats.active;
const expEl = document.getElementById('expiring-leases-count');
    if(expEl) expEl.textContent = String(stats.expiring);
    const endEl = document.getElementById('ended-leases-count');
    if(endEl) endEl.textContent = String(stats.endedByDate);
    const totalUnitsEl = document.getElementById('total-units-count');
    if(totalUnitsEl) totalUnitsEl.textContent = String(stats.totalUnits);
    const occEl = document.getElementById('occupancy-rate');
    const occBar = document.getElementById('occupancy-bar');
    const occ = stats.totalUnits ? (stats.active / stats.totalUnits) * 100 : 0;
    if(occEl) occEl.textContent = `${occ.toFixed(1)}%`;
    if(occBar) occBar.style.width = `${Math.max(0, Math.min(100, occ)).toFixed(1)}%`;
    document.getElementById('empty-units-count').textContent = stats.empty;
    document.getElementById('late-tenants-count').textContent = lateCount;

    const isDark = document.body.classList.contains('dark-mode');
    const textColor = isDark ? '#d1d5db' : '#666';
    const gridColor = isDark ? '#374151' : '#e5e5e5';

    if(leasesChart) leasesChart.destroy();
    leasesChart = new Chart(document.getElementById('leasesChart'), {
      type:'doughnut',
      data:{
        labels:['Ù…Ø¤Ø¬Ø±Ø©','Ø´Ø§ØºØ±Ø©','Ù…Ù†ØªÙ‡ÙŠØ©'],
        datasets:[{
          data:[stats.active, stats.empty, stats.expired],
          backgroundColor:['#10b981','#e5e7eb','#f43f5e'],
          borderColor: isDark ? '#1f2937' : '#fff'
        }]
      },
      options:{
        plugins:{ legend:{ position:'left', labels:{ color:textColor } } }
      }
    });

    const collected = payments.reduce((s,p)=>s+p.amount,0);
    if(financeChart) financeChart.destroy();
    financeChart = new Chart(document.getElementById('financeChart'), {
      type:'bar',
      data:{
        labels:['Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ø³Ù†ÙˆÙŠØ§Ù‹', 'Ø§Ù„Ù…Ù‚Ø¨ÙˆØ¶ ÙØ¹Ù„ÙŠØ§Ù‹'],
        datasets:[{
          label:'AED',
          data:[stats.totalRent, collected],
          backgroundColor:['#3b82f6', '#10b981'],
          borderRadius: 6
        }]
      },
      options:{
        scales:{
          y:{ beginAtZero:true, grid:{ color:gridColor }, ticks:{ color:textColor } },
          x:{ ticks:{ color:textColor }, grid:{ display:false } }
        },
        plugins:{ legend:{ labels:{ color:textColor } } }
      }
    });
  }

  // Dashboard -> Leases quick navigation (with computed status filter)
  function openLeasesFromDashboard(statusLabel){
    try{
      // Reset existing advanced filters first (avoids mixing states)
      resetLeaseAdvanced();
    }catch(e){}

    // Navigate
    showView('leases');

    // Apply filter
    const statusEl = document.getElementById('leases-filter-status');
    if(statusEl){
      statusEl.value = statusLabel || '';
    }
    try{ _lsSet('re_leases_f_status', statusLabel || ''); }catch(e){}

    // Open filters panel for clarity
    const panel = document.getElementById('leases-filters-panel');
    const btn = document.getElementById('leases-toggle-filters');
    if(panel){
      panel.classList.remove('hidden');
      if(btn) btn.textContent = 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©';
      try{ _lsSet('re_leases_filters_open', '1'); }catch(e){}
    }

    renderLeases();
  }


  function renderLogs(){
    const el=document.getElementById('contractLogs');
    el.innerHTML='';
    contractLogs.forEach(l=>{
      const li=document.createElement('li');
      li.innerHTML = `<span class="text-xs text-gray-400 font-mono">[${new Date(l.t).toLocaleTimeString('ar-AE')}]</span> ${l.m}`;
      el.appendChild(li);
    });
  }

  // ================= PROPERTIES =================
  function renderProperties(){
    const container = document.getElementById('properties-container');
    container.innerHTML = '';
    const search = (document.getElementById('prop-search').value||'').toLowerCase().trim();

    const propSortBy = (document.getElementById('prop-sort-by')?.value) || _lsGet('re_prop_sort_by','name');
    const propSortDir = (document.getElementById('prop-sort-dir')?.dataset?.dir) || _lsGet('re_prop_sort_dir','asc');
    const unitSortBy = (document.getElementById('unit-sort-by')?.value) || _lsGet('re_unit_sort_by','unitName');
    const unitSortDir = (document.getElementById('unit-sort-dir')?.dataset?.dir) || _lsGet('re_unit_sort_dir','asc');

    const unitStatusFilter = (document.getElementById('unit-status-filter')?.value) || _lsGet('re_unit_status_filter','');
    const unitEndFrom = (document.getElementById('unit-end-from')?.value) || _lsGet('re_unit_end_from','');
    const unitEndTo   = (document.getElementById('unit-end-to')?.value)   || _lsGet('re_unit_end_to','');

    const hasStatusFilter = !!unitStatusFilter;
    const hasEndFrom = !!unitEndFrom;
    const hasEndTo = !!unitEndTo;
    const hasQuery = (!!search) || hasStatusFilter || hasEndFrom || hasEndTo;
    const endFromNum = hasEndFrom ? _unitDateNum(unitEndFrom) : NaN;
    const endToNum   = hasEndTo   ? _unitDateNum(unitEndTo)   : NaN;

    let __totalUnits = 0;
    let __shownUnits = 0;
    let __countVacant = 0;
    let __countRented = 0;

    const props = _sortProperties(properties, propSortBy, propSortDir);

    props.forEach(p=>{
      __totalUnits += (p.units||[]).length;
      const filteredUnits = (p.units||[]).filter(u=>{
        const matchesSearch = (!search) ||
          (u.unitName||u.name||'').toLowerCase().includes(search) ||
          (u.id||'').toLowerCase().includes(search) ||
          (u.tenant||'').toLowerCase().includes(search) ||
          (u.contractNo||'').toLowerCase().includes(search);
        if(!matchesSearch) return false;

        if(hasStatusFilter){
          if((u.status||'') !== unitStatusFilter) return false;
        }
        if(hasEndFrom || hasEndTo){
          const eNum = _unitDateNum(u.end);
          if(!Number.isFinite(eNum)) return false;
          if(hasEndFrom && Number.isFinite(endFromNum) && eNum < endFromNum) return false;
          if(hasEndTo && Number.isFinite(endToNum) && eNum > endToNum) return false;
        }
        return true;
      });
      if(hasQuery && filteredUnits.length === 0) return;

      const unitsToRender = hasQuery ? filteredUnits : (p.units||[]);
      const unitsSorted = _sortUnits(unitsToRender, unitSortBy, unitSortDir);
      __shownUnits += unitsSorted.length;
      unitsSorted.forEach(__u=>{
        const __st = (__u.status || 'Ø´Ø§ØºØ±Ø©');
        if(__st === 'Ù…Ø¤Ø¬Ø±Ø©') __countRented++;
        else __countVacant++;
      });
const contentId = `units-content-${p.id}`;
      const iconId = `icon-${p.id}`;

      const rowsHTML = unitsSorted.map(u=>{
                const st = (u.status === 'Ù…Ø¤Ø¬Ø±Ø©') ? 'Ù…Ø¤Ø¬Ø±Ø©' : 'Ø´Ø§ØºØ±Ø©';
        const statusMeta =
          st==='Ù…Ø¤Ø¬Ø±Ø©'
            ? { pill:'bg-emerald-100 text-emerald-800 dark:bg-emerald-900 dark:text-emerald-200', dot:'bg-emerald-600 dark:bg-emerald-300' }
            : { pill:'bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-200', dot:'bg-amber-600 dark:bg-amber-300' };

return `
          <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors">
            <td class="px-4 py-3 font-bold text-gray-700 dark:text-gray-200">${u.id || ""}</td>
            <td class="px-4 py-3 text-gray-700 dark:text-gray-200">${u.unitName || u.name || ""}</td>
            <td class="px-4 py-3 text-xs text-gray-600 dark:text-gray-300">
              <div class="flex flex-col leading-tight">
                <span class="font-mono">${u.elecMeterNo || '-'}</span>
              </div>
            </td>
            <td class="px-4 py-3 text-xs text-gray-600 dark:text-gray-300">
              <div class="flex flex-col leading-tight">
                <span class="font-mono">${u.waterMeterNo || '-'}</span>
              </div>
            </td>
            <td class="px-4 py-3 text-xs text-gray-600 dark:text-gray-300 font-mono">${(u.taqaPropertyId||'')}</td>
            <td class="px-4 py-3 text-xs text-gray-500 dark:text-gray-400">${u.type||'-'}</td>
            <td class="px-4 py-3">
              <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-[11px] font-bold ${statusMeta.pill}"><span class="h-1.5 w-1.5 rounded-full ${statusMeta.dot}"></span>${st}</span>
            </td>
            <td class="px-4 py-3 text-sm max-w-[150px] truncate" title="${u.tenant||''}">${u.tenant||'-'}</td>
            <td class="px-4 py-3 font-mono text-emerald-700 dark:text-emerald-400 font-bold text-sm">${u.rent ? u.rent.toLocaleString() : '-'}</td>
            <td class="px-4 py-3 text-xs font-mono truncate max-w-[90px] text-gray-500 dark:text-gray-400" title="${u.contractNo||''}">${u.contractNo||'-'}</td>
            <td class="px-4 py-3 text-[10px] text-gray-400">
              <div class="flex flex-col">
                <span>${u.start||'--'}</span>
                <span>${u.end||'--'}</span>
              </div>
            </td>
            <td class="px-4 py-3">
              <div class="flex gap-1">
                <button onclick="openUnitModal('${p.id}','${u.id}')" class="px-2 py-1 text-xs bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-300 rounded transition-colors" title="ØªØ¹Ø¯ÙŠÙ„">âœï¸</button>
                <button onclick="openLeaseModal('${p.id}','${u.id}')" class="px-2 py-1 text-xs bg-purple-100 dark:bg-purple-900/40 text-purple-700 dark:text-purple-300 rounded transition-colors" title="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø¯">ğŸ“„</button>
                <button onclick="deleteUnit('${p.id}','${u.id}')" class="px-2 py-1 text-xs bg-rose-100 dark:bg-rose-900/40 text-rose-700 dark:text-rose-300 rounded transition-colors" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');

      const card = document.createElement('div');
      card.className = "bg-white dark:bg-dark-surface rounded-2xl border border-gray-100 dark:border-gray-700 overflow-hidden transition-all duration-200 hover:shadow-md";

      card.innerHTML = `
        <div class="p-4 bg-gray-50 dark:bg-dark-surface border-b border-gray-100 dark:border-gray-700 flex items-center justify-between select-none" onclick="toggleUnitVisibility('${p.id}')">
          <div class="flex items-center gap-3">
            <div id="${iconId}" class="transition-transform duration-300 transform rotate-0 text-gray-400">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </div>
            <div>
              <div class="flex items-center gap-2">
                <h3 class="text-lg font-bold text-gray-800 dark:text-white">${p.name}</h3>
                <span class="bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-[10px] px-2 py-0.5 rounded-full font-mono">${p.id}</span>
              </div>
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">ğŸ“ ${p.location||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} | ğŸ¢ ${(p.units||[]).length} ÙˆØ­Ø¯Ø§Øª</p>
            </div>
          </div>
          <div class="flex gap-2" onclick="event.stopPropagation()">
            <button onclick="openUnitModal('${p.id}')" class="btn-ui btn-success">+ ÙˆØ­Ø¯Ø©</button>
            <button onclick="deleteProperty('${p.id}')" class="btn-ui btn-danger">Ø­Ø°Ù</button>
          </div>
        </div>

        <div id="${contentId}" class="p-4 hidden">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-50 dark:bg-dark-bg text-xs text-gray-500 dark:text-gray-400 uppercase">
                <tr>
                  <th class="px-4 py-2">Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©</th><th class="px-4 py-2">Ø§Ø³Ù… Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                  <th class="px-4 py-2">Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</th>
                  <th class="px-4 py-2">Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ÙŠØ§Ù‡</th>
                  <th class="px-4 py-2">Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ù‚Ø§Ø± (Ø·Ø§Ù‚Ø©)</th>
                  <th class="px-4 py-2">Ø§Ù„Ù†ÙˆØ¹</th>
                  <th class="px-4 py-2">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                  <th class="px-4 py-2">Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</th>
                  <th class="px-4 py-2">Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                  <th class="px-4 py-2">Ø§Ù„Ø¹Ù‚Ø¯</th>
                  <th class="px-4 py-2">Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®</th>
                  <th class="px-4 py-2">ØªØ­ÙƒÙ…</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                ${rowsHTML}
              </tbody>
            </table>
          </div>
        </div>
      `;

      container.appendChild(card);
    });

    
    const hintEl = document.getElementById('prop-filters-hint');
    if(hintEl){
      hintEl.textContent = hasQuery ? `Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ${__shownUnits} Ù…Ù† ${__totalUnits}` : `Ø§Ù„ÙˆØ­Ø¯Ø§Øª: ${__totalUnits}`;
    }

    // Quick Stats update
    const statVacEl = document.getElementById('stat-vacant');
    const statRentEl = document.getElementById('stat-rented');
    const statShownEl = document.getElementById('stat-shown');
    const statTotalEl = document.getElementById('stat-total');
    const statShownBigEl = document.getElementById('stat-shown-big');

    if(statVacEl) statVacEl.textContent = String(__countVacant);
    if(statRentEl) statRentEl.textContent = String(__countRented);
if(statShownEl) statShownEl.textContent = String(__shownUnits);
    if(statTotalEl) statTotalEl.textContent = String(__totalUnits);
    if(statShownBigEl) statShownBigEl.textContent = String(__shownUnits);

  }

  function toggleUnitVisibility(propId) {
    const content = document.getElementById(`units-content-${propId}`);
    const icon = document.getElementById(`icon-${propId}`);
    if(!content || !icon) return;
    if (content.classList.contains('hidden')) {
      content.classList.remove('hidden');
      icon.classList.remove('-rotate-90');
      icon.classList.add('rotate-0');
    } else {
      content.classList.add('hidden');
      icon.classList.remove('rotate-0');
      icon.classList.add('-rotate-90');
    }
  }

  function expandAllProperties() {
    properties.forEach(p => {
      const content = document.getElementById(`units-content-${p.id}`);
      const icon = document.getElementById(`icon-${p.id}`);
      if(content && icon) {
        content.classList.remove('hidden');
        icon.classList.remove('-rotate-90');
        icon.classList.add('rotate-0');
      }
    });
  }

  function collapseAllProperties() {
    properties.forEach(p => {
      const content = document.getElementById(`units-content-${p.id}`);
      const icon = document.getElementById(`icon-${p.id}`);
      if(content && icon) {
        content.classList.add('hidden');
        icon.classList.remove('rotate-0');
        icon.classList.add('-rotate-90');
      }
    });
  }

  function deleteProperty(id){
    if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø§Ø± ÙˆØ¬Ù…ÙŠØ¹ ÙˆØ­Ø¯Ø§ØªÙ‡ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) return;
    const prop = properties.find(p=>p.id===id);
    properties = properties.filter(p => p.id !== id);
    saveToLocal();
    renderProperties();
    renderLeases();
    renderPayments();
    updateDashboard();
    logAction(`ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø§Ø± ${prop ? prop.name : id}`);
  }

  function deleteUnit(propId, unitId){
    if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ­Ø¯Ø©ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¹Ù‚Ø¯Ù‡Ø§ ÙˆØ¯ÙØ¹Ø§ØªÙ‡Ø§ Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø§ Ø¥Ù† ÙˆÙØ¬Ø¯Øª.')) return;
    const prop = properties.find(p=>p.id===propId);
    if(!prop) return;
    const unit = prop.units.find(u=>u.id===unitId);
    if(!unit) return;

    // Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø¹Ù‚Ø¯/Ø§Ù„ÙˆØ­Ø¯Ø©
    payments = payments.filter(p => !(p.unit === unit.name && p.contract === unit.contractNo));
    prop.units = prop.units.filter(u=>u.id!==unitId);

    saveToLocal();
    renderProperties();
    renderLeases();
    renderPayments();
    updateDashboard();
    logAction(`ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© ${unit.name} Ù…Ù† Ø§Ù„Ø¹Ù‚Ø§Ø± ${prop.name}`);
  }

  // ================= LEASES =================
  let _leasesAdvInited = false;

  function _leaseNorm(v){
    return (v===null || v===undefined) ? '' : String(v).trim().toLowerCase();
  }
  function _leaseDateNum(s){
    const v = (s||'').toString().slice(0,10);
    const t = Date.parse(v);
    return Number.isFinite(t) ? t : NaN;
  }
  function _unitDateNum(s){
    const v = (s||'').toString().slice(0,10);
    const t = Date.parse(v);
    return Number.isFinite(t) ? t : NaN;
  }
  
  function leaseSafeKey(k){
    return String(k||'').replace(/[^a-zA-Z0-9_-]/g,'_');
  }
  function toggleLeaseGroupRow(groupKey){
    const safe = leaseSafeKey(groupKey);
    const row = document.getElementById(`lease-group-${safe}`);
    if(!row) return;
    row.classList.toggle('hidden');
  }

function _leaseHay(l){
    return [
      l.contractNo, l.tenant, l.name, l.id, l.propName, l.propId,
      leaseContractStatusFromDates(l.start, l.end),
      l.start, l.end
    ].filter(Boolean).join(' | ').toLowerCase();
  }

  function _leasesUi(){
    return {
      q: document.getElementById('lease-search-input')?.value || '',
      sortBy: document.getElementById('leases-sort-by')?.value || '',
      sortDir: document.getElementById('leases-sort-dir')?.dataset?.dir || '',
      status: document.getElementById('leases-filter-status')?.value || '',
      prop: document.getElementById('leases-filter-prop')?.value || '',
      unit: document.getElementById('leases-filter-unit')?.value || '',
      tenant: document.getElementById('leases-filter-tenant')?.value || '',
      contractNo: document.getElementById('leases-filter-contract')?.value || '',
      rentMin: document.getElementById('leases-filter-rent-min')?.value || '',
      rentMax: document.getElementById('leases-filter-rent-max')?.value || '',
      startFrom: document.getElementById('leases-filter-start-from')?.value || '',
      startTo: document.getElementById('leases-filter-start-to')?.value || '',
      endFrom: document.getElementById('leases-filter-end-from')?.value || '',
      endTo: document.getElementById('leases-filter-end-to')?.value || '',
    };
  }

  function _leasesPersistFromUI(){
    const ui = _leasesUi();
    _lsSet('re_leases_q', ui.q);
    _lsSet('re_leases_sort_by', ui.sortBy || _lsGet('re_leases_sort_by','end'));
    _lsSet('re_leases_sort_dir', ui.sortDir || _lsGet('re_leases_sort_dir','asc'));

    _lsSet('re_leases_f_status', ui.status);
    _lsSet('re_leases_f_prop', ui.prop);
    _lsSet('re_leases_f_unit', ui.unit);
    _lsSet('re_leases_f_tenant', ui.tenant);
    _lsSet('re_leases_f_contract', ui.contractNo);
    _lsSet('re_leases_f_rmin', ui.rentMin);
    _lsSet('re_leases_f_rmax', ui.rentMax);
    _lsSet('re_leases_f_sfrom', ui.startFrom);
    _lsSet('re_leases_f_sto', ui.startTo);
    _lsSet('re_leases_f_efrom', ui.endFrom);
    _lsSet('re_leases_f_eto', ui.endTo);
  }

  function _leasesRestoreUIOnce(){
    if(_leasesAdvInited) return;
    _leasesAdvInited = true;

    const qEl = document.getElementById('lease-search-input');
    if(qEl) qEl.value = _lsGet('re_leases_q','');

    const sortByEl = document.getElementById('leases-sort-by');
    if(sortByEl) sortByEl.value = _lsGet('re_leases_sort_by','end');

    const dir = _lsGet('re_leases_sort_dir','asc');
    const dirBtn = document.getElementById('leases-sort-dir');
    if(dirBtn){
      dirBtn.dataset.dir = dir;
      dirBtn.textContent = (dir==='asc') ? 'â¬†ï¸' : 'â¬‡ï¸';
    }

    const statusEl = document.getElementById('leases-filter-status');
    if(statusEl) statusEl.value = _lsGet('re_leases_f_status','');

    const propEl = document.getElementById('leases-filter-prop');
    if(propEl) propEl.value = _lsGet('re_leases_f_prop','');

    const unitEl = document.getElementById('leases-filter-unit');
    if(unitEl) unitEl.value = _lsGet('re_leases_f_unit','');

    const tenantEl = document.getElementById('leases-filter-tenant');
    if(tenantEl) tenantEl.value = _lsGet('re_leases_f_tenant','');

    const cEl = document.getElementById('leases-filter-contract');
    if(cEl) cEl.value = _lsGet('re_leases_f_contract','');

    const rminEl = document.getElementById('leases-filter-rent-min');
    if(rminEl) rminEl.value = _lsGet('re_leases_f_rmin','');

    const rmaxEl = document.getElementById('leases-filter-rent-max');
    if(rmaxEl) rmaxEl.value = _lsGet('re_leases_f_rmax','');

    const sFromEl = document.getElementById('leases-filter-start-from');
    if(sFromEl) sFromEl.value = _lsGet('re_leases_f_sfrom','');

    const sToEl = document.getElementById('leases-filter-start-to');
    if(sToEl) sToEl.value = _lsGet('re_leases_f_sto','');

    const eFromEl = document.getElementById('leases-filter-end-from');
    if(eFromEl) eFromEl.value = _lsGet('re_leases_f_efrom','');

    const eToEl = document.getElementById('leases-filter-end-to');
    if(eToEl) eToEl.value = _lsGet('re_leases_f_eto','');

    const open = _lsGet('re_leases_filters_open','0') === '1';
    const panel = document.getElementById('leases-filters-panel');
    const tBtn = document.getElementById('leases-toggle-filters');
    if(panel && tBtn){
      panel.classList.toggle('hidden', !open);
      tBtn.textContent = open ? 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©' : 'Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©';
    }
  }

  function onLeaseAdvancedChanged(){
    _leasesPersistFromUI();
    renderLeases();
  }

  function toggleLeaseSortDir(){
    const btn = document.getElementById('leases-sort-dir');
    if(!btn) return;
    const next = (btn.dataset.dir==='asc') ? 'desc' : 'asc';
    btn.dataset.dir = next;
    btn.textContent = (next==='asc') ? 'â¬†ï¸' : 'â¬‡ï¸';
    _lsSet('re_leases_sort_dir', next);
    renderLeases();
  }

  function toggleLeaseFilters(){
    const panel = document.getElementById('leases-filters-panel');
    const btn = document.getElementById('leases-toggle-filters');
    if(!panel || !btn) return;
    const willShow = panel.classList.contains('hidden');
    panel.classList.toggle('hidden');
    btn.textContent = willShow ? 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©' : 'Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©';
    _lsSet('re_leases_filters_open', willShow ? '1' : '0');
  }

  function resetLeaseAdvanced(){
    const keys = [
      're_leases_q','re_leases_sort_by','re_leases_sort_dir','re_leases_filters_open',
      're_leases_f_status','re_leases_f_prop','re_leases_f_unit','re_leases_f_tenant','re_leases_f_contract',
      're_leases_f_rmin','re_leases_f_rmax','re_leases_f_sfrom','re_leases_f_sto','re_leases_f_efrom','re_leases_f_eto'
    ];
    keys.forEach(k=>{ try{ localStorage.removeItem(k); }catch(e){} });

    // Reset UI
    const qEl = document.getElementById('lease-search-input'); if(qEl) qEl.value='';
    const sortByEl = document.getElementById('leases-sort-by'); if(sortByEl) sortByEl.value='end';
    const dirBtn = document.getElementById('leases-sort-dir'); if(dirBtn){ dirBtn.dataset.dir='asc'; dirBtn.textContent='â¬†ï¸'; }
    const statusEl = document.getElementById('leases-filter-status'); if(statusEl) statusEl.value='';
    const propEl = document.getElementById('leases-filter-prop'); if(propEl) propEl.value='';
    const unitEl = document.getElementById('leases-filter-unit'); if(unitEl) unitEl.value='';
    const tenantEl = document.getElementById('leases-filter-tenant'); if(tenantEl) tenantEl.value='';
    const cEl = document.getElementById('leases-filter-contract'); if(cEl) cEl.value='';
    const rminEl = document.getElementById('leases-filter-rent-min'); if(rminEl) rminEl.value='';
    const rmaxEl = document.getElementById('leases-filter-rent-max'); if(rmaxEl) rmaxEl.value='';
    const sFromEl = document.getElementById('leases-filter-start-from'); if(sFromEl) sFromEl.value='';
    const sToEl = document.getElementById('leases-filter-start-to'); if(sToEl) sToEl.value='';
    const eFromEl = document.getElementById('leases-filter-end-from'); if(eFromEl) eFromEl.value='';
    const eToEl = document.getElementById('leases-filter-end-to'); if(eToEl) eToEl.value='';

    const panel = document.getElementById('leases-filters-panel');
    const tBtn = document.getElementById('leases-toggle-filters');
    if(panel && tBtn){
      panel.classList.add('hidden');
      tBtn.textContent = 'Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©';
    }

    renderLeases();
  }

  // ================= Advanced Search & Sort (Cheques) =================
  let _chequesUIRestored = false;

  function _chequesRestoreUIOnce(){
    if(_chequesUIRestored) return;
    _chequesUIRestored = true;

    const qEl = document.getElementById('cheques-search-input');
    const sortByEl = document.getElementById('cheques-sort-by');
    const sortDirBtn = document.getElementById('cheques-sort-dir');

    const fStatus = document.getElementById('cheques-filter-status');
    const fTenant = document.getElementById('cheques-filter-tenant');
    const fUnit = document.getElementById('cheques-filter-unit');
    const fChequeNo = document.getElementById('cheques-filter-chequeno');
    const fBank = document.getElementById('cheques-filter-bank');
    const fAMin = document.getElementById('cheques-filter-amin');
    const fAMax = document.getElementById('cheques-filter-amax');
    const fDFrom = document.getElementById('cheques-filter-dfrom');
    const fDTo = document.getElementById('cheques-filter-dto');

    if(qEl) qEl.value = _lsGet('re_cheques_q','');
    if(sortByEl) sortByEl.value = _lsGet('re_cheques_sort_by','due');

    const dir = _lsGet('re_cheques_sort_dir','desc');
    if(sortDirBtn){
      sortDirBtn.dataset.dir = (dir==='asc') ? 'asc' : 'desc';
      sortDirBtn.textContent = (sortDirBtn.dataset.dir==='asc') ? 'â¬†ï¸' : 'â¬‡ï¸';
    }

    if(fStatus) fStatus.value = _lsGet('re_cheques_f_status','');
    if(fTenant) fTenant.value = _lsGet('re_cheques_f_tenant','');
    if(fUnit) fUnit.value = _lsGet('re_cheques_f_unit','');
    if(fChequeNo) fChequeNo.value = _lsGet('re_cheques_f_chequeno','');
    if(fBank) fBank.value = _lsGet('re_cheques_f_bank','');
    if(fAMin) fAMin.value = _lsGet('re_cheques_f_amin','');
    if(fAMax) fAMax.value = _lsGet('re_cheques_f_amax','');
    if(fDFrom) fDFrom.value = _lsGet('re_cheques_f_dfrom','');
    if(fDTo) fDTo.value = _lsGet('re_cheques_f_dto','');

    // restore filters panel open/closed
    const open = _lsGet('re_cheques_filters_open','0')==='1';
    const panel = document.getElementById('cheques-filters-panel');
    const tBtn = document.getElementById('cheques-toggle-filters');
    if(panel && tBtn){
      panel.classList.toggle('hidden', !open);
      tBtn.textContent = open ? 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©' : 'Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©';
    }
  }

  function _chequesPersistFromUI(){
    const qEl = document.getElementById('cheques-search-input');
    const sortByEl = document.getElementById('cheques-sort-by');
    const sortDirBtn = document.getElementById('cheques-sort-dir');

    _lsSet('re_cheques_q', (qEl?.value||'').trim());
    _lsSet('re_cheques_sort_by', (sortByEl?.value||'due'));
    _lsSet('re_cheques_sort_dir', (sortDirBtn?.dataset?.dir||'desc'));

    _lsSet('re_cheques_f_status', (document.getElementById('cheques-filter-status')?.value||'').trim());
    _lsSet('re_cheques_f_tenant', (document.getElementById('cheques-filter-tenant')?.value||'').trim());
    _lsSet('re_cheques_f_unit', (document.getElementById('cheques-filter-unit')?.value||'').trim());
    _lsSet('re_cheques_f_chequeno', (document.getElementById('cheques-filter-chequeno')?.value||'').trim());
    _lsSet('re_cheques_f_bank', (document.getElementById('cheques-filter-bank')?.value||'').trim());
    _lsSet('re_cheques_f_amin', (document.getElementById('cheques-filter-amin')?.value||'').trim());
    _lsSet('re_cheques_f_amax', (document.getElementById('cheques-filter-amax')?.value||'').trim());
    _lsSet('re_cheques_f_dfrom', (document.getElementById('cheques-filter-dfrom')?.value||'').trim());
    _lsSet('re_cheques_f_dto', (document.getElementById('cheques-filter-dto')?.value||'').trim());
  }

  function onChequesAdvancedChanged(){
    _chequesPersistFromUI();
    renderCheques();
  }

  function toggleChequesSortDir(){
    const btn = document.getElementById('cheques-sort-dir');
    if(!btn) return;
    const cur = (btn.dataset.dir==='asc') ? 'asc' : 'desc';
    const next = (cur==='asc') ? 'desc' : 'asc';
    btn.dataset.dir = next;
    btn.textContent = (next==='asc') ? 'â¬†ï¸' : 'â¬‡ï¸';
    onChequesAdvancedChanged();
  }

  function toggleChequesFiltersPanel(){
    const panel = document.getElementById('cheques-filters-panel');
    const btn = document.getElementById('cheques-toggle-filters');
    if(!panel || !btn) return;
    const willShow = panel.classList.contains('hidden');
    panel.classList.toggle('hidden', !willShow);
    btn.textContent = willShow ? 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©' : 'Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©';
    _lsSet('re_cheques_filters_open', willShow ? '1' : '0');
  }

  function resetChequesAdvanced(){
    const keys = [
      're_cheques_q','re_cheques_sort_by','re_cheques_sort_dir','re_cheques_filters_open',
      're_cheques_f_status','re_cheques_f_tenant','re_cheques_f_unit','re_cheques_f_chequeno','re_cheques_f_bank',
      're_cheques_f_amin','re_cheques_f_amax','re_cheques_f_dfrom','re_cheques_f_dto'
    ];
    keys.forEach(k=>{ try{ localStorage.removeItem(k); }catch(e){} });

    // Reset UI
    const qEl = document.getElementById('cheques-search-input'); if(qEl) qEl.value='';
    const sortByEl = document.getElementById('cheques-sort-by'); if(sortByEl) sortByEl.value='due';
    const dirBtn = document.getElementById('cheques-sort-dir'); if(dirBtn){ dirBtn.dataset.dir='desc'; dirBtn.textContent='â¬‡ï¸'; }

    const setVal = (id,v)=>{ const el=document.getElementById(id); if(el) el.value=v; };
    setVal('cheques-filter-status','');
    setVal('cheques-filter-tenant','');
    setVal('cheques-filter-unit','');
    setVal('cheques-filter-chequeno','');
    setVal('cheques-filter-bank','');
    setVal('cheques-filter-amin','');
    setVal('cheques-filter-amax','');
    setVal('cheques-filter-dfrom','');
    setVal('cheques-filter-dto','');

    // Hide panel (default)
    const panel = document.getElementById('cheques-filters-panel');
    const tBtn = document.getElementById('cheques-toggle-filters');
    if(panel) panel.classList.add('hidden');
    if(tBtn) tBtn.textContent = 'Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©';

    onChequesAdvancedChanged();
  }

  function _chequesState(){
    return {
      q: _lsGet('re_cheques_q',''),
      sortBy: _lsGet('re_cheques_sort_by','due'),
      sortDir: _lsGet('re_cheques_sort_dir','desc'),
      f: {
        status: _lsGet('re_cheques_f_status',''),
        tenant: _lsGet('re_cheques_f_tenant',''),
        unit: _lsGet('re_cheques_f_unit',''),
        chequeNo: _lsGet('re_cheques_f_chequeno',''),
        bank: _lsGet('re_cheques_f_bank',''),
        aMin: _lsGet('re_cheques_f_amin',''),
        aMax: _lsGet('re_cheques_f_amax',''),
        dFrom: _lsGet('re_cheques_f_dfrom',''),
        dTo: _lsGet('re_cheques_f_dto','')
      }
    };
  }

  function _chequesApply(list, st){
    const q = (st.q||'').trim().toLowerCase();
    const f = st.f || {};

    const status = (f.status||'').trim();
    const tenant = (f.tenant||'').trim().toLowerCase();
    const unit = (f.unit||'').trim().toLowerCase();
    const chequeNo = (f.chequeNo||'').trim().toLowerCase();
    const bank = (f.bank||'').trim().toLowerCase();

    const aMin = parseFloat(f.aMin); const hasMin = Number.isFinite(aMin);
    const aMax = parseFloat(f.aMax); const hasMax = Number.isFinite(aMax);

    const dFrom = f.dFrom ? Date.parse(String(f.dFrom).slice(0,10)) : NaN;
    const dTo = f.dTo ? Date.parse(String(f.dTo).slice(0,10)) : NaN;
    const hasDFrom = Number.isFinite(dFrom);
    const hasDTo = Number.isFinite(dTo);

    return (list||[]).filter(c=>{
      const blob = [
        c.status, c.dueDate, c.tenant, c.unit, c.amount, c.bank, c.chequeNo
      ].filter(Boolean).join(' | ').toLowerCase();

      if(q && !blob.includes(q)) return false;

      if(status && String(c.status||'')!==status) return false;

      if(tenant && !String(c.tenant||'').toLowerCase().includes(tenant)) return false;

      if(unit && !String(c.unit||'').toLowerCase().includes(unit)) return false;

      if(chequeNo && !String(c.chequeNo||'').toLowerCase().includes(chequeNo)) return false;

      if(bank && !String(c.bank||'').toLowerCase().includes(bank)) return false;

      const amt = parseFloat(c.amount);
      if(hasMin && (!Number.isFinite(amt) || amt < aMin)) return false;
      if(hasMax && (!Number.isFinite(amt) || amt > aMax)) return false;

      const due = c.dueDate ? Date.parse(String(c.dueDate).slice(0,10)) : NaN;
      if(hasDFrom && (!Number.isFinite(due) || due < dFrom)) return false;
      if(hasDTo && (!Number.isFinite(due) || due > dTo)) return false;

      return true;
    });
  }

  function _sortCheques(list, sortBy, sortDir){
    const dir = (sortDir==='asc') ? 1 : -1;
    const k = sortBy || 'due';

    const get = (c)=>{
      if(k==='amount') return Number(c.amount)||0;
      if(k==='tenant') return String(c.tenant||'').toLowerCase();
      if(k==='unit') return String(c.unit||'').toLowerCase();
      if(k==='bank') return String(c.bank||'').toLowerCase();
      if(k==='chequeNo') return String(c.chequeNo||'').toLowerCase();
      if(k==='status') return String(c.status||'').toLowerCase();
      // due default
      const t = c.dueDate ? Date.parse(String(c.dueDate).slice(0,10)) : 0;
      return Number.isFinite(t) ? t : 0;
    };

    return [...(list||[])].sort((a,b)=>{
      const va = get(a);
      const vb = get(b);
      if(va < vb) return -1*dir;
      if(va > vb) return 1*dir;
      // tiebreaker by dueDate desc
      const ta = a.dueDate ? Date.parse(String(a.dueDate).slice(0,10)) : 0;
      const tb = b.dueDate ? Date.parse(String(b.dueDate).slice(0,10)) : 0;
      if(ta < tb) return -1;
      if(ta > tb) return 1;
      return 0;
    });
  }
  // ================= /Advanced Search & Sort (Cheques) =================



  // Backward compatibility (if used somewhere else)
  function setLeaseSort(k){
    const map = { end:'end', rent:'rent', tenant:'tenant' };
    const by = map[k] || 'end';
    const sel = document.getElementById('leases-sort-by');
    if(sel) sel.value = by;
    _lsSet('re_leases_sort_by', by);
    renderLeases();
  }

  function _leasesState(){
    const ui = _leasesUi();
    return {
      q: _leaseNorm(ui.q || _lsGet('re_leases_q','')),
      sortBy: ui.sortBy || _lsGet('re_leases_sort_by','end'),
      sortDir: ui.sortDir || _lsGet('re_leases_sort_dir','asc'),
      f: {
        status: ui.status || _lsGet('re_leases_f_status',''),
        prop: ui.prop || _lsGet('re_leases_f_prop',''),
        unit: ui.unit || _lsGet('re_leases_f_unit',''),
        tenant: ui.tenant || _lsGet('re_leases_f_tenant',''),
        contractNo: ui.contractNo || _lsGet('re_leases_f_contract',''),
        rentMin: ui.rentMin || _lsGet('re_leases_f_rmin',''),
        rentMax: ui.rentMax || _lsGet('re_leases_f_rmax',''),
        startFrom: ui.startFrom || _lsGet('re_leases_f_sfrom',''),
        startTo: ui.startTo || _lsGet('re_leases_f_sto',''),
        endFrom: ui.endFrom || _lsGet('re_leases_f_efrom',''),
        endTo: ui.endTo || _lsGet('re_leases_f_eto',''),
      }
    };
  }

  function _leasesApply(list, st){
    const q = st.q;
    const f = st.f;

    const status = (f.status||'').trim();
    const prop = _leaseNorm(f.prop);
    const unit = _leaseNorm(f.unit);
    const tenant = _leaseNorm(f.tenant);
    const cno = _leaseNorm(f.contractNo);

    const rmin = (f.rentMin!=='' && f.rentMin!==null && f.rentMin!==undefined) ? Number(f.rentMin) : NaN;
    const rmax = (f.rentMax!=='' && f.rentMax!==null && f.rentMax!==undefined) ? Number(f.rentMax) : NaN;

    const sFrom = f.startFrom ? _leaseDateNum(f.startFrom) : NaN;
    const sTo = f.startTo ? _leaseDateNum(f.startTo) : NaN;
    const eFrom = f.endFrom ? _leaseDateNum(f.endFrom) : NaN;
    const eTo = f.endTo ? _leaseDateNum(f.endTo) : NaN;

    return (list||[]).filter(l=>{
      if(q && !_leaseHay(l).includes(q)) return false;

      if(status && leaseContractStatusFromDates(l.start, l.end) !== status) return false;
      if(prop && !_leaseNorm(l.propName).includes(prop)) return false;

      if(unit){
        const uName = _leaseNorm(l.name);
        const uId = _leaseNorm(l.id);
        if(!uName.includes(unit) && !uId.includes(unit)) return false;
      }

      if(tenant && !_leaseNorm(l.tenant).includes(tenant)) return false;
      if(cno && !_leaseNorm(l.contractNo).includes(cno)) return false;

      const rent = Number(l.rent||0);
      if(Number.isFinite(rmin) && rent < rmin) return false;
      if(Number.isFinite(rmax) && rent > rmax) return false;

      const s = _leaseDateNum(l.start);
      const e = _leaseDateNum(l.end);

      if(Number.isFinite(sFrom) && (!Number.isFinite(s) || s < sFrom)) return false;
      if(Number.isFinite(sTo) && (!Number.isFinite(s) || s > sTo)) return false;
      if(Number.isFinite(eFrom) && (!Number.isFinite(e) || e < eFrom)) return false;
      if(Number.isFinite(eTo) && (!Number.isFinite(e) || e > eTo)) return false;

      return true;
    });
  }

  function _sortLeases(list, by, dir){
    const m = _dirMult(dir);
    const arr = [...(list||[])];
    arr.sort((a,b)=>{
      switch(by){
        case 'rent': return m * _cmpNum(a.rent, b.rent);
        case 'end': return m * _cmpNum(_leaseDateNum(a.end), _leaseDateNum(b.end));
        case 'start': return m * _cmpNum(_leaseDateNum(a.start), _leaseDateNum(b.start));
        case 'tenant': return m * _cmpText(a.tenant, b.tenant);
        case 'unit': return m * _cmpText(a.name, b.name);
        case 'property': return m * _cmpText(a.propName, b.propName);
        case 'contractNo': return m * _cmpText(a.contractNo, b.contractNo);
        case 'status': {
          const sa = leaseContractStatusOrder(leaseContractStatusFromDates(a.start, a.end));
          const sb = leaseContractStatusOrder(leaseContractStatusFromDates(b.start, b.end));
          const primary = m * _cmpNum(sa, sb);
          if(primary !== 0) return primary;
          return m * _cmpNum(_leaseDateNum(a.end), _leaseDateNum(b.end));
        }
        default: return m * _cmpText(a.end, b.end);
      }
    });
    return arr;
  }

  function renderLeases(){
    _leasesRestoreUIOnce();

    const tbody = document.getElementById('leases-table-body');
    if(!tbody) return;
    tbody.innerHTML='';

    
    let allLeases = [];
    properties.forEach(p=>p.units.forEach(u=>{
      if(u.status!=='Ø´Ø§ØºØ±Ø©') allLeases.push({...u, propName:p.name, propId:p.id});
    }));

    // Group leases by contractGroupId (multi-unit) â€” otherwise each unit is its own group
    const groupsMap = new Map();
    allLeases.forEach(u=>{
      const key = u.contractGroupId || (u.contractNo ? `CN-${u.contractNo}` : `U-${u.propId}-${u.id}`);
      if(!groupsMap.has(key)){
        groupsMap.set(key, {
          groupKey: key,
          contractGroupId: u.contractGroupId || '',
          contractNo: u.contractNo || '',
          tenant: u.tenant || '',
          start: u.start || '',
          end: u.end || '',
          rent: 0,
          units: [],
          _propNames: new Set(),
          _propIds: new Set(),
        });
      }
      const g = groupsMap.get(key);
      g.units.push(u);
      g.rent += (Number(u.rent)||0);
      if(u.propName) g._propNames.add(u.propName);
      if(u.propId) g._propIds.add(u.propId);

      // unify start/end for group (earliest start, latest end)
      if(u.start){
        if(!g.start) g.start = u.start;
        else if(_leaseDateNum(u.start) < _leaseDateNum(g.start)) g.start = u.start;
      }
      if(u.end){
        if(!g.end) g.end = u.end;
        else if(_leaseDateNum(u.end) > _leaseDateNum(g.end)) g.end = u.end;
      }
      // keep tenant/contractNo if missing
      if(!g.tenant && u.tenant) g.tenant = u.tenant;
      if(!g.contractNo && u.contractNo) g.contractNo = u.contractNo;
    });

    const groupedLeases = Array.from(groupsMap.values()).map(g=>{
      const props = Array.from(g._propNames);
      const propIds = Array.from(g._propIds);
      const unitsNames = g.units.map(x=>x.name).filter(Boolean).join(', ');
      const unitsIds = g.units.map(x=>x.id).filter(Boolean).join(', ');
      return {
        groupKey: g.groupKey,
        contractGroupId: g.contractGroupId || (g.contractNo ? `CN-${g.contractNo}` : ''),
        contractNo: g.contractNo,
        tenant: g.tenant,
        start: g.start,
        end: g.end,
        rent: g.rent,
        units: g.units,
        unitsCount: g.units.length,
        unitsNames,
        // Fields used by existing filters/sorts
        name: unitsNames || (g.units[0]?.name || ''),
        id: unitsIds || (g.units[0]?.id || ''),
        propName: props.join('ØŒ ') || (g.units[0]?.propName || ''),
        propId: propIds.join(',') || (g.units[0]?.propId || ''),
      };
    });

    const st = _leasesState();
    const filtered = _leasesApply(groupedLeases, st);
    const finalList = _sortLeases(filtered, st.sortBy, st.sortDir);

    const hint = document.getElementById('leases-filter-hint');
    if(hint){
      const total = groupedLeases.length;
      const shown = finalList.length;
      hint.textContent = (shown===total) ? `Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ${shown}` : `Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ${shown} Ù…Ù† ${total}`;
    }

    finalList.forEach(g=>{
      window.__leaseGroupsCache = window.__leaseGroupsCache || {};
      window.__leaseGroupsCache[g.groupKey] = g;
      const safe = leaseSafeKey(g.groupKey);
      const isMulti = (g.unitsCount||0) > 1;
      const statusText = leaseContractStatusFromDates(g.start, g.end);
      const rowBg = (statusText==='Ù…Ù†ØªÙ‡ÙŠ') ? 'bg-red-50 dark:bg-red-900/20' : '';

      const tr = document.createElement('tr');
      tr.className = rowBg;
      tr.innerHTML = `
        <td>
          <div class="flex items-start gap-2">
            ${isMulti ? `<button class="mt-0.5 text-gray-500 hover:text-gray-800 dark:text-gray-300 dark:hover:text-white" title="Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ­Ø¯Ø§Øª" onclick="toggleLeaseGroupRow('${g.groupKey}')">â–¾</button>` : `<span class="mt-0.5 text-gray-300">â€¢</span>`}
            <div class="min-w-0">
              <div class="font-bold text-gray-800 dark:text-white">
                ${isMulti ? `Ø¹Ù‚Ø¯ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª (${g.unitsCount})` : (g.units?.[0]?.name || g.name || 'â€”')}
              </div>
              <div class="text-xs text-gray-500 dark:text-gray-400 truncate">
                ${g.propName || 'â€”'}${isMulti ? ` â€” <span class="font-mono">${g.unitsNames || ''}</span>` : ''}
              </div>
            </div>
          </div>
        </td>
        <td class="text-sm font-semibold text-gray-700 dark:text-gray-300">${g.tenant||''}</td>
        <td class="font-mono text-emerald-600 dark:text-emerald-400">${formatAED(g.rent)}</td>
        <td class="text-xs font-mono bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded truncate max-w-[160px]" title="${g.contractNo||''}">${g.contractNo||''}</td>
        <td class="text-xs">${g.start||'-'}</td>
        <td class="text-xs ${(() => { const cs = leaseContractStatusFromDates(g.start, g.end); return (cs==='Ù…Ù†ØªÙ‡ÙŠ' ? 'text-red-600 dark:text-red-300 font-extrabold' : cs==='Ø´Ø§Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡' ? 'text-orange-600 dark:text-orange-300 font-extrabold' : ''); })()}">${g.end||'-'}</td>
        <td><span class="${leaseContractBadgeClass(statusText)}">${statusText}</span></td>
        <td>
          ${isMulti
            ? `<div class="flex items-center gap-2">
                <button onclick="toggleLeaseGroupRow('${g.groupKey}')" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 text-sm font-bold">ØªÙØ§ØµÙŠÙ„</button>
                <button onclick="openLeasePaymentModal('${g.groupKey}')" class="text-emerald-700 dark:text-emerald-400 hover:text-emerald-900 text-sm font-bold">Ø¯ÙØ¹Ø©</button>
              </div>`
            : `<button onclick="openLeaseModal('${g.units?.[0]?.propId || g.propId}','${g.units?.[0]?.id || g.id}')" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 text-sm font-bold">Ø¥Ø¯Ø§Ø±Ø©</button>`
          }
        </td>
      `;
      tbody.appendChild(tr);

      if(isMulti){
        const detail = document.createElement('tr');
        detail.id = `lease-group-${safe}`;
        detail.className = 'hidden bg-gray-50 dark:bg-gray-900/30';
        detail.innerHTML = `
          <td colspan="8" class="p-3">
            <div class="rounded-xl border border-gray-200 dark:border-gray-700 bg-white/60 dark:bg-dark-surface/60 backdrop-blur-md p-3">
              <div class="flex items-center justify-between gap-3 mb-3">
                <div class="flex items-center gap-2">
                <div class="text-sm font-extrabold text-gray-800 dark:text-white">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø¶Ù…Ù† Ø§Ù„Ø¹Ù‚Ø¯</div>
                  <button onclick="openLeasePaymentModal('${g.groupKey}')" class="px-3 py-1.5 rounded-lg text-xs font-extrabold bg-emerald-600 text-white hover:bg-emerald-700">ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø©</button>
                </div>
                <div class="text-xs text-gray-500 dark:text-gray-400 flex items-center gap-3">
                  <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span class="font-mono text-emerald-600 dark:text-emerald-400">${formatAED(g.rent)}</span></span>
                  <span>Ø§Ù„Ù…Ø¯ÙÙˆØ¹: <span class="font-mono text-emerald-700 dark:text-emerald-400">${formatAED(sumLeasePaidForContract(g.contractNo))}</span></span>
                  <span>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span class="font-mono text-red-600 dark:text-red-300">${formatAED(Math.max(0, (Number(g.rent)||0) - sumLeasePaidForContract(g.contractNo)))}</span></span>
                </div>
              </div>

              <div class="overflow-x-auto">
                <table class="min-w-full text-right text-sm">
                  <thead>
                    <tr class="text-xs text-gray-500 dark:text-gray-400">
                      <th class="py-2 px-2">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                      <th class="py-2 px-2">Ø§Ù„Ø¹Ù‚Ø§Ø±</th>
                      <th class="py-2 px-2">Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                      <th class="py-2 px-2">Ø§Ù„Ù…Ø³ØªÙ„Ù…</th>
                      <th class="py-2 px-2">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                      <th class="py-2 px-2">Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th>
                      <th class="py-2 px-2">Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</th>
                      <th class="py-2 px-2">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                      <th class="py-2 px-2">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${g.units.map(u=>{
                      const stt = leaseContractStatusFromDates(u.start, u.end);
                      return `
                        <tr class="border-t border-gray-100 dark:border-gray-800">
                          <td class="py-2 px-2">
                            <div class="font-bold text-gray-800 dark:text-white">${u.name||'â€”'}</div>
                            <div class="text-xs font-mono text-gray-500 dark:text-gray-400">${u.id||''}</div>
                          </td>
                          <td class="py-2 px-2 text-xs text-gray-600 dark:text-gray-300">${u.propName||''}</td>
                          <td class="py-2 px-2 font-mono text-emerald-600 dark:text-emerald-400">${formatAED(u.rent)}</td>
                          <td class="py-2 px-2 font-mono text-gray-700 dark:text-gray-200">${formatAED(sumLeasePaidForUnit(g.contractNo, u.propId, u.id))}</td>
                          <td class="py-2 px-2 font-mono text-red-600 dark:text-red-300">${formatAED(Math.max(0, (Number(u.rent)||0) - sumLeasePaidForUnit(g.contractNo, u.propId, u.id)))}</td>
                          <td class="py-2 px-2 text-xs">${u.start||'-'}</td>
                          <td class="py-2 px-2 text-xs">${u.end||'-'}</td>
                          <td class="py-2 px-2"><span class="${leaseContractBadgeClass(stt)}">${stt}</span></td>
                          <td class="py-2 px-2">
                            <button onclick="openLeaseModal('${u.propId}','${u.id}')" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 text-xs font-bold">Ø¥Ø¯Ø§Ø±Ø©</button>
                          </td>
                        </tr>
                      `;
                    }).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </td>
        `;
        tbody.appendChild(detail);
      }
    });
}

  function openPropertyModal(){ document.getElementById('property-modal').classList.remove('hidden'); }
  function closePropertyModal(){ document.getElementById('property-modal').classList.add('hidden'); }

  document.getElementById('property-form').addEventListener('submit', e=>{
    e.preventDefault();
    properties.push({
      id: document.getElementById('prop-id').value,
      name: document.getElementById('prop-name').value,
      type: document.getElementById('prop-type').value,
      usage: document.getElementById('prop-usage').value,
      location: document.getElementById('prop-location').value,
      units: []
    });
    saveToLocal();
    closePropertyModal();
    renderProperties();
    updateDashboard();
    logAction('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø§Ø± Ø¬Ø¯ÙŠØ¯');
  });

  function openUnitModal(propId, unitId){
    const m = document.getElementById('unit-modal');
    m.classList.remove('hidden');
    document.getElementById('unit-prop-id').value = propId;
    // Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ù‚Ø§Ø± (Ø·Ø§Ù‚Ø©) ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„Ù‡ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù„Ø§Ø­Ù‚Ø§Ù‹ â€” Ù„Ø§ ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    if(document.getElementById('unit-property-id')) document.getElementById('unit-property-id').value = '';
    document.getElementById('unit-id').value = unitId || '';

    const p = properties.find(x=>x.id===propId);
    const u = unitId ? p.units.find(x=>x.id===unitId) : null;

    if(u){
      ensureUnitFields(u);
      document.getElementById('unit-name').value = (u.unitName||u.name||unitLabel(u))||'';
      document.getElementById('unit-code').value = u.id||'';
      // Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø¯Ù…Ø§Øª
      document.getElementById('unit-elec-meter-no').value = u.elecMeterNo || '';
            document.getElementById('unit-water-meter-no').value = u.waterMeterNo || '';
            // Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© (UNT) Ù„Ø§ ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ â€” ÙŠØ¹Ø¨Ø£ ÙŠØ¯ÙˆÙŠØ§Ù‹
      // Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ù‚Ø§Ø± (Ø·Ø§Ù‚Ø©) Ù„Ù„ÙˆØ­Ø¯Ø©
      if(document.getElementById('unit-property-id')) document.getElementById('unit-property-id').value = (u.taqaPropertyId || u.propertyId || '') || '';
      document.getElementById('unit-code').disabled = false;
      
      document.getElementById('unit-type').value = u.type||'';
      document.getElementById('unit-usage').value = u.usage||'';
      document.getElementById('unit-status').value = u.status;
      document.getElementById('unit-tenant').value = u.tenant||'';
      document.getElementById('unit-rent').value = u.rent||'';
      document.getElementById('unit-contractNo').value = u.contractNo||'';
      document.getElementById('unit-start').value = u.start||'';
      document.getElementById('unit-end').value = u.end||'';
      updateUnitPreview();
    } else {
      document.getElementById('unit-form').reset();
      document.getElementById('unit-prop-id').value = propId;
    // Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ù‚Ø§Ø± (Ø·Ø§Ù‚Ø©) ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„Ù‡ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù„Ø§Ø­Ù‚Ø§Ù‹ â€” Ù„Ø§ ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    if(document.getElementById('unit-property-id')) document.getElementById('unit-property-id').value = '';
      document.getElementById('unit-id').value = '';
      document.getElementById('unit-name').value = '';
      document.getElementById('unit-code').value = '';
      // Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø¯Ù…Ø§Øª (ÙØ§Ø±ØºØ© Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©)
      document.getElementById('unit-elec-meter-no').value = '';
            document.getElementById('unit-water-meter-no').value = '';
            document.getElementById('unit-code').disabled = false;
      if(document.getElementById('unit-property-id')) document.getElementById('unit-property-id').value = '';
      updateUnitPreview();
    }
  }

  function updateUnitPreview(){
    const nameEl = document.getElementById('unit-name');
    const el = document.getElementById('unit-display-preview');
    if(!el || !nameEl) return;
    const label = String(nameEl.value||'').trim() || 'â€”';
    el.textContent = label;
  }

  // live preview
  document.getElementById('unit-name')?.addEventListener('input', updateUnitPreview);
  

  function closeUnitModal(){
    document.getElementById('unit-modal').classList.add('hidden');
  }

  document.getElementById('unit-form').addEventListener('submit', e=>{
    e.preventDefault();
    const pid = document.getElementById('unit-prop-id').value;
    const uid = document.getElementById('unit-id').value; // Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© (UNT) Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
    const p = properties.find(x=>x.id===pid);
    // Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ù‚Ø§Ø± (Ø·Ø§Ù‚Ø©) ÙŠÙØ­ÙØ¸ Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ÙˆØ­Ø¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)

    const unitName = String(document.getElementById('unit-name').value||'').trim().replace(/\s*-\s*/g,'-');
    const unitCode = String(document.getElementById('unit-code').value||'').trim().toUpperCase();

    if(!unitName){
      alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ÙˆØ­Ø¯Ø©.');
      return;
    }
    if(!unitCode){
      alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© (UNT).');
      return;
    }

    const existingUnit = uid ? p.units.find(x=>x.id===uid) : null;

    // Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ø¯Ø§Ø®Ù„ Ù†ÙØ³ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
    if(!existingUnit){
      const dup = p.units.some(x=> String(x.id||'').trim().toUpperCase() === unitCode);
      if(dup){
        alert('Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© (UNT) Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ù‹Ø§ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø§Ø±.');
        return;
      }
    }

    
    const oldUnitCode = existingUnit ? String(existingUnit.id||'').trim().toUpperCase() : '';

    // Ø¹Ù†Ø¯ ØªØ¹Ø¯ÙŠÙ„ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©ØŒ Ù†Ù‚ÙˆÙ… Ø¨ØªØ­Ø¯ÙŠØ« Ø£ÙŠ Ø±ÙˆØ§Ø¨Ø· (Ø´ÙŠÙƒØ§Øª/Ø¯ÙØ¹Ø§Øª/Ø³Ø¬Ù„ Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª)
    if(existingUnit && oldUnitCode && oldUnitCode !== unitCode){
      // Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
      const dup2 = p.units.some(x=> String(x.id||'').trim().toUpperCase() === unitCode);
      if(dup2){
        alert('Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø© (UNT) Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ù‹Ø§ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø§Ø±.');
        return;
      }

      try{
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´ÙŠÙƒØ§Øª
        (cheques||[]).forEach(c=>{ if(String(c.unitId||'').trim().toUpperCase()===oldUnitCode) c.unitId = unitCode; });
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙØ¹Ø§Øª
        (payments||[]).forEach(pay=>{
          const k = String(pay.unitId||'').trim().toUpperCase();
          if(k===oldUnitCode) pay.unitId = unitCode;
        });

        // ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª (Ø¥Ù† ÙˆØ¬Ø¯)
        try{
          const nl = JSON.parse(localStorage.getItem('re_notice_log')||'[]');
          nl.forEach(r=>{
            if(String(r.unitId||'').trim().toUpperCase()===oldUnitCode) r.unitId = unitCode;
          });
          localStorage.setItem('re_notice_log', JSON.stringify(nl));
        }catch(e){}

      }catch(e){}
    }

const newUnit = {
      ...(existingUnit || {}),
      id: unitCode,
      unitName: unitName,
      name: unitName,
      // Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø¯Ù…Ø§Øª
      elecMeterNo: String(document.getElementById('unit-elec-meter-no').value||'').trim(),
      waterMeterNo: String(document.getElementById('unit-water-meter-no').value||'').trim(),
      // Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ù‚Ø§Ø± (Ø·Ø§Ù‚Ø©) Ù„Ù„ÙˆØ­Ø¯Ø© â€” Ø§Ø®ØªÙŠØ§Ø±ÙŠ
      taqaPropertyId: String(document.getElementById('unit-property-id')?.value || '').trim(),
      type: document.getElementById('unit-type').value,
      usage: document.getElementById('unit-usage').value,
      status: document.getElementById('unit-status').value,
      tenant: document.getElementById('unit-tenant').value,
      rent: parseInt(document.getElementById('unit-rent').value||0),
      contractNo: document.getElementById('unit-contractNo').value,
      start: document.getElementById('unit-start').value,
      end: document.getElementById('unit-end').value
    };

    // keep legacy display label synced
    ensureUnitFields(newUnit);

// Ø¥Ø°Ø§ ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© Ø¥Ù„Ù‰ Ø´Ø§ØºØ±Ø© Ù…Ù† ØµÙØ­Ø© Ø§Ù„ÙˆØ­Ø¯Ø§ØªØŒ Ù†Ø­ÙØ¸ Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø³Ø§Ø¨Ù‚ ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø«Ù… Ù†Ù†Ø¸Ù‘Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯
    if(newUnit.status === 'Ø´Ø§ØºØ±Ø©'){
      if(existingUnit && unitHasLeaseData(existingUnit) && (existingUnit.status !== 'Ø´Ø§ØºØ±Ø©')){
        archiveUnitLease(existingUnit, 'Ø¥Ø®Ù„Ø§Ø¡/ØªØ¹Ø¯ÙŠÙ„ Ù…Ù† ØµÙØ­Ø© Ø§Ù„ÙˆØ­Ø¯Ø§Øª', 'Ù…Ø®Ù„Ù‰');
        // Ù†Ù‚Ù„ Ø§Ù„Ø³Ø¬Ù„ Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø­ØªÙ‰ Ù„Ø§ Ù†ÙÙ‚Ø¯ Ø§Ù„ØªØ§Ø±ÙŠØ®
        ensureLeaseHistory(newUnit);
        newUnit.leaseHistory = (existingUnit.leaseHistory || []).slice();
      } else if(existingUnit && Array.isArray(existingUnit.leaseHistory)){
        newUnit.leaseHistory = existingUnit.leaseHistory;
      }
      newUnit.tenant = '';
      newUnit.rent = 0;
      newUnit.contractNo = '';
      newUnit.start = '';
      newUnit.end = '';
    } else if(existingUnit && Array.isArray(existingUnit.leaseHistory)){
      // Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
      newUnit.leaseHistory = existingUnit.leaseHistory;
    } else {
      ensureLeaseHistory(newUnit);
    }
if(uid){
      const idx = p.units.findIndex(x=>x.id===uid);
      p.units[idx] = newUnit;
    } else {
      p.units.push(newUnit);
    }
    saveToLocal();
    closeUnitModal();
    showView('properties');
    updateDashboard();
  });

  function openAddLeaseModal(){
    const m = document.getElementById('add-lease-modal');
    m.classList.remove('hidden');
    const propSelect = document.getElementById('add-lease-prop');
    propSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù‚Ø§Ø±...</option>';
    properties.forEach(p => {
      propSelect.innerHTML += `<option value="${p.id}">${p.name}</option>`;
    });
    document.getElementById('add-lease-form').reset();
    applyTenantTypeUI('add-lease');
    _resetAddLeaseUnits();
  }

  function closeAddLeaseModal(){
    document.getElementById('add-lease-modal').classList.add('hidden');
  }

  // ===== Multi-unit contract builder (Add Lease) =====
  let _addLeaseUnits = [{ unitId:'', rent:'' }];

  function _resetAddLeaseUnits(){
    _addLeaseUnits = [{ unitId:'', rent:'' }];
    renderAddLeaseUnitsRows();
    const err = document.getElementById('add-lease-units-error');
    if(err) err.textContent = '';
  }

  function addLeaseUnitRow(){
    const propId = document.getElementById('add-lease-prop')?.value || '';
    const err = document.getElementById('add-lease-units-error');
    if(!propId){
      if(err) err.textContent = 'Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù‚Ø§Ø± Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø£Ø¶Ù Ø§Ù„ÙˆØ­Ø¯Ø§Øª.';
      return;
    }
    if(err) err.textContent = '';
    _addLeaseUnits.push({ unitId:'', rent:'' });
    renderAddLeaseUnitsRows();
  }

  function removeLeaseUnitRow(i){
    _addLeaseUnits.splice(i, 1);
    if(_addLeaseUnits.length === 0) _addLeaseUnits = [{ unitId:'', rent:'' }];
    renderAddLeaseUnitsRows();
  }

  function onAddLeaseUnitChanged(i, val){
    _addLeaseUnits[i].unitId = val;
    renderAddLeaseUnitsRows(); // refresh options to prevent duplicates
  }

  function onAddLeaseUnitRent(i, val){
    _addLeaseUnits[i].rent = val;
    _updateAddLeaseTotalRent();
  }

  function _updateAddLeaseTotalRent(){
    const total = _addLeaseUnits.reduce((s,r)=> s + (parseFloat(r.rent)||0), 0);
    const el = document.getElementById('add-lease-total-rent');
    if(el) el.textContent = formatAED(total);
  }

  function renderAddLeaseUnitsRows(){
    const tbody = document.getElementById('add-lease-units-body');
    if(!tbody) return;

    tbody.innerHTML = '';
    const propId = document.getElementById('add-lease-prop')?.value || '';
    if(!propId){
      tbody.innerHTML = `<tr><td colspan="3" class="py-3 text-center text-gray-500">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù‚Ø§Ø± Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø´Ø§ØºØ±Ø©.</td></tr>`;
      _updateAddLeaseTotalRent();
      return;
    }

    const prop = properties.find(p => p.id === propId);
    const vacantUnits = (prop?.units || []).filter(u => u.status !== 'Ù…Ø¤Ø¬Ø±Ø©');
    if(vacantUnits.length === 0){
      tbody.innerHTML = `<tr><td colspan="3" class="py-3 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ø´Ø§ØºØ±Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø§Ø±.</td></tr>`;
      _updateAddLeaseTotalRent();
      return;
    }

    const selected = new Set(_addLeaseUnits.map(r=>r.unitId).filter(Boolean));

    _addLeaseUnits.forEach((row, idx) => {
      const usedElsewhere = new Set([...selected]);
      if(row.unitId) usedElsewhere.delete(row.unitId);

      let options = `<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø©...</option>`;
      vacantUnits.forEach(u => {
        const disabled = usedElsewhere.has(u.id) ? 'disabled' : '';
        const sel = row.unitId === u.id ? 'selected' : '';
        options += `<option value="${u.id}" ${disabled} ${sel}>${u.name}</option>`;
      });

      const rentVal = (row.rent ?? '');
      tbody.innerHTML += `
        <tr class="border-b border-gray-100 dark:border-gray-800">
          <td class="py-2 px-2">
            <select class="w-full border p-2 rounded" onchange="onAddLeaseUnitChanged(${idx}, this.value)">${options}</select>
          </td>
          <td class="py-2 px-2">
            <input type="number" min="0" class="w-full border p-2 rounded" value="${rentVal}" oninput="onAddLeaseUnitRent(${idx}, this.value)" placeholder="0">
          </td>
          <td class="py-2 px-2 text-center">
            <button type="button" class="text-rose-600 hover:text-rose-800 font-bold" onclick="removeLeaseUnitRow(${idx})">âœ•</button>
          </td>
        </tr>
      `;
    });

    _updateAddLeaseTotalRent();
  }


  document.getElementById('add-lease-prop').addEventListener('change', function(){
    _resetAddLeaseUnits();
  });

  document.getElementById('add-lease-form').addEventListener('submit', e => {
    e.preventDefault();

    const propId = (document.getElementById('add-lease-prop')?.value || '').trim();
    const unitsErrEl = document.getElementById('add-lease-units-error');
    if(unitsErrEl) unitsErrEl.textContent = '';

    if(!propId){
      alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù‚Ø§Ø±");
      return;
    }

    const rows = (_addLeaseUnits || []).filter(r => r && r.unitId);
    if(rows.length === 0){
      if(unitsErrEl) unitsErrEl.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ø¶Ù…Ù† Ø§Ù„Ø¹Ù‚Ø¯.';
      return;
    }

    // Validate duplicates
    const seen = new Set();
    for(const r of rows){
      if(seen.has(r.unitId)){
        if(unitsErrEl) unitsErrEl.textContent = 'ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù†ÙØ³ Ø§Ù„ÙˆØ­Ø¯Ø© Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø±Ø©.';
        return;
      }
      seen.add(r.unitId);
    }

    // Validate rent per unit
    for(const r of rows){
      const rent = parseFloat(r.rent || 0);
      if(!rent || rent <= 0){
        if(unitsErrEl) unitsErrEl.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø³Ù†ÙˆÙŠ Ù„ÙƒÙ„ ÙˆØ­Ø¯Ø©.';
        return;
      }
    }

    const prop = properties.find(p => p.id === propId);
    if(!prop){
      alert("Ø§Ù„Ø¹Ù‚Ø§Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
      return;
    }

    const tenantName = (document.getElementById('add-lease-tenant')?.value || '').trim();
    if(!tenantName){
      alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±");
      return;
    }

    const contractNo = (document.getElementById('add-lease-contractNo')?.value || '').trim();
    const start = (document.getElementById('add-lease-start')?.value || '').trim();
    const end = (document.getElementById('add-lease-end')?.value || '').trim();

    // Extra contract/tenant fields (shared across units)
    const extra = {
      phone: (document.getElementById('add-lease-phone')?.value || '').trim(),
      email: (document.getElementById('add-lease-email')?.value || '').trim(),
      paymentsCount: parseInt(document.getElementById('add-lease-paymentsCount')?.value || '0', 10) || 0,
      chequesCount: parseInt(document.getElementById('add-lease-chequesCount')?.value || '0', 10) || 0,
      bankGuarantee: parseFloat(document.getElementById('add-lease-bankGuarantee')?.value || '0') || 0,
      tenantType: (document.getElementById('add-lease-tenantType')?.value || '').trim(),
      tradeLicenseNo: (document.getElementById('add-lease-tradeLicense')?.value || '').trim(),
      idNumber: (document.getElementById('add-lease-idNumber')?.value || '').trim(),
    };

    const totalRent = rows.reduce((s,r)=> s + (parseFloat(r.rent)||0), 0);
    const contractGroupId = `CG-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,6)}`;

    // Link/update tenant contact record once
    const tk = tenantKey(tenantName);
    const prev = tenantsContacts[tk] || { name: tenantName, phone:'', email:'' };
    tenantsContacts[tk] = {
      name: tenantName,
      phone: extra.phone || prev.phone || '',
      email: extra.email || prev.email || '',
      tenantType: extra.tenantType || prev.tenantType || '',
      tradeLicenseNo: extra.tradeLicenseNo || prev.tradeLicenseNo || '',
      idNumber: extra.idNumber || prev.idNumber || ''
    };

    // Apply the lease to each selected unit
    rows.forEach(r => {
      const unit = prop.units.find(u => u.id === r.unitId);
      if(!unit) return;

      // If the unit contains previous lease data (e.g. ended/old) save it in history before replacing
      if(unitHasLeaseData(unit) && unit.status !== 'Ø´Ø§ØºØ±Ø©'){
        archiveUnitLease(unit, `ØªÙ… ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯ (${contractNo || 'Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù…'})`, 'ØªØ¬Ø¯ÙŠØ¯ Ø¹Ù‚Ø¯');
      }

      unit.status = 'Ù…Ø¤Ø¬Ø±Ø©';
      unit.tenant = tenantName;
      unit.rent = parseFloat(r.rent || 0);
      unit.contractNo = contractNo;
      unit.start = start;
      unit.end = end;

      // Shared metadata to help grouping later
      unit.leaseExtra = Object.assign({}, unit.leaseExtra || {}, extra, {
        contractGroupId,
        contractUnitsCount: rows.length,
        contractTotalRent: totalRent
      });
    });

    saveToLocal();
    closeAddLeaseModal();
    showView('leases');
    logAction(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯ (${contractNo || 'Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù…'}) ÙŠØ¶Ù… ${rows.length} ÙˆØ­Ø¯Ø© Ù„Ù„Ù…Ø³ØªØ£Ø¬Ø± ${tenantName}`);
    updateDashboard();
  });

  
  // ===== Lease Payments (Multi-unit contract payments) =====
  function openLeasePaymentModal(groupKey){
    const cache = window.__leaseGroupsCache || {};
    const g = cache[groupKey];
    if(!g){
      alert('ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯. Ø¬Ø±Ù‘Ø¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© Ø«Ù… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
      return;
    }
    const m = document.getElementById('lease-payment-modal');
    m.classList.remove('hidden');
    m.dataset.groupKey = groupKey;
    m.dataset.contractNo = g.contractNo || '';
    document.getElementById('lease-pay-title').textContent = `ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø© Ù„Ù„Ø¹Ù‚Ø¯: ${g.contractNo || ''} â€” ${g.tenant || ''}`;

    const today = new Date();
    document.getElementById('lease-pay-date').value = today.toISOString().slice(0,10);
    document.getElementById('lease-pay-total').value = '';
    document.getElementById('lease-pay-method').value = 'ØªØ­ÙˆÙŠÙ„';
    document.getElementById('lease-pay-ref').value = '';

    const tb = document.getElementById('lease-pay-units-body');
    tb.innerHTML = '';
    (g.units||[]).forEach(u=>{
      const paid = sumLeasePaidForUnit(g.contractNo, u.propId, u.id);
      const rent = Number(u.rent)||0;
      const remain = Math.max(0, rent - paid);

      const tr = document.createElement('tr');
      tr.className = 'border-t border-gray-100 dark:border-gray-800';
      tr.innerHTML = `
        <td class="py-2 px-2">
          <div class="font-bold text-gray-800 dark:text-white">${u.name||'â€”'}</div>
          <div class="text-xs font-mono text-gray-500 dark:text-gray-400">${u.id||''}</div>
        </td>
        <td class="py-2 px-2 font-mono text-emerald-600 dark:text-emerald-400">${formatAED(rent)}</td>
        <td class="py-2 px-2 font-mono text-gray-700 dark:text-gray-200">${formatAED(paid)}</td>
        <td class="py-2 px-2 font-mono text-red-600 dark:text-red-300">${formatAED(remain)}</td>
        <td class="py-2 px-2">
          <input class="lease-alloc-input w-40 px-3 py-2 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-dark-surface font-mono"
                 type="text" placeholder="0" value=""
                 data-prop="${u.propId}" data-unit="${u.id}" data-unitname="${u.name||''}" data-rent="${rent}"
                 oninput="updateLeasePaySum()" />
        </td>
      `;
      tb.appendChild(tr);
    });

    updateLeasePaySum();
  }

  function updateLeasePaySum(){
    const total = parseAED(document.getElementById('lease-pay-total')?.value);
    let sum = 0;
    document.querySelectorAll('.lease-alloc-input').forEach(inp=>{
      sum += parseAED(inp.value);
    });
    const diff = (total - sum);
    const sumEl = document.getElementById('lease-pay-sum');
    const diffEl = document.getElementById('lease-pay-diff');
    if(sumEl) sumEl.textContent = formatAED(sum);
    if(diffEl){
      diffEl.textContent = formatAED(diff);
      diffEl.className = 'font-mono ' + (Math.abs(diff) < 0.001 ? 'text-emerald-700 dark:text-emerald-400' : 'text-red-600 dark:text-red-300');
    }
  }

  function autoDistributeLeasePayment(){
    const m = document.getElementById('lease-payment-modal');
    const groupKey = m?.dataset?.groupKey || '';
    const contractNo = m?.dataset?.contractNo || '';
    const cache = window.__leaseGroupsCache || {};
    const g = cache[groupKey];
    if(!g){ alert('ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯.'); return; }

    const total = parseAED(document.getElementById('lease-pay-total')?.value);
    if(total <= 0){ alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£ÙˆÙ„Ø§Ù‹.'); return; }

    // Distribute by remaining (rent - paid) proportional
    const rows = [];
    let sumRemain = 0;
    (g.units||[]).forEach(u=>{
      const paid = sumLeasePaidForUnit(contractNo, u.propId, u.id);
      const rent = Number(u.rent)||0;
      const remain = Math.max(0, rent - paid);
      sumRemain += remain;
      rows.push({u, remain});
    });

    const inputs = Array.from(document.querySelectorAll('.lease-alloc-input'));
    if(!inputs.length) return;

    if(sumRemain <= 0){
      // fallback: proportional by rent
      sumRemain = rows.reduce((s,r)=>s + (Number(r.u.rent)||0), 0) || 1;
      rows.forEach(r=>r.remain = Number(r.u.rent)||0);
    }

    let allocated = 0;
    rows.forEach((r, idx)=>{
      let val = (idx === rows.length-1) ? (total - allocated) : Math.round((total * (r.remain/sumRemain)) * 100)/100;
      if(val < 0) val = 0;
      allocated += val;

      const inp = inputs[idx];
      if(inp) inp.value = (val ? String(val) : '');
    });

    updateLeasePaySum();
  }

  function saveLeasePayment(){
    const m = document.getElementById('lease-payment-modal');
    const groupKey = m?.dataset?.groupKey || '';
    const contractNo = m?.dataset?.contractNo || '';
    const cache = window.__leaseGroupsCache || {};
    const g = cache[groupKey];
    if(!g){ alert('ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯.'); return; }

    const date = document.getElementById('lease-pay-date')?.value || '';
    const total = parseAED(document.getElementById('lease-pay-total')?.value);
    const method = document.getElementById('lease-pay-method')?.value || '';
    const ref = document.getElementById('lease-pay-ref')?.value || '';

    if(!date){ alert('Ø­Ø¯Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯ÙØ¹Ø©.'); return; }
    if(total <= 0){ alert('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹Ø©.'); return; }

    const allocInputs = Array.from(document.querySelectorAll('.lease-alloc-input'));
    const allocs = [];
    let sum = 0;
    allocInputs.forEach(inp=>{
      const amt = parseAED(inp.value);
      if(amt > 0){
        allocs.push({
          propId: inp.dataset.prop,
          unitId: inp.dataset.unit,
          unitName: inp.dataset.unitname || '',
          amount: amt
        });
        sum += amt;
      }
    });

    if(allocs.length === 0){
      alert('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„ØºÙ‹Ø§ Ù…Ø®ØµØµÙ‹Ø§ Ù„ÙˆØ­Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.');
      return;
    }

    const diff = total - sum;
    if(Math.abs(diff) > 0.001){
      alert('Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ØªÙˆØ²ÙŠØ¹ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ³Ø§ÙˆÙŠ Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹Ø©. Ø§Ø³ØªØ®Ø¯Ù… "ØªÙˆØ²ÙŠØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠ" Ø£Ùˆ Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø¨Ø§Ù„Øº.');
      return;
    }

    const payId = 'LPAY-' + Date.now();
    leasePayments.push({
      id: payId,
      groupKey,
      contractNo,
      tenant: g.tenant || '',
      date,
      total,
      method,
      ref
    });

    allocs.forEach(a=>{
      leaseAllocations.push({
        id: 'LPA-' + Date.now() + '-' + Math.floor(Math.random()*1000),
        paymentId: payId,
        contractNo,
        groupKey,
        tenant: g.tenant || '',
        date,
        propId: a.propId,
        unitId: a.unitId,
        unitName: a.unitName,
        amount: a.amount
      });
    });

    saveToLocal();
    renderLeases();
    m.classList.add('hidden');
    alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¯ÙØ¹Ø© ÙˆØªÙˆØ²ÙŠØ¹Ù‡Ø§ Ø¹Ù„Ù‰ ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯.');
  }

function openLeaseModal(pid, uid){
    const m = document.getElementById('lease-modal');
    m.classList.remove('hidden');
    const u = properties.find(x=>x.id===pid).units.find(x=>x.id===uid);
    document.getElementById('lease-prop-id').value=pid;
    document.getElementById('lease-unit-id').value=uid;
    document.getElementById('lease-tenant').value=u.tenant||'';
    document.getElementById('lease-rent').value=u.rent||'';
    document.getElementById('lease-contractNo').value=u.contractNo||'';
    document.getElementById('lease-start').value=u.start||'';
    document.getElementById('lease-end').value=u.end||'';
    const tk = tenantKey(u.tenant||'');
    const c = tenantsContacts[tk] || {};
    const ex = u.leaseExtra || {};
    if(document.getElementById('lease-phone')) document.getElementById('lease-phone').value = ex.phone || c.phone || '';
    if(document.getElementById('lease-email')) document.getElementById('lease-email').value = ex.email || c.email || '';
    if(document.getElementById('lease-paymentsCount')) document.getElementById('lease-paymentsCount').value = (ex.paymentsCount ?? '');
    if(document.getElementById('lease-chequesCount')) document.getElementById('lease-chequesCount').value = (ex.chequesCount ?? '');
    if(document.getElementById('lease-bankGuarantee')) document.getElementById('lease-bankGuarantee').value = (ex.bankGuarantee ?? '');
    if(document.getElementById('lease-tenantType')) document.getElementById('lease-tenantType').value = ex.tenantType || c.tenantType || '';
    if(document.getElementById('lease-tradeLicense')) document.getElementById('lease-tradeLicense').value = ex.tradeLicenseNo || c.tradeLicenseNo || '';
    if(document.getElementById('lease-idNumber')) document.getElementById('lease-idNumber').value = ex.idNumber || c.idNumber || '';
    applyTenantTypeUI('lease');
    if(document.getElementById('lease-tenantType')) document.getElementById('lease-tenantType').addEventListener('change', ()=>applyTenantTypeUI('lease'));

    document.getElementById('lease-status').value=u.status;
  }

  function closeLeaseModal(){
    document.getElementById('lease-modal').classList.add('hidden');
  }

  document.getElementById('lease-form').addEventListener('submit', e=>{
    e.preventDefault();
    const pid = document.getElementById('lease-prop-id').value;
    const uid = document.getElementById('lease-unit-id').value;
    const p = properties.find(x=>x.id===pid);
    const u = p.units.find(x=>x.id===uid);

    
    ensureLeaseHistory(u);
u.tenant = document.getElementById('lease-tenant').value;
    u.rent = parseFloat(document.getElementById('lease-rent').value||0);
    u.contractNo = document.getElementById('lease-contractNo').value;
    u.start = document.getElementById('lease-start').value;
    u.end = document.getElementById('lease-end').value;
    u.status = document.getElementById('lease-status').value;
    const extra = {
      phone: (document.getElementById('lease-phone')?.value || '').trim(),
      email: (document.getElementById('lease-email')?.value || '').trim(),
      paymentsCount: parseInt(document.getElementById('lease-paymentsCount')?.value || '0', 10) || 0,
      chequesCount: parseInt(document.getElementById('lease-chequesCount')?.value || '0', 10) || 0,
      bankGuarantee: parseFloat(document.getElementById('lease-bankGuarantee')?.value || '0') || 0,
      tenantType: (document.getElementById('lease-tenantType')?.value || '').trim(),
      tradeLicenseNo: (document.getElementById('lease-tradeLicense')?.value || '').trim(),
      idNumber: (document.getElementById('lease-idNumber')?.value || '').trim(),
    };
    u.leaseExtra = Object.assign({}, u.leaseExtra || {}, extra);

    const tk = tenantKey(u.tenant);
    const prev = tenantsContacts[tk] || { name: u.tenant, phone:'', email:'' };
    tenantsContacts[tk] = {
      name: u.tenant,
      phone: extra.phone || prev.phone || '',
      email: extra.email || prev.email || '',
      tenantType: extra.tenantType || prev.tenantType || '',
      tradeLicenseNo: extra.tradeLicenseNo || prev.tradeLicenseNo || '',
      idNumber: extra.idNumber || prev.idNumber || ''
    };


    saveToLocal();
    closeLeaseModal();
    renderLeases();
    renderProperties();
    updateDashboard();
    logAction(`ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù‚Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø© ${u.name}`);
  });

  function cancelLease(){
    if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù‚Ø¯ØŸ Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© Ù„Ø´Ø§ØºØ±Ø©.')) return;
    const pid = document.getElementById('lease-prop-id').value;
    const uid = document.getElementById('lease-unit-id').value;
    const u = properties.find(x=>x.id===pid).units.find(x=>x.id===uid);
    // Ø­ÙØ¸ Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¶Ù…Ù† Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø®Ù„Ø§Ø¡/Ø§Ù„Ø¥Ù„ØºØ§Ø¡ (Ù„Ø¸Ù‡ÙˆØ±Ù‡ ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±)
    const overrideStatus = (u.status === 'Ù…Ù†ØªÙ‡ÙŠØ©') ? 'Ù…Ù†ØªÙ‡ÙŠØ©' : 'Ù…Ù„ØºØ§Ø©';
    const reason = (u.status === 'Ù…Ù†ØªÙ‡ÙŠØ©') ? 'Ø¥Ø®Ù„Ø§Ø¡ Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø¯' : 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù‚Ø¯ ÙˆØ¥Ø®Ù„Ø§Ø¡ Ø§Ù„ÙˆØ­Ø¯Ø©';
    archiveUnitLease(u, reason, overrideStatus);
u.status='Ø´Ø§ØºØ±Ø©';
    u.tenant='';
    u.rent=0;
    u.contractNo='';
    u.start='';
    u.end='';
    saveToLocal();
    closeLeaseModal();
    showView('leases');
    updateDashboard();
    logAction(`ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¹Ù‚Ø¯ ${u.name}`);
  }

  // ================= TENANTS =================
  function getTenantsData(){
    const map = {};
    properties.forEach(p=>p.units.forEach(u=>{
      if(u.status==='Ù…Ø¤Ø¬Ø±Ø©' && u.tenant){
        const key = tenantKey(u.tenant);
        if(!key) return;
        if(!map[key]) map[key] = { key, name:String(u.tenant).trim(), phone:'', email:'', tenantType:'', tradeLicenseNo:'', idNumber:'', idLabel:'', units:[], rent:0, paid:0 };
        map[key].units.push(u.name);
        map[key].rent += (u.rent||0);
      }
    }));
    Object.keys(map).forEach(key=>{
      const c = tenantsContacts[key];
      if(c){
        map[key].phone = c.phone || '';
        map[key].email = c.email || '';
        map[key].tenantType = c.tenantType || map[key].tenantType || '';
        map[key].tradeLicenseNo = c.tradeLicenseNo || map[key].tradeLicenseNo || '';
        map[key].idNumber = c.idNumber || map[key].idNumber || '';
        // Display label in tenants table
        if(map[key].tenantType === 'Ø´Ø±ÙƒØ©' && map[key].tradeLicenseNo){
          map[key].idLabel = `ğŸ¢ Ø±Ø®ØµØ©: ${map[key].tradeLicenseNo}`;
        } else if(map[key].tenantType === 'ÙØ±Ø¯' && map[key].idNumber){
          map[key].idLabel = `ğŸªª Ù‡ÙˆÙŠØ©: ${map[key].idNumber}`;
        } else if(map[key].tradeLicenseNo){
          map[key].idLabel = `ğŸ¢ Ø±Ø®ØµØ©: ${map[key].tradeLicenseNo}`;
        } else if(map[key].idNumber){
          map[key].idLabel = `ğŸªª Ù‡ÙˆÙŠØ©: ${map[key].idNumber}`;
        } else {
          map[key].idLabel = '';
        }
        // keep a preferred display name if available
        if(c.name) map[key].name = c.name;
      }
    });
    payments.forEach(pay=>{
      const key = tenantKey(pay.tenant);
      if(map[key]) map[key].paid += pay.amount;
    });
    return Object.values(map).map(t=>({...t, balance: t.rent - t.paid}));
  }

  function getTenantNames(){
    return Object.keys(
      getTenantsData().reduce((acc, t)=>{
        if(t.units && t.units.length>0) acc[t.name]=true;
        return acc;
      }, {})
    );
  }

  // ======= Units lookup helpers (for linking cheques to units) =======
  function findUnitById(unitId){
    if(!unitId) return null;
    for(const p of (properties||[])){
      for(const u of (p.units||[])){
        if(u.id === unitId){
          return { property: p, unit: u };
        }
      }
    }
    return null;
  }

  function getTenantLeasedUnitsDetailed(tenantName){
    const tkey = tenantKey(tenantName);
    const out = [];
    if(!tkey) return out;
    (properties||[]).forEach(p=>{
      (p.units||[]).forEach(u=>{
        if(u.status === 'Ù…Ø¤Ø¬Ø±Ø©' && tenantKey(u.tenant) === tkey){
          out.push({
            unitId: u.id,
            unitName: u.name,
            propertyId: p.id,
            propertyName: p.name,
            contractNo: u.contractNo || '',
            start: u.start || '',
            end: u.end || '',
            label: `${u.name} - ${p.name}`
          });
        }
      });
    });
    return out;
  }

  function inferSingleLeasedUnitIdForTenant(tenantName){
    const list = getTenantLeasedUnitsDetailed(tenantName);
    return list.length === 1 ? list[0].unitId : '';
  }

  function getUnitDisplayById(unitId){
    const hit = findUnitById(unitId);
    if(!hit) return '';
    return `${hit.unit.name} - ${hit.property.name}`;
  }

  function resolveChequeUnitInfo(cheque){
    const c = normalizeChequeRecord(cheque||{});
    let unitId = c.unitId || '';
    if(!unitId){
      unitId = inferSingleLeasedUnitIdForTenant(c.tenant);
    }
    const hit = findUnitById(unitId);
    const unitLabel = hit ? `${hit.unit.name} - ${hit.property.name}` : (c.unitLabel || '');
    const contractNo = hit ? (hit.unit.contractNo || '') : '';
    return { unitId, unitLabel, contractNo };
  }

  function migrateChequePaymentsToUnit(chequeId){
    const chRaw = (cheques||[]).find(x=>x.id===chequeId);
    if(!chRaw) return;
    const info = resolveChequeUnitInfo(chRaw);
    if(!info.unitId) return;

    // Update cheque record
    const idx = cheques.findIndex(x=>x.id===chequeId);
    if(idx>=0){
      cheques[idx] = { ...cheques[idx], unitId: info.unitId, unitLabel: info.unitLabel };
    }

    // Update linked payment record (if created earlier with generic unit)
    const pIdx = (payments||[]).findIndex(p=>p.chequeId===chequeId);
    if(pIdx>=0){
      const p = payments[pIdx];
      const needs = (!p.unit || p.unit === 'Ø´ÙŠÙƒ Ù…ØµØ±Ù' || p.unit === 'Ø´ÙŠÙƒ Ù…ØµØ±Ù' || p.unit === 'Ø´ÙŠÙƒ Ù…ØµØ±Ù');
      if(needs){
        payments[pIdx] = { ...p, unit: info.unitLabel || p.unit, unitId: info.unitId, contract: info.contractNo || p.contract };
      } else {
        // still store unitId for future matching
        payments[pIdx] = { ...p, unitId: info.unitId };
      }
    }
  }


  function renderTenants(){
    const tbody = document.getElementById('tenants-table-body');
    tbody.innerHTML = '';
    const search = (document.getElementById('tenants-search').value||'').toLowerCase().trim();

    let data = getTenantsData().filter(t=>{
      if(!search) return true;
      const hay = [
        t.name, t.phone, t.email, t.idLabel,
        (t.units||[]).join(' '),
      ].join(' ').toLowerCase();
      return hay.includes(search);
    });

    const sortBy = (document.getElementById('tenants-sort-by')?.value) || _lsGet('re_tenants_sort_by','name');
    const sortDir = (document.getElementById('tenants-sort-dir')?.dataset?.dir) || _lsGet('re_tenants_sort_dir','asc');
    data = _sortTenants(data, sortBy, sortDir);

    data.forEach(t=>{
      const tr = document.createElement('tr');

      tr.innerHTML = `
        <td class="font-bold">${t.name}</td>
        <td class="text-sm">
          ğŸ“ ${t.phone||'--'}<br>
          ğŸ“§ ${t.email||'--'}
        </td>
        <td class="text-xs text-gray-600 dark:text-gray-300">
          ${t.idLabel||'--'}
        </td>
        <td class="text-xs text-gray-500 dark:text-gray-400">${t.units.join(', ')}</td>
        <td class="font-mono">${formatAED(t.rent)}</td>
        <td class="font-mono text-green-600">${formatAED(t.paid)}</td>
        <td class="font-mono font-bold ${t.balance>0?'text-rose-600 dark:text-rose-400':'text-gray-400'}">${formatAED(t.balance)}</td>
        <td class="tenant-actions"></td>
      `;

      const td = tr.querySelector('.tenant-actions');
      const btn = document.createElement('button');
      btn.textContent = 'ØªØ­Ø¯ÙŠØ«';
      btn.className = 'text-blue-600 hover:text-blue-800 border border-blue-200 dark:border-blue-800 px-2 py-1 rounded';
      btn.addEventListener('click', ()=> openTenantModal(t.key, t.name));
      td.appendChild(btn);

      tbody.appendChild(tr);
    });
  }

  
    // ================= SORTING (Properties / Tenants) =================
  function _lsGet(key, fallback){
    try{
      const v = localStorage.getItem(key);
      return (v===null || v===undefined || v==='') ? fallback : v;
    }catch(e){ return fallback; }
  }
  function _lsSet(key, value){
    try{ localStorage.setItem(key, String(value)); }catch(e){}
  }

  function initSortingPrefs(){
    // Properties
    const psb = document.getElementById('prop-sort-by');
    const psd = document.getElementById('prop-sort-dir');
    const usb = document.getElementById('unit-sort-by');
    const usd = document.getElementById('unit-sort-dir');

    if(psb) psb.value = _lsGet('re_prop_sort_by','name');
    if(psd){
      const d = _lsGet('re_prop_sort_dir','asc');
      psd.dataset.dir = d;
      psd.textContent = (d==='asc') ? 'â¬†ï¸' : 'â¬‡ï¸';
    }
    if(usb) usb.value = _lsGet('re_unit_sort_by','unitName');
    if(usd){
      const d = _lsGet('re_unit_sort_dir','asc');
      usd.dataset.dir = d;
      usd.textContent = (d==='asc') ? 'â¬†ï¸' : 'â¬‡ï¸';
    }

    // Tenants
    const tsb = document.getElementById('tenants-sort-by');
    const tsd = document.getElementById('tenants-sort-dir');
    if(tsb) tsb.value = _lsGet('re_tenants_sort_by','name');
    if(tsd){
      const d = _lsGet('re_tenants_sort_dir','asc');
      tsd.dataset.dir = d;
      tsd.textContent = (d==='asc') ? 'â¬†ï¸' : 'â¬‡ï¸';
    }
  }
  // ===== Properties - Unit Filters (Vacant/Rented + End Date) =====
  function initPropertiesUnitFilters(){
    const statusEl = document.getElementById('unit-status-filter');
    const endFromEl = document.getElementById('unit-end-from');
    const endToEl = document.getElementById('unit-end-to');
    const panel = document.getElementById('prop-filters-panel');

    if(statusEl) statusEl.value = _lsGet('re_unit_status_filter','');
    if(endFromEl) endFromEl.value = _lsGet('re_unit_end_from','');
    if(endToEl) endToEl.value = _lsGet('re_unit_end_to','');

    const open = _lsGet('re_prop_filters_open','0') === '1';
    if(panel){
      panel.classList.toggle('hidden', !open);
      const btn = document.getElementById('prop-filters-toggle');
      if(btn) btn.textContent = open ? 'ğŸ§° Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙÙ„Ø§ØªØ±' : 'ğŸ§° ÙÙ„Ø§ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø§Øª';
    }

    const onChange = ()=>{ onPropertiesUnitFiltersChanged(); };
    statusEl && statusEl.addEventListener('change', onChange);
    endFromEl && endFromEl.addEventListener('change', onChange);
    endToEl && endToEl.addEventListener('change', onChange);
  }

  function togglePropertiesUnitFilters(){
    const panel = document.getElementById('prop-filters-panel');
    if(!panel) return;
    const willOpen = panel.classList.contains('hidden');
    panel.classList.toggle('hidden', !willOpen);
    _lsSet('re_prop_filters_open', willOpen ? '1' : '0');
    const btn = document.getElementById('prop-filters-toggle');
    if(btn) btn.textContent = willOpen ? 'ğŸ§° Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙÙ„Ø§ØªØ±' : 'ğŸ§° ÙÙ„Ø§ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø§Øª';
  }

  function onPropertiesUnitFiltersChanged(){
    const statusEl = document.getElementById('unit-status-filter');
    const endFromEl = document.getElementById('unit-end-from');
    const endToEl = document.getElementById('unit-end-to');

    _lsSet('re_unit_status_filter', statusEl?.value || '');
    _lsSet('re_unit_end_from', endFromEl?.value || '');
    _lsSet('re_unit_end_to', endToEl?.value || '');

    renderProperties();
  }

  function resetPropertiesUnitFilters(){
    _lsSet('re_unit_status_filter','');
    _lsSet('re_unit_end_from','');
    _lsSet('re_unit_end_to','');

    const statusEl = document.getElementById('unit-status-filter');
    const endFromEl = document.getElementById('unit-end-from');
    const endToEl = document.getElementById('unit-end-to');
    if(statusEl) statusEl.value = '';
    if(endFromEl) endFromEl.value = '';
    if(endToEl) endToEl.value = '';
    renderProperties();
  }
  // ===== /Properties - Unit Filters =====


  function onPropSortChanged(){
    const el = document.getElementById('prop-sort-by');
    if(el) _lsSet('re_prop_sort_by', el.value);
    renderProperties();
  }
  function togglePropSortDir(){
    const btn = document.getElementById('prop-sort-dir');
    if(!btn) return;
    const next = (btn.dataset.dir==='asc') ? 'desc' : 'asc';
    btn.dataset.dir = next;
    btn.textContent = (next==='asc') ? 'â¬†ï¸' : 'â¬‡ï¸';
    _lsSet('re_prop_sort_dir', next);
    renderProperties();
  }
  function onUnitSortChanged(){
    const el = document.getElementById('unit-sort-by');
    if(el) _lsSet('re_unit_sort_by', el.value);
    renderProperties();
  }
  function toggleUnitSortDir(){
    const btn = document.getElementById('unit-sort-dir');
    if(!btn) return;
    const next = (btn.dataset.dir==='asc') ? 'desc' : 'asc';
    btn.dataset.dir = next;
    btn.textContent = (next==='asc') ? 'â¬†ï¸' : 'â¬‡ï¸';
    _lsSet('re_unit_sort_dir', next);
    renderProperties();
  }

  function onTenantSortChanged(){
    const el = document.getElementById('tenants-sort-by');
    if(el) _lsSet('re_tenants_sort_by', el.value);
    renderTenants();
  }
  function toggleTenantSortDir(){
    const btn = document.getElementById('tenants-sort-dir');
    if(!btn) return;
    const next = (btn.dataset.dir==='asc') ? 'desc' : 'asc';
    btn.dataset.dir = next;
    btn.textContent = (next==='asc') ? 'â¬†ï¸' : 'â¬‡ï¸';
    _lsSet('re_tenants_sort_dir', next);
    renderTenants();
  }

  function _cmpText(a,b){
    const A = (a||'').toString().trim();
    const B = (b||'').toString().trim();
    return A.localeCompare(B, 'ar', {numeric:true, sensitivity:'base'});
  }
  function _cmpNum(a,b){
    const A = Number(a||0);
    const B = Number(b||0);
    return A - B;
  }
  function _dirMult(dir){ return (dir==='desc') ? -1 : 1; }

  function _sortProperties(list, by, dir){
    const m = _dirMult(dir);
    const arr = [...(list||[])];
    arr.sort((p1,p2)=>{
      switch(by){
        case 'units': return m * _cmpNum((p1.units||[]).length, (p2.units||[]).length);
        case 'location': return m * _cmpText(p1.location, p2.location);
        case 'id': return m * _cmpText(p1.id, p2.id);
        case 'name':
        default: return m * _cmpText(p1.name, p2.name);
      }
    });
    return arr;
  }

  function _statusRank(s){
    // lower = earlier in sort
    if(s==='Ù…Ø¤Ø¬Ø±Ø©') return 1;
    if(s==='Ø´Ø§ØºØ±Ø©') return 2;
    if(s==='Ù…Ù†ØªÙ‡ÙŠØ©') return 3;
    return 99;
  }

  function _sortUnits(list, by, dir){
    const m = _dirMult(dir);
    const arr = [...(list||[])];
    arr.sort((u1,u2)=>{
      switch(by){
        case 'unitId': return m * _cmpText(u1.id, u2.id);
        case 'status': return m * (_statusRank(u1.status) - _statusRank(u2.status));
        case 'tenant': return m * _cmpText(u1.tenant, u2.tenant);
        case 'rent': return m * _cmpNum(u1.rent, u2.rent);
        case 'unitName':
        default: return m * _cmpText(u1.unitName || u1.name, u2.unitName || u2.name);
      }
    });
    return arr;
  }

  function _sortTenants(list, by, dir){
    const m = _dirMult(dir);
    const arr = [...(list||[])];
    arr.sort((t1,t2)=>{
      switch(by){
        case 'balance': return m * _cmpNum(t1.balance, t2.balance);
        case 'rent': return m * _cmpNum(t1.rent, t2.rent);
        case 'unitsCount': return m * _cmpNum((t1.units||[]).length, (t2.units||[]).length);
        case 'idLabel': return m * _cmpText(t1.idLabel, t2.idLabel);
        case 'name':
        default: return m * _cmpText(t1.name, t2.name);
      }
    });
    return arr;
  }

  // ================= TENANT CONTACTS (reliable save) =================
  let tenantAutosaveTimer = null;

  function setTenantSaveStatus(msg=''){
    const el = document.getElementById('tenant-save-status');
    if(!el) return;
    el.textContent = msg;
  }

  function persistTenantContact({silent=false} = {}){
    const nameEl  = document.getElementById('tenant-name');
    const phoneEl = document.getElementById('tenant-phone');
    const emailEl = document.getElementById('tenant-email');

    const displayName = (nameEl?.value || '').trim();
    const key = currentTenantKey || tenantKey(displayName);
    if(!key) return null;

    tenantsContacts[key] = {
      name: displayName || (tenantsContacts[key]?.name || ''),
      phone: phoneEl?.value || '',
      email: emailEl?.value || '',
      tenantType: document.getElementById('tenant-type')?.value || (tenantsContacts[key]?.tenantType || ''),
      tradeLicenseNo: document.getElementById('tenant-tradeLicense')?.value || (tenantsContacts[key]?.tradeLicenseNo || ''),
      idNumber: document.getElementById('tenant-idNumber')?.value || (tenantsContacts[key]?.idNumber || '')
    };

    saveToLocal();
    if(!silent) setTenantSaveStatus('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸');
    return key;
  }

  function scheduleTenantAutosave(){
    clearTimeout(tenantAutosaveTimer);
    setTenantSaveStatus('â€¦ Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸');
    tenantAutosaveTimer = setTimeout(()=>{
      persistTenantContact({silent:true});
      setTenantSaveStatus('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸');
    }, 500);
  }

  function setupTenantModalUX(){
    const modal = document.getElementById('tenant-modal');
    if(!modal || modal.dataset.bound === '1') return;
    modal.dataset.bound = '1';

    // autosave on input (phone/email)
    ['tenant-phone','tenant-email','tenant-type','tenant-tradeLicense','tenant-idNumber'].forEach(id=>{
      const el = document.getElementById(id);
      if(el){
        el.addEventListener('input', scheduleTenantAutosave);
      }
    });


    // ensure select (tenant-type) also saves on change
    const _tenantTypeSel = document.getElementById('tenant-type');
    if(_tenantTypeSel){
      _tenantTypeSel.addEventListener('change', ()=>{ applyTenantTypeUI('tenant'); scheduleTenantAutosave(); });
    }
    const typeEl = document.getElementById('tenant-type');
    if(typeEl){
      typeEl.addEventListener('change', ()=>applyTenantTypeUI('tenant'));
    }

    // ESC closes (and saves)
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape' && !document.getElementById('tenant-modal').classList.contains('hidden')){
        closeTenantModal();
      }
    });

    // click backdrop closes (and saves)
    modal.addEventListener('click', (e)=>{
      if(e.target === modal){
        closeTenantModal();
      }
    });
  }

function openTenantModal(key='', displayName=''){
    const modal = document.getElementById('tenant-modal');
    modal.classList.remove('hidden');

    setupTenantModalUX();
    setTenantSaveStatus('');

    currentTenantKey = key || tenantKey(displayName);

    const nameInput  = document.getElementById('tenant-name');
    const phoneInput = document.getElementById('tenant-phone');
    const emailInput = document.getElementById('tenant-email');

    nameInput.value = displayName || '';
    phoneInput.value = '';
    emailInput.value = '';
    const typeSel = document.getElementById('tenant-type');
    const tradeInput = document.getElementById('tenant-tradeLicense');
    const idInput = document.getElementById('tenant-idNumber');
    if(typeSel) typeSel.value = '';
    if(tradeInput) tradeInput.value = '';
    if(idInput) idInput.value = '';


    const c = tenantsContacts[currentTenantKey];
    if(c){
      phoneInput.value = c.phone || '';
      emailInput.value = c.email || '';
      if(typeSel) typeSel.value = c.tenantType || '';
      if(tradeInput) tradeInput.value = c.tradeLicenseNo || '';
      if(idInput) idInput.value = c.idNumber || '';
      // keep stored preferred name if present
      if(c.name && !displayName) nameInput.value = c.name;
    }
    applyTenantTypeUI('tenant');
  }

  function closeTenantModal(){
    // finalize any pending autosave
    clearTimeout(tenantAutosaveTimer);
    persistTenantContact({silent:true});
    renderTenants();

    currentTenantKey = null;
    document.getElementById('tenant-modal').classList.add('hidden');
    setTenantSaveStatus('');
  }

  document.getElementById('tenant-form').addEventListener('submit', function(e){
    e.preventDefault();
    // Ø­ÙØ¸ ÙÙˆØ±ÙŠ
    persistTenantContact({silent:true});
    closeTenantModal();
  });

  // ================= PAYMENTS =================
  function openPaymentModal(){
    const m = document.getElementById('payment-modal');
    m.classList.remove('hidden');
    const sel = document.getElementById('pay-contract');
    sel.innerHTML='';
    properties.forEach(p=>p.units.forEach(u=>{
      if(u.status==='Ù…Ø¤Ø¬Ø±Ø©'){
        const opt = document.createElement('option');
        opt.value = JSON.stringify({t:u.tenant, u:u.name, c:u.contractNo, rent:u.rent});
        opt.textContent = `${u.tenant} - (${u.name})`;
        sel.appendChild(opt);
      }
    }));
  }

  function closePaymentModal(){
    document.getElementById('payment-modal').classList.add('hidden');
  }

  document.getElementById('payment-form').addEventListener('submit', e=>{
    e.preventDefault();
    const data = JSON.parse(document.getElementById('pay-contract').value);
    const amt = parseFloat(document.getElementById('pay-amount').value);
    const payObj = {
      id: 'PAY-'+Date.now(),
      date: document.getElementById('pay-date').value,
      tenant: data.t,
      unit: data.u,
      contract: data.c,
      due: data.rent,
      type: document.getElementById('pay-type').value,
      amount: amt,
      desc: document.getElementById('pay-desc').value,
      voucherNo: nextVoucherNumber('receipt')
    };
    payments.push(payObj);
    saveToLocal();
    closePaymentModal();
    renderPayments();
    updateDashboard();
    renderReceiptsHistory();
    logAction(`Ø¯ÙØ¹Ø© ${amt} Ù…Ù† ${data.t}`);
  });

  function renderPayments(){
    const tbody = document.getElementById('payments-table-body');
    tbody.innerHTML='';
    payments.sort((a,b)=> new Date(b.date)-new Date(a.date)).forEach(p=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="text-sm">${p.date}</td>
        <td>
          <div class="font-bold text-sm">${p.tenant}</div>
          <div class="text-xs text-gray-500 dark:text-gray-400">${p.unit}</div>
        </td>
        <td><span class="badge badge-blue">${p.type}</span></td>
        <td class="font-bold text-emerald-700 dark:text-emerald-400 font-mono">${formatAED(p.amount)}</td>
        <td class="text-xs text-gray-500 dark:text-gray-400 font-mono">${formatAED(p.due)} / <span class="text-rose-500 dark:text-rose-400">${formatAED(p.due-p.amount)}</span></td>
        <td>${p.amount>=p.due ? '<span class="badge badge-green">Ù…ÙƒØªÙ…Ù„</span>' : '<span class="badge badge-amber">Ø¬Ø²Ø¦ÙŠ</span>'}</td>
        <td><button onclick="previewReceipt('${p.id}', 'payment')" class="text-purple-600 dark:text-purple-400 hover:underline text-xs">Ø¹Ø±Ø¶ Ø§Ù„Ø³Ù†Ø¯</button></td>
      `;
      tbody.appendChild(tr);
    });
    const total = payments.reduce((s,p)=>s+p.amount,0);
    document.getElementById('payments-total').textContent = formatAED(total);
  }

  // ================= CHEQUES =================
  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      if (!file) {
        resolve(null);
        return;
      }
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = error => reject(error);
      reader.readAsDataURL(file);
    });
  }

  function toggleTenantInput() {
    const selectEl = document.getElementById('cheque-tenant-select');
    const manualEl = document.getElementById('cheque-tenant-manual');
    const unitSel  = document.getElementById('cheque-unit-select');

    const selected = selectEl ? selectEl.value : '';
    if (selected === 'other') {
      manualEl.classList.remove('hidden');
      manualEl.setAttribute('required', 'required');
      if(unitSel){
        unitSel.innerHTML = '<option value="">â€” Ø¨Ø¯ÙˆÙ† Ø±Ø¨Ø· ÙˆØ­Ø¯Ø© â€”</option>';
        unitSel.disabled = true;
      }
    } else {
      manualEl.classList.add('hidden');
      manualEl.removeAttribute('required');
      const tenantName = selected;
      if(unitSel){
        unitSel.innerHTML = '<option value="">â€” Ø¨Ø¯ÙˆÙ† Ø±Ø¨Ø· ÙˆØ­Ø¯Ø© â€”</option>';
        const units = getTenantLeasedUnitsDetailed(tenantName);
        units.forEach(x=>{
          const opt = document.createElement('option');
          opt.value = x.unitId;
          opt.textContent = x.label;
          unitSel.appendChild(opt);
        });
        unitSel.disabled = units.length === 0;
      }
    }
  }

  
  function openChequeModal(chequeId=''){
    const modal = document.getElementById('cheque-modal');
    const form  = document.getElementById('new-cheque-form');
    const title = document.getElementById('cheque-modal-title');
    const saveBtn = document.getElementById('cheque-modal-save-btn');
    if(!modal || !form) return;

    modal.classList.remove('hidden');
    form.reset();

    // Populate tenant select
    const selectEl = document.getElementById('cheque-tenant-select');
    selectEl.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù…Ø³ØªØ£Ø¬Ø± Ø­Ø§Ù„ÙŠ...</option>';
    getTenantNames().forEach(name => {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      selectEl.appendChild(opt);
    });
    selectEl.innerHTML += '<option value="other">-- Ù…Ø³ØªØ£Ø¬Ø± Ø¬Ø¯ÙŠØ¯ / Ø¢Ø®Ø± --</option>';

    // Default (Add)
    editingChequeId = null;
    if(title) title.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø´ÙŠÙƒ Ø¬Ø¯ÙŠØ¯';
    if(saveBtn) saveBtn.textContent = 'Ø­ÙØ¸ Ø§Ù„Ø´ÙŠÙƒ';

    // If edit
    if(chequeId){
      const raw = (cheques||[]).find(c=>c.id===chequeId);
      const ch = raw ? normalizeChequeRecord(raw) : null;
      if(ch){
        editingChequeId = chequeId;
        if(title) title.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø´ÙŠÙƒ';
        if(saveBtn) saveBtn.textContent = 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';

        // Tenant selection
        const inList = getTenantNames().some(n => tenantKey(n) === tenantKey(ch.tenant));
        if(inList){
          selectEl.value = getTenantNames().find(n => tenantKey(n) === tenantKey(ch.tenant)) || '';
        } else {
          selectEl.value = 'other';
          document.getElementById('cheque-tenant-manual').value = ch.tenant || '';
        }

        // Populate unit list for selected tenant
        toggleTenantInput();

        // Set unit if available
        const unitSel = document.getElementById('cheque-unit-select');
        if(unitSel){
          unitSel.value = ch.unitId || '';
        }

        // Fill fields
        document.getElementById('cheque-number').value = ch.chequeNo || '';
        document.getElementById('cheque-value').value = (ch.value ?? '') === null ? '' : (ch.value ?? '');
        document.getElementById('cheque-due-date').value = ch.dueDate || '';
        document.getElementById('cheque-bank').value = ch.bank || '';
        document.getElementById('cheque-purpose').value = ch.purpose || '';
      } else {
        toggleTenantInput();
      }
    } else {
      toggleTenantInput();
    }
  }
function closeChequeModal(){
    const modal = document.getElementById('cheque-modal');
    if(modal) modal.classList.add('hidden');
    editingChequeId = null;
    pendingChequeAfterEditId = null;
    pendingChequeAfterEditStatus = '';
    const title = document.getElementById('cheque-modal-title');
    const saveBtn = document.getElementById('cheque-modal-save-btn');
    if(title) title.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø´ÙŠÙƒ Ø¬Ø¯ÙŠØ¯';
    if(saveBtn) saveBtn.textContent = 'Ø­ÙØ¸ Ø§Ù„Ø´ÙŠÙƒ';
  }

  document.getElementById('new-cheque-form').addEventListener('submit', async e=>{
    e.preventDefault();

    const tenantSelect = document.getElementById('cheque-tenant-select').value;
    const tenantManual = document.getElementById('cheque-tenant-manual').value;
    const tenantName = tenantSelect === 'other' ? tenantManual : tenantSelect;

    const unitId = (document.getElementById('cheque-unit-select') ? document.getElementById('cheque-unit-select').value : '') || '';

    if (!tenantName) {
      alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø£Ùˆ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±.");
      return;
    }
const newImageFile = document.getElementById('cheque-image').files[0];
    const newImageUrl = await fileToBase64(newImageFile);

    const payload = {
      tenant: tenantName,
      unitId: unitId,
      chequeNo: document.getElementById('cheque-number').value,
      value: parseFloat(document.getElementById('cheque-value').value),
      dueDate: document.getElementById('cheque-due-date').value,
      bank: document.getElementById('cheque-bank').value,
      purpose: document.getElementById('cheque-purpose').value,
    };

    if(editingChequeId){
      const i = cheques.findIndex(c=>c.id===editingChequeId);
      if(i !== -1){
        const old = normalizeChequeRecord(cheques[i]);
        cheques[i] = {
          ...cheques[i],
          ...payload,
          status: old.status || cheques[i].status || 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØµØ±Ù',
          imageUrl: newImageUrl || old.imageUrl || cheques[i].imageUrl || ''
        };
      }
    } else {
      cheques.push({
        id: 'CHQ-'+Date.now(),
        ...payload,
        status: 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØµØ±Ù',
        imageUrl: newImageUrl
      });
    }

    saveToLocal();
    
    // If this edit was triggered to complete a status change (Ù…Ø«Ù„: ØµØ±Ù Ø§Ù„Ø´ÙŠÙƒ)ØŒ Ù†ÙÙ‘Ø°Ù‡Ø§ Ø§Ù„Ø¢Ù† Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø©
    if(editingChequeId && pendingChequeAfterEditId === editingChequeId && pendingChequeAfterEditStatus){
      const updated = (cheques||[]).find(c=>c.id===editingChequeId);
      const info = updated ? resolveChequeUnitInfo(updated) : null;
      if(info && info.unitId){
        const st = pendingChequeAfterEditStatus;
        pendingChequeAfterEditId = null;
        pendingChequeAfterEditStatus = '';
        // Apply status change with the now-known unit
        setTimeout(()=>changeChequeStatus(editingChequeId, st, info.unitId), 0);
      }
    }
closeChequeModal();
    renderCheques();
    logAction(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø´ÙŠÙƒ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ø³ØªØ£Ø¬Ø±: ${tenantName}`);
  });

  
  // ======= Cheque â†” Unit linking (for accurate notices/reports) =======
  let pendingChequeLinkId = null;
  let pendingChequeLinkNextStatus = '';

  function openChequeLinkModal(chequeId, nextStatus=''){
    pendingChequeLinkId = chequeId;
    pendingChequeLinkNextStatus = nextStatus || '';
    const modal = document.getElementById('cheque-link-modal');
    const infoEl = document.getElementById('cheque-link-info');
    const sel = document.getElementById('cheque-link-unit-select');

    const raw = (cheques||[]).find(c=>c.id===chequeId);
    const ch = raw ? normalizeChequeRecord(raw) : null;
    if(!modal || !infoEl || !sel || !ch) return;

    const units = getTenantLeasedUnitsDetailed(ch.tenant);
    sel.innerHTML = '';
    if(units.length === 0){
      sel.innerHTML = '<option value="">â€” Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù…Ø¤Ø¬Ø±Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± â€”</option>';
      sel.disabled = true;
    } else {
      sel.disabled = false;
      const opts = ['<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø© â€”</option>']
        .concat(units.map(u=>`<option value="${u.unitId}">${u.label}</option>`));
      sel.innerHTML = opts.join('');
      // preselect
      if(ch.unitId){
        sel.value = ch.unitId;
      } else if(units.length === 1){
        sel.value = units[0].unitId;
      }
    }

    infoEl.textContent = `Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±: ${ch.tenant} â€” Ø§Ù„Ø´ÙŠÙƒ: #${ch.chequeNo||'â€”'} â€” Ø§Ù„Ù‚ÙŠÙ…Ø©: ${formatAED(ch.value||0)}`;
    modal.classList.remove('hidden');
  }

  function closeChequeLinkModal(){
    const modal = document.getElementById('cheque-link-modal');
    if(modal) modal.classList.add('hidden');
    pendingChequeLinkId = null;
    pendingChequeLinkNextStatus = '';
  }

  function confirmChequeLink(){
    const chequeId = pendingChequeLinkId;
    const nextStatus = pendingChequeLinkNextStatus;
    const sel = document.getElementById('cheque-link-unit-select');
    const unitId = sel ? (sel.value || '') : '';
    if(!chequeId) { closeChequeLinkModal(); return; }

    if(nextStatus === 'Ù…ØµØ±ÙˆÙ' && !unitId){
      alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØ­Ø¯Ø© Ù‚Ø¨Ù„ ØµØ±Ù Ø§Ù„Ø´ÙŠÙƒ Ø­ØªÙ‰ ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„Ù‡ Ø¶Ù…Ù† Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„ÙˆØ­Ø¯Ø©.');
      return;
    }

    const idx = cheques.findIndex(c=>c.id===chequeId);
    if(idx >= 0){
      const hit = findUnitById(unitId);
      const label = hit ? `${hit.unit.name} - ${hit.property.name}` : '';
      cheques[idx] = { ...cheques[idx], unitId: unitId, unitLabel: label };
      migrateChequePaymentsToUnit(chequeId);
      saveToLocal();
      renderCheques();
      renderPayments();
      updateDashboard();
      renderReceiptsHistory();
    }

    closeChequeLinkModal();

    if(nextStatus){
      changeChequeStatus(chequeId, nextStatus, unitId);
    }
  }


function changeChequeStatus(id, newStatus, unitIdOverride='') {
    const chequeIndex = cheques.findIndex(c => c.id === id);
    if (chequeIndex === -1) return;

    const cheque = cheques[chequeIndex];

    if(unitIdOverride){
      cheque.unitId = unitIdOverride;
    }

    // If cashing the cheque, we must know which unit it belongs to (to record payment correctly)
    if (newStatus === 'Ù…ØµØ±ÙˆÙ') {
      const info = resolveChequeUnitInfo(cheque);
      if(!info.unitId){
        // Ask user to link the cheque first
        pendingChequeAfterEditId = id; pendingChequeAfterEditStatus = 'Ù…ØµØ±ÙˆÙ'; alert('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ­Ø¯Ø© Ù„Ù„Ø´ÙŠÙƒ Ø«Ù… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„ÙŠØªÙ… ØµØ±ÙÙ‡ ÙˆØªØ³Ø¬ÙŠÙ„Ù‡ ÙƒØ¯ÙØ¹Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.'); openChequeModal(id);
        return;
      }

      cheque.unitId = info.unitId;
      cheque.unitLabel = info.unitLabel || cheque.unitLabel || '';

      const paymentExists = payments.some(p => p.chequeId === id);

      if (!paymentExists) {
        payments.push({
          id: 'PAY-CHQ-'+Date.now(),
          chequeId: id,
          date: new Date().toISOString().substring(0, 10),
          tenant: cheque.tenant,
          unit: info.unitLabel || 'Ø´ÙŠÙƒ Ù…ØµØ±Ù',
          unitId: info.unitId,
          contract: info.contractNo || cheque.chequeNo,
          due: cheque.value,
          type: 'Ø´ÙŠÙƒ Ù…ØµØ±Ù',
          amount: cheque.value,
          desc: cheque.purpose || `ØªØ­ØµÙŠÙ„ Ø§Ù„Ø´ÙŠÙƒ Ø±Ù‚Ù… ${cheque.chequeNo} (${info.unitLabel||''}) Ù…Ù† ${cheque.tenant}`,
          voucherNo: nextVoucherNumber('receipt')
        });
        logAction(`ØªÙ… ØµØ±Ù Ø§Ù„Ø´ÙŠÙƒ Ø±Ù‚Ù… ${cheque.chequeNo} ÙˆØªÙ… ØªØ³Ø¬ÙŠÙ„Ù‡ ÙƒØ¯ÙØ¹Ø© Ù…Ù‚Ø¨ÙˆØ¶Ø© Ù„Ù„ÙˆØ­Ø¯Ø©: ${info.unitLabel||info.unitId}.`);
      } else {
        // Ensure existing payment record is linked to the unit (older versions)
        migrateChequePaymentsToUnit(id);
      }

      cheque.status = newStatus;
    } else {
      // If status was changed away from "Ù…ØµØ±ÙˆÙ", remove the linked payment (to avoid double counting)
      cheque.status = newStatus;
      payments = payments.filter(p => p.chequeId !== id);
    }

    saveToLocal();
    renderCheques();
    updateDashboard();
    renderPayments();
    renderReceiptsHistory();
  }


  function viewChequeImage(imageUrl) {
    if (!imageUrl) return;
    const w = window.open('', '_blank');
    w.document.write(`
      <!DOCTYPE html>
      <html lang="ar" dir="rtl">
      <head><title>ØµÙˆØ±Ø© Ø§Ù„Ø´ÙŠÙƒ</title>
      <style>
        body{margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh;background:#111;}
        img{max-width:90vw;max-height:90vh;border:10px solid white;box-shadow:0 0 20px rgba(0,0,0,0.5);}
      </style>
      </head>
      <body><img src="${imageUrl}" alt="ØµÙˆØ±Ø© Ø§Ù„Ø´ÙŠÙƒ"></body>
      </html>
    `);
    w.document.close();
  }

  function renderCheques(){
    _chequesRestoreUIOnce();
    const tbody = document.getElementById('cheques-table-body');
    if(!tbody) return;
    tbody.innerHTML='';
    const st = _chequesState();
    const filtered = _chequesApply(cheques.slice(), st);
    const finalList = _sortCheques(filtered, st.sortBy, st.sortDir);

    const hint = document.getElementById('cheques-filter-hint');
    if(hint){
      const total = cheques.length;
      const shown = finalList.length;
      hint.textContent = (shown===total) ? `Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ${shown}` : `Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ${shown} Ù…Ù† ${total}`;
    }

    finalList.forEach(c=>{
      let statusClass = 'badge-amber';
      if (c.status === 'Ù…ØµØ±ÙˆÙ') statusClass = 'badge-green';
      else if (c.status === 'Ø±Ø§Ø¬Ø¹') statusClass = 'badge-red';

      const statusOptions = ['Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØµØ±Ù', 'Ù…ØµØ±ÙˆÙ', 'Ø±Ø§Ø¬Ø¹'];
      const selectOptions = statusOptions.map(s =>
        `<option value="${s}" ${c.status === s ? 'selected' : ''}>${s}</option>`
      ).join('');

      const tr = document.createElement('tr');
      tr.innerHTML=`
        <td><span class="badge ${statusClass}">${c.status}</span></td>
        <td class="font-mono">${c.dueDate}</td>
        <td>${c.tenant}</td>
        <td class="text-xs text-gray-600 dark:text-gray-300">${escHtml(getUnitDisplayById(c.unitId) || '-') }</td>
        <td class="font-bold">${formatAED(c.value)}</td>
        <td class="text-xs text-gray-500 dark:text-gray-400">${c.bank} - #${c.chequeNo}</td>
        <td>
          ${c.imageUrl ? `<button onclick="viewChequeImage('${c.imageUrl}')" class="text-purple-600 dark:text-purple-400 hover:underline text-xs">Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø©</button>` : '-'}
        </td>
        <td>
          <select onchange="changeChequeStatus('${c.id}', this.value)" class="text-sm border p-1 rounded bg-white dark:bg-gray-800 dark:text-white">
            ${selectOptions}
          </select>
          <button type="button" onclick="openChequeModal('${c.id}')" class="text-xs px-2 py-1 rounded border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-800 ml-2" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´ÙŠÙƒ">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
          <button onclick="deleteCheque('${c.id}')" class="text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 p-1 rounded transition ml-2" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function deleteCheque(id){
    if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø´ÙŠÙƒØŸ Ø³ÙŠØªÙ… Ø­Ø°ÙÙ‡ Ù…Ù† Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØµØ±ÙˆÙØ§Ù‹.')) return;
    cheques = cheques.filter(c => c.id !== id);
    payments = payments.filter(p => p.chequeId !== id);
    saveToLocal();
    renderCheques();
    renderPayments();
    updateDashboard();
    renderReceiptsHistory();
    logAction(`ØªÙ… Ø­Ø°Ù Ø§Ù„Ø´ÙŠÙƒ ${id}`);
  }

  // ================= EXPENSES =================
  let _expensesAdvInited = false;

  function _expenseNorm(v){
    return (v===null || v===undefined) ? '' : String(v).trim().toLowerCase();
  }
  function _expenseDateNum(s){
    const v = (s||'').toString().slice(0,10);
    const t = Date.parse(v);
    return Number.isFinite(t) ? t : NaN;
  }
  function _expenseHay(e){
    return [
      e.id, e.date, e.type, e.amount, e.details
    ].filter(Boolean).join(' | ');
  }

  function _expensesUi(){
    const dirBtn = document.getElementById('expenses-sort-dir');
    return {
      q: document.getElementById('expenses-search-input')?.value || '',
      sortBy: document.getElementById('expenses-sort-by')?.value || '',
      sortDir: dirBtn?.dataset?.dir || '',
      type: document.getElementById('expenses-filter-type')?.value || '',
      amountMin: document.getElementById('expenses-filter-amount-min')?.value || '',
      amountMax: document.getElementById('expenses-filter-amount-max')?.value || '',
      dateFrom: document.getElementById('expenses-filter-date-from')?.value || '',
      dateTo: document.getElementById('expenses-filter-date-to')?.value || '',
    };
  }

  function _expensesPersistFromUI(){
    const ui = _expensesUi();
    _lsSet('re_expenses_q', ui.q);
    _lsSet('re_expenses_sort_by', ui.sortBy || _lsGet('re_expenses_sort_by','date'));
    _lsSet('re_expenses_sort_dir', ui.sortDir || _lsGet('re_expenses_sort_dir','desc'));

    _lsSet('re_expenses_f_type', ui.type);
    _lsSet('re_expenses_f_amin', ui.amountMin);
    _lsSet('re_expenses_f_amax', ui.amountMax);
    _lsSet('re_expenses_f_dfrom', ui.dateFrom);
    _lsSet('re_expenses_f_dto', ui.dateTo);
  }

  function _expensesRestoreUIOnce(){
    if(_expensesAdvInited) return;
    _expensesAdvInited = true;

    const qEl = document.getElementById('expenses-search-input');
    if(qEl) qEl.value = _lsGet('re_expenses_q','');

    const sortByEl = document.getElementById('expenses-sort-by');
    if(sortByEl) sortByEl.value = _lsGet('re_expenses_sort_by','date');

    const dirBtn = document.getElementById('expenses-sort-dir');
    if(dirBtn){
      const d = _lsGet('re_expenses_sort_dir','desc');
      dirBtn.dataset.dir = (d==='asc') ? 'asc' : 'desc';
      dirBtn.textContent = (dirBtn.dataset.dir==='asc') ? 'â¬†ï¸' : 'â¬‡ï¸';
    }

    const typeEl = document.getElementById('expenses-filter-type');
    if(typeEl) typeEl.value = _lsGet('re_expenses_f_type','');

    const aminEl = document.getElementById('expenses-filter-amount-min');
    if(aminEl) aminEl.value = _lsGet('re_expenses_f_amin','');

    const amaxEl = document.getElementById('expenses-filter-amount-max');
    if(amaxEl) amaxEl.value = _lsGet('re_expenses_f_amax','');

    const dfEl = document.getElementById('expenses-filter-date-from');
    if(dfEl) dfEl.value = _lsGet('re_expenses_f_dfrom','');

    const dtEl = document.getElementById('expenses-filter-date-to');
    if(dtEl) dtEl.value = _lsGet('re_expenses_f_dto','');

    const open = _lsGet('re_expenses_filters_open','0') === '1';
    const panel = document.getElementById('expenses-filters-panel');
    const tBtn = document.getElementById('expenses-toggle-filters');
    if(panel && tBtn){
      panel.classList.toggle('hidden', !open);
      tBtn.textContent = open ? 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©' : 'Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©';
    }
  }

  function _expensesState(){
    const ui = _expensesUi();
    return {
      q: _expenseNorm(ui.q || _lsGet('re_expenses_q','')),
      sortBy: ui.sortBy || _lsGet('re_expenses_sort_by','date'),
      sortDir: ui.sortDir || _lsGet('re_expenses_sort_dir','desc'),
      f: {
        type: ui.type || _lsGet('re_expenses_f_type',''),
        amountMin: ui.amountMin || _lsGet('re_expenses_f_amin',''),
        amountMax: ui.amountMax || _lsGet('re_expenses_f_amax',''),
        dateFrom: ui.dateFrom || _lsGet('re_expenses_f_dfrom',''),
        dateTo: ui.dateTo || _lsGet('re_expenses_f_dto',''),
      }
    };
  }

  function _expensesApply(list, st){
    const q = st.q;
    const f = st.f || {};
    const type = (f.type||'').trim();

    const amin = (f.amountMin!=='' && f.amountMin!==null && f.amountMin!==undefined) ? Number(f.amountMin) : NaN;
    const amax = (f.amountMax!=='' && f.amountMax!==null && f.amountMax!==undefined) ? Number(f.amountMax) : NaN;

    const dfrom = f.dateFrom ? _expenseDateNum(f.dateFrom) : NaN;
    const dto   = f.dateTo ? _expenseDateNum(f.dateTo) : NaN;

    return (list||[]).filter(e=>{
      if(q){
        const hay = _expenseNorm(_expenseHay(e));
        if(!hay.includes(q)) return false;
      }
      if(type && (e.type||'') !== type) return false;

      const amt = Number(e.amount);
      if(!Number.isNaN(amin) && (!Number.isFinite(amt) || amt < amin)) return false;
      if(!Number.isNaN(amax) && (!Number.isFinite(amt) || amt > amax)) return false;

      const d = _expenseDateNum(e.date);
      if(!Number.isNaN(dfrom) && (Number.isNaN(d) || d < dfrom)) return false;
      if(!Number.isNaN(dto) && (Number.isNaN(d) || d > dto)) return false;

      return true;
    });
  }

  function _sortExpenses(list, sortBy, sortDir){
    const dir = (sortDir==='asc') ? 1 : -1;
    const by = sortBy || 'date';
    return [...(list||[])].sort((a,b)=>{
      let va, vb;
      if(by==='amount'){
        va = Number(a.amount); vb = Number(b.amount);
        if(!Number.isFinite(va)) va = -Infinity;
        if(!Number.isFinite(vb)) vb = -Infinity;
      }else if(by==='type'){
        va = _expenseNorm(a.type); vb = _expenseNorm(b.type);
      }else{
        // date
        va = _expenseDateNum(a.date); vb = _expenseDateNum(b.date);
        if(!Number.isFinite(va)) va = -Infinity;
        if(!Number.isFinite(vb)) vb = -Infinity;
      }
      if(va < vb) return -1*dir;
      if(va > vb) return  1*dir;
      return 0;
    });
  }

  function onExpensesAdvancedChanged(){
    _expensesPersistFromUI();
    renderExpenses();
  }

  function toggleExpensesSortDir(){
    const btn = document.getElementById('expenses-sort-dir');
    if(!btn) return;
    const cur = (btn.dataset.dir==='asc') ? 'asc' : 'desc';
    const next = (cur==='asc') ? 'desc' : 'asc';
    btn.dataset.dir = next;
    btn.textContent = (next==='asc') ? 'â¬†ï¸' : 'â¬‡ï¸';
    _lsSet('re_expenses_sort_dir', next);
    renderExpenses();
  }

  function toggleExpensesFilters(){
    const panel = document.getElementById('expenses-filters-panel');
    const btn = document.getElementById('expenses-toggle-filters');
    if(!panel || !btn) return;
    const willShow = panel.classList.contains('hidden');
    panel.classList.toggle('hidden');
    btn.textContent = willShow ? 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©' : 'Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©';
    _lsSet('re_expenses_filters_open', willShow ? '1' : '0');
  }

  function resetExpensesAdvanced(){
    const keys = [
      're_expenses_q','re_expenses_sort_by','re_expenses_sort_dir','re_expenses_filters_open',
      're_expenses_f_type','re_expenses_f_amin','re_expenses_f_amax','re_expenses_f_dfrom','re_expenses_f_dto'
    ];
    keys.forEach(k=>{ try{ localStorage.removeItem(k);}catch(e){} });

    const qEl = document.getElementById('expenses-search-input'); if(qEl) qEl.value='';
    const sbEl = document.getElementById('expenses-sort-by'); if(sbEl) sbEl.value='date';
    const dirBtn = document.getElementById('expenses-sort-dir'); if(dirBtn){ dirBtn.dataset.dir='desc'; dirBtn.textContent='â¬‡ï¸'; }
    const tEl = document.getElementById('expenses-filter-type'); if(tEl) tEl.value='';
    const aminEl = document.getElementById('expenses-filter-amount-min'); if(aminEl) aminEl.value='';
    const amaxEl = document.getElementById('expenses-filter-amount-max'); if(amaxEl) amaxEl.value='';
    const dfEl = document.getElementById('expenses-filter-date-from'); if(dfEl) dfEl.value='';
    const dtEl = document.getElementById('expenses-filter-date-to'); if(dtEl) dtEl.value='';

    const panel = document.getElementById('expenses-filters-panel'); 
    const btn = document.getElementById('expenses-toggle-filters');
    if(panel && btn){
      panel.classList.add('hidden');
      btn.textContent = 'Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©';
    }
    renderExpenses();
  }

  function renderExpenses(){
    _expensesRestoreUIOnce();

    const tbody = document.getElementById('expenses-table-body');
    if(!tbody) return;
    tbody.innerHTML='';

    const st = _expensesState();
    const filtered = _expensesApply(expenses, st);
    const finalList = _sortExpenses(filtered, st.sortBy, st.sortDir);

    const hint = document.getElementById('expenses-filter-hint');
    if(hint){
      const total = (expenses||[]).length;
      const shown = finalList.length;
      hint.textContent = (shown===total) ? `Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ${shown}` : `Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ${shown} Ù…Ù† ${total}`;
    }

    finalList.forEach((e)=>{
      const tr = document.createElement('tr');
      tr.className = "hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors";
      tr.innerHTML=`
        <td class="text-sm font-mono" dir="ltr">${e.date}</td>
        <td class="text-sm font-bold text-indigo-700 dark:text-indigo-400">${e.type}</td>
        <td class="font-bold text-rose-600 dark:text-rose-400" dir="ltr">${formatAED(e.amount)}</td>
        <td class="text-sm text-gray-600 dark:text-gray-300">${e.details}</td>
        <td class="text-center">
          <div class="flex items-center justify-center gap-2">
            <button onclick="previewReceipt('${e.id}', 'expense')" class="text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/30 px-2 py-1 rounded text-xs font-bold hover:bg-blue-100">ğŸ–¨ï¸ Ø³Ù†Ø¯ ØµØ±Ù</button>
            <button onclick="deleteExpenseById('${e.id}')" class="text-red-600 dark:text-red-400 hover:bg-red-100 dark:hover:bg-red-900/30 p-1 rounded transition" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function deleteExpenseById(id){
    if(!confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙØŸ')) return;
    expenses = (expenses||[]).filter(e => e.id !== id);
    saveToLocal();
    renderExpenses();
    renderReceiptsHistory();
  }

  function deleteExpense(index){
    // ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©: Ø¥Ø°Ø§ ØªÙ… ØªÙ…Ø±ÙŠØ± index
    const item = (expenses||[])[index];
    if(!item || !item.id){
      if(!confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙØŸ')) return;
      expenses.splice(index, 1);
      saveToLocal();
      renderExpenses();
      renderReceiptsHistory();
      return;
    }
    deleteExpenseById(item.id);
  }

  document.getElementById('new-expense-form').addEventListener('submit', e=>{
    e.preventDefault();
    expenses.push({
      id: 'EXP-'+Date.now(),
      date: document.getElementById('expense-date').value,
      type: document.getElementById('expense-type').value,
      amount: parseFloat(document.getElementById('expense-amount').value),
      details: document.getElementById('expense-details').value,
      voucherNo: nextVoucherNumber('expense')
    });
    saveToLocal();
    renderExpenses();
    renderReceiptsHistory();
    e.target.reset();
    logAction(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ù†ÙˆØ¹: ${document.getElementById('expense-type').value}`);
  });

  // ================= SALARIES =================
  function initSalaryYears(){
    const yearSel = document.getElementById('sal-year');
    if(!yearSel) return;
    const currentYear = new Date().getFullYear();
    yearSel.innerHTML = `
      <option value="${currentYear-1}">${currentYear-1}</option>
      <option value="${currentYear}" selected>${currentYear}</option>
      <option value="${currentYear+1}">${currentYear+1}</option>
    `;
  }

  function renderSalaries(){
    initSalaryYears();
    const tbody = document.getElementById('salaries-table-body');
    if(!tbody) return;
    tbody.innerHTML = '';

    let total = 0;
    salaries.sort((a,b)=> new Date(b.date) - new Date(a.date)).forEach((s,index)=>{
      total += (s.amount || 0);
      const tr = document.createElement('tr');
      tr.className = "hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors";
      tr.innerHTML = `
        <td class="px-4 py-3 text-sm font-mono text-gray-600 dark:text-gray-300">${s.date}</td>
        <td class="px-4 py-3 font-bold text-gray-800 dark:text-white">${s.name}</td>
        <td class="px-4 py-3 font-mono font-bold text-emerald-600 dark:text-emerald-400">${formatAED(s.amount)}</td>
        <td class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400">${s.notes || '-'}</td>
        <td class="px-4 py-3 text-center">
          <button onclick="previewReceipt('${s.id}', 'salary')" class="text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/30 px-2 py-1 rounded text-xs font-bold hover:bg-blue-100">ğŸ–¨ï¸ Ø³Ù†Ø¯ ØµØ±Ù Ø±Ø§ØªØ¨</button>
        </td>
        <td class="px-4 py-3 text-center">
          <button onclick="deleteSalary(${index})" class="text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/30 p-1 rounded transition">ğŸ—‘ï¸</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
    document.getElementById('total-salaries').textContent = formatAED(total);
    document.getElementById('count-salaries').textContent = salaries.length;
  }

  document.getElementById('salary-form')?.addEventListener('submit', function(e){
    e.preventDefault();

    const month = document.getElementById('sal-month').value;
    const year = document.getElementById('sal-year').value;
    const notes = `Ø±Ø§ØªØ¨ Ø´Ù‡Ø± ${month} Ù„Ø³Ù†Ø© ${year}`;

    const newSalary = {
      id: 'SAL-'+Date.now(),
      name: document.getElementById('sal-name').value,
      role: document.getElementById('sal-role').value,
      amount: parseFloat(document.getElementById('sal-amount').value),
      date: document.getElementById('sal-date').value,
      notes: notes,
      voucherNo: nextVoucherNumber('salary')
    };
    salaries.push(newSalary);
    saveToLocal();
    renderSalaries();
    renderReceiptsHistory();
    this.reset();
    logAction(`ØªÙ… ØµØ±Ù Ø±Ø§ØªØ¨ Ù„Ù„Ù…ÙˆØ¸Ù: ${newSalary.name}`);

    initSalaryYears();
    document.getElementById('sal-month').selectedIndex = 0;
  });

  function deleteSalary(index){
    if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‚ÙŠØ¯ Ø§Ù„Ø±Ø§ØªØ¨ Ù‡Ø°Ø§ØŸ')) return;
    salaries.splice(index, 1);
    saveToLocal();
    renderSalaries();
    renderReceiptsHistory();
  }

  // ================= RECEIPTS HISTORY & PREVIEW =================
  
  // ================= RECEIPTS HISTORY (VOUCHERS) ADVANCED SEARCH =================
  let _receiptsAdvInited = false;

  function _receiptNorm(v){
    return (v===null || v===undefined) ? '' : String(v).trim().toLowerCase();
  }
  function _receiptDateNum(s){
    const v = (s||'').toString().slice(0,10);
    const t = Date.parse(v);
    return Number.isFinite(t) ? t : NaN;
  }
  function _receiptHay(v){
    return [
      v.id, v.type, v.sourceType, v.date, v.amount,
      v.party, v.desc
    ].map(x=> (x===null||x===undefined) ? '' : String(x)).join(' ').trim().toLowerCase();
  }

  function _receiptsUi(){
    return {
      bar: document.getElementById('receipts-advanced-bar'),
      qEl: document.getElementById('receipts-search-input'),
      sortByEl: document.getElementById('receipts-sort-by'),
      sortDirBtn: document.getElementById('receipts-sort-dir'),
      hintEl: document.getElementById('receipts-advanced-hint'),
      toggleBtn: document.getElementById('receipts-toggle-filters'),
      panel: document.getElementById('receipts-filters-panel'),
      fType: document.getElementById('receipts-filter-type'),
      fSource: document.getElementById('receipts-filter-source'),
      fParty: document.getElementById('receipts-filter-party'),
      fDesc: document.getElementById('receipts-filter-desc'),
      fAMin: document.getElementById('receipts-filter-amin'),
      fAMax: document.getElementById('receipts-filter-amax'),
      fDFrom: document.getElementById('receipts-filter-dfrom'),
      fDTo: document.getElementById('receipts-filter-dto'),
    };
  }

  function _receiptsPersistFromUI(){
    const ui = _receiptsUi();
    if(!ui.bar) return;

    _lsSet('re_receipts_q', ui.qEl ? ui.qEl.value : '');
    _lsSet('re_receipts_sort_by', ui.sortByEl ? ui.sortByEl.value : 'date');
    _lsSet('re_receipts_sort_dir', ui.sortDirBtn ? (ui.sortDirBtn.dataset.dir||'desc') : 'desc');
    _lsSet('re_receipts_filters_open', (ui.panel && !ui.panel.classList.contains('hidden')) ? '1' : '0');

    _lsSet('re_receipts_f_type', ui.fType ? ui.fType.value : '');
    _lsSet('re_receipts_f_source', ui.fSource ? ui.fSource.value : '');
    _lsSet('re_receipts_f_party', ui.fParty ? ui.fParty.value : '');
    _lsSet('re_receipts_f_desc', ui.fDesc ? ui.fDesc.value : '');
    _lsSet('re_receipts_f_amin', ui.fAMin ? ui.fAMin.value : '');
    _lsSet('re_receipts_f_amax', ui.fAMax ? ui.fAMax.value : '');
    _lsSet('re_receipts_f_dfrom', ui.fDFrom ? ui.fDFrom.value : '');
    _lsSet('re_receipts_f_dto', ui.fDTo ? ui.fDTo.value : '');
  }

  function _receiptsRestoreUIOnce(){
    if(_receiptsAdvInited) return;
    _receiptsAdvInited = true;

    const ui = _receiptsUi();
    if(!ui.bar) return;

    if(ui.qEl) ui.qEl.value = _lsGet('re_receipts_q','');
    if(ui.sortByEl) ui.sortByEl.value = _lsGet('re_receipts_sort_by','date');

    const dir = _lsGet('re_receipts_sort_dir','desc');
    if(ui.sortDirBtn){
      ui.sortDirBtn.dataset.dir = (dir==='asc') ? 'asc' : 'desc';
      ui.sortDirBtn.textContent = (ui.sortDirBtn.dataset.dir==='asc') ? 'â¬†ï¸' : 'â¬‡ï¸';
    }

    if(ui.fType) ui.fType.value = _lsGet('re_receipts_f_type','');
    if(ui.fSource) ui.fSource.value = _lsGet('re_receipts_f_source','');
    if(ui.fParty) ui.fParty.value = _lsGet('re_receipts_f_party','');
    if(ui.fDesc) ui.fDesc.value = _lsGet('re_receipts_f_desc','');
    if(ui.fAMin) ui.fAMin.value = _lsGet('re_receipts_f_amin','');
    if(ui.fAMax) ui.fAMax.value = _lsGet('re_receipts_f_amax','');
    if(ui.fDFrom) ui.fDFrom.value = _lsGet('re_receipts_f_dfrom','');
    if(ui.fDTo) ui.fDTo.value = _lsGet('re_receipts_f_dto','');

    const open = _lsGet('re_receipts_filters_open','0') === '1';
    if(ui.panel) ui.panel.classList.toggle('hidden', !open);
    if(ui.toggleBtn) ui.toggleBtn.textContent = open ? 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©' : 'Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©';
  }

  function _receiptsState(){
    const ui = _receiptsUi();
    return {
      q: _receiptNorm(ui.qEl ? ui.qEl.value : ''),
      sortBy: (ui.sortByEl ? ui.sortByEl.value : 'date') || 'date',
      sortDir: (ui.sortDirBtn ? (ui.sortDirBtn.dataset.dir||'desc') : 'desc') || 'desc',
      filters: {
        type: ui.fType ? ui.fType.value : '',
        source: ui.fSource ? ui.fSource.value : '',
        party: _receiptNorm(ui.fParty ? ui.fParty.value : ''),
        desc: _receiptNorm(ui.fDesc ? ui.fDesc.value : ''),
        amin: ui.fAMin ? ui.fAMin.value : '',
        amax: ui.fAMax ? ui.fAMax.value : '',
        dfrom: ui.fDFrom ? ui.fDFrom.value : '',
        dto: ui.fDTo ? ui.fDTo.value : '',
      }
    };
  }

  function _receiptsApply(list, st){
    const q = st.q;
    const f = st.filters || {};
    const type = f.type || '';
    const source = f.source || '';
    const party = f.party || '';
    const desc = f.desc || '';

    const aminRaw = (f.amin ?? '').toString().trim();
    const amaxRaw = (f.amax ?? '').toString().trim();
    const amin = (aminRaw === '') ? NaN : Number(aminRaw);
    const amax = (amaxRaw === '') ? NaN : Number(amaxRaw);
    const hasAmin = Number.isFinite(amin);
    const hasAmax = Number.isFinite(amax);

    const dfrom = f.dfrom ? _receiptDateNum(f.dfrom) : NaN;
    const dto = f.dto ? _receiptDateNum(f.dto) : NaN;
    const hasDfrom = Number.isFinite(dfrom);
    const hasDto = Number.isFinite(dto);

    let out = (list||[]).filter(v=>{
      if(q && !_receiptHay(v).includes(q)) return false;

      if(type && (v.type||'') !== type) return false;
      if(source && ((v.sourceType||v.source||'') !== source)) return false;

      if(party && !_receiptNorm(v.party).includes(party)) return false;
      if(desc && !_receiptNorm(v.desc).includes(desc)) return false;

      const a = Number(v.amount);
      if(hasAmin && (!Number.isFinite(a) || a < amin)) return false;
      if(hasAmax && (!Number.isFinite(a) || a > amax)) return false;

      const d = _receiptDateNum(v.date);
      if(hasDfrom && (!Number.isFinite(d) || d < dfrom)) return false;
      if(hasDto && (!Number.isFinite(d) || d > dto)) return false;

      return true;
    });

    const dir = (st.sortDir === 'asc') ? 1 : -1;
    out.sort((a,b)=>{
      let va, vb;
      switch(st.sortBy){
        case 'amount':
          va = Number(a.amount); vb = Number(b.amount);
          va = Number.isFinite(va) ? va : -Infinity;
          vb = Number.isFinite(vb) ? vb : -Infinity;
          break;
        case 'type':
          va = _receiptNorm(a.type); vb = _receiptNorm(b.type);
          break;
        case 'party':
          va = _receiptNorm(a.party); vb = _receiptNorm(b.party);
          break;
        case 'source':
          va = _receiptNorm(a.sourceType || a.source); vb = _receiptNorm(b.sourceType || b.source);
          break;
        case 'date':
        default:
          va = _receiptDateNum(a.date); vb = _receiptDateNum(b.date);
          va = Number.isFinite(va) ? va : -Infinity;
          vb = Number.isFinite(vb) ? vb : -Infinity;
          break;
      }
      if(va < vb) return -1 * dir;
      if(va > vb) return  1 * dir;
      return 0;
    });

    return out;
  }

  function onReceiptsAdvancedChanged(){
    _receiptsPersistFromUI();
    renderReceiptsHistory();
  }

  function toggleReceiptsSortDir(){
    const btn = document.getElementById('receipts-sort-dir');
    if(!btn) return;
    const current = (btn.dataset.dir === 'asc') ? 'asc' : 'desc';
    const next = (current === 'asc') ? 'desc' : 'asc';
    btn.dataset.dir = next;
    btn.textContent = (next === 'asc') ? 'â¬†ï¸' : 'â¬‡ï¸';
    _lsSet('re_receipts_sort_dir', next);
    onReceiptsAdvancedChanged();
  }

  function toggleReceiptsFiltersPanel(){
    const panel = document.getElementById('receipts-filters-panel');
    const btn = document.getElementById('receipts-toggle-filters');
    if(!panel || !btn) return;
    const willShow = panel.classList.contains('hidden');
    panel.classList.toggle('hidden', !willShow);
    btn.textContent = willShow ? 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©' : 'Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©';
    _lsSet('re_receipts_filters_open', willShow ? '1' : '0');
  }

  function resetReceiptsAdvanced(){
    const keys = [
      're_receipts_q','re_receipts_sort_by','re_receipts_sort_dir','re_receipts_filters_open',
      're_receipts_f_type','re_receipts_f_source','re_receipts_f_party','re_receipts_f_desc',
      're_receipts_f_amin','re_receipts_f_amax','re_receipts_f_dfrom','re_receipts_f_dto'
    ];
    keys.forEach(k=>{ try{ localStorage.removeItem(k); }catch(e){} });

    // Reset UI
    const qEl = document.getElementById('receipts-search-input'); if(qEl) qEl.value='';
    const sortByEl = document.getElementById('receipts-sort-by'); if(sortByEl) sortByEl.value='date';
    const dirBtn = document.getElementById('receipts-sort-dir'); if(dirBtn){ dirBtn.dataset.dir='desc'; dirBtn.textContent='â¬‡ï¸'; }

    const fType = document.getElementById('receipts-filter-type'); if(fType) fType.value='';
    const fSource = document.getElementById('receipts-filter-source'); if(fSource) fSource.value='';
    const fParty = document.getElementById('receipts-filter-party'); if(fParty) fParty.value='';
    const fDesc = document.getElementById('receipts-filter-desc'); if(fDesc) fDesc.value='';
    const fAMin = document.getElementById('receipts-filter-amin'); if(fAMin) fAMin.value='';
    const fAMax = document.getElementById('receipts-filter-amax'); if(fAMax) fAMax.value='';
    const fDFrom = document.getElementById('receipts-filter-dfrom'); if(fDFrom) fDFrom.value='';
    const fDTo = document.getElementById('receipts-filter-dto'); if(fDTo) fDTo.value='';

    const panel = document.getElementById('receipts-filters-panel');
    const btn = document.getElementById('receipts-toggle-filters');
    if(panel) panel.classList.add('hidden');
    if(btn) btn.textContent = 'Ø¹Ø±Ø¶ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©';

    renderReceiptsHistory();
  }
  // ================= /RECEIPTS HISTORY ADVANCED SEARCH =================


  function renderReceiptsHistory(){
    _receiptsRestoreUIOnce();
    const tbody = document.getElementById('receipts-history-table-body');
    tbody.innerHTML = '';

    let allVouchers = [];
    let totalReceipts = 0;
    let totalSalariesAmt = 0;
    let totalExpensesAmt = 0;

    payments.forEach(p => {
      totalReceipts += p.amount;
      allVouchers.push({
        id: p.id,
        type: 'Ù‚Ø¨Ø¶',
        date: p.date,
        amount: p.amount,
        party: p.tenant,
        desc: p.desc || `Ø¯ÙØ¹Ø© Ø¥ÙŠØ¬Ø§Ø± ÙˆØ­Ø¯Ø© ${p.unit}`,
        sourceType: 'payment'
      });
    });

    salaries.forEach(s => {
      totalSalariesAmt += s.amount;
      allVouchers.push({
        id: s.id,
        type: 'ØµØ±Ù Ø±Ø§ØªØ¨',
        date: s.date,
        amount: s.amount,
        party: s.name,
        desc: s.notes,
        sourceType: 'salary'
      });
    });

    expenses.forEach(e => {
      totalExpensesAmt += e.amount;
      allVouchers.push({
        id: e.id,
        type: 'ØµØ±Ù',
        date: e.date,
        amount: e.amount,
        party: e.type,
        desc: `${e.type}: ${e.details}`,
        sourceType: 'expense'
      });
    });

    const st = _receiptsState();
    const filtered = _receiptsApply(allVouchers.slice(), st);

    const hint = document.getElementById('receipts-advanced-hint');
    if(hint) hint.textContent = `Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ${filtered.length} Ù…Ù† ${allVouchers.length}`;


    filtered.forEach(v => {
      const isReceipt = v.sourceType === 'payment';
      const typeClass = isReceipt ? 'badge-green' : 'badge-red';
      const amountClass = isReceipt ? 'text-emerald-700 dark:text-emerald-400' : 'text-rose-700 dark:text-rose-400';
      const tr = document.createElement('tr');
      tr.className = "hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors";
      tr.innerHTML = `
        <td class="px-4 py-3 text-sm font-mono whitespace-nowrap cell-nowrap cell-ltr text-right align-top" dir="ltr">${v.date}</td>
        <td class="px-4 py-3 whitespace-nowrap text-right align-top"><span class="badge ${typeClass}">${v.type}</span></td>
        <td class="px-4 py-3 font-bold font-mono whitespace-nowrap text-right align-top ${amountClass}" dir="ltr"><span class="inline-block" dir="ltr">${formatAED(v.amount)}</span></td>
        <td class="px-4 py-3 text-sm font-bold text-gray-700 dark:text-gray-300 text-right align-top break-words"><div class="cell-2lines font-bold text-gray-700 dark:text-gray-300" dir="auto">${v.party}</div></td>
        <td class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400 text-right align-top break-words"><div class="cell-2lines" title="${v.desc}">${v.desc}</div></td>
        <td class="px-4 py-3 text-center whitespace-nowrap align-top">
          <button onclick="previewReceipt('${v.id}', '${v.sourceType}')" class="text-purple-600 dark:text-purple-400 hover:underline text-sm">Ø¹Ø±Ø¶</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById('total-receipt-vouchers').textContent = formatAED(totalReceipts);
    document.getElementById('total-payment-vouchers').textContent = formatAED(totalSalariesAmt + totalExpensesAmt);
    document.getElementById('total-vouchers-count').textContent = allVouchers.length;
  }

  function findPropertyForPayment(payment){
    if(!payment) return null;
    for(const p of properties){
      for(const u of p.units){
        if(payment.unit && u.name === payment.unit) return p;
        if(payment.contract && u.contractNo === payment.contract) return p;
      }
    }
    return null;
  }

  function setReceiptHeaderByProperty(prop){
    const nameEl = document.getElementById('rv-building-name');
    const locEl  = document.getElementById('rv-building-location');
    const phoneEl= document.getElementById('rv-building-phone');
    if(prop){
      nameEl.textContent = prop.name || defaultHeader.name;
      locEl.textContent  = prop.location || defaultHeader.location;
    } else {
      nameEl.textContent = defaultHeader.name;
      locEl.textContent  = defaultHeader.location;
    }
    phoneEl.textContent = defaultHeader.phone;
  }

  function previewReceipt(id, type='payment'){
    showView('receipt');

    const titleEl    = document.getElementById('rv-title');
    const subTitleEl = document.getElementById('rv-subtitle');
    const partyLabelEl = document.getElementById('rv-party-label');
    const mainTitleEl = document.getElementById('receipt-main-title');

    const btnBack = document.getElementById('back-to-source-btn');
    btnBack.onclick = function(){ showView('receipts-history'); };

    if(type === 'salary'){
      const item = salaries.find(x => x.id === id);
      if(!item) return;

      titleEl.textContent = "Ø³Ù†Ø¯ ØµØ±Ù Ø±Ø§ØªØ¨";
      titleEl.className = "text-3xl font-black text-rose-700 tracking-wider";
      subTitleEl.textContent = "Salary Payment Voucher";
      partyLabelEl.textContent = "Ø§ØµØ±ÙÙˆØ§ Ù„Ù„Ø³ÙŠØ¯/Ø©:";
      mainTitleEl.textContent = "Ø³Ù†Ø¯ ØµØ±Ù Ø±Ø§ØªØ¨";

      setReceiptHeaderByProperty(null);

      document.getElementById('rv-no').textContent = item.voucherNo || '';
      document.getElementById('rv-date-out').textContent = item.date;
      document.getElementById('rv-tenant-out').textContent = `${item.name} (${item.role})`;
      document.getElementById('rv-amount-out').textContent = parseFloat(item.amount).toLocaleString();
      document.getElementById('rv-method-out').textContent = "Ù†Ù‚Ø¯ÙŠ / ØªØ­ÙˆÙŠÙ„";
      document.getElementById('rv-for-out').textContent = item.notes;

    } else if(type === 'expense'){
      const item = expenses.find(x => x.id === id);
      if(!item) return;

      titleEl.textContent = "Ø³Ù†Ø¯ ØµØ±Ù";
      titleEl.className = "text-3xl font-black text-rose-700 tracking-wider";
      subTitleEl.textContent = "Payment Voucher";
      partyLabelEl.textContent = "Ø§ØµØ±ÙÙˆØ§ Ù„Ù„Ø¬Ù‡Ø©:"; 
      mainTitleEl.textContent = "Ø³Ù†Ø¯ ØµØ±Ù";

      setReceiptHeaderByProperty(null);

      document.getElementById('rv-no').textContent = item.voucherNo || '';
      document.getElementById('rv-date-out').textContent = item.date;
      document.getElementById('rv-tenant-out').textContent = item.type;
      document.getElementById('rv-amount-out').textContent = parseFloat(item.amount).toLocaleString();
      document.getElementById('rv-method-out').textContent = "Ù†Ù‚Ø¯ÙŠ";
      document.getElementById('rv-for-out').textContent = `Ø¯ÙØ¹ Ù…Ø¨Ù„Øº ${item.amount.toLocaleString()} Ø¹Ù† ${item.type}: ${item.details}`;

    } else {
      const item = payments.find(x => x.id === id || x.chequeId === id);
      if(!item) return;

      titleEl.textContent = "Ø³Ù†Ø¯ Ù‚Ø¨Ø¶";
      titleEl.className = "text-3xl font-black text-emerald-700 tracking-wider";
      subTitleEl.textContent = "Receipt Voucher";
      partyLabelEl.textContent = "Ø§Ø³ØªÙ„Ù…Ù†Ø§ Ù…Ù†:";
      mainTitleEl.textContent = "Ø³Ù†Ø¯ Ù‚Ø¨Ø¶";

      const prop = findPropertyForPayment(item);
      setReceiptHeaderByProperty(prop);

      document.getElementById('rv-no').textContent = item.voucherNo || '';
      document.getElementById('rv-date-out').textContent = item.date;
      document.getElementById('rv-tenant-out').textContent = item.tenant;
      document.getElementById('rv-amount-out').textContent = parseFloat(item.amount).toLocaleString();
      document.getElementById('rv-method-out').textContent = item.type;
      document.getElementById('rv-for-out').textContent = item.desc || `Ø¯ÙØ¹Ø© Ø¥ÙŠØ¬Ø§Ø± ÙˆØ­Ø¯Ø© ${item.unit}`;
    }
  }

  function downloadReceiptPDF(){
    const element = document.getElementById('printable-receipt');
    const opt = {
      margin: 10,
      filename: 'Voucher.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().set(opt).from(element).save();
  }

  // ================= REPORTS =================
  
function ensureReportPeriodControls(){
  const monthSel = document.getElementById('report-month');
  const yearSel  = document.getElementById('report-year');

  const now = new Date();
  const currentMonth = now.getMonth() + 1;
  const currentYear  = now.getFullYear();

  // Months (Arabic labels)
  if(monthSel && monthSel.options.length === 0){
    const months = [
      'ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ',
      'ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'
    ];
    months.forEach((name, idx)=>{
      const opt = document.createElement('option');
      opt.value = String(idx+1);
      opt.textContent = name;
      monthSel.appendChild(opt);
    });
    monthSel.value = String(currentMonth);
  }

  // Years (current-5 .. current+1)
  if(yearSel && yearSel.options.length === 0){
    for(let y = currentYear-5; y <= currentYear+1; y++){
      const opt = document.createElement('option');
      opt.value = String(y);
      opt.textContent = String(y);
      yearSel.appendChild(opt);
    }
    yearSel.value = String(currentYear);
  }
}

function getReportPeriod(){
  ensureReportPeriodControls();
  const monthSel = document.getElementById('report-month');
  const yearSel  = document.getElementById('report-year');
  const now = new Date();
  const m = monthSel ? parseInt(monthSel.value||String(now.getMonth()+1),10) : (now.getMonth()+1);
  const y = yearSel  ? parseInt(yearSel.value||String(now.getFullYear()),10) : now.getFullYear();

  const start = new Date(y, m-1, 1);
  const end   = new Date(y, m, 1);

  const months = [
    'ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ',
    'ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'
  ];
  const label = `${months[m-1]} ${y}`;
  return { start, end, label };
}


// ===== Half-Year Owners Distribution Report (Mar/Sep) =====
function ensureHalfYearControls(){
  const yearSel = document.getElementById('hy-year');
  const cycleSel = document.getElementById('hy-cycle');
  if(!yearSel || !cycleSel) return;

  const now = new Date();
  const currentYear = now.getFullYear();

  if(yearSel.options.length === 0){
    for(let y=currentYear-5; y<=currentYear+1; y++){
      const opt = document.createElement('option');
      opt.value = String(y);
      opt.textContent = String(y);
      yearSel.appendChild(opt);
    }
    yearSel.value = String(currentYear);
  }
  if(!cycleSel.value) cycleSel.value = 'mar';
}


function getHalfYearPeriod(){
  ensureHalfYearControls();
  const cycle = (document.getElementById('hy-cycle')?.value) || 'mar';
  const y = parseInt((document.getElementById('hy-year')?.value) || String(new Date().getFullYear()), 10);

  // Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: 1 Ù…Ø§Ø±Ø³ -> 31 Ø£ØºØ³Ø·Ø³ (Ù†Ù‡Ø§ÙŠØ© = 1 Ø³Ø¨ØªÙ…Ø¨Ø±)
  // Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: 1 Ø³Ø¨ØªÙ…Ø¨Ø± -> 28/29 ÙØ¨Ø±Ø§ÙŠØ± (Ù†Ù‡Ø§ÙŠØ© = 1 Ù…Ø§Ø±Ø³ Ù…Ù† Ø§Ù„Ø³Ù†Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©)
  let start, end, label;
  if(cycle === 'mar'){
    start = new Date(y, 2, 1);   // Mar 1 (month=2)
    end   = new Date(y, 8, 1);   // Sep 1 (month=8)
    label = `Ù…Ù† 01/03/${y} Ø­ØªÙ‰ 31/08/${y}`;
  }else{
    start = new Date(y, 8, 1);   // Sep 1 (month=8)
    end   = new Date(y+1, 2, 1); // Mar 1 next year (month=2)
    label = `Ù…Ù† 01/09/${y} Ø­ØªÙ‰ 28/02/${y+1}`; // 28/29 handled by end boundary
  }
  return { start, end, label, cycle, year: y };
}


function overlapDays(aStartMs, aEndMs, bStartMs, bEndMs){
  const s = Math.max(aStartMs, bStartMs);
  const e = Math.min(aEndMs, bEndMs);
  if(!Number.isFinite(s) || !Number.isFinite(e) || e <= s) return 0;
  return Math.ceil((e - s) / (24*60*60*1000));
}

function renderHalfYearOwnersReport(){
  // Ensure data loaded
  ensureHalfYearControls();
  const period = getHalfYearPeriod();
  const startMs = period.start.getTime();
  const endMs   = period.end.getTime();

  // Ø¶Ø¨Ø· Ø¹Ø±Ø¶ Ù†Ù‡Ø§ÙŠØ© ÙØ¨Ø±Ø§ÙŠØ± (28/29) ÙˆÙÙ‚ Ø§Ù„Ø³Ù†Ø©
  if(period.cycle === 'sep'){
    const lastFeb = new Date(period.year+1, 2, 0); // Ø¢Ø®Ø± ÙŠÙˆÙ… ÙÙŠ ÙØ¨Ø±Ø§ÙŠØ±
    period.label = `Ù…Ù† 01/09/${period.year} Ø­ØªÙ‰ ${String(lastFeb.getDate()).padStart(2,'0')}/02/${period.year+1}`;
  }

  const labelEl = document.getElementById('hy-period-label');
  if(labelEl) labelEl.textContent = period.label;

  // Payments collected during period
  let collected = 0, collectedCount = 0;
  const payByContract = {};
  (payments||[]).forEach(p=>{
    const d = _leaseDateLocalNum(p?.date);
    if(Number.isFinite(d) && d >= startMs && d < endMs){
      const amt = Number(p?.amount||0) || 0;
      collected += amt;
      collectedCount++;
      const c = (p?.contract || '').trim();
      if(c){
        payByContract[c] = (payByContract[c]||0) + amt;
      }
    }
  });

  
  const contractRows = [];
  let contractsDueTotal = 0;
  let contractsRecTotal = 0;
  let contractsArrTotal = 0;

// Due rent (pro-rata by overlap days using annual rent)
  let dueTotal = 0;
  let rentedInPeriod = 0, vacantInPeriod = 0;

  const unitsRows = [];
  properties.forEach(pr=>pr.units.forEach(u=>{
    const hasContractDates = u?.start && u?.end;
    const cStart = _leaseDateLocalNum(u?.start);
    const cEnd   = _leaseDateLocalNum(u?.end);
    const overlaps = hasContractDates && Number.isFinite(cStart) && Number.isFinite(cEnd) && (cEnd >= startMs) && (cStart < endMs);
    const statusInPeriod = overlaps ? 'Ù…Ø¤Ø¬Ø±Ø© Ø®Ù„Ø§Ù„ Ø§Ù„ÙØªØ±Ø©' : 'Ø´Ø§ØºØ±Ø© Ø®Ù„Ø§Ù„ Ø§Ù„ÙØªØ±Ø©';

    if(overlaps) rentedInPeriod++;
    else vacantInPeriod++;

    let due = 0;
    if(overlaps){
      const days = overlapDays(cStart, cEnd + (24*60*60*1000), startMs, endMs); // include end day
      const annual = Number(u?.rent||0) || 0;
      // Ø¥Ø°Ø§ rent Ø³Ù†ÙˆÙŠ: pro-rata Ø£ÙŠØ§Ù…/365
      due = (annual/365) * days;
      dueTotal += due;
    }

    const contractNo = (u?.contractNo || '').trim();
    const received = contractNo ? (payByContract[contractNo]||0) : 0;
    const diff = due - received;

    // Ø³Ø·Ø± ØªÙØµÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø¯ Ø¶Ù…Ù† Ø§Ù„ÙØªØ±Ø© (Ø¥Ø°Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¯Ø§Ø®Ù„)
    if(overlaps && contractNo){
      // (ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø¢Ø®Ø± Ø¯ÙØ¹Ø© Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„)
      let lastPay = '';
const arr = Math.max(0, diff);
      contractsDueTotal += due;
      contractsRecTotal += received;
      contractsArrTotal += arr;

      contractRows.push({
        contractNo,
        unitName: u?.name || '-',
        tenantName: u?.tenantName || (u?.tenant || '-') || '-',
        start: u?.start || '',
        end: u?.end || '',
        due, received, arrears: arr,
        lastPay
      });
    }

    unitsRows.push({
      name: u?.name || '-',
      status: statusInPeriod,
      due, received, diff
    });
  }));

  // Expenses by type within period
  const expAgg = {};
  let expTotal = 0;
  (expenses||[]).forEach(ex=>{
    const d = _leaseDateLocalNum(ex?.date);
    if(Number.isFinite(d) && d >= startMs && d < endMs){
      const t = (ex?.type || 'Ø£Ø®Ø±Ù‰').trim() || 'Ø£Ø®Ø±Ù‰';
      const amt = Number(ex?.amount||0) || 0;
      expTotal += amt;
      if(!expAgg[t]) expAgg[t] = { total:0, count:0 };
      expAgg[t].total += amt;
      expAgg[t].count++;
    }
  });

  const arrears = Math.max(0, dueTotal - collected);
  const net = collected - expTotal;

  // Fill KPI fields
  const elCollected = document.getElementById('hy-collected');
  if(elCollected) elCollected.textContent = formatAED(collected);
  const elCollectedCount = document.getElementById('hy-collected-count');
  if(elCollectedCount) elCollectedCount.textContent = String(collectedCount);

  const elDue = document.getElementById('hy-due');
  if(elDue) elDue.textContent = formatAED(dueTotal);

  const elArrears = document.getElementById('hy-arrears');
  if(elArrears) elArrears.textContent = formatAED(arrears);

  const elNet = document.getElementById('hy-net');
  if(elNet) elNet.textContent = formatAED(net);

  // A4 summary header values
  const a4Period = document.getElementById('hy-a4-period');
  if(a4Period) a4Period.textContent = period.label;
  const a4Issued = document.getElementById('hy-a4-issued');
  if(a4Issued) a4Issued.textContent = new Date().toLocaleDateString('ar-EG', { year:'numeric', month:'long', day:'numeric' });

  const a4Collected = document.getElementById('hy-a4-collected');
  if(a4Collected) a4Collected.textContent = formatAED(collected);
  const a4Expenses = document.getElementById('hy-a4-expenses');
  if(a4Expenses) a4Expenses.textContent = formatAED(expTotal);
  const a4Arrears = document.getElementById('hy-a4-arrears');
  if(a4Arrears) a4Arrears.textContent = formatAED(arrears);
  const a4Net = document.getElementById('hy-a4-net');
  if(a4Net) a4Net.textContent = formatAED(net);


  const elExpTotal = document.getElementById('hy-expenses-total');
  if(elExpTotal) elExpTotal.textContent = formatAED(expTotal);

  // Expenses table
  const expBody = document.getElementById('hy-expenses-by-type-body');
  if(expBody){
    expBody.innerHTML = '';
    const entries = Object.entries(expAgg).sort((a,b)=> (b[1].total||0)-(a[1].total||0));
    if(entries.length === 0){
      expBody.innerHTML = '<tr><td colspan="3" class="text-sm text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙ Ø¶Ù…Ù† Ø§Ù„ÙØªØ±Ø©</td></tr>';
    }else{
      entries.forEach(([t,v])=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${t}</td><td class="ui-td-ltr">${formatAED(v.total)}</td><td class="ui-td-ltr">${v.count}</td>`;
        expBody.appendChild(tr);
      });
    }
  }

  // Units table (sorted by diff desc)
  const unitsBody = document.getElementById('hy-units-summary-body');
  if(unitsBody){
    unitsBody.innerHTML = '';
    unitsRows.sort((a,b)=> (b.diff||0)-(a.diff||0)).forEach(r=>{
      const tr = document.createElement('tr');
      const diffBadge = (r.diff>0.01) ? 'text-rose-700 font-extrabold' : 'text-emerald-700 font-extrabold';
      tr.innerHTML = `
        <td class="font-bold">${r.name}</td>
        <td class="text-sm">${r.status}</td>
        <td class="ui-td-ltr">${formatAED(r.due)}</td>
        <td class="ui-td-ltr">${formatAED(r.received)}</td>
        <td class="ui-td-ltr ${diffBadge}">${formatAED(r.diff)}</td>
      `;
      unitsBody.appendChild(tr);
    });
    if(unitsRows.length === 0){
      unitsBody.innerHTML = '<tr><td colspan="5" class="text-sm text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª</td></tr>';
    }
  }
  const elR = document.getElementById('hy-units-rented'); if(elR) elR.textContent = String(rentedInPeriod);
  const elV = document.getElementById('hy-units-vacant'); if(elV) elV.textContent = String(vacantInPeriod);


  // Contracts table (details: due vs received per contract)
  const contractsBody = document.getElementById('hy-contracts-body');
  if(contractsBody){
    contractsBody.innerHTML = '';

    // ØªØ±ØªÙŠØ¨: Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù…ØªØ£Ø®Ø±Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
    contractRows.sort((a,b)=> (b.arrears||0)-(a.arrears||0)).forEach(r=>{
      const badge = (r.arrears > 0.01)
        ? '<span class="inline-flex items-center px-3 py-1 rounded-full bg-rose-100 text-rose-800 font-extrabold text-xs">Ù…ØªØ£Ø®Ø±</span>'
        : '<span class="inline-flex items-center px-3 py-1 rounded-full bg-emerald-100 text-emerald-800 font-extrabold text-xs">Ù…Ù†ØªØ¸Ù…</span>';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="ui-td-ltr font-bold cell-nowrap">${r.contractNo}</td>
        <td class="font-bold cell-nowrap">${r.unitName}</td>
        <td class="ui-td-2lines cell-tenant">${r.tenantName}</td>
        <td class="ui-td-ltr cell-nowrap">${r.start ? formatDMY(r.start) : 'â€”'}</td>
        <td class="ui-td-ltr cell-nowrap">${r.end ? formatDMY(r.end) : 'â€”'}</td>
        <td class="ui-td-ltr cell-amount">${formatAED(r.due)}</td>
        <td class="ui-td-ltr cell-amount">${formatAED(r.received)}</td>
        <td>
          <div class="cell-arrears">
            ${badge}
            <span class="ui-td-ltr ${r.arrears>0.01 ? 'text-rose-700 font-extrabold' : 'text-emerald-700 font-extrabold'}">${formatAED(r.arrears)}</span>
          </div>
        </td>
`;
      contractsBody.appendChild(tr);
    });

    if(contractRows.length === 0){
      contractsBody.innerHTML = '<tr><td colspan="9" class="text-sm text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚ÙˆØ¯ ØªØªØ¯Ø§Ø®Ù„ Ù…Ø¹ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©</td></tr>';
    }
  }

  const cd = document.getElementById('hy-contracts-due-total');
  if(cd) cd.textContent = formatAED(contractsDueTotal);
  const cr = document.getElementById('hy-contracts-rec-total');
  if(cr) cr.textContent = formatAED(contractsRecTotal);
  const ca = document.getElementById('hy-contracts-arr-total');
  if(ca) ca.textContent = formatAED(contractsArrTotal);


  // Owners distribution (placeholder until owners shares exist)
  const ownersBody = document.getElementById('hy-owners-body');
  if(ownersBody){
    ownersBody.innerHTML = '';
    const owners = JSON.parse(localStorage.getItem('owners') || '[]'); // [{name:'...', share:50}]
    if(!Array.isArray(owners) || owners.length === 0){
      ownersBody.innerHTML = `<tr><td colspan="3" class="text-sm text-rose-700 font-bold">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù„Ø§Ùƒ ÙˆÙ†Ø³Ø¨ Ø§Ù„Ù…Ù„ÙƒÙŠØ©. (Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§ ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ø§Ø­Ù‚Ø§Ù‹) â€” ØµØ§ÙÙŠ Ø§Ù„ÙØªØ±Ø©: ${formatAED(net)}</td></tr>`;
    }else{
      const totalShare = owners.reduce((s,o)=> s + (Number(o.share)||0), 0);
      owners.forEach(o=>{
        const share = Number(o.share||0) || 0;
        const amount = totalShare ? (net * (share/totalShare)) : 0;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="font-bold">${o.name||'-'}</td><td class="ui-td-ltr">${share}%</td><td class="ui-td-ltr">${formatAED(amount)}</td>`;
        ownersBody.appendChild(tr);
      });
    }
  }

  // Notes
  const noteEl = document.getElementById('hy-note-arrears');
  if(noteEl){
    if(arrears > 0.01){
      noteEl.textContent = `Ù…Ù„Ø§Ø­Ø¸Ø©: ØªÙˆØ¬Ø¯ Ù…ØªØ£Ø®Ø±Ø§Øª ØªÙ‚Ø¯ÙŠØ±ÙŠØ© Ø¶Ù…Ù† Ø§Ù„ÙØªØ±Ø© Ø¨Ù‚ÙŠÙ…Ø© ${formatAED(arrears)} â€” ÙŠÙˆØµÙ‰ Ø¨Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ­ØµÙŠÙ„ Ù‚Ø¨Ù„ Ø§Ù„ØµØ±Ù.`;
    }else{
      noteEl.textContent = 'Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØªØ£Ø®Ø±Ø§Øª ØªÙ‚Ø¯ÙŠØ±ÙŠØ© Ø¶Ù…Ù† Ø§Ù„ÙØªØ±Ø© Ø¨Ø­Ø³Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©.';
    }
  }
}
// ===== /Half-Year Owners Distribution Report =====

function renderReports(){
    const date = new Date().toLocaleDateString('ar-AE');
    document.getElementById('report-date').textContent = date;

    ensureReportPeriodControls();
    const period = getReportPeriod();
    const periodEl = document.getElementById('report-period');
    if(periodEl) periodEl.textContent = period.label;

    // KPIs for the selected period
    const startMs = period.start.getTime();
    const endMs   = period.end.getTime();

    let revTotal = 0, revCount = 0;
    (payments||[]).forEach(pm=>{
      const d = _leaseDateLocalNum(pm?.date);
      if(Number.isFinite(d) && d >= startMs && d < endMs){
        revTotal += Number(pm?.amount||0) || 0;
        revCount++;
      }
    });

    let expTotal = 0, expCount = 0;
    (expenses||[]).forEach(ex=>{
      const d = _leaseDateLocalNum(ex?.date);
      if(Number.isFinite(d) && d >= startMs && d < endMs){
        expTotal += Number(ex?.amount||0) || 0;
        expCount++;
      }
    });

    const netTotal = revTotal - expTotal;

    let totalUnits = 0, vacantUnits = 0, rentedUnits = 0;
    properties.forEach(p=>p.units.forEach(u=>{
      totalUnits++;
      if((u.status||'Ø´Ø§ØºØ±Ø©') === 'Ù…Ø¤Ø¬Ø±Ø©') rentedUnits++;
      else if((u.status||'Ø´Ø§ØºØ±Ø©') === 'Ø´Ø§ØºØ±Ø©') vacantUnits++;
    }));
    const occ = totalUnits ? (rentedUnits / totalUnits) * 100 : 0;

    const kRev = document.getElementById('report-kpi-revenue');
    if(kRev) kRev.textContent = formatAED(revTotal);
    const kRevC = document.getElementById('report-kpi-revenue-count');
    if(kRevC) kRevC.textContent = String(revCount);

    const kExp = document.getElementById('report-kpi-expenses');
    if(kExp) kExp.textContent = formatAED(expTotal);
    const kExpC = document.getElementById('report-kpi-expenses-count');
    if(kExpC) kExpC.textContent = String(expCount);

    const kNet = document.getElementById('report-kpi-net');
    if(kNet) kNet.textContent = formatAED(netTotal);

    const kOcc = document.getElementById('report-kpi-occupancy');
    if(kOcc) kOcc.textContent = `${occ.toFixed(1)}%`;
    const kVac = document.getElementById('report-kpi-vacant');
    if(kVac) kVac.textContent = String(vacantUnits);
    const kTot = document.getElementById('report-kpi-totalunits');
    if(kTot) kTot.textContent = String(totalUnits);



    const tenants = getTenantsData();

    // Full contract value â€” rent amount is treated as the full contract amount (not annual) inside reports
    const contractTotals = {};
    properties.forEach(p=>p.units.forEach(u=>{
      if(u.status==='Ù…Ø¤Ø¬Ø±Ø©' && u.tenant){
        if(!contractTotals[u.tenant]) contractTotals[u.tenant] = 0;
        contractTotals[u.tenant] += calcUnitContractValue(u);
      }
    }));
    const tenantsR = tenants.map(t=>{
      const contractValue = Number(contractTotals[t.name] ?? t.rent) || 0;
      const paid = Number(t.paid) || 0;
      return {...t, contractValue, contractBalance: contractValue - paid};
    });

    const list = document.getElementById('tenants-summary-list');
    list.innerHTML='';
    tenantsR.forEach(t=>{
      const div = document.createElement('div');
      div.className = "border p-3 rounded bg-gray-50 flex justify-between";
      div.innerHTML = `<span><strong>${t.name}</strong> (${t.units.join(', ')})</span>
        <span class="font-bold text-emerald-700">${formatAED(t.contractValue)}</span>`;
      list.appendChild(div);
    });

    const lateList = document.getElementById('late-tenants-list');
    lateList.innerHTML='';
    const late = tenantsR.filter(t=>t.contractBalance>0);
    if(late.length===0) lateList.innerHTML = '<li class="text-green-700">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªØ£Ø®Ø±Ø§Øª ÙˆÙ„Ù„Ù‡ Ø§Ù„Ø­Ù…Ø¯</li>';
    else late.forEach(t=>{
      const li = document.createElement('li');
      li.innerHTML = `âš ï¸ <strong>${t.name}</strong> - Ù…ØªØ¨Ù‚ÙŠ Ø¹Ù„ÙŠÙ‡: <span class="font-bold text-red-700">${formatAED(t.contractBalance)}</span>`;
      lateList.appendChild(li);
    });
  
    renderLeaseArchiveReport();

  renderHalfYearOwnersReport();
}


  // ================= SETTINGS & BACKUP =================
  function exportBackupJSON(){
    const data = { properties, cheques, expenses, payments, tenantsContacts, salaries };
    const blob = new Blob([JSON.stringify(data)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url;
    a.download='realestate_backup.json';
    a.click();
  }

  function exportBackupExcel(){
    const wb = XLSX.utils.book_new();
    const unitsData = [];
    properties.forEach(p=>p.units.forEach(u=> unitsData.push({...u, Property:p.name})));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(unitsData), "Units");
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(payments), "Payments");
    if(salaries.length > 0) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(salaries), "Salaries");
    if(expenses.length > 0) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(expenses), "Expenses");
    XLSX.writeFile(wb, "RealEstate_Data.xlsx");
  }

  function importBackup(e){
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(evt){
      try{
        const data = JSON.parse(evt.target.result);
        if(data.properties) properties = data.properties;
        if(data.payments) payments = data.payments;
        if(data.cheques) cheques = data.cheques;
        if(data.salaries) salaries = data.salaries;
        if(data.expenses) expenses = data.expenses;
        if(data.tenantsContacts) tenantsContacts = data.tenantsContacts;

        expenses = expenses.map(e => ({
          id: e.id || 'EXP-' + Date.now() + Math.floor(Math.random()*1000),
          date: e.date,
          type: e.type || 'Ø£Ø®Ø±Ù‰',
          amount: e.amount,
          details: e.details,
          voucherNo: e.voucherNo || null
        }));
        cheques = (cheques||[]).map(normalizeChequeRecord);
        cheques = cheques.map(c=>{
          const nc = normalizeChequeRecord(c);
          if(!nc.unitId){
            const inferred = inferSingleLeasedUnitIdForTenant(nc.tenant);
            if(inferred) nc.unitId = inferred;
          }
          if(nc.unitId && !nc.unitLabel){
            nc.unitLabel = getUnitDisplayById(nc.unitId);
          }
          return nc;
        });
        (payments||[]).forEach(p=>{ if(p && p.chequeId){ migrateChequePaymentsToUnit(p.chequeId); } });
        saveToLocal();
        ensureVoucherNumbers();
        document.getElementById('backup-msg').textContent = "âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!";
        setTimeout(()=>location.reload(), 1500);
      } catch(err){
        console.error(err);
        document.getElementById('backup-msg').textContent = "âŒ Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­";
      }
    };
    reader.readAsText(file);
  }

  function clearAllData(){
    properties = [];
    cheques = [];
    expenses = [];
    payments = [];
    tenantsContacts = {};
    salaries = [];
    saveToLocal();
    location.reload();
  }

  // ================= THEME =================
  function toggleDarkMode(){
    const willBeDark = !document.body.classList.contains('dark-mode');

    if (willBeDark) {
      document.body.classList.add('dark-mode');
      document.documentElement.classList.add('dark');
      localStorage.setItem('re_dark_mode', '1');
    } else {
      document.body.classList.remove('dark-mode');
      document.documentElement.classList.remove('dark');
      localStorage.setItem('re_dark_mode', '0');
    }
    updateDashboard();
  }

  function initTheme(){
    const saved = localStorage.getItem('re_dark_mode');
    if (saved === '1') {
      document.body.classList.add('dark-mode');
      document.documentElement.classList.add('dark');
    } else {
      document.body.classList.remove('dark-mode');
      document.documentElement.classList.remove('dark');
    }
  }

  
  // Bind once: mark arrears details as "user edited" so auto-fill won't overwrite unless forced
  function initNoticeArrearsAutogenTracking(){
    const details = document.getElementById('notice-arrears-details');
    if(details && details.dataset.bound !== '1'){
      details.dataset.bound = '1';
      details.addEventListener('input', ()=>{ details.dataset.autogen = '0'; });
    }
  }

// ================= INIT =================
  window.onload = function(){
    initTheme();
    loadRentBasisSetting();
    loadFromLocal();
    initSortingPrefs();
    initPropertiesUnitFilters();
    initNoticeArrearsAutogenTracking();
    showView('dashboard');
  };

  // =========================================================
  // Modal drag support (drag by header) + safe reset on open
  // =========================================================
  (function(){
    const state = { active:false, el:null, startX:0, startY:0, baseX:0, baseY:0 };

    function getXY(el){
      const x = parseFloat(el.dataset.dx || '0') || 0;
      const y = parseFloat(el.dataset.dy || '0') || 0;
      return {x,y};
    }
    function setXY(el, x, y){
      el.dataset.dx = String(x);
      el.dataset.dy = String(y);
      el.style.transform = `translate(${x}px, ${y}px)`;
    }
    function clamp(el, x, y){
      // Clamp within viewport with a small margin
      const margin = 8;
      // Temporarily apply to measure
      const prev = el.style.transform;
      el.style.transform = `translate(${x}px, ${y}px)`;
      const r = el.getBoundingClientRect();
      el.style.transform = prev;

      let nx = x, ny = y;
      if(r.left < margin) nx += (margin - r.left);
      if(r.right > window.innerWidth - margin) nx -= (r.right - (window.innerWidth - margin));
      if(r.top < margin) ny += (margin - r.top);
      if(r.bottom > window.innerHeight - margin) ny -= (r.bottom - (window.innerHeight - margin));
      return {x:nx,y:ny};
    }

    function onDown(e, content){
      if(e.button !== undefined && e.button !== 0) return;
      state.active = true;
      state.el = content;
      state.startX = (e.touches ? e.touches[0].clientX : e.clientX);
      state.startY = (e.touches ? e.touches[0].clientY : e.clientY);
      const {x,y} = getXY(content);
      state.baseX = x; state.baseY = y;
      document.body.classList.add('select-none');
      e.preventDefault();
    }
    function onMove(e){
      if(!state.active || !state.el) return;
      const cx = (e.touches ? e.touches[0].clientX : e.clientX);
      const cy = (e.touches ? e.touches[0].clientY : e.clientY);
      let x = state.baseX + (cx - state.startX);
      let y = state.baseY + (cy - state.startY);
      const c = clamp(state.el, x, y);
      setXY(state.el, c.x, c.y);
      e.preventDefault();
    }
    function onUp(){
      state.active = false;
      state.el = null;
      document.body.classList.remove('select-none');
    }

    function resetModalPosition(modal){
      const content = modal?.querySelector('.modal-content');
      if(!content) return;
      content.dataset.dx = '0';
      content.dataset.dy = '0';
      content.style.transform = '';
    }

    function wire(modal){
      const content = modal.querySelector('.modal-content');
      if(!content) return;
      const header = content.querySelector(':scope > div:first-child');
      if(!header) return;

      header.style.cursor = 'move';
      header.addEventListener('mousedown', (e)=>onDown(e, content));
      header.addEventListener('touchstart', (e)=>onDown(e, content), {passive:false});

      // Reset position whenever modal opens
      const obs = new MutationObserver(()=>{
        if(!modal.classList.contains('hidden')){
          resetModalPosition(modal);
        }
      });
      obs.observe(modal, { attributes:true, attributeFilter:['class'] });
    }

    window.addEventListener('mousemove', onMove, {passive:false});
    window.addEventListener('touchmove', onMove, {passive:false});
    window.addEventListener('mouseup', onUp);
    window.addEventListener('touchend', onUp);

    window.addEventListener('DOMContentLoaded', ()=>{
      document.querySelectorAll('div[id$="-modal"]').forEach(wire);
    });
  })();


// ===== Print Helpers (Reports) =====


function printCurrentReport(){
  const rv = document.getElementById('reports-view');
  const wasHidden = rv ? rv.classList.contains('hidden') : false;

  if(rv) rv.classList.remove('hidden');

  // Always print only the half-year owners payout report
  try{ renderReports(); }catch(e){}
  try{ renderHalfYearOwnersReport(); }catch(e){}

  const monthly = document.getElementById('monthly-report-section');
  const hy = document.getElementById('hy-report-section');

  // Temporarily hide monthly report content for print consistency
  const monthlyWasHidden = monthly ? monthly.classList.contains('hidden') : false;
  if(monthly) monthly.classList.add('hidden');

  // Ensure half-year section is visible
  const hyWasHidden = hy ? hy.classList.contains('hidden') : false;
  if(hy) hy.classList.remove('hidden');

  // Print header meta
  const dEl = document.getElementById('print-header-date');
  if(dEl) dEl.textContent = new Date().toLocaleDateString('ar-EG', { year:'numeric', month:'long', day:'numeric' });

  const hyLbl = document.getElementById('hy-period-label')?.textContent?.trim();
  const pEl = document.getElementById('print-header-period');
  if(pEl) pEl.textContent = `ØªÙ‚Ø±ÙŠØ± Ù†ØµÙ Ø³Ù†ÙˆÙŠ Ù„ØµØ±Ù Ø§Ù„Ù…Ù„Ø§Ùƒ (${hyLbl || 'â€”'})`;

  setTimeout(()=>{
    window.print();
    setTimeout(()=>{
      // restore views
      if(monthly && !monthlyWasHidden) monthly.classList.remove('hidden');
      if(hy && hyWasHidden) hy.classList.add('hidden');
      if(rv && wasHidden) rv.classList.add('hidden');
    }, 400);
  }, 80);
}


// ===== /Print Helpers =====

</script>

</body>
</html>

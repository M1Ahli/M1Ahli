
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            dark: {
              bg: '#111827',
              surface: '#1f2937',
              border: '#374151',
              text: '#f3f4f6',
              muted: '#9ca3af',
              input: '#111827'
            }
          }
        }
      }
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Tajawal:wght@400;500;700&display=swap');

    body {
      font-family: 'Tajawal','Cairo',system-ui,sans-serif;
      background:#f9fafb;
      color:#111827;
      transition: background-color 0.3s, color 0.3s;
    }

    /* --- Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ --- */
    body.dark-mode {
      background-color: #111827;
      color: #f3f4f6;
    }

    body.dark-mode .bg-white,
    body.dark-mode .modal-content {
      background-color: #1f2937 !important;
      color: #f3f4f6 !important;
      border-color: #374151 !important;
    }

    body.dark-mode .bg-gray-50 { background-color: #111827 !important; }
    body.dark-mode .bg-gray-100 { background-color: #374151 !important; color: white !important; }

    /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
    body.dark-mode th {
      background-color: #1f2937 !important;
      color: #9ca3af !important;
      border-bottom-color: #374151 !important;
    }
    body.dark-mode td { border-bottom-color: #374151 !important; }

    /* Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª */
    body.dark-mode input,
    body.dark-mode select,
    body.dark-mode textarea {
      background-color: #111827 !important;
      border-color: #4b5563 !important;
      color: #fff !important;
    }
    body.dark-mode input::placeholder,
    body.dark-mode textarea::placeholder { color: #6b7280 !important; }

    /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù†ØµÙˆØµ ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
    body.dark-mode .text-gray-900,
    body.dark-mode .text-gray-800 {
      color: #f9fafb !important;
    }
    body.dark-mode .text-gray-700 {
      color: #e5e7eb !important;
    }
    body.dark-mode .text-gray-600 {
      color: #d1d5db !important;
    }
    body.dark-mode .text-gray-500 {
      color: #9ca3af !important;
    }
    body.dark-mode .text-gray-400 {
      color: #6b7280 !important;
    }

    /* Ø§Ù„Ù†Ø§ÙØ¨Ø§Ø± */
    nav {
      background:#ffffff;
      border-radius:16px;
      box-shadow:0 4px 6px -1px rgba(0,0,0,0.05);
      padding:12px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-bottom: 20px;
      transition: background-color 0.3s;
    }
    body.dark-mode nav {
      background-color: #1f2937 !important;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.3);
    }

    .nav-btn {
      border-radius:8px;
      font-weight:600;
      padding:8px 16px;
      transition:all .2s;
      background:#f3f4f6;
      color:#4b5563;
      border: 1px solid transparent;
    }
    .nav-btn:hover {
      background:#e5e7eb;
      transform:translateY(-1px);
    }
    .nav-btn.active {
      background:#7c3aed;
      color:#fff;
      box-shadow:0 4px 12px rgba(124, 58, 237, 0.3);
    }

    body.dark-mode .nav-btn {
      background:#374151;
      color:#d1d5db;
    }
    body.dark-mode .nav-btn:hover {
      background:#4b5563;
      color: white;
    }
    body.dark-mode .nav-btn.active {
      background:#8b5cf6;
      color:#fff;
      box-shadow:0 4px 12px rgba(139, 92, 246, 0.4);
    }

    .bg-white {
      border-radius:16px;
      box-shadow:0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid rgba(0,0,0,0.05);
    }
    table {
      border-collapse:separate;
      border-spacing:0;
      width:100%;
      font-size:.9rem;
    }
    th {
      background:#f9fafb;
      font-weight:700;
      text-align:right;
      padding:12px 16px;
      border-bottom:2px solid #e5e7eb;
      color: #4b5563;
      text-transform: uppercase;
      font-size: 0.8rem;
      letter-spacing: 0.05em;
    }
    td {
      padding:12px 16px;
      border-bottom:1px solid #f3f4f6;
      vertical-align: middle;
    }

    .badge {
      padding:.25rem .6rem;
      border-radius:9999px;
      font-size:.7rem;
      font-weight:700;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .badge-green { background:#d1fae5; color:#047857; }
    .badge-red { background:#fee2e2; color:#b91c1c; }
    .badge-amber { background:#fef3c7; color:#b45309; }
    .badge-blue { background:#dbeafe; color:#1e40af; }

    button { border-radius:8px; font-weight:600; transition:all .2s; }
    button:active { transform: scale(0.98); }

    .hidden { display:none !important; }
    .table-wrap {
      overflow-x:auto;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
    }
    body.dark-mode .table-wrap { border-color: #374151; }

    .truncate-text {
      max-width: 120px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .rotate-0 { transform: rotate(0deg); }
    .-rotate-90 { transform: rotate(90deg); }

    @page {
      size: A4 portrait;
      margin: 10mm;
    }

    /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù„Ù„Ø³Ù†Ø¯Ø§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ± */
    
    .letter-title-ar{
      font-family:"Arabic Typesetting","Amiri","Noto Naskh Arabic",serif;
      font-size:28px;
      line-height:1.2;
      font-weight:700;
    }
    .letter-title-en{
      font-family:"Times New Roman", Georgia, serif;
      font-size:18px;
      line-height:1.25;
      margin-top:6px;
      font-weight:600;
      opacity:.95;
    }
    body.dark-mode .letter-title{
      border-bottom-color: rgba(255,255,255,0.18);
    }

@media print {
      body {
        margin: 0;
      }
      body * {
        visibility: hidden;
      }

      #printable-area,
      #printable-area *,
      #printable-receipt,
      #printable-receipt * {
        visibility: visible;
      }

      #printable-area,
      #printable-receipt {
        position: absolute;
        inset: 0;
        margin: 0 auto;
        width: 190mm;
        page-break-inside: avoid;
      }

      .no-print {
        display: none !important;
      }
    }
  
    /* =========================================================
       Enhanced Light/Dark Theme (Accessibility + Visual Comfort)
       ========================================================= */
    :root{
      --bg:#f8fafc;
      --surface:#ffffff;
      --surface-2:#f1f5f9;
      --border:rgba(15,23,42,.12);
      --text:#0f172a;
      --muted:#475569;
      --muted-2:#64748b;
      --shadow:0 1px 2px rgba(15,23,42,.06), 0 6px 18px rgba(15,23,42,.06);
      --focus:rgba(124,58,237,.35);
    }
    body.dark-mode{
      --bg:#0b1220;
      --surface:#0f172a;
      --surface-2:#111c33;
      --border:rgba(148,163,184,.18);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --muted-2:#64748b;
      --shadow:0 1px 2px rgba(0,0,0,.35), 0 10px 28px rgba(0,0,0,.35);
      --focus:rgba(139,92,246,.45);
    }

    body{
      background:var(--bg) !important;
      color:var(--text) !important;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Surfaces */
    nav{
      background:var(--surface) !important;
      border:1px solid var(--border);
      box-shadow:var(--shadow);
    }
    .bg-white,
    .modal-content{
      background-color:var(--surface) !important;
      color:var(--text) !important;
      border-color:var(--border) !important;
      box-shadow:var(--shadow);
    }
    body.dark-mode .bg-gray-50{ background-color:var(--bg) !important; }
    body.dark-mode .bg-gray-100{
      background-color:var(--surface-2) !important;
      color:var(--text) !important;
    }

    /* Navigation buttons */
    .nav-btn{
      background:var(--surface-2) !important;
      color:var(--muted) !important;
      border:1px solid var(--border);
    }
    .nav-btn:hover{
      background:rgba(148,163,184,.18) !important;
      transform:translateY(-1px);
    }
    body.dark-mode .nav-btn:hover{
      background:rgba(148,163,184,.22) !important;
      color:var(--text) !important;
    }

    /* Inputs */
    input, select, textarea{
      background-color:var(--surface) !important;
      color:var(--text) !important;
      border-color:var(--border) !important;
    }
    body.dark-mode input,
    body.dark-mode select,
    body.dark-mode textarea{
      background-color:var(--surface-2) !important;
      color:var(--text) !important;
      border-color:var(--border) !important;
    }
    input::placeholder, textarea::placeholder{
      color:var(--muted-2) !important;
    }
    input:focus, select:focus, textarea:focus{
      outline:none !important;
      box-shadow:0 0 0 3px var(--focus) !important;
    }

    /* Tables */
    th{
      background:var(--surface-2) !important;
      color:var(--muted) !important;
      border-bottom:1px solid var(--border) !important;
    }
    td{
      border-bottom:1px solid var(--border) !important;
      color:var(--text) !important;
    }
    tbody tr:hover td{
      background:rgba(15,23,42,.03) !important;
    }
    body.dark-mode tbody tr:hover td{
      background:rgba(148,163,184,.08) !important;
    }

    /* Common text utilities */
    .text-gray-900, .text-gray-800{ color:var(--text) !important; }
    .text-gray-700, .text-gray-600, .text-gray-500{ color:var(--muted) !important; }
    .text-gray-400{ color:var(--muted-2) !important; }

    /* Badges (softer in dark mode) */
    body.dark-mode .badge-green{ background:rgba(16,185,129,.18) !important; color:#34d399 !important; }
    body.dark-mode .badge-red{ background:rgba(244,63,94,.18) !important; color:#fb7185 !important; }
    body.dark-mode .badge-amber{ background:rgba(245,158,11,.18) !important; color:#fbbf24 !important; }
    body.dark-mode .badge-blue{ background:rgba(59,130,246,.18) !important; color:#93c5fd !important; }


    /* ===== ØªØ­Ø³ÙŠÙ† ØµÙØ­Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ ===== */
    body.dark-mode #reports-view .bg-rose-50{
      background-color: rgba(127,29,29,.22) !important;
      border: 1px solid rgba(248,113,113,.20) !important;
    }
    body.dark-mode #reports-view .text-rose-700{ color:#fca5a5 !important; }
    body.dark-mode #reports-view .border-rose-700{ border-color: rgba(248,113,113,.55) !important; }
    body.dark-mode #reports-view .text-red-700{ color:#fca5a5 !important; }
    body.dark-mode #reports-view .text-emerald-700{ color:#86efac !important; }
    body.dark-mode #reports-view .text-green-700{ color:#86efac !important; }


    /* ===== Letters / Notices (A4) ===== */
    .letter-paper{
      font-family:"Arabic Typesetting","Noto Naskh Arabic","Tahoma","Arial",sans-serif;
      background:#ffffff;
      color:#111827;
            font-size:20px;
border:1px solid rgba(0,0,0,0.10);
      border-radius:18px;
      padding:28px;
      max-width:920px;
      margin: 0 auto;
    }
    .letter-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      margin-bottom:14px;
    }
    .letter-head-lines{
      font-weight:700;
      line-height:1.45;
      font-size:15px;
    }
    .letter-date{
      font-weight:600;
      font-size:14px;
      opacity:.85;
      white-space:nowrap;
    }
    .letter-title{
      text-align:center;
      margin: 10px 0 14px;
      padding-bottom:12px;
      border-bottom: 2px solid rgba(0,0,0,0.12);
    }
    .letter-meta{
      display:flex;
      flex-wrap:wrap;
      justify-content:space-between;
      gap:10px;
      margin: 10px 0 18px;
      font-size:13px;
      opacity:.9;
    }
    .letter-columns{
      direction:rtl;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 0;
      border:1px solid rgba(0,0,0,0.10);
      border-radius:16px;
      overflow:hidden;
      background: rgba(255,255,255,0.65);
    }
    body.dark-mode .letter-columns{
      background: rgba(17,24,39,0.40);
      border-color: rgba(255,255,255,0.14);
    }
    .letter-col{
      padding:16px 18px;
      min-height: 380px;
    }
    .letter-col[dir="rtl"]{
      direction:rtl;
      font-family:"Arabic Typesetting","Amiri","Noto Naskh Arabic","Times New Roman",serif;
      font-size: 28px;
      line-height:2.0;
      border-left:1px solid rgba(0,0,0,0.10);
      border-right:none;
}
    body.dark-mode .letter-col[dir="rtl"]{
      border-left-color: rgba(255,255,255,0.14);
      border-right-color: transparent;
}
    .letter-col[dir="ltr"]{
      direction:ltr;
      font-family:"Times New Roman", Georgia, serif;
      font-size:15px;
      line-height:1.9;
    }
    .letter-p{
      margin:0 0 10px 0;
    }
    .letter-list{
      margin:0 0 12px 0;
      padding-left: 20px;
    }
    .letter-col[dir="rtl"] .letter-list{
      padding-left:0;
      padding-right: 22px;
    }
    .letter-list li{ margin: 0 0 6px 0; }
.letter-body{
      font-size:inherit;
      line-height:inherit;
      white-space:pre-wrap;
    }
    .letter-edit{ outline:none; }
    .letter-footer{
      margin-top: 26px;
      padding-top: 14px;
      border-top: 1px solid rgba(0,0,0,0.12);
      font-size:12.5px;
      line-height:1.6;
      opacity:.9;
    }
    .letter-footer .sig{
      font-weight:700;
      margin-bottom:6px;
    }

    @media print{
      @page { size: A4; margin: 14mm; }
      body{ background:#fff !important; }
      nav, .no-print{ display:none !important; }
      .view{ display:none !important; }
      #notices-view{ display:block !important; padding:0 !important; }
      #notice-preview{ border:none !important; background:transparent !important; padding:0 !important; min-height:auto !important; }
      .letter-paper{
        border:none !important;
        border-radius:0 !important;
        padding:0 !important;
        max-width:none !important;
        margin:0 !important;
      }
      .letter-col{ border:none !important; padding:0 !important; border-radius:0 !important; }
    }
</style>
</head>
<body class="p-4 md:p-6 max-w-[1600px] mx-auto transition-colors duration-300">

  <nav>
    <button id="nav-dashboard" class="nav-btn active" onclick="showView('dashboard')">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <button id="nav-properties" class="nav-btn" onclick="showView('properties')">ğŸ¢ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª</button>
    <button id="nav-leases" class="nav-btn" onclick="showView('leases')">ğŸ“‘ Ø§Ù„Ø¹Ù‚ÙˆØ¯</button>
    <button id="nav-tenants" class="nav-btn" onclick="showView('tenants')">ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ†</button>
    <button id="nav-cheques" class="nav-btn" onclick="showView('cheques')">ğŸ’³ Ø§Ù„Ø´ÙŠÙƒØ§Øª</button>
    <button id="nav-payments" class="nav-btn" onclick="showView('payments')">ğŸ’° Ø§Ù„Ø¯ÙØ¹Ø§Øª</button>
    <button id="nav-expenses" class="nav-btn" onclick="showView('expenses')">ğŸ’¸ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</button>
    <button id="nav-salaries" class="nav-btn" onclick="showView('salaries')">ğŸ‘¨â€ğŸ”§ Ø§Ù„Ø±ÙˆØ§ØªØ¨</button>
    <button id="nav-receipts-history" class="nav-btn" onclick="showView('receipts-history')">ğŸ§¾ Ø§Ù„Ø³Ù†Ø¯Ø§Øª</button>
    <button id="nav-reports" class="nav-btn" onclick="showView('reports')">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
    <button id="nav-notices" class="nav-btn" onclick="showView('notices')">ğŸ”” Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</button>
    <button id="nav-settings" class="nav-btn" onclick="showView('settings')">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    <button class="nav-btn mr-auto" onclick="toggleDarkMode()">ğŸŒ™/â˜€ï¸</button>
  </nav>

  <!-- ============= DASHBOARD ============= -->
  <section id="dashboard-view" class="view">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</h2>
      <span class="text-sm text-gray-500 dark:text-gray-400" id="current-date-display"></span>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
      <div class="bg-white p-6 rounded-2xl border-r-4 border-emerald-500">
        <p id="total-rent-label" class="text-gray-500 dark:text-gray-400 text-sm font-semibold mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø³Ù†ÙˆÙŠ</p>
        <p id="total-annual-rent" class="text-3xl font-bold text-gray-800 dark:text-white">0 AED</p>
      </div>
      <div class="bg-white p-6 rounded-2xl border-r-4 border-blue-500">
        <p class="text-gray-500 dark:text-gray-400 text-sm font-semibold mb-1">Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„ÙØ¹Ø§Ù„Ø©</p>
        <p id="active-leases-count" class="text-3xl font-bold text-gray-800 dark:text-white">0</p>
      </div>
      <div class="bg-white p-6 rounded-2xl border-r-4 border-rose-500">
        <p class="text-gray-500 dark:text-gray-400 text-sm font-semibold mb-1">Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø´Ø§ØºØ±Ø©</p>
        <p id="empty-units-count" class="text-3xl font-bold text-gray-800 dark:text-white">0</p>
      </div>
      <div class="bg-white p-6 rounded-2xl border-r-4 border-amber-500">
        <p class="text-gray-500 dark:text-gray-400 text-sm font-semibold mb-1">Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† Ø§Ù„Ù…ØªØ£Ø®Ø±ÙŠÙ†</p>
        <p id="late-tenants-count" class="text-3xl font-bold text-gray-800 dark:text-white">0</p>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
      <div class="bg-white p-6 rounded-2xl">
        <h3 class="font-bold mb-4 text-gray-700 dark:text-gray-200">ØªÙˆØ²ÙŠØ¹ Ø­Ø§Ù„Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø§Øª</h3>
        <div class="h-64"><canvas id="leasesChart"></canvas></div>
      </div>
      <div class="bg-white p-6 rounded-2xl">
        <h3 class="font-bold mb-4 text-gray-700 dark:text-gray-200">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø§Ù„ÙŠ</h3>
        <div class="h-64"><canvas id="financeChart"></canvas></div>
      </div>
    </div>

    <div class="bg-white p-6 rounded-2xl">
      <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-gray-700 dark:text-gray-200">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø£Ø®ÙŠØ±</h3>
        <button onclick="clearLogs()" class="text-xs text-rose-600 hover:underline">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
      </div>
      <ul id="contractLogs" class="space-y-2 text-sm text-gray-600 dark:text-gray-400 max-h-48 overflow-y-auto pr-2"></ul>
    </div>
  </section>

  <!-- ============= PROPERTIES ============= -->
  <section id="properties-view" class="view hidden">
    <div class="flex flex-wrap items-center justify-between mb-6 gap-4">
      <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙˆØ§Ù„ÙˆØ­Ø¯Ø§Øª</h2>

      <div class="flex flex-wrap gap-2 items-center">
        <div class="flex bg-white rounded-lg shadow border border-gray-100 dark:border-gray-700 p-0.5 ml-2">
          <button onclick="expandAllProperties()" class="px-3 py-1.5 text-xs font-bold text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" title="ØªÙˆØ³ÙŠØ¹ Ø§Ù„ÙƒÙ„">
            ğŸ”½ ØªÙˆØ³ÙŠØ¹
          </button>
          <div class="w-px bg-gray-200 dark:bg-gray-700 my-1"></div>
          <button onclick="collapseAllProperties()" class="px-3 py-1.5 text-xs font-bold text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" title="Ø·ÙŠ Ø§Ù„ÙƒÙ„">
            â—€ï¸ Ø·ÙŠ
          </button>
        </div>

        <div class="relative">
          <input type="text" id="prop-search" placeholder="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹..." class="pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 w-56 text-sm" oninput="renderProperties()">
          <span class="absolute left-3 top-2.5 text-gray-400 text-sm">ğŸ”</span>
        </div>

        <button onclick="openPropertyModal()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg shadow flex items-center gap-2 text-sm">
          <span>+</span> Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø§Ø±
        </button>
      </div>
    </div>
    <div id="properties-container" class="space-y-6"></div>
  </section>

  <!-- ============= LEASES ============= -->
  <section id="leases-view" class="view hidden">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¯</h2>
      <button onclick="openAddLeaseModal()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg shadow">Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯</button>
    </div>
    <div class="bg-white p-4 rounded-xl mb-4 flex flex-wrap gap-3 items-center">
      <span class="font-semibold text-gray-600 dark:text-gray-300">ÙØ±Ø² Ø­Ø³Ø¨:</span>
      <button onclick="setLeaseSort('end')" class="px-3 py-1 rounded bg-gray-100 dark:bg-gray-700 hover:bg-purple-100 hover:text-purple-700 text-sm">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</button>
      <button onclick="setLeaseSort('rent')" class="px-3 py-1 rounded bg-gray-100 dark:bg-gray-700 hover:bg-purple-100 hover:text-purple-700 text-sm">Ø§Ù„Ù‚ÙŠÙ…Ø©</button>
      <button onclick="setLeaseSort('tenant')" class="px-3 py-1 rounded bg-gray-100 dark:bg-gray-700 hover:bg-purple-100 hover:text-purple-700 text-sm">Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</button>
      <div class="border-r h-6 mx-2 dark:border-gray-600"></div>
      <input id="lease-search-input" placeholder="Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ Ø£Ùˆ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±..." class="border p-1 px-3 rounded text-sm w-64" oninput="renderLeases()">
    </div>
    <div class="table-wrap bg-white shadow-sm">
      <table class="min-w-full">
        <thead>
          <tr>
            <th class="w-1/6">Ø§Ù„Ø¹Ù‚Ø§Ø± / Ø§Ù„ÙˆØ­Ø¯Ø©</th>
            <th class="w-1/6">Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</th>
            <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
            <th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯</th>
            <th>Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th>
            <th>Ø§Ù„Ù†Ù‡Ø§ÙŠØ©</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="leases-table-body"></tbody>
      </table>
    </div>
  </section>

  <!-- ============= TENANTS ============= -->
  <section id="tenants-view" class="view hidden">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ†</h2>
    </div>
    <div class="bg-white p-4 rounded-xl mb-4 shadow-sm">
      <input id="tenants-search" class="w-full border p-2 rounded-lg focus:ring-2 focus:ring-purple-500 outline-none" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ£Ø¬Ø± Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙ Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯..." oninput="renderTenants()">
    </div>
    <div class="table-wrap bg-white shadow-sm">
      <table class="min-w-full">
        <thead>
          <tr>
            <th>Ø§Ù„Ø§Ø³Ù…</th>
            <th>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</th>
            <th>Ø§Ù„ÙˆØ­Ø¯Ø§Øª</th>
            <th>Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø³Ù†ÙˆÙŠ</th>
            <th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
            <th>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="tenants-table-body"></tbody>
      </table>
    </div>
  </section>

  <!-- ============= CHEQUES ============= -->
  <section id="cheques-view" class="view hidden">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´ÙŠÙƒØ§Øª</h2>
      <button onclick="openChequeModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow">Ø¥Ø¶Ø§ÙØ© Ø´ÙŠÙƒ Ø¬Ø¯ÙŠØ¯</button>
    </div>
    <div class="table-wrap bg-white shadow-sm">
      <table class="min-w-full">
        <thead>
          <tr>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th>
            <th>Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</th>
            <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
            <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
            <th>Ø§Ù„Ø¨Ù†Ùƒ / Ø±Ù‚Ù… Ø§Ù„Ø´ÙŠÙƒ</th>
            <th>ØµÙˆØ±Ø© Ø§Ù„Ø´ÙŠÙƒ</th>
            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="cheques-table-body"></tbody>
      </table>
    </div>
  </section>

  <!-- ============= PAYMENTS ============= -->
  <section id="payments-view" class="view hidden">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h2>
      <button onclick="openPaymentModal()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg shadow">ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white p-4 rounded shadow border-t-4 border-emerald-500 text-center">
        <p class="text-xs text-gray-500 dark:text-gray-400">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙØ¹Ø§Øª</p>
        <p id="payments-total" class="font-bold text-xl text-emerald-700 dark:text-emerald-400">0</p>
      </div>
    </div>
    <div class="table-wrap bg-white shadow-sm">
      <table class="min-w-full">
        <thead>
          <tr>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± / Ø§Ù„ÙˆØ­Ø¯Ø©</th>
            <th>Ø§Ù„Ù†ÙˆØ¹</th>
            <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
            <th>Ø§Ù„Ù…Ø³ØªØ­Ù‚ / Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø§Ù„Ø³Ù†Ø¯</th>
          </tr>
        </thead>
        <tbody id="payments-table-body"></tbody>
      </table>
    </div>
  </section>

  <!-- ============= EXPENSES ============= -->
  <section id="expenses-view" class="view hidden">
    <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-white">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h2>
    <div class="grid md:grid-cols-3 gap-6">
      <form id="new-expense-form" class="bg-white p-6 rounded-xl shadow-sm space-y-4 h-fit">
        <h3 class="font-bold text-gray-700 dark:text-gray-200">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯</h3>
        <input id="expense-date" type="date" class="w-full border p-2 rounded" required>
        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ</label>
          <select id="expense-type" class="w-full border p-2 rounded" required>
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹...</option>
            <option value="ØµÙŠØ§Ù†Ø©">ØµÙŠØ§Ù†Ø©</option>
            <option value="Ø±Ø³ÙˆÙ… ÙƒÙ‡Ø±Ø¨Ø§Ø¡ ÙˆÙ…Ø§Ø¡">Ø±Ø³ÙˆÙ… ÙƒÙ‡Ø±Ø¨Ø§Ø¡ ÙˆÙ…Ø§Ø¡</option>
            <option value="Ø±Ø³ÙˆÙ… Ø¨Ù„Ø¯ÙŠØ©">Ø±Ø³ÙˆÙ… Ø¨Ù„Ø¯ÙŠØ©</option>
            <option value="Ù…Ø­ÙƒÙ…Ø©">Ù…Ø­ÙƒÙ…Ø©</option>
            <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
          </select>
        </div>
        <input id="expense-amount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº (AED)" class="w-full border p-2 rounded" required>
        <textarea id="expense-details" placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ..." class="w-full border p-2 rounded h-24" required></textarea>
        <button class="w-full bg-rose-600 text-white py-2 rounded shadow">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ</button>
      </form>
      <div class="md:col-span-2 table-wrap bg-white shadow-sm rounded-xl">
        <table class="min-w-full">
          <thead>
            <tr>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ø§Ù„Ù†ÙˆØ¹</th>
              <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
              <th>Ø§Ù„Ø¨ÙŠØ§Ù†</th>
              <th class="text-center">Ø§Ù„Ø³Ù†Ø¯ / ØªØ­ÙƒÙ…</th>
            </tr>
          </thead>
          <tbody id="expenses-table-body"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ============= SALARIES ============= -->
  <section id="salaries-view" class="view hidden">
    <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-white">Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ø­Ø§Ø±Ø³ ÙˆØ§Ù„Ø¹Ù…Ø§Ù„</h2>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="md:col-span-1">
        <form id="salary-form" class="bg-white dark:bg-dark-surface p-6 rounded-xl shadow-sm space-y-4 sticky top-4">
          <h3 class="font-bold text-gray-700 dark:text-gray-200 border-b dark:border-dark-border pb-2">ØªØ³Ø¬ÙŠÙ„ Ø±Ø§ØªØ¨ Ø¬Ø¯ÙŠØ¯</h3>

          <div>
            <label class="text-xs text-gray-500 dark:text-gray-400">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</label>
            <input id="sal-name" class="w-full border p-2 rounded" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯ Ø¹Ù„ÙŠ" required>
          </div>

          <div>
            <label class="text-xs text-gray-500 dark:text-gray-400">Ø§Ù„ÙˆØ¸ÙŠÙØ©</label>
            <select id="sal-role" class="w-full border p-2 rounded">
              <option value="Ø­Ø§Ø±Ø³">Ø­Ø§Ø±Ø³</option>
              <option value="Ø¹Ø§Ù…Ù„ Ù†Ø¸Ø§ÙØ©">Ø¹Ø§Ù…Ù„ Ù†Ø¸Ø§ÙØ©</option>
              <option value="ØµÙŠØ§Ù†Ø©">ÙÙ†ÙŠ ØµÙŠØ§Ù†Ø©</option>
              <option value="Ø¥Ø¯Ø§Ø±ÙŠ">Ø¥Ø¯Ø§Ø±ÙŠ</option>
              <option value="Ø¢Ø®Ø±">Ø¢Ø®Ø±</option>
            </select>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="text-xs text-gray-500 dark:text-gray-400">Ø§Ù„Ù…Ø¨Ù„Øº</label>
              <input id="sal-amount" type="number" class="w-full border p-2 rounded" required>
            </div>
            <div>
              <label class="text-xs text-gray-500 dark:text-gray-400">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
              <input id="sal-date" type="date" class="w-full border p-2 rounded" required>
            </div>
          </div>

          <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded border dark:border-gray-700">
            <label class="text-xs font-bold text-gray-700 dark:text-gray-300 block mb-2">Ø±Ø§ØªØ¨ Ø´Ù‡Ø±:</label>
            <div class="flex gap-2">
              <select id="sal-month" class="w-2/3 border p-2 rounded text-sm">
                <option value="ÙŠÙ†Ø§ÙŠØ±">ÙŠÙ†Ø§ÙŠØ±</option>
                <option value="ÙØ¨Ø±Ø§ÙŠØ±">ÙØ¨Ø±Ø§ÙŠØ±</option>
                <option value="Ù…Ø§Ø±Ø³">Ù…Ø§Ø±Ø³</option>
                <option value="Ø£Ø¨Ø±ÙŠÙ„">Ø£Ø¨Ø±ÙŠÙ„</option>
                <option value="Ù…Ø§ÙŠÙˆ">Ù…Ø§ÙŠÙˆ</option>
                <option value="ÙŠÙˆÙ†ÙŠÙˆ">ÙŠÙˆÙ†ÙŠÙˆ</option>
                <option value="ÙŠÙˆÙ„ÙŠÙˆ">ÙŠÙˆÙ„ÙŠÙˆ</option>
                <option value="Ø£ØºØ³Ø·Ø³">Ø£ØºØ³Ø·Ø³</option>
                <option value="Ø³Ø¨ØªÙ…Ø¨Ø±">Ø³Ø¨ØªÙ…Ø¨Ø±</option>
                <option value="Ø£ÙƒØªÙˆØ¨Ø±">Ø£ÙƒØªÙˆØ¨Ø±</option>
                <option value="Ù†ÙˆÙÙ…Ø¨Ø±">Ù†ÙˆÙÙ…Ø¨Ø±</option>
                <option value="Ø¯ÙŠØ³Ù…Ø¨Ø±">Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
              </select>
              <select id="sal-year" class="w-1/3 border p-2 rounded text-sm"></select>
            </div>
          </div>

          <button class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded shadow transition-colors">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø±Ø§ØªØ¨</button>
        </form>
      </div>

      <div class="md:col-span-2 space-y-6">
        <div class="grid grid-cols-2 gap-4">
          <div class="bg-white dark:bg-dark-surface p-4 rounded-xl shadow border-r-4 border-indigo-500">
            <p class="text-xs text-gray-500 dark:text-gray-400">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©</p>
            <p id="total-salaries" class="text-xl font-bold text-gray-800 dark:text-white">0 AED</p>
          </div>
          <div class="bg-white dark:bg-dark-surface p-4 rounded-xl shadow border-r-4 border-teal-500">
            <p class="text-xs text-gray-500 dark:text-gray-400">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</p>
            <p id="count-salaries" class="text-xl font-bold text-gray-800 dark:text-white">0</p>
          </div>
        </div>

        <div class="table-wrap bg-white dark:bg-dark-surface shadow-sm rounded-xl">
          <table class="min-w-full">
            <thead class="bg-gray-50 dark:bg-dark-bg">
              <tr>
                <th class="py-3 px-4">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th class="py-3 px-4">Ø§Ù„Ù…ÙˆØ¸Ù</th>
                <th class="py-3 px-4">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                <th class="py-3 px-4">Ø§Ù„Ø¨ÙŠØ§Ù†</th>
                <th class="py-3 px-4 text-center">Ø§Ù„Ø³Ù†Ø¯</th>
                <th class="py-3 px-4 text-center">Ø­Ø°Ù</th>
              </tr>
            </thead>
            <tbody id="salaries-table-body" class="divide-y divide-gray-100 dark:divide-gray-700"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- ============= RECEIPTS HISTORY ============= -->
  <section id="receipts-history-view" class="view hidden">
    <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-white">Ø³Ø¬Ù„ Ø§Ù„Ø³Ù†Ø¯Ø§Øª (Ù‚Ø¨Ø¶ ÙˆØµØ±Ù)</h2>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="bg-white p-4 rounded-xl shadow border-r-4 border-emerald-500 text-center">
        <p class="text-xs text-gray-500 dark:text-gray-400">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ù†Ø¯Ø§Øª Ø§Ù„Ù‚Ø¨Ø¶ (Ø§Ù„Ø¯ÙØ¹Ø§Øª)</p>
        <p id="total-receipt-vouchers" class="font-bold text-xl text-emerald-700 dark:text-emerald-400">0 AED</p>
      </div>
      <div class="bg-white p-4 rounded-xl shadow border-r-4 border-rose-500 text-center">
        <p class="text-xs text-gray-500 dark:text-gray-400">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ù†Ø¯Ø§Øª Ø§Ù„ØµØ±Ù (Ø§Ù„Ø±ÙˆØ§ØªØ¨ ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª)</p>
        <p id="total-payment-vouchers" class="font-bold text-xl text-rose-700 dark:text-rose-400">0 AED</p>
      </div>
      <div class="bg-white p-4 rounded-xl shadow border-r-4 border-blue-500 text-center">
        <p class="text-xs text-gray-500 dark:text-gray-400">Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ù†Ø¯Ø§Øª Ø§Ù„ÙƒÙ„ÙŠ</p>
        <p id="total-vouchers-count" class="font-bold text-xl text-blue-700 dark:text-blue-400">0</p>
      </div>
    </div>

    <div class="table-wrap bg-white shadow-sm">
      <table class="min-w-full">
        <thead>
          <tr>
            <th class="w-[100px]">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th class="w-[100px]">Ø§Ù„Ù†ÙˆØ¹</th>
            <th class="w-[120px]">Ø§Ù„Ù…Ø¨Ù„Øº</th>
            <th class="w-[200px]">Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±</th>
            <th>Ø§Ù„Ø¨ÙŠØ§Ù†</th>
            <th class="w-[80px]">Ø¹Ø±Ø¶ Ø§Ù„Ø³Ù†Ø¯</th>
          </tr>
        </thead>
        <tbody id="receipts-history-table-body"></tbody>
      </table>
    </div>
  </section>

  <!-- ============= RECEIPT VIEW ============= -->
  <section id="receipt-view" class="view hidden">
    <div class="max-w-4xl mx-auto">
      <h2 id="receipt-main-title" class="text-2xl font-bold mb-6 text-gray-800 dark:text-white">Ø¥ØµØ¯Ø§Ø± Ø³Ù†Ø¯</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <form id="receipt-form" class="md:col-span-1 bg-white p-6 rounded-xl shadow-sm space-y-4 h-fit hidden">
          <button type="submit">generate</button>
        </form>

        <div class="md:col-span-3">
          <button onclick="showView('receipts-history')" id="back-to-source-btn" class="mb-4 inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-gray-200 bg-white text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-emerald-500/40 dark:border-slate-700 dark:bg-slate-800 dark:text-gray-100 dark:hover:bg-slate-700">â†©ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø³Ø¬Ù„ Ø§Ù„Ø³Ù†Ø¯Ø§Øª</button>

          <div id="receipt-preview" class="bg-white p-8 rounded shadow-lg border relative">
            <div id="printable-receipt" class="p-4 border-2 border-double border-gray-300 text-gray-800 bg-white">
              <div class="flex justify-between items-start border-b-2 border-gray-200 pb-4 mb-6">
                <div>
                  <h1 id="rv-building-name" class="text-xl font-bold text-gray-800">Ø¨Ù†Ø§ÙŠØ© ÙˆØ±Ø«Ø© Ø¬Ù…Ø¹Ø© Ø¹Ø¨ÙŠØ¯ Ø£Ø¨ÙˆØ§Ù„Ø´ÙˆØ§Ø±Ø¨</h1>
                  <p id="rv-building-location" class="text-sm text-gray-600">Ø§Ù„Ø¹ÙŠÙ†ØŒ Ø¨Ø·Ø­Ø§Ø¡ Ø§Ù„Ø­Ø§Ø¦Ø±</p>
                  <p id="rv-building-phone" class="text-sm text-gray-600">00971503343600</p>
                </div>
                <div class="text-center">
                  <h2 id="rv-title" class="text-3xl font-black text-emerald-700 tracking-wider">Ø³Ù†Ø¯ Ù‚Ø¨Ø¶</h2>
                  <p id="rv-subtitle" class="text-xs uppercase tracking-widest text-gray-400">Receipt Voucher</p>
                </div>
              </div>

              <div class="flex justify-between mb-8 text-sm">
                <p><strong>Ø±Ù‚Ù… Ø§Ù„Ø³Ù†Ø¯:</strong> <span id="rv-no" class="text-rose-600 font-mono font-bold text-lg"></span></p>
                <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> <span id="rv-date-out"></span></p>
              </div>
              <div class="space-y-4 mb-8">
                <div class="flex border-b border-dotted border-gray-300 pb-2">
                  <span id="rv-party-label" class="w-32 font-bold text-gray-700">Ø§Ø³ØªÙ„Ù…Ù†Ø§ Ù…Ù†:</span>
                  <span id="rv-tenant-out" class="flex-1 text-lg"></span>
                </div>
                <div class="flex border-b border-dotted border-gray-300 pb-2">
                  <span class="w-32 font-bold text-gray-700">Ù…Ø¨Ù„Øº ÙˆÙ‚Ø¯Ø±Ù‡:</span>
                  <span class="flex-1 font-bold text-xl text-emerald-700"><span id="rv-amount-out"></span> AED</span>
                </div>
                <div class="flex border-b border-dotted border-gray-300 pb-2">
                  <span class="w-32 font-bold text-gray-700">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</span>
                  <span id="rv-method-out" class="flex-1"></span>
                </div>
                <div class="flex border-b border-dotted border-gray-300 pb-2">
                  <span class="w-32 font-bold text-gray-700">ÙˆØ°Ù„Ùƒ Ø¹Ù†:</span>
                  <span id="rv-for-out" class="flex-1"></span>
                </div>
              </div>
              <div class="flex justify-between mt-12 pt-8 border-t border-gray-200">
                <div class="text-center w-1/3">
                  <p class="font-bold text-sm mb-4">Ø§Ù„Ù…Ø³ØªÙ„Ù… / Ø§Ù„Ù…Ø­Ø§Ø³Ø¨</p>
                  <div class="h-0 border-b border-gray-400 w-2/3 mx-auto"></div>
                </div>
                <div class="text-center w-1/3">
                  <p class="font-bold text-sm mb-4">Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ / Ø§Ù„Ø®ØªÙ…</p>
                  <div class="w-20 h-20 border-2 border-gray-200 rounded-full mx-auto opacity-50"></div>
                </div>
              </div>
            </div>
            <div class="mt-6 flex justify-end gap-3 no-print">
              <button onclick="downloadReceiptPDF()" class="bg-rose-600 hover:bg-rose-700 text-white px-4 py-2 rounded flex items-center gap-2">ğŸ“„ ØªØµØ¯ÙŠØ± PDF</button>
              <button onclick="window.print()" class="bg-gray-800 hover:bg-gray-900 text-white px-4 py-2 rounded flex items-center gap-2">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ============= REPORTS ============= -->
  <section id="reports-view" class="view hidden">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„Ø©</h2>
      <div class="flex gap-2">
        <button onclick="window.print()" class="bg-gray-700 text-white px-4 py-2 rounded">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
      </div>
    </div>
    <div id="printable-area" class="bg-white p-8 rounded shadow-lg space-y-8 text-gray-800">
      <div class="text-center border-b pb-4 mb-4">
        <h1 class="text-2xl font-bold text-emerald-700">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª ÙˆØ§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ†</h1>
        <p class="text-gray-500">ØªÙ… Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨ØªØ§Ø±ÙŠØ®: <span id="report-date"></span></p>
      </div>
      <div>
        <h3 class="font-bold text-lg mb-2 text-indigo-700 border-r-4 border-indigo-700 pr-2">Ù…Ù„Ø®Øµ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</h3>
        <div id="tenants-summary-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mt-4"></div>
      </div>
      <hr>
      <div>
        <h3 class="font-bold text-lg mb-2 text-rose-700 border-r-4 border-rose-700 pr-2">Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h3>
        <ul id="late-tenants-list" class="space-y-2 mt-2 text-sm bg-rose-50 p-4 rounded text-gray-800"></ul>
      </div>

      <div class="mt-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3">
          <h3 class="font-bold text-lg text-indigo-700 border-r-4 border-indigo-700 pr-2">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù‚ÙˆØ¯ (Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ø³Ø§Ø¨Ù‚Ø©)</h3>
          <div class="flex flex-col sm:flex-row gap-2 sm:items-center">
            <select id="report-lease-status-filter" class="border p-2 rounded text-sm bg-white dark:bg-gray-800 dark:border-gray-600">
              <option value="all">Ø§Ù„ÙƒÙ„</option>
              <option value="Ù…Ø¤Ø¬Ø±Ø©">Ù…Ø¤Ø¬Ø±Ø©</option>
              <option value="Ù…Ù†ØªÙ‡ÙŠØ©">Ù…Ù†ØªÙ‡ÙŠØ©</option>
              <option value="Ù…Ù„ØºØ§Ø©">Ù…Ù„ØºØ§Ø©</option>
              <option value="ØªØ¬Ø¯ÙŠØ¯ Ø¹Ù‚Ø¯">ØªØ¬Ø¯ÙŠØ¯ Ø¹Ù‚Ø¯</option>
              <option value="Ù…Ø®Ù„Ù‰">Ù…Ø®Ù„Ù‰</option>
            </select>
            <input id="report-lease-search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± / Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ / Ø§Ù„ÙˆØ­Ø¯Ø©..." class="border p-2 rounded text-sm w-full sm:w-72 bg-white dark:bg-gray-800 dark:border-gray-600" />
          </div>
        </div>

        <div class="flex flex-wrap gap-3 text-xs mb-3">
          <span id="report-leases-counts" class="px-3 py-1 rounded bg-indigo-50 text-indigo-700 border border-indigo-200 dark:bg-indigo-900/20 dark:text-indigo-200 dark:border-indigo-800"></span>
          <span class="px-3 py-1 rounded bg-gray-50 text-gray-700 border border-gray-200 dark:bg-gray-800 dark:text-gray-200 dark:border-gray-700">
            Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ù…Ù„ØºØ§Ø©/Ø§Ù„Ù…Ø¬Ø¯Ø¯Ø© ÙŠØªÙ… Ø­ÙØ¸Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¶Ù…Ù† Ø§Ù„Ø³Ø¬Ù„
          </span>
        </div>

        <div class="table-wrap bg-white shadow-sm">
          <table class="min-w-full">
            <thead>
              <tr>
                <th class="w-[170px]">Ø§Ù„Ø¹Ù‚Ø§Ø± / Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                <th class="w-[220px]">Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</th>
                <th class="w-[140px]">Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                <th class="w-[180px]">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯</th>
                <th class="w-[110px]">Ù…Ù†</th>
                <th class="w-[110px]">Ø¥Ù„Ù‰</th>
                <th class="w-[90px]">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ù…Ù„Ø§Ø­Ø¸Ø©</th>
                <th class="w-[130px]">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£Ø±Ø´ÙØ©</th>
              </tr>
            </thead>
            <tbody id="report-leases-body" class="divide-y divide-gray-100 dark:divide-gray-700"></tbody>
          </table>
        </div>
        <p id="report-leases-empty" class="hidden mt-3 text-sm text-gray-600 dark:text-gray-300"></p>
      </div>

    </div>
  </section>


  <!-- ============= NOTICES ============= -->
  <section id="notices-view" class="view hidden">
    <div class="flex flex-wrap items-center justify-between mb-6 gap-3 no-print">
      <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª</h2>
      <p class="text-sm text-gray-500 dark:text-gray-400">Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø·Ø§Ø¨Ø§Øª Ø±Ø³Ù…ÙŠØ© Ù…ÙˆØ¬Ù‡Ø© Ù„Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† ÙˆØ·Ø¨Ø§Ø¹ØªÙ‡Ø§</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø·Ø§Ø¨ -->
      <div class="bg-white p-6 rounded-2xl no-print">
        <h3 class="font-bold mb-4 text-gray-700 dark:text-gray-200">Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø·Ø§Ø¨</h3>

        <div class="space-y-3">
          <div>
            <label class="block text-sm font-semibold mb-1">Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</label>
            <select id="notice-tenant-select" class="w-full border p-2 rounded-lg" onchange="onNoticeTenantChange()">
              <option value="">Ø§Ø®ØªØ± Ù…Ø³ØªØ£Ø¬Ø±...</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-semibold mb-1">Ø§Ù„ÙˆØ­Ø¯Ø©</label>
            <select id="notice-unit-select" class="w-full border p-2 rounded-lg" disabled>
              <option value="">Ø§Ø®ØªØ± ÙˆØ­Ø¯Ø©...</option>
            </select>
            <p class="text-[11px] text-gray-400 mt-1">Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØ­Ø¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±.</p>
          </div>

          <div>
            <label class="block text-sm font-semibold mb-1">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø§Ø¨</label>
            <select id="notice-template-select" class="w-full border p-2 rounded-lg" onchange="resetNoticePreview()">
              <option value="blank">Ø®Ø·Ø§Ø¨ Ø±Ø³Ù…ÙŠ ÙØ§Ø±Øº (ÙŠÙÙƒØªØ¨ Ø­Ø³Ø¨ Ø±ØºØ¨Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„)</option>
              <option value="eviction">Ø¥Ø®Ø·Ø§Ø± Ø¨Ø¹Ø¯Ù… Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ ÙˆØ¥Ø®Ù„Ø§Ø¡ Ø§Ù„Ø¹ÙŠÙ† + Ø¨Ø±Ø§Ø¡Ø© Ø°Ù…Ø© ÙƒÙ‡Ø±Ø¨Ø§Ø¡/Ù…ÙŠØ§Ù‡</option>
              <option value="increase5">Ø¥Ø´Ø¹Ø§Ø± Ø²ÙŠØ§Ø¯Ø© Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚Ø¯ 5%</option>
                          <option value="arrearsRenew">Ø¥Ù†Ø°Ø§Ø± Ø¯ÙØ¹ Ù…ØªØ£Ø®Ø±Ø§Øª Ø¥ÙŠØ¬Ø§Ø±ÙŠØ© + ØªØ¬Ø¯ÙŠØ¯ Ø¹Ù‚Ø¯</option>
              <option value="arrearsCheque">Ø¥Ù†Ø°Ø§Ø± Ø¯ÙØ¹ Ù…ØªØ£Ø®Ø±Ø§Øª (Ø´ÙŠÙƒ Ø±Ø§Ø¬Ø¹/Ø¯ÙØ¹Ø© Ø£ÙˆÙ„Ù‰)</option>
</select>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
            <div>
              <label class="block text-sm font-semibold mb-1">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
              <input id="notice-date" type="date" class="w-full border p-2 rounded-lg dark:bg-gray-800 dark:text-white" onchange="resetNoticePreview()">
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">Ø±Ù‚Ù… Ø§Ù„Ø®Ø·Ø§Ø¨</label>
              <input id="notice-ref" class="w-full border p-2 rounded-lg bg-gray-50 dark:bg-gray-800 dark:text-white" placeholder="NT-00001" oninput="resetNoticePreview()">
            </div>
          </div>

          <div class="flex items-center gap-2 pt-1">
            <input id="notice-bilingual" type="checkbox" class="h-4 w-4" onchange="resetNoticePreview()">
            <label for="notice-bilingual" class="text-sm">Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø³Ø®Ø© English (Ø¹Ù…ÙˆØ¯ÙŠÙ†)</label>
          </div>

          <div id="notice-extra-options" class="hidden p-3 rounded-xl border border-gray-200 dark:border-gray-700 space-y-3">
            <!-- Ø®ÙŠØ§Ø±Ø§Øª Ø²ÙŠØ§Ø¯Ø© 5% -->
            <div id="notice-extra-increase5">
              <div class="flex items-center gap-2">
                <input id="notice-no-reply-accept" type="checkbox" class="h-4 w-4" checked onchange="resetNoticePreview()">
                <label for="notice-no-reply-accept" class="text-sm">Ø§Ø¹ØªØ¨Ø§Ø± Ø¹Ø¯Ù… Ø§Ù„Ø±Ø¯ Ø®Ù„Ø§Ù„ 7 Ø£ÙŠØ§Ù… Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø²ÙŠØ§Ø¯Ø©</label>
              </div>
            </div>

            <!-- Ø®ÙŠØ§Ø±Ø§Øª Ø¥Ù†Ø°Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª -->
            <div id="notice-extra-arrears" class="hidden space-y-3">
                            <div class="p-3 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/40">
                <div class="flex items-start gap-2">
                  <input id="notice-arrears-autofill" type="checkbox" class="h-4 w-4 mt-1" checked>
                  <div class="flex-1">
                    <label for="notice-arrears-autofill" class="text-sm font-semibold">ØªØ¹Ø¨Ø¦Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù…</label>
                    <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">ÙŠØ­Ø³Ø¨ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª Ù…Ù† Ø§Ù„Ø¯ÙØ¹Ø§Øª/Ø§Ù„Ø´ÙŠÙƒØ§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ÙˆÙ‡Ø°Ù‡ Ø§Ù„ÙˆØ­Ø¯Ø©. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©.</div>
                    <button type="button" onclick="autofillNoticeArrears(true)" class="mt-2 px-3 py-1.5 rounded-lg border text-sm hover:bg-gray-100 dark:hover:bg-gray-700">ğŸ”„ ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>
                  </div>
                </div>
              </div>

<div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                <div>
                  <label class="block text-sm font-semibold mb-1">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚Ø¯</label>
                  <input id="notice-contract-value" type="number" class="w-full border p-2 rounded-lg dark:bg-gray-800 dark:text-white" placeholder="Ù…Ø«Ø§Ù„: 47500" oninput="resetNoticePreview()">
                </div>
                <div>
                  <label class="block text-sm font-semibold mb-1">Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª / Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</label>
                  <input id="notice-arrears-amount" type="number" class="w-full border p-2 rounded-lg dark:bg-gray-800 dark:text-white" placeholder="Ù…Ø«Ø§Ù„: 14000" oninput="resetNoticePreview()">
                </div>
              </div>

              <div>
                <label class="block text-sm font-semibold mb-1">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input id="notice-arrears-details" class="w-full border p-2 rounded-lg dark:bg-gray-800 dark:text-white" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ (Ø´ÙŠÙƒ Ø±Ø§Ø¬Ø¹ Ù„Ø¹Ø¯Ù… ÙƒÙØ§ÙŠØ© Ø§Ù„Ø±ØµÙŠØ¯)" oninput="resetNoticePreview()">
              </div>
            </div>
          </div>

<div>
            <label class="block text-sm font-semibold mb-1">Ø¹Ù†ÙˆØ§Ù†/Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø®Ø·Ø§Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="notice-subject" class="w-full border p-2 rounded-lg" placeholder="Ù…Ø«Ø§Ù„: Ø¥Ù†Ø°Ø§Ø± Ø±Ø³Ù…ÙŠ..." oninput="resetNoticePreview()">
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 pt-2">
            <button onclick="buildNoticePreview()" class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg shadow">Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
            <button id="notice-print-btn" onclick="printNotice()" class="bg-gray-700 hover:bg-gray-800 text-white py-2 rounded-lg shadow disabled:opacity-50" disabled>ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
          </div>

          <div class="text-xs text-gray-500 dark:text-gray-400 leading-relaxed">
            Ù…Ù„Ø§Ø­Ø¸Ø©: ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ© ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙØ­Ø© ÙˆØ±Ø¨Ø·Ù‡Ø§ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù…. <b>Ù†ØµÙˆØµ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ø±Ø³Ù…ÙŠØ© ÙˆØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©</b> Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„Ù‡Ø§ ÙÙŠ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªØ§Ù„ÙŠØ© Ø­Ø³Ø¨ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø®Ø·Ø§Ø¨ Ø§Ù„Ù…Ø±ÙÙ‚.
          </div>
        </div>
      </div>

      <!-- Ù…Ø¹Ø§ÙŠÙ†Ø© -->
      <div class="bg-white p-6 rounded-2xl lg:col-span-2">
        <div class="flex items-center justify-between mb-3 no-print">
          <h3 class="font-bold text-gray-700 dark:text-gray-200">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø®Ø·Ø§Ø¨</h3>
          <span id="notice-preview-status" class="text-xs text-gray-500 dark:text-gray-400"></span>
        </div>

        <div id="notice-preview" class="border rounded-2xl p-6 min-h-[460px] bg-gray-50 dark:bg-gray-900/20">
          <div class="text-center text-gray-500 dark:text-gray-400">
            Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ÙˆÙ†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø§Ø¨ Ø«Ù… Ø§Ø¶ØºØ· <b>Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø§ÙŠÙ†Ø©</b>.
          </div>
        </div>
      </div>
    </div>
  </section>


  <!-- ============= SETTINGS ============= -->
  <section id="settings-view" class="view hidden">
    <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-white">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-white p-6 rounded-xl shadow-sm">
        <h3 class="font-bold mb-4 flex items-center gap-2">ğŸ“¦ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ (Backup)</h3>
        <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Ù‚Ù… Ø¨ØªØµØ¯ÙŠØ± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„ÙŠÙ‡Ø§ Ø£Ùˆ Ù†Ù‚Ù„Ù‡Ø§.</p>
        <div class="flex flex-wrap gap-2">
          <button onclick="exportBackupJSON()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow text-sm">ØªØµØ¯ÙŠØ± (JSON)</button>
          <button onclick="exportBackupExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow text-sm">ØªØµØ¯ÙŠØ± (Excel)</button>
        </div>
      </div>
      <div class="bg-white p-6 rounded-xl shadow-sm">
        <h3 class="font-bold mb-4 flex items-center gap-2">ğŸ“¥ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
        <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Ø§Ø³ØªØ±Ø¬Ø¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ù† Ù…Ù„Ù JSON Ù…Ø­ÙÙˆØ¸ Ù…Ø³Ø¨Ù‚Ø§Ù‹.</p>
        <input type="file" id="backup-file" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100 mb-3" onchange="importBackup(event)">
        <p id="backup-msg" class="text-xs h-4"></p>
      </div>
      <div class="bg-white p-6 rounded-xl shadow-sm">
        <h3 class="font-bold mb-4 flex items-center gap-2">ğŸ’° Ø·Ø±ÙŠÙ‚Ø© Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±</h3>
        <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Ø§Ø®ØªØ± Ù‡Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ù…Ø¯Ø®Ù„Ø© Ù„Ù„ÙˆØ­Ø¯Ø© ØªÙ…Ø«Ù„ Ù…Ø¨Ù„ØºÙ‹Ø§ Ø³Ù†ÙˆÙŠÙ‹Ø§ Ø£Ù… Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚Ø¯ ÙƒØ§Ù…Ù„Ø©. Ø³ÙŠØ¤Ø«Ø± Ù‡Ø°Ø§ Ø¹Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±.</p>
        <label class="block text-sm font-semibold mb-2">Ø§Ù„Ù‚ÙŠÙ…Ø© ØªÙ…Ø«Ù„</label>
        <select id="rent-basis-select" class="w-full border border-gray-200 dark:border-gray-600 rounded-lg px-3 py-2 bg-white dark:bg-gray-800 dark:text-white" onchange="saveRentBasisSetting()">
          <option value="total">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚Ø¯ ÙƒØ§Ù…Ù„Ø©</option>
          <option value="annual">Ø¥ÙŠØ¬Ø§Ø± Ø³Ù†ÙˆÙŠ</option>
        </select>
        <p class="text-xs text-gray-400 mt-2">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¥Ø°Ø§ Ø§Ø®ØªØ±Øª "Ø¥ÙŠØ¬Ø§Ø± Ø³Ù†ÙˆÙŠ" ÙØ³ÙŠØªÙ… Ø¶Ø±Ø¨Ù‡ ÙÙŠ Ù…Ø¯Ø© Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„ÙØ¹Ù„ÙŠØ©.</p>
      </div>

      <div class="bg-white p-6 rounded-xl shadow-sm border border-rose-100 dark:border-rose-900">
        <h3 class="font-bold mb-4 text-rose-700">âš ï¸ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø®Ø·Ø±</h3>
        <button onclick="if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ ØªÙ…Ø§Ù…Ø§Ù‹ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø´ÙŠØ¡ ÙˆØªÙØ±ÙŠØº Ø§Ù„Ù†Ø¸Ø§Ù…!')) clearAllData()" class="bg-rose-100 text-rose-700 hover:bg-rose-200 px-4 py-2 rounded w-full text-sm font-bold">ÙØ±Ù…ØªÙ‡ Ø§Ù„Ù†Ø¸Ø§Ù… (Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)</button>
      </div>
    </div>
  </section>

  <!-- ============= MODALS ============= -->

  <!-- Property Modal -->
  <div id="property-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white modal-content rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden animate-[fadeIn_0.2s_ease-out]">
      <div class="p-6 border-b bg-gray-50 dark:bg-gray-700 dark:border-gray-600 flex justify-between items-center">
        <h3 class="text-xl font-bold">Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø§Ø± Ø¬Ø¯ÙŠØ¯</h3>
        <button onclick="closePropertyModal()" class="text-gray-400 hover:text-gray-600">âœ•</button>
      </div>
      <form id="property-form" class="p-6 grid grid-cols-1 gap-4">
        <input id="prop-id" placeholder="Ø±Ù…Ø² Ø§Ù„Ø¹Ù‚Ø§Ø± (Ù…Ø«Ø§Ù„: PRP001)" class="border p-2 rounded w-full" required>
        <input id="prop-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±" class="border p-2 rounded w-full" required>
        <div class="grid grid-cols-2 gap-4">
          <input id="prop-type" placeholder="Ø§Ù„Ù†ÙˆØ¹ (ÙÙŠÙ„Ø§/Ø¨Ù†Ø§ÙŠØ©)" class="border p-2 rounded">
          <input id="prop-usage" placeholder="Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…" class="border p-2 rounded">
        </div>
        <input id="prop-location" placeholder="Ø§Ù„Ù…ÙˆÙ‚Ø¹" class="border p-2 rounded">
        <div class="flex justify-end gap-3 mt-4">
          <button type="button" onclick="closePropertyModal()" class="px-4 py-2 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded">Ø¥Ù„ØºØ§Ø¡</button>
          <button class="px-6 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700 shadow">Ø­ÙØ¸</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Unit Modal -->
  <div id="unit-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white modal-content rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden">
      <div class="p-6 border-b bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
        <h3 class="text-xl font-bold">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©</h3>
      </div>
      <form id="unit-form" class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="hidden" id="unit-prop-id">
        <input type="hidden" id="unit-id">
        <div class="md:col-span-2">
          <label class="text-xs text-gray-500 dark:text-gray-400">Ø§Ø³Ù…/Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©</label>
          <input id="unit-name" class="border p-2 rounded w-full" required>
        </div>
        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">Ø§Ù„Ù†ÙˆØ¹</label>
          <input id="unit-type" class="border p-2 rounded w-full">
        </div>
        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</label>
          <input id="unit-usage" class="border p-2 rounded w-full">
        </div>
        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">Ø§Ù„Ø­Ø§Ù„Ø©</label>
          <select id="unit-status" class="border p-2 rounded w-full">
            <option value="Ø´Ø§ØºØ±Ø©">Ø´Ø§ØºØ±Ø©</option>
            <option value="Ù…Ø¤Ø¬Ø±Ø©">Ù…Ø¤Ø¬Ø±Ø©</option>
            <option value="Ù…Ù†ØªÙ‡ÙŠØ©">Ù…Ù†ØªÙ‡ÙŠØ©</option>
          </select>
        </div>
        <div class="md:col-span-2 border-t dark:border-gray-600 pt-4 mt-2">
          <p class="font-bold text-gray-700 dark:text-gray-300 mb-2">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø¥Ù† ÙˆØ¬Ø¯)</p>
        </div>
        <div class="md:col-span-2">
          <input id="unit-tenant" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±" class="border p-2 rounded w-full">
        </div>
        <div>
          <input id="unit-rent" type="number" placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±ÙŠØ©" class="border p-2 rounded w-full">
        </div>
        <div>
          <input id="unit-contractNo" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯" class="border p-2 rounded w-full">
        </div>
        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯</label>
          <input id="unit-start" type="date" class="border p-2 rounded w-full">
        </div>
        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯</label>
          <input id="unit-end" type="date" class="border p-2 rounded w-full">
        </div>
        <div class="md:col-span-2 flex justify-end gap-3 mt-4 border-t dark:border-gray-600 pt-4">
          <button type="button" onclick="closeUnitModal()" class="px-4 py-2 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded">Ø¥Ù„ØºØ§Ø¡</button>
          <button class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 shadow">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Lease Modal -->
  <div id="lease-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white modal-content rounded-xl shadow-2xl w-full max-w-lg">
      <form id="lease-form" class="p-6 space-y-4">
        <h3 class="font-bold text-lg mb-4">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯</h3>
        <input type="hidden" id="lease-prop-id">
        <input type="hidden" id="lease-unit-id">
        <input id="lease-tenant" class="w-full border p-2 rounded" placeholder="Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±" required>
        <div class="grid grid-cols-2 gap-2">
          <input id="lease-rent" type="number" class="border p-2 rounded" placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø©">
          <input id="lease-contractNo" class="border p-2 rounded" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯">
        </div>
        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="text-xs">Ù…Ù†</label>
            <input id="lease-start" type="date" class="w-full border p-2 rounded">
          </div>
          <div>
            <label class="text-xs">Ø¥Ù„Ù‰</label>
            <input id="lease-end" type="date" class="w-full border p-2 rounded">
          </div>
        </div>
        <select id="lease-status" class="w-full border p-2 rounded">
          <option value="Ù…Ø¤Ø¬Ø±Ø©">Ù…Ø¤Ø¬Ø±Ø©</option>
          <option value="Ù…Ù†ØªÙ‡ÙŠØ©">Ù…Ù†ØªÙ‡ÙŠØ©</option>
        </select>
        <div class="flex justify-between pt-4">
          <button type="button" onclick="cancelLease()" class="text-rose-600 hover:bg-rose-50 dark:hover:bg-rose-900/20 px-3 py-1 rounded">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù‚Ø¯ ÙˆØ¥Ø®Ù„Ø§Ø¡ Ø§Ù„ÙˆØ­Ø¯Ø©</button>
          <div class="flex gap-2">
            <button type="button" onclick="closeLeaseModal()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded text-gray-800">Ø¥Ù„ØºØ§Ø¡</button>
            <button class="px-4 py-2 bg-blue-600 text-white rounded">Ø­ÙØ¸</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Lease Modal -->
  <div id="add-lease-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white modal-content rounded-xl shadow-2xl w-full max-w-lg">
      <form id="add-lease-form" class="p-6 space-y-4">
        <h3 class="font-bold text-xl mb-4">Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯</h3>
        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">Ø§Ù„Ø¹Ù‚Ø§Ø±</label>
          <select id="add-lease-prop" class="w-full border p-2 rounded"></select>
        </div>
        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">Ø§Ù„ÙˆØ­Ø¯Ø©</label>
          <select id="add-lease-unit" class="w-full border p-2 rounded"></select>
        </div>
        <input id="add-lease-tenant" class="w-full border p-2 rounded" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±" required>
        <div class="grid grid-cols-2 gap-3">
          <input id="add-lease-rent" type="number" class="border p-2 rounded" placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³Ù†ÙˆÙŠØ©">
          <input id="add-lease-contractNo" class="border p-2 rounded" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯">
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-xs text-gray-500 dark:text-gray-400">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡</label>
            <input id="add-lease-start" type="date" class="w-full border p-2 rounded">
          </div>
          <div>
            <label class="text-xs text-gray-500 dark:text-gray-400">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</label>
            <input id="add-lease-end" type="date" class="w-full border p-2 rounded">
          </div>
        </div>
        <div id="add-lease-errors" class="text-rose-600 text-sm"></div>
        <div class="flex justify-end gap-3 pt-4">
          <button type="button" onclick="closeAddLeaseModal()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded text-gray-800">Ø¥Ù„ØºØ§Ø¡</button>
          <button class="px-6 py-2 bg-emerald-600 text-white rounded shadow">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø¯</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Payment Modal -->
  <div id="payment-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white modal-content rounded-xl shadow-2xl w-full max-w-lg">
      <form id="payment-form" class="p-6 space-y-4">
        <h3 class="font-bold text-lg">ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
        <input id="pay-date" type="date" class="w-full border p-2 rounded" required>
        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">Ø§Ù„Ø¹Ù‚Ø¯</label>
          <select id="pay-contract" class="w-full border p-2 rounded"></select>
        </div>
        <select id="pay-type" class="w-full border p-2 rounded">
          <option>Ù†Ù‚Ø¯ÙŠ</option>
          <option>Ø´ÙŠÙƒ</option>
          <option>ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option>
        </select>
        <input id="pay-amount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº (AED)" class="w-full border p-2 rounded font-bold text-lg" required>
        <input id="pay-desc" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª / ÙˆØµÙ" class="w-full border p-2 rounded">
        <div class="flex justify-end gap-3 pt-4">
          <button type="button" onclick="closePaymentModal()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded text-gray-800">Ø¥Ù„ØºØ§Ø¡</button>
          <button class="px-6 py-2 bg-emerald-600 text-white rounded shadow">Ø­ÙØ¸ Ø§Ù„Ø¯ÙØ¹Ø©</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Tenant Modal -->
  <div id="tenant-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white modal-content rounded-xl shadow-2xl w-full max-w-md p-6">
      <h3 class="font-bold text-lg mb-4">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</h3>
      <form id="tenant-form" class="space-y-4">
        <input id="tenant-name" class="w-full border p-2 rounded bg-gray-100 dark:bg-gray-700" readonly>
        <input id="tenant-phone" class="w-full border p-2 rounded" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
        <input id="tenant-email" class="w-full border p-2 rounded" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
        <div class="flex justify-end gap-2 pt-2">
          <button type="button" onclick="closeTenantModal()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded text-gray-800">Ø¥ØºÙ„Ø§Ù‚</button>
          <button class="px-4 py-2 bg-blue-600 text-white rounded">Ø­ÙØ¸</button>
        </div>
        <div id="tenant-save-status" class="text-xs text-gray-500 text-right"></div>
      </form>
    </div>
  </div>

  <!-- Cheque Modal -->
  <div id="cheque-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white modal-content rounded-xl shadow-2xl w-full max-w-lg">
      <form id="new-cheque-form" class="p-6 space-y-4">
        <h3 id="cheque-modal-title" class="font-bold text-lg border-b pb-2 dark:border-gray-600">ØªØ³Ø¬ÙŠÙ„ Ø´ÙŠÙƒ Ø¬Ø¯ÙŠØ¯</h3>

        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</label>
          <select id="cheque-tenant-select" class="w-full border p-2 rounded" onchange="toggleTenantInput()">
            <option value="">Ø§Ø®ØªØ± Ù…Ø³ØªØ£Ø¬Ø± Ø­Ø§Ù„ÙŠ...</option>
            <option value="other">-- Ù…Ø³ØªØ£Ø¬Ø± Ø¬Ø¯ÙŠØ¯ / Ø¢Ø®Ø± --</option>
          </select>
          <input id="cheque-tenant-manual" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ÙŠØ¯ÙˆÙŠØ§Ù‹" class="w-full border p-2 rounded mt-2 hidden">
        </div>

        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">Ø§Ù„ÙˆØ­Ø¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <select id="cheque-unit-select" class="w-full border p-2 rounded" disabled>
            <option value="">â€” Ø¨Ø¯ÙˆÙ† Ø±Ø¨Ø· ÙˆØ­Ø¯Ø© â€”</option>
          </select>
          <p class="text-[11px] text-gray-500 dark:text-gray-400 mt-1">Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª Ø¨Ø¯Ù‚Ø©ØŒ ÙŠÙÙØ¶Ù‘Ù„ Ø±Ø¨Ø· Ø§Ù„Ø´ÙŠÙƒ Ø¨ÙˆØ­Ø¯Ø© Ù…Ø­Ø¯Ø¯Ø©.</p>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="text-xs text-gray-500 dark:text-gray-400">Ø±Ù‚Ù… Ø§Ù„Ø´ÙŠÙƒ</label>
            <input id="cheque-number" class="w-full border p-2 rounded" required>
          </div>
          <div>
            <label class="text-xs text-gray-500 dark:text-gray-400">Ø§Ù„Ù‚ÙŠÙ…Ø©</label>
            <input id="cheque-value" type="number" class="w-full border p-2 rounded" required>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="text-xs text-gray-500 dark:text-gray-400">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</label>
            <input id="cheque-due-date" type="date" class="w-full border p-2 rounded" required>
          </div>
          <div>
            <label class="text-xs text-gray-500 dark:text-gray-400">Ø§Ù„Ø¨Ù†Ùƒ</label>
            <input id="cheque-bank" class="w-full border p-2 rounded">
          </div>
        </div>

        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400 block mb-1">ØµÙˆØ±Ø© Ø§Ù„Ø´ÙŠÙƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="cheque-image" type="file" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
        </div>

        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
          <input id="cheque-purpose" class="w-full border p-2 rounded">
        </div>

        <div class="flex justify-end gap-3 pt-4 border-t dark:border-gray-700">
          <button type="button" onclick="closeChequeModal()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded text-gray-800">Ø¥Ù„ØºØ§Ø¡</button>
          <button class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded" id="cheque-modal-save-btn">Ø­ÙØ¸ Ø§Ù„Ø´ÙŠÙƒ</button>
        </div>
      </form>
    </div>
  
  <!-- ============= CHEQUE LINK MODAL (Link cheque to unit) ============= -->
  <div id="cheque-link-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white modal-content rounded-xl shadow-2xl w-full max-w-lg">
      <div class="p-6 space-y-4">
        <h3 class="font-bold text-lg border-b pb-2 dark:border-gray-600">Ø±Ø¨Ø· Ø§Ù„Ø´ÙŠÙƒ Ø¨ÙˆØ­Ø¯Ø©</h3>
        <div id="cheque-link-info" class="text-sm text-gray-600 dark:text-gray-300"></div>
        <div>
          <label class="text-xs text-gray-500 dark:text-gray-400">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø©</label>
          <select id="cheque-link-unit-select" class="w-full border p-2 rounded"></select>
          <p class="text-[11px] text-gray-500 dark:text-gray-400 mt-1">Ø§Ù„Ø±Ø¨Ø· ÙŠØ³Ø§Ø¹Ø¯ ÙÙŠ Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø®Ø§ØµØ© Ø¨ÙƒÙ„ ÙˆØ­Ø¯Ø©.</p>
        </div>
        <div class="flex justify-end gap-3 pt-4 border-t dark:border-gray-700">
          <button type="button" onclick="closeChequeLinkModal()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded text-gray-800">Ø¥Ù„ØºØ§Ø¡</button>
          <button type="button" onclick="confirmChequeLink()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">Ø­ÙØ¸ Ø§Ù„Ø±Ø¨Ø·</button>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
  // ================= DATA =================
  const initialProperties = [
    {
      "id": "PRP65351",
      "name": "ÙÙŠÙ„Ø§",
      "type": "ÙÙŠÙ„Ø§",
      "usage": "Ø³ÙƒÙ† Ø®Ø§Øµ",
      "location": "Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø¹ÙŠÙ† - ÙÙ„Ø¬ Ù‡Ø²Ø§Ø¹",
      "units": [
        {
          "id": "PRP65351_U1",
          "name": "ÙÙŠÙ„Ø§",
          "type": "ÙÙŠÙ„Ø§",
          "usage": "Ø³ÙƒÙ†ÙŠ",
          "status": "Ù…Ø¤Ø¬Ø±Ø©",
          "tenant": "HAMDAN ABDULLA ANAYAT GHULAM MOHAMMED",
          "rent": 100000,
          "contractNo": "202402876023",
          "start": "2024-10-15",
          "end": "2025-10-14"
        }
      ]
    },
    {
      "id": "PRP11751",
      "name": "Ø¨Ù†Ø§Ø¡ Ø²Ù‡Ø±Ø§Ø¡ ÙˆÙ„Ø·ÙŠÙØ© ÙˆØ¹Ø§ÙŠØ´Ø© Ø¹Ø¨ÙŠØ¯ Ø¨Ø§Ù„Ø´ÙˆØ§Ø±Ø¨",
      "type": "Ø¨Ù†Ø§ÙŠØ©",
      "usage": "ØªØ¬Ø§Ø±ÙŠ - ØµÙ†Ø§Ø¹ÙŠ",
      "location": "Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø¹ÙŠÙ† - Ø¨Ø·Ø­Ø§Ø¡ Ø§Ù„Ø­Ø§Ø¦Ø±",
      "units": [
        { "id":"UNT83591","name":"10-A","type":"Ù…ÙƒØªØ¨","usage":"ØªØ¬Ø§Ø±ÙŠ","status":"Ø´Ø§ØºØ±Ø©" },
        { "id":"UNT83609","name":"10-B","type":"Ù…ÙƒØªØ¨","usage":"ØªØ¬Ø§Ø±ÙŠ","status":"Ù…Ø¤Ø¬Ø±Ø©","tenant":"KASHMIR AL KHDHRA TILES & PLASTER WORKS EST","rent":9000,"contractNo":"202501709877","start":"2025-03-01","end":"2026-02-28" }
      ]
    }
  ];

  let properties = [], cheques = [], expenses = [], payments = [], tenantsContacts = {}, salaries = [];
  let editingChequeId = null;
  let pendingChequeAfterEditId = null;
  let pendingChequeAfterEditStatus = '';

  let currentTenantKey = null; // internal: active tenant key for modal

  let contractLogs = JSON.parse(localStorage.getItem('logs') || "[]");

  // Default header info
  const defaultHeader = {
    name: 'Ø¨Ù†Ø§ÙŠØ© ÙˆØ±Ø«Ø© Ø¬Ù…Ø¹Ø© Ø¹Ø¨ÙŠØ¯ Ø£Ø¨ÙˆØ§Ù„Ø´ÙˆØ§Ø±Ø¨',
    location: 'Ø§Ù„Ø¹ÙŠÙ†ØŒ Ø¨Ø·Ø­Ø§Ø¡ Ø§Ù„Ø­Ø§Ø¦Ø±',
    phone: '00971503343600'
  };

  // Voucher counters (sequential numbers)
  let voucherCounters = { receipt: 1, expense: 1, salary: 1 };

  // ================= UTILS & LOCAL STORAGE =================
  function formatAED(n){ return (n||0).toLocaleString('en-US') + ' AED'; }
  function tenantKey(name){ return String(name||'').trim().replace(/\s+/g,' ').toLowerCase(); }

  function normalizeChequeStatus(status){
    const s = String(status ?? '').trim();
    if(!s) return '';
    const ns = s.toLowerCase();

    // Arabic / English mappings
    if(ns.includes('Ù…ØµØ±ÙˆÙ') || ns.includes('ØªÙ… Ø§Ù„ØµØ±Ù') || ns.includes('ØµØ±Ù') || ns.includes('cashed') || ns.includes('cleared') || ns.includes('paid')) return 'Ù…ØµØ±ÙˆÙ';
    if(ns.includes('Ø±Ø§Ø¬Ø¹') || ns.includes('Ù…Ø±ØªØ¬Ø¹') || ns.includes('Ù…Ø±ÙÙˆØ¶') || ns.includes('returned') || ns.includes('bounce') || ns.includes('bounced')) return 'Ø±Ø§Ø¬Ø¹';
    if(ns.includes('Ø¨Ø§Ù†ØªØ¸Ø§Ø±') || ns.includes('Ù‚ÙŠØ¯') || ns.includes('pending') || ns.includes('await') || ns.includes('waiting') || ns.includes('not cashed')) return 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØµØ±Ù';

    // Already canonical?
    if(s === 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØµØ±Ù' || s === 'Ù…ØµØ±ÙˆÙ' || s === 'Ø±Ø§Ø¬Ø¹') return s;

    return s; // keep as-is (won't match buckets unless mapped above)
  }

  function normalizeChequeRecord(c){
    const out = { ...(c||{}) };

    // Normalize common field names from older versions
    out.id = out.id || out.chequeId || out.checkId || ('CHQ-' + Date.now() + Math.floor(Math.random()*1000));
    out.tenant = out.tenant || out.tenantName || out.tenant_name || out.name || out.client || '';
    out.chequeNo = out.chequeNo || out.number || out.chequeNumber || out.cheque_number || out.no || '';
    out.value = Number(out.value ?? out.amount ?? out.due ?? out.total ?? 0) || 0;
    out.dueDate = out.dueDate || out.date || out.due_date || out.due_at || '';
    out.bank = out.bank || out.bankName || out.bank_name || '';
    out.purpose = out.purpose || out.desc || out.description || '';
    out.unitId = out.unitId || out.unit || out.unit_id || out.unitID || '';
    out.unitLabel = out.unitLabel || out.unitName || out.unit_name || '';
    out.imageUrl = out.imageUrl || out.image || out.imgUrl || null;

    out.status = normalizeChequeStatus(out.status);
    if(!out.status){
      // Default based on due date (if any)
      try{
        out.status = (out.dueDate && new Date(out.dueDate) < new Date()) ? 'Ø±Ø§Ø¬Ø¹' : 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØµØ±Ù';
      }catch(e){
        out.status = 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØµØ±Ù';
      }
    }
    return out;
  }

  function chequeStatusBucket(status){
    const s = normalizeChequeStatus(status);
    if(s === 'Ø±Ø§Ø¬Ø¹') return 'returned';
    if(s === 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØµØ±Ù') return 'pending';
    if(s === 'Ù…ØµØ±ÙˆÙ') return 'cashed';
    return 'other';
  }


  

  // ======= Lease duration helpers (for reports: contract full value) =======
  function toUTCDate(dateStr){
    if(!dateStr) return null;
    const parts = String(dateStr).split('-').map(Number);
    if(parts.length !== 3) return null;
    const [y,m,d] = parts;
    if(!y || !m || !d) return null;
    // noon UTC to avoid timezone edge cases
    return new Date(Date.UTC(y, m-1, d, 12, 0, 0));
  }

  // Returns contract duration in years (can be fractional). End date is treated as inclusive.
  function contractYears(startStr, endStr){
    const start = toUTCDate(startStr);
    const end = toUTCDate(endStr);
    if(!start || !end) return 1;

    const endPlus1 = new Date(end.getTime());
    endPlus1.setUTCDate(endPlus1.getUTCDate() + 1);

    // If aligned on same day-of-month => exact month count (handles leap years cleanly)
    if(endPlus1.getUTCDate() === start.getUTCDate()){
      const months = (endPlus1.getUTCFullYear() - start.getUTCFullYear()) * 12
                   + (endPlus1.getUTCMonth() - start.getUTCMonth());
      const years = months / 12;
      return years > 0 ? years : 1;
    }

    const msPerDay = 24 * 60 * 60 * 1000;
    const days = Math.round((endPlus1 - start) / msPerDay);
    const years = days / 365.25;
    return years > 0 ? years : 1;
  }

  function calcContractValueFromAnnual(annualRent, startStr, endStr){
    const annual = Number(annualRent) || 0;
    return annual * contractYears(startStr, endStr);
  }


  // ================= RENT BASIS (annual vs total) =================
  function getRentBasis(){
    return localStorage.getItem('re_rent_basis') || 'total'; // 'total' | 'annual'
  }

  function calcUnitContractValue(u){
    const rent = (u && u.rent) ? Number(u.rent) : 0;
    if(!rent) return 0;
    const basis = getRentBasis();
    if(basis === 'annual'){
      return calcContractValueFromAnnual(rent, u.start, u.end);
    }
    return rent; // total contract value
  }

  function updateRentLabels(){
    const basis = getRentBasis();
    const lbl = document.getElementById('total-rent-label');
    if(lbl){
      lbl.textContent = (basis === 'annual')
        ? 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¯ (Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ø³Ù†ÙˆÙŠ Ã— Ù…Ø¯Ø© Ø§Ù„Ø¹Ù‚Ø¯)'
        : 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¯';
    }
  }

  function loadRentBasisSetting(){
    const sel = document.getElementById('rent-basis-select');
    if(sel) sel.value = getRentBasis();
    updateRentLabels();
  }

  function saveRentBasisSetting(){
    const sel = document.getElementById('rent-basis-select');
    if(!sel) return;
    localStorage.setItem('re_rent_basis', sel.value);
    updateRentLabels();
    updateDashboard();
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ù„Ùˆ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø© Ø£Ùˆ Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù†Øª Ù…Ø®ÙÙŠØ©
    try{ renderReports(); } catch(e){}
  }


  // ===== Lease History (Keep old contracts in reports) =====
  function ensureLeaseHistory(u){
    if(!u) return;
    if(!Array.isArray(u.leaseHistory)) u.leaseHistory = [];
  }

  function unitHasLeaseData(u){
    if(!u) return false;
    const hasMoney = Number(u.rent || 0) > 0;
    const hasText = !!(u.tenant || u.contractNo || u.start || u.end);
    return hasMoney || hasText;
  }

  function archiveUnitLease(u, reason, statusOverride){
    if(!u) return false;
    if(!unitHasLeaseData(u)) return false;
    ensureLeaseHistory(u);

    const entry = {
      tenant: u.tenant || '',
      rent: Number(u.rent || 0),
      contractNo: u.contractNo || '',
      start: u.start || '',
      end: u.end || '',
      status: normalizeLeaseStatus(statusOverride || (u.status || '')),
      prevStatus: u.status || '',
      reason: reason || '',
      archivedAt: new Date().toISOString()
    };
    u.leaseHistory.push(entry);
    return true;
  }

  function getAllLeaseRecords(){
    const records = [];
    (properties || []).forEach(p=>{
      (p.units || []).forEach(u=>{
        // current
        if(u.status !== 'Ø´Ø§ØºØ±Ø©' && unitHasLeaseData(u)){
          records.push({
            propId: p.id,
            propName: p.name,
            unitId: u.id,
            unitName: u.name,
            tenant: u.tenant || '',
            rent: Number(u.rent || 0),
            contractNo: u.contractNo || '',
            start: u.start || '',
            end: u.end || '',
            status: normalizeLeaseStatus(u.status || ''),
            reason: 'Ø­Ø§Ù„ÙŠ',
            archivedAt: ''
          });
        }
        // history
        ensureLeaseHistory(u);
        u.leaseHistory.forEach(h=>{
          records.push({
            propId: p.id,
            propName: p.name,
            unitId: u.id,
            unitName: u.name,
            tenant: h.tenant || '',
            rent: Number(h.rent || 0),
            contractNo: h.contractNo || '',
            start: h.start || '',
            end: h.end || '',
            status: normalizeLeaseStatus(h.status || ''),
            reason: h.reason || '',
            archivedAt: h.archivedAt || ''
          });
        });
      });
    });
    // sort: newest first (by archivedAt, else end, else start)
    records.sort((a,b)=>{
      const da = a.archivedAt ? new Date(a.archivedAt) : (a.end ? new Date(a.end) : (a.start ? new Date(a.start) : new Date(0)));
      const db = b.archivedAt ? new Date(b.archivedAt) : (b.end ? new Date(b.end) : (b.start ? new Date(b.start) : new Date(0)));
      return db - da;
    });
    return records;
  }

  function normalizeLeaseStatus(status){
    const s = (status || '').trim();
    if(s === 'Ù…Ø³ØªØ¨Ø¯Ù„Ø©' || s === 'Ø§Ø³ØªØ¨Ø¯Ø§Ù„') return 'ØªØ¬Ø¯ÙŠØ¯ Ø¹Ù‚Ø¯';
    return s;
  }

  function leaseStatusLabel(status){
    return normalizeLeaseStatus(status);
  }

  function leaseStatusBadge(status){
    status = normalizeLeaseStatus(status);
    if(status === 'Ù…Ø¤Ø¬Ø±Ø©') return 'badge badge-green';
    if(status === 'Ù…Ù†ØªÙ‡ÙŠØ©') return 'badge badge-red';
    if(status === 'Ù…Ù„ØºØ§Ø©') return 'badge badge-red';
    if(status === 'ØªØ¬Ø¯ÙŠØ¯ Ø¹Ù‚Ø¯') return 'badge badge-amber';
    if(status === 'Ù…Ø³ØªØ¨Ø¯Ù„Ø©') return 'badge badge-amber';
    if(status === 'Ù…Ø®Ù„Ù‰') return 'badge badge-red';
    return 'badge';
  }

  function renderLeaseArchiveReport(){
    const tbody = document.getElementById('report-leases-body');
    if(!tbody) return;

    const statusSel = document.getElementById('report-lease-status-filter');
    const qInput = document.getElementById('report-lease-search');
    const empty = document.getElementById('report-leases-empty');
    const counts = document.getElementById('report-leases-counts');

    // bind once
    if(statusSel && !statusSel.dataset.bound){
      statusSel.dataset.bound = '1';
      statusSel.addEventListener('change', renderLeaseArchiveReport);
    }
    if(qInput && !qInput.dataset.bound){
      qInput.dataset.bound = '1';
      qInput.addEventListener('input', renderLeaseArchiveReport);
    }

    const statusFilter = statusSel ? statusSel.value : 'all';
    const q = (qInput ? qInput.value : '').trim().toLowerCase();

    let recs = getAllLeaseRecords();

    // counts
    const c = { all: recs.length, active:0, ended:0, cancelled:0, renewed:0, vacated:0 };
    recs.forEach(r=>{
      if(normalizeLeaseStatus(r.status)==='Ù…Ø¤Ø¬Ø±Ø©') c.active++;
      else if(normalizeLeaseStatus(r.status)==='Ù…Ù†ØªÙ‡ÙŠØ©') c.ended++;
      else if(normalizeLeaseStatus(r.status)==='Ù…Ù„ØºØ§Ø©') c.cancelled++;
      else if(normalizeLeaseStatus(r.status)==='ØªØ¬Ø¯ÙŠØ¯ Ø¹Ù‚Ø¯') c.renewed++;
      else if(normalizeLeaseStatus(r.status)==='Ù…Ø®Ù„Ù‰') c.vacated++;
    });
    if(counts){
      counts.textContent = `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${c.all} â€¢ Ù…Ø¤Ø¬Ø±Ø©: ${c.active} â€¢ Ù…Ù†ØªÙ‡ÙŠØ©: ${c.ended} â€¢ Ù…Ù„ØºØ§Ø©: ${c.cancelled} â€¢ ØªØ¬Ø¯ÙŠØ¯ Ø¹Ù‚Ø¯: ${c.renewed} â€¢ Ù…Ø®Ù„Ù‰: ${c.vacated}`;
    }

    if(statusFilter !== 'all'){
      recs = recs.filter(r => normalizeLeaseStatus(r.status) === statusFilter);
    }

    if(q){
      recs = recs.filter(r=>{
        const hay = `${r.propName} ${r.unitName} ${r.tenant} ${r.contractNo}`.toLowerCase();
        return hay.includes(q);
      });
    }

    tbody.innerHTML = '';
    if(empty) empty.classList.add('hidden');

    if(recs.length === 0){
      if(empty){
        empty.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚ÙˆØ¯ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«/Ø§Ù„ÙÙ„ØªØ±.';
        empty.classList.remove('hidden');
      }
      return;
    }

    recs.forEach(r=>{
      const tr = document.createElement('tr');
      const archivedDate = r.archivedAt ? (new Date(r.archivedAt).toLocaleDateString('ar-AE')) : '-';
      tr.innerHTML = `
        <td class="px-3 py-3">
          <div class="font-bold text-gray-800 dark:text-white">${r.unitName || '-'}</div>
          <div class="text-xs text-gray-500 dark:text-gray-400">${r.propName || '-'}</div>
        </td>
        <td class="px-3 py-3 text-sm">${r.tenant || '-'}</td>
        <td class="px-3 py-3 font-mono text-emerald-700 dark:text-emerald-400">${formatAED(r.rent || 0)}</td>
        <td class="px-3 py-3 text-xs font-mono bg-gray-100 dark:bg-gray-800 rounded truncate-text" title="${r.contractNo || ''}">${r.contractNo || '-'}</td>
        <td class="px-3 py-3 text-xs">${r.start || '-'}</td>
        <td class="px-3 py-3 text-xs">${r.end || '-'}</td>
        <td class="px-3 py-3"><span class="${leaseStatusBadge(r.status)}">${leaseStatusLabel(r.status) || '-'}</span></td>
        <td class="px-3 py-3 text-xs text-gray-700 dark:text-gray-300">${r.reason || '-'}</td>
        <td class="px-3 py-3 text-xs">${archivedDate}</td>
      `;
      tbody.appendChild(tr);
    });
  }


function logAction(msg){
    contractLogs.unshift({m:msg, t:new Date().toISOString()});
    if(contractLogs.length>50) contractLogs.pop();
    localStorage.setItem('logs', JSON.stringify(contractLogs));
    renderLogs();
  }

  function clearLogs(){
    contractLogs=[];
    localStorage.setItem('logs','[]');
    renderLogs();
  }

  function saveToLocal(){
    localStorage.setItem('re_data_v2', JSON.stringify({ properties, cheques, expenses, payments, tenantsContacts, salaries }));
  }

  function loadFromLocal(){
    const d = localStorage.getItem('re_data_v2');
    if(d){
      try {
        const o = JSON.parse(d);
        if(o.properties) properties = o.properties;
        
        // Migration: ensure each unit has leaseHistory array (for keeping old contracts in reports)
        if(Array.isArray(properties)){
          properties.forEach(p=>{
            if(!p.units) p.units = [];
            p.units.forEach(u=>{
              if(!Array.isArray(u.leaseHistory)) u.leaseHistory = [];
            });
          });
        }
cheques = o.cheques || [];
        expenses = o.expenses || [];
        payments = o.payments || [];
        // migrate tenantsContacts to normalized keys for reliable saving/loading
        const rawContacts = o.tenantsContacts || {};
        tenantsContacts = {};
        Object.keys(rawContacts).forEach(k=>{
          const v = rawContacts[k] || {};
          const nk = tenantKey(v.name || k);
          if(!nk) return;
          if(!tenantsContacts[nk]){
            tenantsContacts[nk] = { name: v.name || k, phone: v.phone || '', email: v.email || '' };
          } else {
            // merge (keep existing if already set)
            tenantsContacts[nk].phone = tenantsContacts[nk].phone || (v.phone||'');
            tenantsContacts[nk].email = tenantsContacts[nk].email || (v.email||'');
          }
        });
        salaries = o.salaries || [];

        // Migration: ensure expenses have ID & type
        expenses = expenses.map(e => ({
          id: e.id || 'EXP-' + Date.now() + Math.floor(Math.random()*1000),
          date: e.date,
          type: e.type || 'Ø£Ø®Ø±Ù‰',
          amount: e.amount,
          details: e.details,
          voucherNo: e.voucherNo || null
        }));

        // Migration: normalize cheques (compatibility across versions)
        cheques = (o.cheques || []).map(normalizeChequeRecord);
        // Auto-infer unit link for cheques when the tenant has exactly one leased unit
        cheques = cheques.map(c=>{
          const nc = normalizeChequeRecord(c);
          if(!nc.unitId){
            const inferred = inferSingleLeasedUnitIdForTenant(nc.tenant);
            if(inferred) nc.unitId = inferred;
          }
          if(nc.unitId && !nc.unitLabel){
            nc.unitLabel = getUnitDisplayById(nc.unitId);
          }
          return nc;
        });

        // Migrate old cheque-linked payments to the proper unit label/unitId (if possible)
        (payments||[]).forEach(p=>{
          if(p && p.chequeId){
            migrateChequePaymentsToUnit(p.chequeId);
          }
        });

} catch(e){
        console.error("Error loading data", e);
      }
    } else {
      properties = JSON.parse(JSON.stringify(initialProperties));
      saveToLocal();
    }
    ensureVoucherNumbers();
  }

  function extractVoucherNumber(code){
    if(!code) return null;
    const parts = String(code).split('-');
    const numPart = parts[parts.length - 1];
    const n = parseInt(numPart, 10);
    return isNaN(n) ? null : n;
  }

  function recomputeVoucherCounters(){
    voucherCounters = { receipt:1, expense:1, salary:1 };
    payments.forEach(p => {
      const n = extractVoucherNumber(p.voucherNo);
      if(n && n >= voucherCounters.receipt) voucherCounters.receipt = n + 1;
    });
    expenses.forEach(e => {
      const n = extractVoucherNumber(e.voucherNo);
      if(n && n >= voucherCounters.expense) voucherCounters.expense = n + 1;
    });
    salaries.forEach(s => {
      const n = extractVoucherNumber(s.voucherNo);
      if(n && n >= voucherCounters.salary) voucherCounters.salary = n + 1;
    });
  }

  function nextVoucherNumber(type){
    if(!voucherCounters[type]) voucherCounters[type] = 1;
    const prefixMap = { receipt:'R', expense:'P', salary:'S' };
    const prefix = prefixMap[type] || 'V';
    const n = voucherCounters[type]++;
    return `${prefix}-${String(n).padStart(4,'0')}`;
  }

  function ensureVoucherNumbers(){
    recomputeVoucherCounters();
    let updated = false;

    payments.forEach(p => {
      if(!p.voucherNo){
        p.voucherNo = nextVoucherNumber('receipt');
        updated = true;
      }
    });
    expenses.forEach(e => {
      if(!e.voucherNo){
        e.voucherNo = nextVoucherNumber('expense');
        updated = true;
      }
    });
    salaries.forEach(s => {
      if(!s.voucherNo){
        s.voucherNo = nextVoucherNumber('salary');
        updated = true;
      }
    });

    if(updated) saveToLocal();
  }

  // ================= VIEW LOGIC =================
  function showView(id){
    document.querySelectorAll('.view').forEach(v=>v.classList.add('hidden'));
    document.getElementById(id+'-view')?.classList.remove('hidden');
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById('nav-'+id)?.classList.add('active');

    if(id==='dashboard') updateDashboard();
    else if(id==='properties') renderProperties();
    else if(id==='leases') renderLeases();
    else if(id==='tenants') renderTenants();
    else if(id==='cheques') renderCheques();
    else if(id==='payments') renderPayments();
    else if(id==='expenses') renderExpenses();
    else if(id==='salaries') renderSalaries();
    else if(id==='receipts-history') renderReceiptsHistory();
    else if(id==='reports') renderReports();
    else if(id==='notices') renderNotices();
  }


  // ================= NOTICES / LETTERS =================

  const NOTICE_LETTERHEAD = {
    topLines: [
      'Ø¨Ù†Ø§ÙŠØ© ÙˆØ±Ø«Ø© Ø¬Ù…Ø¹Ø© Ø¹Ø¨ÙŠØ¯ Ø£Ø¨Ùˆ Ø§Ù„Ø´ÙˆØ§Ø±Ø¨',
      'Ø§Ù„Ø¹ÙŠÙ†ØŒ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ©ØŒ Ø¨Ø·Ø­Ø§Ø¡ Ø§Ù„Ø­Ø§Ø¦Ø±',
      '24-04-014-18'
    ],
    footerLines: [
      'Mohammed Abdulrahim Ahli',
      'UAE, Al Ain',
      'Po Box: 1148',
      '+971503343600',
      'Mohd_Ahli@live.com'
    ]
  };

  function getRentBasisSetting(){ return localStorage.getItem('re_rent_basis') || 'total'; }

  function getNextNoticeNo(){
    let n = parseInt(localStorage.getItem('re_notice_counter') || '1', 10);
    if(!n || n < 1) n = 1;
    const code = 'NT-' + String(n).padStart(5,'0');
    localStorage.setItem('re_notice_counter', String(n + 1));
    return code;
  }

  function formatEnglishDate(dateStr){
    const d = dateStr ? new Date(dateStr) : new Date();
    if(isNaN(d)) return '';
    return d.toLocaleDateString('en-GB', { day:'2-digit', month:'long', year:'numeric' });
  }

  function formatArabicDate(dateStr){
    const d = dateStr ? new Date(dateStr) : new Date();
    if(isNaN(d)) return '';
    return d.toLocaleDateString('ar-AE', { year:'numeric', month:'long', day:'numeric' });
  }

  function findUnitByComposite(composite){
    if(!composite) return { prop:null, unit:null };
    const [pid, uid] = String(composite).split('::');
    const prop = properties.find(p => String(p.id) === String(pid)) || null;
    const unit = prop?.units?.find(u => String(u.id) === String(uid)) || null;
    return { prop, unit };
  }

  function textToHtml(s){
    const raw = String(s||'').replace(/\r\n/g,'\n').trim();
    if(!raw) return '';
    const blocks = raw.split(/\n\s*\n+/g);
    const out = [];
    for(const b of blocks){
      const lines = b.split('\n').map(x=>x.trim()).filter(Boolean);
      if(!lines.length) continue;
      const isList = lines.every(l => /^[-â€¢*]\s+/.test(l));
      if(isList){
        const items = lines.map(l => escHtml(l.replace(/^[-â€¢*]\s+/, '').trim()));
        out.push('<ul class="letter-list">' + items.map(i=>`<li>${i}</li>`).join('') + '</ul>');
      }else{
        const txt = escHtml(lines.join(' '));
        out.push(`<p class="letter-p">${txt}</p>`);
      }
    }
    return out.join('');
  }

  function updateNoticeExtraOptions(){
    const tpl = document.getElementById('notice-template-select')?.value || 'blank';
    const box = document.getElementById('notice-extra-options');
    if(!box) return;

    const isIncrease = tpl === 'increase5';
    const isArrears = (tpl === 'arrearsRenew' || tpl === 'arrearsCheque');

    box.classList.toggle('hidden', !(isIncrease || isArrears));

    const incBox = document.getElementById('notice-extra-increase5');
    if(incBox) incBox.classList.toggle('hidden', !isIncrease);

    const arrBox = document.getElementById('notice-extra-arrears');
    if(arrBox) arrBox.classList.toggle('hidden', !isArrears);
  }


  // ===== Notices: Auto arrears calculation =====
  function normalizeMatchStr(v){
    return String(v||'')
      .toLowerCase()
      .replace(/\s+/g,'')
      .replace(/[â€“â€”\-_/\\]+/g,'');
  }

  function noticeUnitMatchTokens(ctx, unit, prop){
    const strict = [];
    const loose = [];
    const add = (arr, x)=>{ if(x!==undefined && x!==null && String(x).trim()) arr.push(String(x).trim()); };

    // Strict identifiers (reduce false matches)
    add(strict, unit?.id);
    add(strict, unit?.code);
    add(strict, unit?.unitCode);
    add(strict, unit?.name);
    add(strict, ctx?.contractNo);

    // Loose identifiers (fallback if no matches found)
    strict.forEach(x=> add(loose, x));
    add(loose, prop?.id);
    add(loose, prop?.name);

    const uniq = (arr)=> Array.from(new Set(arr));
    return { strict: uniq(strict), loose: uniq(loose) };
  }

  function paymentMatchesNoticeUnit(p, tokens){
    const hay = normalizeMatchStr([p.unit, p.contract, p.desc, p.type, p.voucherNo].filter(Boolean).join(' | '));
    if(!hay) return false;
    return tokens.some(t=>{
      const nt = normalizeMatchStr(t);
      return nt && hay.includes(nt);
    });
  }

  function chequeMatchesUnitTokens(c, tokens){
    const hay = normalizeMatchStr([c.tenant, c.purpose, c.chequeNo, c.bank].filter(Boolean).join(' | '));
    if(!hay) return false;
    return tokens.some(t=>{
      const nt = normalizeMatchStr(t);
      return nt && hay.includes(nt);
    });
  }

  function computeNoticeUnitPaid(ctx, unit, prop){
    const tokenSets = noticeUnitMatchTokens(ctx, unit, prop);
    const tkey = tenantKey(ctx?.tenantName);

    const matchTokens = (tokens)=> payments.filter(p=>{
      if(tenantKey(p.tenant) !== tkey) return false;

      // Direct unitId match (best signal when available)
      if(p.unitId && unit && unit.id && p.unitId === unit.id) return true;

      // Direct match (unit/contract/description)
      if(paymentMatchesNoticeUnit(p, tokens)) return true;

      // If this payment came from a cashed cheque, try to match on cheque purpose too
      if(p.chequeId){
        const chRaw = cheques.find(c=>c.id === p.chequeId);
        const ch = chRaw ? normalizeChequeRecord(chRaw) : null;
        if(ch){
          const hay2 = normalizeMatchStr([ch.purpose, ch.chequeNo, ch.bank].filter(Boolean).join(' | '));
          return tokens.some(t=>{
            const nt = normalizeMatchStr(t);
            return nt && hay2.includes(nt);
          });
        }
      }
      return false;
    });

    // Prefer strict matching; if nothing found, fallback to loose matching
    let matchedPayments = matchTokens(tokenSets.strict);
    if(matchedPayments.length === 0){
      matchedPayments = matchTokens(tokenSets.loose);
    }

    let paid = matchedPayments.reduce((s,p)=> s + Number(p.amount||0), 0);

    // ---- Cheques suggestions (returned / pending) ----
    // We primarily filter by the same tenant; if we can match by unit tokens (purpose/cheque text), we prefer that.
    const tenantChequesAll = cheques
      .map(normalizeChequeRecord)
      .filter(c => tenantKey(c.tenant) === tkey);

    const unitId = unit && unit.id ? unit.id : '';
    const linked = unitId ? tenantChequesAll.filter(c=> (c.unitId||'') === unitId) : [];
    const tenantCheques = linked.length ? linked : tenantChequesAll;

    // ---- Include cashed cheques as paid when no payment record exists (legacy/imported data) ----
    // Some older data may have cheques marked as "Ù…ØµØ±ÙˆÙ" without a corresponding payment entry.
    // To keep notices accurate, we add those cheque values to paid (while avoiding double counting).
    const pickCashed = (tokens)=>{
      const list = tenantCheques.filter(c => chequeStatusBucket(c.status) === 'cashed');
      if(list.length === 0) return [];
      const matched = list.filter(c => {
        // Direct unitId match is best when available
        if(unitId && (c.unitId||'') && (c.unitId||'') === unitId) return true;
        return chequeMatchesUnitTokens(c, tokens);
      });
      return matched;
    };

    let cashedCheques = pickCashed(tokenSets.strict);
    if(cashedCheques.length === 0) cashedCheques = pickCashed(tokenSets.loose);

    const cashedMissingPayment = cashedCheques.filter(c => !(payments||[]).some(p => p.chequeId === c.id));
    const cashedExtraPaid = cashedMissingPayment.reduce((s,c)=> s + Number(c.value||0), 0);
    if(cashedExtraPaid) paid += cashedExtraPaid;


    const pickCheques = (bucket, tokens)=>{
      const list = tenantCheques.filter(c => chequeStatusBucket(c.status) === bucket);
      if(list.length === 0) return [];

      const matched = list.filter(c => {
        // âœ… Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø´ÙŠÙƒ Ù…Ø±Ø¨ÙˆØ·Ù‹Ø§ Ø¨Ù†ÙØ³ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©ØŒ Ø§Ø¹ØªØ¨Ø±Ù‡ Ù…Ø·Ø§Ø¨Ù‚ Ù…Ø¨Ø§Ø´Ø±Ø©
        if(unitId && String(c.unitId || '') === String(unitId)) return true;
        // âœ… Ø§Ø­ØªÙŠØ§Ø·ÙŠØ§Ù‹: Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¨Ø§Ù„Ù†Øµ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø±Ø¨Ø· Ù„Ù„ÙˆØ­Ø¯Ø©
        return chequeMatchesUnitTokens(c, tokens);
      });

      return matched;
    };

    // Prefer strict tokens; fallback to loose
    let returnedCheques = pickCheques('returned', tokenSets.strict);
    let pendingCheques  = pickCheques('pending',  tokenSets.strict);
    if(returnedCheques.length === 0 && pendingCheques.length === 0){
      returnedCheques = pickCheques('returned', tokenSets.loose);
      pendingCheques  = pickCheques('pending',  tokenSets.loose);
    }

    returnedCheques = returnedCheques.slice().sort((a,b)=> new Date(b.dueDate||'1970-01-01') - new Date(a.dueDate||'1970-01-01'));
    pendingCheques  = pendingCheques.slice().sort((a,b)=> new Date(b.dueDate||'1970-01-01') - new Date(a.dueDate||'1970-01-01'));

    const suggestedDetails = [];
    returnedCheques.slice(0,5).forEach(c=>{
      const extra = c.purpose ? ` â€” ${c.purpose}` : '';
      suggestedDetails.push(`Ø´ÙŠÙƒ Ø±Ø§Ø¬Ø¹ Ø±Ù‚Ù… ${c.chequeNo||'â€”'} Ø¨Ù‚ÙŠÙ…Ø© ${formatAED(c.value||0)} Ù…Ø³ØªØ­Ù‚ ${c.dueDate||''}${extra}`.trim());
    });
    pendingCheques.slice(0,5).forEach(c=>{
      const extra = c.purpose ? ` â€” ${c.purpose}` : '';
      suggestedDetails.push(`Ø´ÙŠÙƒ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØµØ±Ù Ø±Ù‚Ù… ${c.chequeNo||'â€”'} Ø¨Ù‚ÙŠÙ…Ø© ${formatAED(c.value||0)} Ù…Ø³ØªØ­Ù‚ ${c.dueDate||''}${extra}`.trim());
    });

    return { paid, matchedPayments, returnedCheques, pendingCheques, cashedCheques, cashedMissingPayment, cashedExtraPaid, suggestedDetailsText: suggestedDetails.join('Ø› ') };
  }

  function autofillNoticeArrears(force=false){
    const tplSel = document.getElementById('notice-template-select');
    const tenantSel = document.getElementById('notice-tenant-select');
    const unitSel = document.getElementById('notice-unit-select');
    if(!tplSel || !tenantSel || !unitSel) return;

    const template = tplSel.value;
    if(!(template === 'arrearsRenew' || template === 'arrearsCheque')) return;

    const autoEl = document.getElementById('notice-arrears-autofill');
    const autoOn = autoEl ? autoEl.checked : true;
    if(!autoOn && !force) return;

    const tenantKeyVal = tenantSel.value || '';
    const unitVal = unitSel.value || '';
    if(!tenantKeyVal || !unitVal) return;

    const [propId, unitId] = unitVal.split('::');
    const prop = properties.find(p=> String(p.id)===String(propId));
    const unit = prop?.units?.find(u=> String(u.id)===String(unitId));
    if(!prop || !unit) return;

    const ctx = {
      tenantName: unit?.tenant || '',
      propName: prop?.name || '',
      unitName: unit?.name || '',
      contractNo: unit?.contractNo || '',
      start: unit?.start || '',
      end: unit?.end || '',
      rent: unit?.rent || 0
    };

    const basis = getRentBasisSetting(); // 'total' | 'annual'
    const oldVal = Number(ctx.rent || 0);
    const contractTotal = (basis === 'annual') ? calcContractValueFromAnnual(oldVal, ctx.start, ctx.end) : oldVal;

    const info = computeNoticeUnitPaid(ctx, unit, prop);
    const balance = Math.max(0, Number(contractTotal||0) - Number(info.paid||0));

    const contractValueInput = document.getElementById('notice-contract-value');
    const arrearsAmountInput = document.getElementById('notice-arrears-amount');
    const arrearsDetailsInput = document.getElementById('notice-arrears-details');

    if(contractValueInput && (force || !contractValueInput.value || Number(contractValueInput.value)===0)){
      if(contractTotal) contractValueInput.value = Math.round(Number(contractTotal));
    }
    if(arrearsAmountInput && (force || !arrearsAmountInput.value || Number(arrearsAmountInput.value)===0)){
      arrearsAmountInput.value = Math.round(Number(balance));
    }

    // For arrears templates, propose details automatically (returned/pending cheques)
// Note: we keep user edits. If the field was auto-generated before, we keep updating it automatically.
// If user types manually, it stops auto-updating until they click "ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ".
    if(arrearsDetailsInput){
      const wasAuto = arrearsDetailsInput.dataset.autogen === '1';
      const shouldUpdateDetails = force || !arrearsDetailsInput.value.trim() || wasAuto;
      if(shouldUpdateDetails){
        arrearsDetailsInput.value = info.suggestedDetailsText || '';
        arrearsDetailsInput.dataset.autogen = '1';
      }
    }

    const status = document.getElementById('notice-preview-status');
    if(status){
      status.textContent = `ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ â€” Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª: ${formatAED(info.paid)} ØŒ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${formatAED(balance)} ØŒ Ø´ÙŠÙƒØ§Øª Ø±Ø§Ø¬Ø¹Ø©: ${info.returnedCheques.length} ØŒ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØµØ±Ù: ${info.pendingCheques.length}`;
    }
  }



  let noticePreviewReady = false;

  function escHtml(v){
    return String(v ?? '')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  function renderNotices(){
    const tenantSel = document.getElementById('notice-tenant-select');
    if(!tenantSel) return;

    // defaults
    const dateEl = document.getElementById('notice-date');
    if(dateEl && !dateEl.value){
      const d = new Date();
      dateEl.value = new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10);
    }

    updateNoticeExtraOptions();

    const current = tenantSel.value || '';
    const tenants = getTenantsData()
      .slice()
      .sort((a,b)=> String(a.name||'').localeCompare(String(b.name||'')));

    tenantSel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù…Ø³ØªØ£Ø¬Ø±...</option>'
      + tenants.map(t => `<option value="${escHtml(t.key)}">${escHtml(t.name)}</option>`).join('');

    if(current && tenants.some(t => t.key === current)) tenantSel.value = current;

    // Units depend on tenant
    onNoticeTenantChange(false);
    resetNoticePreview();
  }

function onNoticeTenantChange(resetPreview=true){
    const tenantSel = document.getElementById('notice-tenant-select');
    const unitSel = document.getElementById('notice-unit-select');
    if(!tenantSel || !unitSel) return;

    const selectedKey = tenantSel.value || '';
    if(!selectedKey){
      unitSel.innerHTML = '<option value="">Ø§Ø®ØªØ± ÙˆØ­Ø¯Ø©...</option>';
      unitSel.disabled = true;
      if(resetPreview) resetNoticePreview();
      return;
    }

    const units = [];
    properties.forEach(p => (p.units||[]).forEach(u => {
      if(u.status === 'Ù…Ø¤Ø¬Ø±Ø©' && u.tenant && tenantKey(u.tenant) === selectedKey){
        units.push({
          value: `${p.id}::${u.id}`,
          label: `${p.name} - ${u.name}`
        });
      }
    }));

    unitSel.disabled = false;
    unitSel.innerHTML = '<option value="">Ø§Ø®ØªØ± ÙˆØ­Ø¯Ø©...</option>'
      + units.map(x => `<option value="${escHtml(x.value)}">${escHtml(x.label)}</option>`).join('');

    if(resetPreview) resetNoticePreview();
  }

  function resetNoticePreview(){
    noticePreviewReady = false;
    updateNoticeExtraOptions();
    autofillNoticeArrears(false);
    const preview = document.getElementById('notice-preview');
    const status = document.getElementById('notice-preview-status');
    const printBtn = document.getElementById('notice-print-btn');
    if(printBtn) printBtn.disabled = true;

    if(status) status.textContent = '';
    if(preview){
      preview.innerHTML = `
        <div class="text-center text-gray-500 dark:text-gray-400">
          Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± ÙˆÙ†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø§Ø¨ Ø«Ù… Ø§Ø¶ØºØ· <b>Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø§ÙŠÙ†Ø©</b>.
        </div>
      `;
    }
  }

  
  function buildNoticePreview(){
    updateNoticeExtraOptions();
    autofillNoticeArrears(false);

    const tenantSel = document.getElementById('notice-tenant-select');
    const unitSel = document.getElementById('notice-unit-select');
    const tplSel = document.getElementById('notice-template-select');
    const subjectInput = document.getElementById('notice-subject');
    const dateEl = document.getElementById('notice-date');
    const refEl = document.getElementById('notice-ref');
    const bilingualEl = document.getElementById('notice-bilingual');
    const noReplyEl = document.getElementById('notice-no-reply-accept');

    const preview = document.getElementById('notice-preview');
    const status = document.getElementById('notice-preview-status');
    const printBtn = document.getElementById('notice-print-btn');

    const tenantKeyVal = tenantSel?.value || '';
    if(!tenantKeyVal){
      alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± Ø£ÙˆÙ„Ø§Ù‹.');
      return;
    }

    const template = tplSel?.value || 'blank';
    const bilingual = !!(bilingualEl && bilingualEl.checked);

    // Require unit for eviction / increase
    const unitVal = unitSel?.value || '';
    if((template === 'eviction' || template === 'increase5') && !unitVal){
      alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØ­Ø¯Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø®Ø·Ø§Ø¨.');
      return;
    }

    const tenant = getTenantsData().find(t => t.key === tenantKeyVal);
    const { prop, unit } = findUnitByComposite(unitVal);

    // default subject
    if(subjectInput && !(subjectInput.value||'').trim()){
      if(template === 'eviction') subjectInput.value = 'Ø¥Ø®Ø·Ø§Ø± Ø¨Ø¹Ø¯Ù… ØªØ¬Ø¯ÙŠØ¯ Ø¹Ù‚Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± ÙˆØ¥Ø®Ù„Ø§Ø¡ Ø§Ù„Ø¹ÙŠÙ† Ø§Ù„Ù…Ø¤Ø¬Ø±Ø©';
      else if(template === 'increase5') subjectInput.value = 'Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±ÙŠØ© Ø¨Ù†Ø³Ø¨Ø© 5%';
      else subjectInput.value = '';
    }

    const subject = (subjectInput?.value || '').trim();
    const dateStr = (dateEl?.value || '');
    const dateEn = formatEnglishDate(dateStr);
    const dateAr = formatArabicDate(dateStr);

    if(refEl && !(refEl.value||'').trim()){
      refEl.value = getNextNoticeNo();
    }
    const refNo = (refEl?.value || '').trim();

    // Keep edited text if user re-builds
    const prevAr = document.getElementById('notice-body-ar')?.innerText || '';
    const prevEn = document.getElementById('notice-body-en')?.innerText || '';

    const ctx = {
      tenantName: tenant?.name || '',
      propName: prop?.name || '',
      unitName: unit?.name || '',
      contractNo: unit?.contractNo || '',
      start: unit?.start || '',
      end: unit?.end || '',
      rent: unit?.rent || 0
    };

    // Compute 5% increase numbers
    const basis = getRentBasisSetting(); // 'total' | 'annual'
    const years = (ctx.start && ctx.end) ? contractYears(ctx.start, ctx.end) : 1;
    const oldVal = Number(ctx.rent || 0);
    const newVal = Math.round(oldVal * 1.05);

    const oldAnnual = basis === 'annual' ? oldVal : (years ? (oldVal / years) : oldVal);
    const newAnnual = Math.round(oldAnnual * 1.05);

    // ---- Arrears defaults (auto-fill inputs) ----
    const unitCode = (unit && (unit.id || unit.code || unit.unitCode)) ? (unit.id || unit.code || unit.unitCode) : (unit?.name || '');
    const contractTotal = (basis === 'annual') ? calcContractValueFromAnnual(oldVal, ctx.start, ctx.end) : oldVal;

    const contractValueInput = document.getElementById('notice-contract-value');
    const arrearsAmountInput = document.getElementById('notice-arrears-amount');
    const arrearsDetailsInput = document.getElementById('notice-arrears-details');

    // compute paid/balance for this unit (from recorded payments/cheques)
    const paidInfo = computeNoticeUnitPaid(ctx, unit, prop);
    const unitPaid = Number(paidInfo.paid||0);
    const unitBalance = Math.max(0, (Number(contractTotal||0) - Number(unitPaid||0)));

    if(contractValueInput && (!contractValueInput.value || Number(contractValueInput.value)===0)){
      if(contractTotal) contractValueInput.value = Math.round(Number(contractTotal));
    }
    if(arrearsAmountInput && (!arrearsAmountInput.value || Number(arrearsAmountInput.value)===0)){
      if(unitBalance) arrearsAmountInput.value = Math.round(Number(unitBalance));
    }

    // Templates
    let titleAr = 'Ø®Ø·Ø§Ø¨ Ø±Ø³Ù…ÙŠ';
    let titleEn = 'Official Letter';
    let bodyAr = '';
    let bodyEn = '';

    if(template === 'blank'){
      titleAr = 'Ø®Ø·Ø§Ø¨ Ø±Ø³Ù…ÙŠ';
      titleEn = 'Official Letter';
      bodyAr = prevAr.trim() || (
`Ø¹Ø²ÙŠØ²ÙŠ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±/Ø§Ù„Ø³Ø§Ø¯Ø©: ${ctx.tenantName || '______________'}\n\n` +
`Ø¨Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ Ø¹Ù‚Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø±Ù‚Ù… ${ctx.contractNo || 'â€”'} Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹ÙŠÙ† Ø§Ù„Ù…Ø¤Ø¬Ø±Ø© (${ctx.propName} - ${ctx.unitName})ØŒ Ù†ÙˆØ¯ Ø¥Ø´Ø¹Ø§Ø±ÙƒÙ… Ø¨Ø£Ù†Ù‡ ØªÙ‚Ø±Ø± ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±ÙŠØ© Ø¨Ù†Ø³Ø¨Ø© 5% ÙˆÙÙ‚Ù‹Ø§ Ù„Ø¨Ù†ÙˆØ¯ Ø¹Ù‚Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±.\n\n` +
`Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${formatAED(oldAnnual)}\n` +
`Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø²ÙŠØ§Ø¯Ø© (5%): ${formatAED(newAnnual)}\n\n` +
`ØªØ§Ø±ÙŠØ® Ø³Ø±ÙŠØ§Ù† Ø§Ù„Ø²ÙŠØ§Ø¯Ø©: Ø¹Ù†Ø¯ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ / Ù„Ù„ÙØªØ±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ØªØ¨Ø¹Ø©.\n\n` +
`ÙŠØ±Ø¬Ù‰ ØªØ²ÙˆÙŠØ¯Ù†Ø§ Ø¨Ù…ÙˆØ§ÙÙ‚ØªÙƒÙ… Ø£Ùˆ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒÙ… Ø®Ù„Ø§Ù„ 7 Ø£ÙŠØ§Ù… Ù…Ù† ØªØ§Ø±ÙŠØ® Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±ØŒ ÙˆÙÙŠ Ø­Ø§Ù„ Ø¹Ø¯Ù… Ø§Ù„Ø±Ø¯ Ø®Ù„Ø§Ù„ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…Ø°ÙƒÙˆØ±Ø© Ø³ÙŠÙØ¹ØªØ¨Ø± Ø°Ù„Ùƒ Ù‚Ø¨ÙˆÙ„Ø§Ù‹ Ø¶Ù…Ù†ÙŠÙ‹Ø§ Ø¨Ø§Ù„Ø²ÙŠØ§Ø¯Ø©.\n\n` +
`ÙˆØªÙØ¶Ù„ÙˆØ§ Ø¨Ù‚Ø¨ÙˆÙ„ ÙØ§Ø¦Ù‚ Ø§Ù„Ø§Ø­ØªØ±Ø§Ù… ÙˆØ§Ù„ØªÙ‚Ø¯ÙŠØ±ØŒØŒ`
      );
      bodyEn = prevEn.trim() || (
`Dear Tenant,\n\n${ctx.tenantName || '______________'}\n\n` +
`With reference to Lease Agreement No. ${ctx.contractNo || 'â€”'} for the leased premises (${ctx.propName} - ${ctx.unitName}), please be informed that the rental value will be increased by 5% in accordance with the lease terms.\n\n` +
`Current rental value: ${formatAED(oldAnnual)}\n` +
`New rental value (5% increase): ${formatAED(newAnnual)}\n\n` +
`Effective date: upon renewal / next rental period as per the applicable procedures.\n\n` +
`Kindly provide your confirmation or remarks within 7 days from the date of this notice. Failure to respond within the said period shall be deemed as acceptance of the increase.\n\n` +
`Regards ,,`
      );
} 
else if(template === 'eviction'){
      titleAr = 'Ø¥Ø®Ø·Ø§Ø± Ø±Ø³Ù…ÙŠ Ø¨Ø¹Ø¯Ù… ØªØ¬Ø¯ÙŠØ¯ Ø¹Ù‚Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± ÙˆØ¥Ø®Ù„Ø§Ø¡ Ø§Ù„Ø¹ÙŠÙ† Ø§Ù„Ù…Ø¤Ø¬Ø±Ø©';
      titleEn = 'Eviction Notice and Non-Renewal of Lease Agreement';
      bodyAr = prevAr.trim() || (
`Ø¹Ø²ÙŠØ²ÙŠ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ØŒ\n\n${ctx.tenantName || '______________'}\n\n` +
`Ø¨Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ Ø¹Ù‚Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø±Ù‚Ù… ${ctx.contractNo || 'â€”'} Ø§Ù„Ù…Ø¨Ø±Ù… Ø¨ÙŠÙ†ÙƒÙ… ÙˆØ¨ÙŠÙ† Ø§Ù„Ù…Ù„Ø§Ùƒ Ø¨Ø®ØµÙˆØµ Ø§Ù„Ø¹ÙŠÙ† Ø§Ù„Ù…Ø¤Ø¬Ø±Ø© (${ctx.propName} - ${ctx.unitName})ØŒ ÙˆØ§Ù„ØªÙŠ Ø³ÙŠÙ†ØªÙ‡ÙŠ Ø¹Ù‚Ø¯Ù‡Ø§ Ø¨ØªØ§Ø±ÙŠØ® ${ctx.end || 'â€”'}ØŒ Ù†ÙˆØ¯ Ø¥Ù†Ø°Ø§Ø±ÙƒÙ… Ø¨Ù…Ø§ ÙŠÙ„ÙŠ:\n\n` +
`Ù‚Ø±Ø± Ø§Ù„Ù…Ù„Ø§Ùƒ Ø¹Ø¯Ù… ØªØ¬Ø¯ÙŠØ¯ Ø¹Ù‚Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¦Ù‡ØŒ ÙˆÙŠÙØ¹Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø®Ø·Ø§Ø± Ø¥Ù†Ø°Ø§Ø±Ù‹Ø§ Ø±Ø³Ù…ÙŠÙ‹Ø§ ÙˆÙ†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ Ø¨ÙˆØ¬ÙˆØ¨ Ø§Ù„Ø¥Ø®Ù„Ø§Ø¡.\n\n` +
`ÙˆØ¹Ù„ÙŠÙ‡ØŒ ÙŠÙØ·Ù„Ø¨ Ù…Ù†ÙƒÙ…:\n\n` +
`- Ø¥Ø®Ù„Ø§Ø¡ Ø§Ù„Ø¹ÙŠÙ† Ø§Ù„Ù…Ø¤Ø¬Ø±Ø© ÙˆØªØ³Ù„ÙŠÙ…Ù‡Ø§ Ø®Ø§Ù„ÙŠØ© Ù…Ù† Ø£ÙŠ Ø¥Ø´ØºØ§Ù„ ÙÙŠ Ù…ÙˆØ¹Ø¯ Ø£Ù‚ØµØ§Ù‡ ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø¯.\n` +
`- ØªÙ‚Ø¯ÙŠÙ… Ø¨Ø±Ø§Ø¡Ø© Ø°Ù…Ø© Ù…Ù† Ø·Ø§Ù‚Ø© Ù„Ù„ØªÙˆØ²ÙŠØ¹ (ÙƒÙ‡Ø±Ø¨Ø§Ø¡/Ù…ÙŠØ§Ù‡) ØªÙÙŠØ¯ Ø¨Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø£ÙŠ Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ù…Ø§Ù„ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„ØªØ³Ù„ÙŠÙ….\n` +
`- ØªØ³ÙˆÙŠØ© Ø£ÙŠ Ù…Ø³ØªØ­Ù‚Ø§Øª Ù…ØªØ£Ø®Ø±Ø©ØŒ ÙˆØªØ³Ù„ÙŠÙ… Ø§Ù„Ù…ÙØ§ØªÙŠØ­ ÙˆÙƒØ§ÙØ© Ø§Ù„Ù…Ù„Ø­Ù‚Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„ØªØ³Ù„ÙŠÙ….\n\n` +
`ÙˆÙ†Ø¤ÙƒØ¯ Ø£Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ù†Ø°Ø§Ø± ÙŠÙØ¹ØªØ¨Ø± Ù…Ù„Ø²Ù…Ù‹Ø§ØŒ ÙˆÙÙŠ Ø­Ø§Ù„ Ø¹Ø¯Ù… Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ù…Ø§ ÙˆØ±Ø¯ Ø£Ø¹Ù„Ø§Ù‡ØŒ Ø³ÙŠØ¶Ø·Ø± Ø§Ù„Ù…Ù„Ø§Ùƒ Ø¥Ù„Ù‰ Ø§ØªØ®Ø§Ø° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© Ø§Ù„Ù„Ø§Ø²Ù…Ø© ÙˆÙÙ‚Ù‹Ø§ Ù„Ù„Ù‚ÙˆØ§Ù†ÙŠÙ† ÙˆØ§Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…Ø¹Ù…ÙˆÙ„ Ø¨Ù‡Ø§ ÙÙŠ Ø¯ÙˆÙ„Ø© Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ù…ØªØ­Ø¯Ø©.\n\n` +
`ÙˆØªÙØ¶Ù„ÙˆØ§ Ø¨Ù‚Ø¨ÙˆÙ„ ÙØ§Ø¦Ù‚ Ø§Ù„Ø§Ø­ØªØ±Ø§Ù… ÙˆØ§Ù„ØªÙ‚Ø¯ÙŠØ±ØŒØŒ`
      );
      bodyEn = prevEn.trim() || (
`Dear Tenant,\n\n${ctx.tenantName || '______________'}\n\n` +
`Referring to Lease Agreement No. ${ctx.contractNo || 'â€”'}, concluded between you and the landlords regarding the leased premises (${ctx.propName} - ${ctx.unitName}), which will expire on ${ctx.end || 'â€”'}, we hereby notify you of the following:\n\n` +
`The landlords have decided not to renew the lease agreement after its expiry date, and this notice shall be considered an official and final warning requiring eviction.\n\n` +
`Therefore, you are required to:\n\n` +
`- Vacate the leased premises and hand them over free of any occupation no later than the expiry date.\n` +
`- Provide a clearance certificate from TAQA Distribution confirming that no financial obligations remain outstanding prior to handover.\n` +
`- Settle any outstanding dues and hand over keys and all related attachments upon handover.\n\n` +
`We emphasize that this notice is binding, and in the event of non-compliance, the landlords will be compelled to take legal action in accordance with the applicable laws and regulations of the United Arab Emirates.\n\n` +
`Regards ,,`
      );
} else if(template === 'increase5'){
      titleAr = 'Ø¥Ø´Ø¹Ø§Ø± Ø±Ø³Ù…ÙŠ Ø¨Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±ÙŠØ© Ø¨Ù†Ø³Ø¨Ø© 5%';
      titleEn = 'Notice of 5% Rent Increase';

      const noReplyClause = !!(noReplyEl && noReplyEl.checked);

      const oldStr = basis === 'annual'
        ? `Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±ÙŠØ© Ø§Ù„Ø³Ù†ÙˆÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${formatAED(oldVal)}`
        : `Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${formatAED(oldVal)}`;

      const newStr = basis === 'annual'
        ? `Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±ÙŠØ© Ø§Ù„Ø³Ù†ÙˆÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø²ÙŠØ§Ø¯Ø© (5%): ${formatAED(newAnnual)}`
        : `Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ø¹Ø¯ Ø§Ù„Ø²ÙŠØ§Ø¯Ø© (5%): ${formatAED(newVal)}`;

      bodyAr = prevAr.trim() || (
`Ø¹Ø²ÙŠØ²ÙŠ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±/Ø§Ù„Ø³Ø§Ø¯Ø©: ${ctx.tenantName}\n\n` +
`Ø¨Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ Ø¹Ù‚Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø±Ù‚Ù… ${ctx.contractNo || 'â€”'} Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹ÙŠÙ† Ø§Ù„Ù…Ø¤Ø¬Ø±Ø© (${ctx.propName} - ${ctx.unitName})ØŒ Ù†ÙˆØ¯ Ø¥Ø´Ø¹Ø§Ø±ÙƒÙ… Ø¨Ù…Ø§ ÙŠÙ„ÙŠ:\n\n` +
`${oldStr}\n${newStr}\n\n` +
`ÙˆØ³ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø²ÙŠØ§Ø¯Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ / Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ØªØ¨Ø¹Ø©.\n` +
(noReplyClause ? `\nØ¹Ø¯Ù… Ø§Ù„Ø±Ø¯ Ø®Ù„Ø§Ù„ (7) Ø£ÙŠØ§Ù… Ù…Ù† ØªØ§Ø±ÙŠØ® Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø³ÙŠÙØ¹ØªØ¨Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.\n` : ``) +
`\nÙˆØªÙØ¶Ù„ÙˆØ§ Ø¨Ù‚Ø¨ÙˆÙ„ ÙØ§Ø¦Ù‚ Ø§Ù„Ø§Ø­ØªØ±Ø§Ù… ÙˆØ§Ù„ØªÙ‚Ø¯ÙŠØ± ØŒØŒ`
      );

      bodyEn = prevEn.trim() || (
`Dear Tenant,\n\n` +
`Referring to Lease Agreement No. ${ctx.contractNo || 'â€”'} for the leased premises (${ctx.propName} - ${ctx.unitName}), please be advised:\n\n` +
(basis === 'annual'
  ? `Current annual rent: ${formatAED(oldVal)}\nNew annual rent (+5%): ${formatAED(newAnnual)}\n\n`
  : `Current contract value: ${formatAED(oldVal)}\nNew contract value (+5%): ${formatAED(newVal)}\n\n`
) +
`The increase will be applied upon renewal / the upcoming period as per applicable procedures.\n` +
(noReplyClause ? `\nNo response within 7 days from this notice date shall be considered acceptance.\n` : ``) +
`\nRegards ,,`
      );
    }
else if(template === 'arrearsRenew'){
      titleAr = 'Ø¥Ù†Ø°Ø§Ø± Ø¯ÙØ¹ Ù…ØªØ£Ø®Ø±Ø§Øª Ø¥ÙŠØ¬Ø§Ø±ÙŠØ©';
      titleEn = 'Rental Arrears Notice';

      const cv = Number(contractValueInput?.value || contractTotal || 0);
      const arAmt = Number(arrearsAmountInput?.value || unitBalance || 0);
      const details = String(arrearsDetailsInput?.value || '').trim();
      const unitLabel = unitCode || ctx.unitName || 'â€”';

      bodyAr = prevAr.trim() || (
`Ø¹Ø²ÙŠØ²ÙŠ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ØŒ\n\n${ctx.tenantName || '______________'}\n\n` +
`Ø¨Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ù…Ø´Ø§Ø± Ø¥Ù„ÙŠÙ‡ Ø£Ø¹Ù„Ø§Ù‡ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙƒØ±Ù… Ø¨Ø¯ÙØ¹ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±ÙŠØ© Ø¹Ù„Ù‰ Ø¹Ù‚Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ù„Ù„ÙˆØ­Ø¯Ø© ${unitLabel} ÙˆØ§Ù„Ù…Ø¤Ø¬Ø±Ø© Ù„ÙƒÙ…ØŒ ÙˆØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ù…Ù†ØªÙ‡ÙŠ Ø¨ØªØ§Ø±ÙŠØ® ${ctx.end || 'â€”'} Ø®Ù„Ø§Ù„ Ù…Ø¯Ø© Ø£Ù‚ØµØ§Ù‡Ø§ Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ† Ù…Ù† ØªØ§Ø±ÙŠØ®Ù‡.\n\n` +
`ÙˆØ¹Ù„ÙŠÙ‡ØŒ ÙŠØ¬Ø¨ Ø³Ø¯Ø§Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ£Ø®Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ù…ÙˆØ«Ù‚ ÙÙŠ Ø¨Ù„Ø¯ÙŠØ© Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø¹ÙŠÙ† ÙˆØ±Ù‚Ù…Ù‡ (${ctx.contractNo || 'â€”'}) ÙˆØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ø£Ø³Ø±Ø¹ ÙˆÙ‚Øª Ù…Ù…ÙƒÙ† Ø­ØªÙ‰ Ù„Ø§ Ù†Ø¶Ø·Ø± Ø¢Ø³ÙÙŠÙ† Ù„Ø§ØªØ®Ø§Ø° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© Ø¶Ø¯ÙƒÙ….\n\n` +
`Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚Ø¯: ${cv ? cv.toLocaleString('en-US') : 'â€”'} Ø¯Ø±Ù‡Ù…\n` +
`Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${arAmt ? arAmt.toLocaleString('en-US') : 'â€”'} Ø¯Ø±Ù‡Ù…\n` +
(details ? `\nØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª: ${details}\n` : ``) +
`\nÙÙŠ Ø­Ø§Ù„ ØªØ¹Ø°Ø±ÙƒÙ… Ø¹Ù† Ø§Ù„Ø³Ø¯Ø§Ø¯ Ø®Ù„Ø§Ù„ Ø§Ù„Ù…Ù‡Ù„Ø© Ø§Ù„Ù…Ù…Ù†ÙˆØ­Ø© Ù„ÙƒÙ… Ø³ÙŠØªÙ… Ø§ØªØ®Ø§Ø° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© Ø¶Ø¯ÙƒÙ… Ù…Ù…Ø§ ÙŠØªØ±ØªØ¨ Ø¹Ù„ÙŠÙƒÙ… Ø³Ø¯Ø§Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ£Ø®Ø±Ø© Ù…Ù† ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ù…Ø°ÙƒÙˆØ± Ø£Ø¹Ù„Ø§Ù‡ ÙˆØ­ØªÙ‰ Ø§Ù„Ø¥Ø®Ù„Ø§Ø¡ Ø§Ù„ÙØ¹Ù„ÙŠØŒ ÙˆØªØ³Ù„ÙŠÙ… Ø¨Ø±Ø§Ø¡Ø© Ø°Ù…Ø© Ø§Ù„Ù…Ø§Ø¡ ÙˆØ§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ ÙˆØµÙŠØ§Ù†Ø© Ø§Ù„Ø¹ÙŠÙ† Ø§Ù„Ù…Ø¤Ø¬Ø±Ø©.\n\n` +
`Ø´Ø§ÙƒØ±ÙŠÙ† Ù„ÙƒÙ… Ø­Ø³Ù† ØªØ¹Ø§ÙˆÙ†ÙƒÙ… Ù…Ø¹Ù†Ø§ØŒØŒ\nÙˆØªÙØ¶Ù„ÙˆØ§ Ø¨Ù‚Ø¨ÙˆÙ„ ÙØ§Ø¦Ù‚ Ø§Ù„Ø§Ø­ØªØ±Ø§Ù… ÙˆØ§Ù„ØªÙ‚Ø¯ÙŠØ± ØŒØŒ`
      );

      bodyEn = prevEn.trim() || (
`Dear Tenant,\n\n${ctx.tenantName || '______________'}\n\n` +
`With reference to the above subject, kindly pay the rental arrears for the lease contract of Unit ${unitLabel} leased to you, and renew the lease contract expired on ${ctx.end || 'â€”'} within a maximum period of two weeks.\n\n` +
`Accordingly, you must pay the late rents on the contract documented in Al Ain Municipality No. (${ctx.contractNo || 'â€”'}) and renew the contract as soon as possible so that we do not have to take legal action against you.\n\n` +
`Rental Value: ${cv ? cv.toLocaleString('en-US') : 'â€”'} AED\n` +
`Remaining: ${arAmt ? arAmt.toLocaleString('en-US') : 'â€”'} AED\n` +
(details ? `\nArrears details: ${details}\n` : ``) +
`\nIf you fail to pay within the period given to you, legal action will be taken against you. You will have to pay the late rents from the contract expiry date mentioned above until the actual eviction, provide the water and electricity clearance, and maintain the leased property.\n\n` +
`Thank you for your cooperation with us,,\nRegards ,,`
      );

    } else if(template === 'arrearsCheque'){
      titleAr = 'Ø¥Ù†Ø°Ø§Ø± Ø¯ÙØ¹ Ù…ØªØ£Ø®Ø±Ø§Øª Ø¥ÙŠØ¬Ø§Ø±ÙŠØ©';
      titleEn = 'Legal Notice - Rental Arrears';

      const cv = Number(contractValueInput?.value || contractTotal || 0);
      const arAmt = Number(arrearsAmountInput?.value || unitBalance || 0);
      const details = String(arrearsDetailsInput?.value || '').trim();
      const unitLabel = unitCode || ctx.unitName || 'â€”';

      bodyAr = prevAr.trim() || (
`Ø¹Ø²ÙŠØ²ÙŠ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ØŒ\n\n${ctx.tenantName || '______________'}\n\n` +
`Ø¨Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ù…Ø´Ø§Ø± Ø¥Ù„ÙŠÙ‡ Ø£Ø¹Ù„Ø§Ù‡ØŒ ÙŠØ¹Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ù†Ø°Ø§Ø± Ù„ÙƒÙ… Ù„Ø¯ÙØ¹ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ£Ø®Ø±Ø© Ø¹Ù„Ù‰ Ø¹Ù‚Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø± Ø§Ù„Ù…ÙˆØ«Ù‚ Ø§Ù„Ø®Ø§Øµ Ø¨ÙƒÙ… ÙˆØ±Ù‚Ù…Ù‡: ${ctx.contractNo || 'â€”'} Ù„Ù„ÙˆØ­Ø¯Ø© Ø±Ù‚Ù…: ${unitLabel} Ø®Ù„Ø§Ù„ Ù…Ø¯Ø© Ø£Ù‚ØµØ§Ù‡Ø§ Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ† Ù…Ù† ØªØ§Ø±ÙŠØ®Ù‡.\n\n` +
`ÙˆØ¹Ù„ÙŠÙ‡ØŒ ÙŠØ¬Ø¨ Ø§Ù„Ù…Ø¨Ø§Ø¯Ø±Ø© ÙˆØ³Ø¯Ø§Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ£Ø®Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ù…ÙˆØ«Ù‚ ÙÙŠ Ø¨Ù„Ø¯ÙŠØ© Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø¹ÙŠÙ† Ø¨Ø£Ø³Ø±Ø¹ ÙˆÙ‚Øª Ù…Ù…ÙƒÙ† Ø­ØªÙ‰ Ù„Ø§ Ù†Ø¶Ø·Ø± Ø¢Ø³ÙÙŠÙ† Ù„Ø§ØªØ®Ø§Ø° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© Ø¶Ø¯ÙƒÙ….\n\n` +
`Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù‚Ø¯: ${cv ? cv.toLocaleString('en-US') : 'â€”'} Ø¯Ø±Ù‡Ù…\n` +
`Ø§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª: ${details ? details : (arAmt ? arAmt.toLocaleString('en-US') + ' Ø¯Ø±Ù‡Ù…' : 'â€”')}\n\n` +
`ÙÙŠ Ø­Ø§Ù„ ØªØ¹Ø°Ø±ÙƒÙ… Ø¹Ù† Ø§Ù„Ø³Ø¯Ø§Ø¯ Ø®Ù„Ø§Ù„ Ø§Ù„Ù…Ù‡Ù„Ø© Ø§Ù„Ù…Ù…Ù†ÙˆØ­Ø© Ù„ÙƒÙ… Ø³ÙŠØªÙ… Ø§ØªØ®Ø§Ø° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© Ø¶Ø¯ÙƒÙ… Ù…Ù…Ø§ ÙŠØªØ±ØªØ¨ Ø¹Ù„ÙŠÙƒÙ… Ø³Ø¯Ø§Ø¯ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ£Ø®Ø±Ø© Ø§Ù„Ù…Ø°ÙƒÙˆØ±Ø© Ø£Ø¹Ù„Ø§Ù‡ ÙˆØ­ØªÙ‰ Ø§Ù„Ø¥Ø®Ù„Ø§Ø¡ Ø§Ù„ÙØ¹Ù„ÙŠØŒ ÙˆØªØ³Ù„ÙŠÙ… Ø¨Ø±Ø§Ø¡Ø© Ø°Ù…Ø© Ø§Ù„Ù…Ø§Ø¡ ÙˆØ§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ ÙˆØµÙŠØ§Ù†Ø© Ø§Ù„Ø¹ÙŠÙ† Ø§Ù„Ù…Ø¤Ø¬Ø±Ø©.\n\n` +
`Ø´Ø§ÙƒØ±ÙŠÙ† Ù„ÙƒÙ… Ø­Ø³Ù† ØªØ¹Ø§ÙˆÙ†ÙƒÙ… Ù…Ø¹Ù†Ø§ØŒØŒ\nÙˆØªÙØ¶Ù„ÙˆØ§ Ø¨Ù‚Ø¨ÙˆÙ„ ÙØ§Ø¦Ù‚ Ø§Ù„Ø§Ø­ØªØ±Ø§Ù… ÙˆØ§Ù„ØªÙ‚Ø¯ÙŠØ± ØŒØŒ`
      );

      bodyEn = prevEn.trim() || (
`Dear Tenant,\n\n${ctx.tenantName || '______________'}\n\n` +
`With reference to the above subject matter, this is the notice to pay overdue rents on your tenancy lease: ${ctx.contractNo || 'â€”'}\n` +
`Unit No.: ${unitLabel}\nwithin a maximum period of two weeks.\n\n` +
`Accordingly, you must pay the arrears on the contract documented in Al Ain Municipality as soon as possible so that we do not have to take legal action against you.\n\n` +
`Contract Value: ${cv ? cv.toLocaleString('en-US') : 'â€”'} AED\n` +
`Arrears: ${details ? details : (arAmt ? arAmt.toLocaleString('en-US') + ' AED' : 'â€”')}\n\n` +
`If you fail to pay within the period given to you, legal action will be taken against you. You will have to pay the late rents mentioned above until the actual eviction, provide the water and electricity clearance, and maintain the leased property.\n\n` +
`Thank you for your cooperation with us,,\nRegards ,,`
      );
    }


    const headerLinesHtml = NOTICE_LETTERHEAD.topLines.map(l => `<div>${escHtml(l)}</div>`).join('');
    const footerLinesHtml = NOTICE_LETTERHEAD.footerLines.map((l,i) => (i===0 ? `<div class="sig">${escHtml(l)}</div>` : `<div>${escHtml(l)}</div>`)).join('');

    const titleHtml = `
      <div class="letter-title-ar">${escHtml(titleAr || '')}</div>
      ${bilingual ? `<div class="letter-title-en" dir="ltr">${escHtml(titleEn || '')}</div>` : ''}
    `;

    const metaHtml = `
      <div><b>Ø±Ù‚Ù… Ø§Ù„Ø®Ø·Ø§Ø¨:</b> ${escHtml(refNo || 'â€”')}</div>
      <div dir="ltr"><b>Date:</b> ${escHtml(dateEn || '')}</div>
      <div><b>Ø§Ù„ØªØ§Ø±ÙŠØ®:</b> ${escHtml(dateAr || '')}</div>
      ${subject ? `<div style="flex-basis:100%"><b>Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹:</b> ${escHtml(subject)}</div>` : ''}
    `;

    const bodyHtml = bilingual ? `
      <div class="letter-columns">
        <div class="letter-col" dir="rtl">
          <div id="notice-body-ar" class="letter-body letter-edit" contenteditable="true">${textToHtml(bodyAr)}</div>
        </div>
        <div class="letter-col" dir="ltr">
          <div id="notice-body-en" class="letter-body letter-edit" contenteditable="true">${textToHtml(bodyEn)}</div>
        </div>
      </div>
    ` : `
      <div id="notice-body-ar" class="letter-body letter-edit" dir="rtl" contenteditable="true">${textToHtml(bodyAr)}</div>
    `;

    preview.innerHTML = `
      <div class="letter-paper" id="notice-letter">
        <div class="letter-head">
          <div class="letter-head-lines">${headerLinesHtml}</div>
          <div class="letter-date" dir="ltr">${escHtml(dateEn || '')}</div>
        </div>

        <div class="letter-title">${titleHtml}</div>

        <div class="letter-meta">${metaHtml}</div>

        ${bodyHtml}

        <div class="letter-footer">${footerLinesHtml}</div>
      </div>
    `;

    noticePreviewReady = true;
    if(printBtn) printBtn.disabled = false;
    if(status) status.textContent = 'Ø¬Ø§Ù‡Ø² Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© â€” ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ù†Øµ Ø§Ù„Ø®Ø·Ø§Ø¨ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©.';
  }

  function printNotice(){
    if(!noticePreviewReady){
      alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø£ÙˆÙ„Ø§Ù‹.');
      return;
    }
    window.print();
  }

// ================= DASHBOARD =================
  let leasesChart, financeChart;

  function updateDashboard(){
    document.getElementById('current-date-display').textContent =
      new Date().toLocaleDateString('ar-AE', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
    renderLogs();

    const stats = { active:0, empty:0, expired:0, totalRent:0 };
    properties.forEach(p=>p.units.forEach(u=>{
      if(u.status==='Ù…Ø¤Ø¬Ø±Ø©'){ stats.active++; stats.totalRent += calcUnitContractValue(u); }
      else if(u.status==='Ù…Ù†ØªÙ‡ÙŠØ©') stats.expired++;
      else stats.empty++;
    }));

    const tenants = getTenantsData();
    const lateCount = tenants.filter(t => t.balance > 0).length;

    document.getElementById('total-annual-rent').textContent = formatAED(stats.totalRent);
    document.getElementById('active-leases-count').textContent = stats.active;
    document.getElementById('empty-units-count').textContent = stats.empty;
    document.getElementById('late-tenants-count').textContent = lateCount;

    const isDark = document.body.classList.contains('dark-mode');
    const textColor = isDark ? '#d1d5db' : '#666';
    const gridColor = isDark ? '#374151' : '#e5e5e5';

    if(leasesChart) leasesChart.destroy();
    leasesChart = new Chart(document.getElementById('leasesChart'), {
      type:'doughnut',
      data:{
        labels:['Ù…Ø¤Ø¬Ø±Ø©','Ø´Ø§ØºØ±Ø©','Ù…Ù†ØªÙ‡ÙŠØ©'],
        datasets:[{
          data:[stats.active, stats.empty, stats.expired],
          backgroundColor:['#10b981','#e5e7eb','#f43f5e'],
          borderColor: isDark ? '#1f2937' : '#fff'
        }]
      },
      options:{
        plugins:{ legend:{ position:'left', labels:{ color:textColor } } }
      }
    });

    const collected = payments.reduce((s,p)=>s+p.amount,0);
    if(financeChart) financeChart.destroy();
    financeChart = new Chart(document.getElementById('financeChart'), {
      type:'bar',
      data:{
        labels:['Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ø³Ù†ÙˆÙŠØ§Ù‹', 'Ø§Ù„Ù…Ù‚Ø¨ÙˆØ¶ ÙØ¹Ù„ÙŠØ§Ù‹'],
        datasets:[{
          label:'AED',
          data:[stats.totalRent, collected],
          backgroundColor:['#3b82f6', '#10b981'],
          borderRadius: 6
        }]
      },
      options:{
        scales:{
          y:{ beginAtZero:true, grid:{ color:gridColor }, ticks:{ color:textColor } },
          x:{ ticks:{ color:textColor }, grid:{ display:false } }
        },
        plugins:{ legend:{ labels:{ color:textColor } } }
      }
    });
  }

  function renderLogs(){
    const el=document.getElementById('contractLogs');
    el.innerHTML='';
    contractLogs.forEach(l=>{
      const li=document.createElement('li');
      li.innerHTML = `<span class="text-xs text-gray-400 font-mono">[${new Date(l.t).toLocaleTimeString('ar-AE')}]</span> ${l.m}`;
      el.appendChild(li);
    });
  }

  // ================= PROPERTIES =================
  function renderProperties(){
    const container = document.getElementById('properties-container');
    container.innerHTML = '';
    const search = document.getElementById('prop-search').value.toLowerCase();

    properties.forEach(p=>{
      const filteredUnits = p.units.filter(u=>
        u.name.toLowerCase().includes(search) ||
        (u.tenant||'').toLowerCase().includes(search)
      );
      if(search && filteredUnits.length === 0) return;

      const contentId = `units-content-${p.id}`;
      const iconId = `icon-${p.id}`;

      const card = document.createElement('div');
      card.className = "bg-white dark:bg-dark-surface rounded-2xl shadow-sm border border-gray-100 dark:border-dark-border overflow-hidden transition-all duration-200 hover:shadow-md";

      card.innerHTML = `
        <div class="p-4 bg-gray-50 dark:bg-dark-surface border-b dark:border-dark-border flex justify-between items-center cursor-pointer select-none" onclick="toggleUnitVisibility('${p.id}')">
          <div class="flex items-center gap-3">
            <div id="${iconId}" class="transition-transform duration-300 transform rotate-0 text-gray-400">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </div>
            <div>
              <div class="flex items-center gap-2">
                <h3 class="text-lg font-bold text-gray-800 dark:text-white">${p.name}</h3>
                <span class="bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-[10px] px-2 py-0.5 rounded-full font-mono">${p.id}</span>
              </div>
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">ğŸ“ ${p.location||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} | ğŸ¢ ${p.units.length} ÙˆØ­Ø¯Ø§Øª</p>
            </div>
          </div>
          <div class="flex gap-2" onclick="event.stopPropagation()">
            <button onclick="openUnitModal('${p.id}')" class="bg-white dark:bg-dark-surface border border-emerald-200 dark:border-emerald-800 text-emerald-700 dark:text-emerald-400 hover:bg-emerald-50 dark:hover:bg-gray-700 px-3 py-1 rounded text-xs font-bold shadow-sm transition-colors">+ ÙˆØ­Ø¯Ø©</button>
            <button onclick="deleteProperty('${p.id}')" class="bg-white dark:bg-dark-surface border border-red-200 dark:border-red-900 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-gray-700 px-3 py-1 rounded text-xs font-bold shadow-sm transition-colors">Ø­Ø°Ù</button>
          </div>
        </div>

        <div id="${contentId}" class="p-4 transition-all duration-300 ease-in-out">
          <div class="table-wrap border dark:border-dark-border rounded-lg">
            <table class="w-full">
              <thead class="bg-gray-50 dark:bg-dark-bg text-xs text-gray-500 dark:text-gray-400 uppercase">
                <tr>
                  <th class="px-4 py-2">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                  <th class="px-4 py-2">Ø§Ù„Ù†ÙˆØ¹</th>
                  <th class="px-4 py-2">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                  <th class="px-4 py-2">Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±</th>
                  <th class="px-4 py-2">Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                  <th class="px-4 py-2">Ø§Ù„Ø¹Ù‚Ø¯</th>
                  <th class="px-4 py-2">Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®</th>
                  <th class="px-4 py-2">ØªØ­ÙƒÙ…</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                ${(search ? filteredUnits : p.units).map(u=>{
                  const statusClass =
                    u.status==='Ù…Ø¤Ø¬Ø±Ø©'
                      ? 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900 dark:text-emerald-200'
                      : (u.status==='Ù…Ù†ØªÙ‡ÙŠØ©'
                        ? 'bg-rose-100 text-rose-800 dark:bg-rose-900 dark:text-rose-200'
                        : 'bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-200');
                  return `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors">
                      <td class="px-4 py-3 font-bold text-gray-700 dark:text-gray-200">${u.name}</td>
                      <td class="px-4 py-3 text-xs text-gray-500 dark:text-gray-400">${u.type||'-'}</td>
                      <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded text-[10px] font-bold ${statusClass}">${u.status}</span>
                      </td>
                      <td class="px-4 py-3 text-sm max-w-[150px] truncate" title="${u.tenant||''}">${u.tenant||'-'}</td>
                      <td class="px-4 py-3 font-mono text-emerald-700 dark:text-emerald-400 font-bold text-sm">${u.rent ? u.rent.toLocaleString() : '-'}</td>
                      <td class="px-4 py-3 text-xs font-mono truncate-text text-gray-500 dark:text-gray-400" title="${u.contractNo||''}">${u.contractNo||'-'}</td>
                      <td class="px-4 py-3 text-[10px] text-gray-400">
                        <div class="flex flex-col">
                          <span>${u.start||'--'}</span>
                          <span>${u.end||'--'}</span>
                        </div>
                      </td>
                      <td class="px-4 py-3">
                        <div class="flex gap-1">
                          <button onclick="openUnitModal('${p.id}','${u.id}')" class="p-1.5 hover:bg-blue-50 dark:hover:bg-gray-700 text-blue-600 dark:text-blue-400 rounded transition-colors" title="ØªØ¹Ø¯ÙŠÙ„">âœï¸</button>
                          <button onclick="openLeaseModal('${p.id}','${u.id}')" class="p-1.5 hover:bg-purple-50 dark:hover:bg-gray-700 text-purple-600 dark:text-purple-400 rounded transition-colors" title="Ø§Ù„Ø¹Ù‚Ø¯">ğŸ“‘</button>
                          <button onclick="deleteUnit('${p.id}','${u.id}')" class="p-1.5 hover:bg-red-50 dark:hover:bg-gray-700 text-red-600 dark:text-red-400 rounded transition-colors" title="Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø©">ğŸ—‘ï¸</button>
                        </div>
                      </td>
                    </tr>`;
                }).join('')}
              </tbody>
            </table>
          </div>
          ${p.units.length === 0 ? '<div class="text-center py-4 text-gray-400 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù…Ø¶Ø§ÙØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø§Ø±</div>' : ''}
        </div>
      `;
      container.appendChild(card);
    });
  }

  function toggleUnitVisibility(propId) {
    const content = document.getElementById(`units-content-${propId}`);
    const icon = document.getElementById(`icon-${propId}`);
    if(!content || !icon) return;
    if (content.classList.contains('hidden')) {
      content.classList.remove('hidden');
      icon.classList.remove('-rotate-90');
      icon.classList.add('rotate-0');
    } else {
      content.classList.add('hidden');
      icon.classList.remove('rotate-0');
      icon.classList.add('-rotate-90');
    }
  }

  function expandAllProperties() {
    properties.forEach(p => {
      const content = document.getElementById(`units-content-${p.id}`);
      const icon = document.getElementById(`icon-${p.id}`);
      if(content && icon) {
        content.classList.remove('hidden');
        icon.classList.remove('-rotate-90');
        icon.classList.add('rotate-0');
      }
    });
  }

  function collapseAllProperties() {
    properties.forEach(p => {
      const content = document.getElementById(`units-content-${p.id}`);
      const icon = document.getElementById(`icon-${p.id}`);
      if(content && icon) {
        content.classList.add('hidden');
        icon.classList.remove('rotate-0');
        icon.classList.add('-rotate-90');
      }
    });
  }

  function deleteProperty(id){
    if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù‚Ø§Ø± ÙˆØ¬Ù…ÙŠØ¹ ÙˆØ­Ø¯Ø§ØªÙ‡ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) return;
    const prop = properties.find(p=>p.id===id);
    properties = properties.filter(p => p.id !== id);
    saveToLocal();
    renderProperties();
    renderLeases();
    renderPayments();
    updateDashboard();
    logAction(`ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù‚Ø§Ø± ${prop ? prop.name : id}`);
  }

  function deleteUnit(propId, unitId){
    if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ­Ø¯Ø©ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¹Ù‚Ø¯Ù‡Ø§ ÙˆØ¯ÙØ¹Ø§ØªÙ‡Ø§ Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø§ Ø¥Ù† ÙˆÙØ¬Ø¯Øª.')) return;
    const prop = properties.find(p=>p.id===propId);
    if(!prop) return;
    const unit = prop.units.find(u=>u.id===unitId);
    if(!unit) return;

    // Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø¹Ù‚Ø¯/Ø§Ù„ÙˆØ­Ø¯Ø©
    payments = payments.filter(p => !(p.unit === unit.name && p.contract === unit.contractNo));
    prop.units = prop.units.filter(u=>u.id!==unitId);

    saveToLocal();
    renderProperties();
    renderLeases();
    renderPayments();
    updateDashboard();
    logAction(`ØªÙ… Ø­Ø°Ù Ø§Ù„ÙˆØ­Ø¯Ø© ${unit.name} Ù…Ù† Ø§Ù„Ø¹Ù‚Ø§Ø± ${prop.name}`);
  }

  // ================= LEASES =================
  let leaseSort={key:'end',dir:'asc'};

  function setLeaseSort(k){
    if(leaseSort.key===k) leaseSort.dir = leaseSort.dir==='asc'?'desc':'asc';
    else { leaseSort.key=k; leaseSort.dir='asc'; }
    renderLeases();
  }

  function renderLeases(){
    const tbody = document.getElementById('leases-table-body');
    tbody.innerHTML='';
    const search = document.getElementById('lease-search-input').value.toLowerCase();

    let allLeases = [];
    properties.forEach(p=>p.units.forEach(u=>{
      if(u.status!=='Ø´Ø§ØºØ±Ø©') allLeases.push({...u, propName:p.name, propId:p.id});
    }));

    if(search){
      allLeases = allLeases.filter(l=>
        (l.contractNo||'').includes(search) ||
        (l.tenant||'').toLowerCase().includes(search)
      );
    }

    allLeases.sort((a,b)=>{
      let va = a[leaseSort.key], vb = b[leaseSort.key];
      if(leaseSort.key==='rent')
        return leaseSort.dir==='asc' ? (va||0)-(vb||0) : (vb||0)-(va||0);
      return leaseSort.dir==='asc'
        ? (va||'').localeCompare(vb||'')
        : (vb||'').localeCompare(va||'');
    });

    allLeases.forEach(l=>{
      const tr = document.createElement('tr');
      tr.className = l.status==='Ù…Ù†ØªÙ‡ÙŠØ©' ? 'bg-red-50 dark:bg-red-900/20' : '';
      tr.innerHTML = `
        <td>
          <div class="font-bold text-gray-800 dark:text-white">${l.name}</div>
          <div class="text-xs text-gray-500 dark:text-gray-400">${l.propName}</div>
        </td>
        <td class="text-sm font-semibold text-gray-700 dark:text-gray-300">${l.tenant}</td>
        <td class="font-mono text-emerald-600 dark:text-emerald-400">${formatAED(l.rent)}</td>
        <td class="text-xs font-mono bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded inline-block truncate-text" title="${l.contractNo}">${l.contractNo}</td>
        <td class="text-xs">${l.start||'-'}</td>
        <td class="text-xs ${new Date(l.end)<new Date() ? 'text-red-600 dark:text-red-400 font-bold':''}">${l.end||'-'}</td>
        <td><span class="badge ${l.status==='Ù…Ø¤Ø¬Ø±Ø©'?'badge-green':'badge-red'}">${l.status}</span></td>
        <td>
          <button onclick="openLeaseModal('${l.propId}','${l.id}')" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 text-sm font-bold">Ø¥Ø¯Ø§Ø±Ø©</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function openPropertyModal(){ document.getElementById('property-modal').classList.remove('hidden'); }
  function closePropertyModal(){ document.getElementById('property-modal').classList.add('hidden'); }

  document.getElementById('property-form').addEventListener('submit', e=>{
    e.preventDefault();
    properties.push({
      id: document.getElementById('prop-id').value,
      name: document.getElementById('prop-name').value,
      type: document.getElementById('prop-type').value,
      usage: document.getElementById('prop-usage').value,
      location: document.getElementById('prop-location').value,
      units: []
    });
    saveToLocal();
    closePropertyModal();
    renderProperties();
    updateDashboard();
    logAction('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø¹Ù‚Ø§Ø± Ø¬Ø¯ÙŠØ¯');
  });

  function openUnitModal(propId, unitId){
    const m = document.getElementById('unit-modal');
    m.classList.remove('hidden');
    document.getElementById('unit-prop-id').value = propId;
    document.getElementById('unit-id').value = unitId || '';

    const p = properties.find(x=>x.id===propId);
    const u = unitId ? p.units.find(x=>x.id===unitId) : null;

    if(u){
      document.getElementById('unit-name').value = u.name;
      document.getElementById('unit-type').value = u.type||'';
      document.getElementById('unit-usage').value = u.usage||'';
      document.getElementById('unit-status').value = u.status;
      document.getElementById('unit-tenant').value = u.tenant||'';
      document.getElementById('unit-rent').value = u.rent||'';
      document.getElementById('unit-contractNo').value = u.contractNo||'';
      document.getElementById('unit-start').value = u.start||'';
      document.getElementById('unit-end').value = u.end||'';
    } else {
      document.getElementById('unit-form').reset();
      document.getElementById('unit-prop-id').value = propId;
    }
  }

  function closeUnitModal(){
    document.getElementById('unit-modal').classList.add('hidden');
  }

  document.getElementById('unit-form').addEventListener('submit', e=>{
    e.preventDefault();
    const pid = document.getElementById('unit-prop-id').value;
    const uid = document.getElementById('unit-id').value;
    const p = properties.find(x=>x.id===pid);

    
    const existingUnit = uid ? p.units.find(x=>x.id===uid) : null;
const newUnit = {
      id: uid || 'U'+Date.now(),
      name: document.getElementById('unit-name').value,
      type: document.getElementById('unit-type').value,
      usage: document.getElementById('unit-usage').value,
      status: document.getElementById('unit-status').value,
      tenant: document.getElementById('unit-tenant').value,
      rent: parseInt(document.getElementById('unit-rent').value||0),
      contractNo: document.getElementById('unit-contractNo').value,
      start: document.getElementById('unit-start').value,
      end: document.getElementById('unit-end').value
    };

    
    // Ø¥Ø°Ø§ ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© Ø¥Ù„Ù‰ Ø´Ø§ØºØ±Ø© Ù…Ù† ØµÙØ­Ø© Ø§Ù„ÙˆØ­Ø¯Ø§ØªØŒ Ù†Ø­ÙØ¸ Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø³Ø§Ø¨Ù‚ ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø«Ù… Ù†Ù†Ø¸Ù‘Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‚Ø¯
    if(newUnit.status === 'Ø´Ø§ØºØ±Ø©'){
      if(existingUnit && unitHasLeaseData(existingUnit) && (existingUnit.status !== 'Ø´Ø§ØºØ±Ø©')){
        archiveUnitLease(existingUnit, 'Ø¥Ø®Ù„Ø§Ø¡/ØªØ¹Ø¯ÙŠÙ„ Ù…Ù† ØµÙØ­Ø© Ø§Ù„ÙˆØ­Ø¯Ø§Øª', 'Ù…Ø®Ù„Ù‰');
        // Ù†Ù‚Ù„ Ø§Ù„Ø³Ø¬Ù„ Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø­ØªÙ‰ Ù„Ø§ Ù†ÙÙ‚Ø¯ Ø§Ù„ØªØ§Ø±ÙŠØ®
        ensureLeaseHistory(newUnit);
        newUnit.leaseHistory = (existingUnit.leaseHistory || []).slice();
      } else if(existingUnit && Array.isArray(existingUnit.leaseHistory)){
        newUnit.leaseHistory = existingUnit.leaseHistory;
      }
      newUnit.tenant = '';
      newUnit.rent = 0;
      newUnit.contractNo = '';
      newUnit.start = '';
      newUnit.end = '';
    } else if(existingUnit && Array.isArray(existingUnit.leaseHistory)){
      // Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
      newUnit.leaseHistory = existingUnit.leaseHistory;
    } else {
      ensureLeaseHistory(newUnit);
    }
if(uid){
      const idx = p.units.findIndex(x=>x.id===uid);
      p.units[idx] = newUnit;
    } else {
      p.units.push(newUnit);
    }
    saveToLocal();
    closeUnitModal();
    showView('properties');
    updateDashboard();
  });

  function openAddLeaseModal(){
    const m = document.getElementById('add-lease-modal');
    m.classList.remove('hidden');
    const propSelect = document.getElementById('add-lease-prop');
    propSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù‚Ø§Ø±...</option>';
    properties.forEach(p => {
      propSelect.innerHTML += `<option value="${p.id}">${p.name}</option>`;
    });
    document.getElementById('add-lease-unit').innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù‚Ø§Ø± Ø£ÙˆÙ„Ø§Ù‹</option>';
    document.getElementById('add-lease-form').reset();
  }

  function closeAddLeaseModal(){
    document.getElementById('add-lease-modal').classList.add('hidden');
  }

  document.getElementById('add-lease-prop').addEventListener('change', function(){
    const propId = this.value;
    const unitSelect = document.getElementById('add-lease-unit');
    unitSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø©...</option>';
    if(propId){
      const prop = properties.find(p => p.id === propId);
      const availableUnits = prop.units.filter(u => u.status !== 'Ù…Ø¤Ø¬Ø±Ø©');
      if(availableUnits.length === 0){
        unitSelect.innerHTML = '<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ø´Ø§ØºØ±Ø©</option>';
      } else {
        availableUnits.forEach(u => {
          unitSelect.innerHTML += `<option value="${u.id}">${u.name} (${u.status})</option>`;
        });
      }
    }
  });

  document.getElementById('add-lease-form').addEventListener('submit', e => {
    e.preventDefault();
    const propId = document.getElementById('add-lease-prop').value;
    const unitId = document.getElementById('add-lease-unit').value;
    if(!propId || !unitId){
      alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù‚Ø§Ø± ÙˆØ§Ù„ÙˆØ­Ø¯Ø©");
      return;
    }
    const prop = properties.find(p => p.id === propId);
    const unit = prop.units.find(u => u.id === unitId);
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ÙˆØ­Ø¯Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¹Ù‚Ø¯ Ø³Ø§Ø¨Ù‚ (Ù…Ø«Ù„Ø§Ù‹: Ù…Ù†ØªÙ‡ÙŠØ©) Ø³ÙŠØªÙ… Ø­ÙØ¸Ù‡ ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„
    const newContractNo = document.getElementById('add-lease-contractNo').value;
    if(unitHasLeaseData(unit) && unit.status !== 'Ø´Ø§ØºØ±Ø©'){
      archiveUnitLease(unit, `ØªÙ… ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù‚Ø¯ Ø¨Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯ (${newContractNo || 'Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù…'})`, 'ØªØ¬Ø¯ÙŠØ¯ Ø¹Ù‚Ø¯');
    }
unit.status = 'Ù…Ø¤Ø¬Ø±Ø©';
    unit.tenant = document.getElementById('add-lease-tenant').value;
    unit.rent = parseFloat(document.getElementById('add-lease-rent').value || 0);
    unit.contractNo = document.getElementById('add-lease-contractNo').value;
    unit.start = document.getElementById('add-lease-start').value;
    unit.end = document.getElementById('add-lease-end').value;
    saveToLocal();
    closeAddLeaseModal();
    showView('leases');
    logAction(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù‚Ø¯ Ø¬Ø¯ÙŠØ¯ Ù„Ù„ÙˆØ­Ø¯Ø© ${unit.name}`);
    updateDashboard();
  });

  function openLeaseModal(pid, uid){
    const m = document.getElementById('lease-modal');
    m.classList.remove('hidden');
    const u = properties.find(x=>x.id===pid).units.find(x=>x.id===uid);
    document.getElementById('lease-prop-id').value=pid;
    document.getElementById('lease-unit-id').value=uid;
    document.getElementById('lease-tenant').value=u.tenant||'';
    document.getElementById('lease-rent').value=u.rent||'';
    document.getElementById('lease-contractNo').value=u.contractNo||'';
    document.getElementById('lease-start').value=u.start||'';
    document.getElementById('lease-end').value=u.end||'';
    document.getElementById('lease-status').value=u.status;
  }

  function closeLeaseModal(){
    document.getElementById('lease-modal').classList.add('hidden');
  }

  document.getElementById('lease-form').addEventListener('submit', e=>{
    e.preventDefault();
    const pid = document.getElementById('lease-prop-id').value;
    const uid = document.getElementById('lease-unit-id').value;
    const p = properties.find(x=>x.id===pid);
    const u = p.units.find(x=>x.id===uid);

    
    ensureLeaseHistory(u);
u.tenant = document.getElementById('lease-tenant').value;
    u.rent = parseFloat(document.getElementById('lease-rent').value||0);
    u.contractNo = document.getElementById('lease-contractNo').value;
    u.start = document.getElementById('lease-start').value;
    u.end = document.getElementById('lease-end').value;
    u.status = document.getElementById('lease-status').value;

    saveToLocal();
    closeLeaseModal();
    renderLeases();
    renderProperties();
    updateDashboard();
    logAction(`ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù‚Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø© ${u.name}`);
  });

  function cancelLease(){
    if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù‚Ø¯ØŸ Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙˆØ­Ø¯Ø© Ù„Ø´Ø§ØºØ±Ø©.')) return;
    const pid = document.getElementById('lease-prop-id').value;
    const uid = document.getElementById('lease-unit-id').value;
    const u = properties.find(x=>x.id===pid).units.find(x=>x.id===uid);
    // Ø­ÙØ¸ Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¶Ù…Ù† Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø®Ù„Ø§Ø¡/Ø§Ù„Ø¥Ù„ØºØ§Ø¡ (Ù„Ø¸Ù‡ÙˆØ±Ù‡ ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±)
    const overrideStatus = (u.status === 'Ù…Ù†ØªÙ‡ÙŠØ©') ? 'Ù…Ù†ØªÙ‡ÙŠØ©' : 'Ù…Ù„ØºØ§Ø©';
    const reason = (u.status === 'Ù…Ù†ØªÙ‡ÙŠØ©') ? 'Ø¥Ø®Ù„Ø§Ø¡ Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¹Ù‚Ø¯' : 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù‚Ø¯ ÙˆØ¥Ø®Ù„Ø§Ø¡ Ø§Ù„ÙˆØ­Ø¯Ø©';
    archiveUnitLease(u, reason, overrideStatus);
u.status='Ø´Ø§ØºØ±Ø©';
    u.tenant='';
    u.rent=0;
    u.contractNo='';
    u.start='';
    u.end='';
    saveToLocal();
    closeLeaseModal();
    showView('leases');
    updateDashboard();
    logAction(`ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¹Ù‚Ø¯ ${u.name}`);
  }

  // ================= TENANTS =================
  function getTenantsData(){
    const map = {};
    properties.forEach(p=>p.units.forEach(u=>{
      if(u.status==='Ù…Ø¤Ø¬Ø±Ø©' && u.tenant){
        const key = tenantKey(u.tenant);
        if(!key) return;
        if(!map[key]) map[key] = { key, name:String(u.tenant).trim(), phone:'', email:'', units:[], rent:0, paid:0 };
        map[key].units.push(u.name);
        map[key].rent += (u.rent||0);
      }
    }));
    Object.keys(map).forEach(key=>{
      const c = tenantsContacts[key];
      if(c){
        map[key].phone = c.phone || '';
        map[key].email = c.email || '';
        // keep a preferred display name if available
        if(c.name) map[key].name = c.name;
      }
    });
    payments.forEach(pay=>{
      const key = tenantKey(pay.tenant);
      if(map[key]) map[key].paid += pay.amount;
    });
    return Object.values(map).map(t=>({...t, balance: t.rent - t.paid}));
  }

  function getTenantNames(){
    return Object.keys(
      getTenantsData().reduce((acc, t)=>{
        if(t.units && t.units.length>0) acc[t.name]=true;
        return acc;
      }, {})
    );
  }

  // ======= Units lookup helpers (for linking cheques to units) =======
  function findUnitById(unitId){
    if(!unitId) return null;
    for(const p of (properties||[])){
      for(const u of (p.units||[])){
        if(u.id === unitId){
          return { property: p, unit: u };
        }
      }
    }
    return null;
  }

  function getTenantLeasedUnitsDetailed(tenantName){
    const tkey = tenantKey(tenantName);
    const out = [];
    if(!tkey) return out;
    (properties||[]).forEach(p=>{
      (p.units||[]).forEach(u=>{
        if(u.status === 'Ù…Ø¤Ø¬Ø±Ø©' && tenantKey(u.tenant) === tkey){
          out.push({
            unitId: u.id,
            unitName: u.name,
            propertyId: p.id,
            propertyName: p.name,
            contractNo: u.contractNo || '',
            start: u.start || '',
            end: u.end || '',
            label: `${u.name} - ${p.name}`
          });
        }
      });
    });
    return out;
  }

  function inferSingleLeasedUnitIdForTenant(tenantName){
    const list = getTenantLeasedUnitsDetailed(tenantName);
    return list.length === 1 ? list[0].unitId : '';
  }

  function getUnitDisplayById(unitId){
    const hit = findUnitById(unitId);
    if(!hit) return '';
    return `${hit.unit.name} - ${hit.property.name}`;
  }

  function resolveChequeUnitInfo(cheque){
    const c = normalizeChequeRecord(cheque||{});
    let unitId = c.unitId || '';
    if(!unitId){
      unitId = inferSingleLeasedUnitIdForTenant(c.tenant);
    }
    const hit = findUnitById(unitId);
    const unitLabel = hit ? `${hit.unit.name} - ${hit.property.name}` : (c.unitLabel || '');
    const contractNo = hit ? (hit.unit.contractNo || '') : '';
    return { unitId, unitLabel, contractNo };
  }

  function migrateChequePaymentsToUnit(chequeId){
    const chRaw = (cheques||[]).find(x=>x.id===chequeId);
    if(!chRaw) return;
    const info = resolveChequeUnitInfo(chRaw);
    if(!info.unitId) return;

    // Update cheque record
    const idx = cheques.findIndex(x=>x.id===chequeId);
    if(idx>=0){
      cheques[idx] = { ...cheques[idx], unitId: info.unitId, unitLabel: info.unitLabel };
    }

    // Update linked payment record (if created earlier with generic unit)
    const pIdx = (payments||[]).findIndex(p=>p.chequeId===chequeId);
    if(pIdx>=0){
      const p = payments[pIdx];
      const needs = (!p.unit || p.unit === 'Ø´ÙŠÙƒ Ù…ØµØ±Ù' || p.unit === 'Ø´ÙŠÙƒ Ù…ØµØ±Ù' || p.unit === 'Ø´ÙŠÙƒ Ù…ØµØ±Ù');
      if(needs){
        payments[pIdx] = { ...p, unit: info.unitLabel || p.unit, unitId: info.unitId, contract: info.contractNo || p.contract };
      } else {
        // still store unitId for future matching
        payments[pIdx] = { ...p, unitId: info.unitId };
      }
    }
  }


  function renderTenants(){
    const tbody = document.getElementById('tenants-table-body');
    tbody.innerHTML = '';
    const search = document.getElementById('tenants-search').value.toLowerCase();
    const data = getTenantsData().filter(t=> (t.name||'').toLowerCase().includes(search));

    data.forEach(t=>{
      const tr = document.createElement('tr');

      tr.innerHTML = `
        <td class="font-bold">${t.name}</td>
        <td class="text-sm">
          ğŸ“ ${t.phone||'--'}<br>
          ğŸ“§ ${t.email||'--'}
        </td>
        <td class="text-xs text-gray-500 dark:text-gray-400">${t.units.join(', ')}</td>
        <td class="font-mono">${formatAED(t.rent)}</td>
        <td class="font-mono text-green-600">${formatAED(t.paid)}</td>
        <td class="font-mono font-bold ${t.balance>0?'text-rose-600 dark:text-rose-400':'text-gray-400'}">${formatAED(t.balance)}</td>
        <td class="tenant-actions"></td>
      `;

      const td = tr.querySelector('.tenant-actions');
      const btn = document.createElement('button');
      btn.textContent = 'ØªØ­Ø¯ÙŠØ«';
      btn.className = 'text-blue-600 hover:text-blue-800 border border-blue-200 dark:border-blue-800 px-2 py-1 rounded';
      btn.addEventListener('click', ()=> openTenantModal(t.key, t.name));
      td.appendChild(btn);

      tbody.appendChild(tr);
    });
  }

  
  // ================= TENANT CONTACTS (reliable save) =================
  let tenantAutosaveTimer = null;

  function setTenantSaveStatus(msg=''){
    const el = document.getElementById('tenant-save-status');
    if(!el) return;
    el.textContent = msg;
  }

  function persistTenantContact({silent=false} = {}){
    const nameEl  = document.getElementById('tenant-name');
    const phoneEl = document.getElementById('tenant-phone');
    const emailEl = document.getElementById('tenant-email');

    const displayName = (nameEl?.value || '').trim();
    const key = currentTenantKey || tenantKey(displayName);
    if(!key) return null;

    tenantsContacts[key] = {
      name: displayName || (tenantsContacts[key]?.name || ''),
      phone: phoneEl?.value || '',
      email: emailEl?.value || ''
    };

    saveToLocal();
    if(!silent) setTenantSaveStatus('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸');
    return key;
  }

  function scheduleTenantAutosave(){
    clearTimeout(tenantAutosaveTimer);
    setTenantSaveStatus('â€¦ Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸');
    tenantAutosaveTimer = setTimeout(()=>{
      persistTenantContact({silent:true});
      setTenantSaveStatus('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸');
    }, 500);
  }

  function setupTenantModalUX(){
    const modal = document.getElementById('tenant-modal');
    if(!modal || modal.dataset.bound === '1') return;
    modal.dataset.bound = '1';

    // autosave on input (phone/email)
    ['tenant-phone','tenant-email'].forEach(id=>{
      const el = document.getElementById(id);
      if(el){
        el.addEventListener('input', scheduleTenantAutosave);
      }
    });

    // ESC closes (and saves)
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape' && !document.getElementById('tenant-modal').classList.contains('hidden')){
        closeTenantModal();
      }
    });

    // click backdrop closes (and saves)
    modal.addEventListener('click', (e)=>{
      if(e.target === modal){
        closeTenantModal();
      }
    });
  }

function openTenantModal(key='', displayName=''){
    const modal = document.getElementById('tenant-modal');
    modal.classList.remove('hidden');

    setupTenantModalUX();
    setTenantSaveStatus('');

    currentTenantKey = key || tenantKey(displayName);

    const nameInput  = document.getElementById('tenant-name');
    const phoneInput = document.getElementById('tenant-phone');
    const emailInput = document.getElementById('tenant-email');

    nameInput.value = displayName || '';
    phoneInput.value = '';
    emailInput.value = '';

    const c = tenantsContacts[currentTenantKey];
    if(c){
      phoneInput.value = c.phone || '';
      emailInput.value = c.email || '';
      // keep stored preferred name if present
      if(c.name && !displayName) nameInput.value = c.name;
    }
  }

  function closeTenantModal(){
    // finalize any pending autosave
    clearTimeout(tenantAutosaveTimer);
    persistTenantContact({silent:true});
    renderTenants();

    currentTenantKey = null;
    document.getElementById('tenant-modal').classList.add('hidden');
    setTenantSaveStatus('');
  }

  document.getElementById('tenant-form').addEventListener('submit', function(e){
    e.preventDefault();
    closeTenantModal();
  });

  // ================= PAYMENTS =================
  function openPaymentModal(){
    const m = document.getElementById('payment-modal');
    m.classList.remove('hidden');
    const sel = document.getElementById('pay-contract');
    sel.innerHTML='';
    properties.forEach(p=>p.units.forEach(u=>{
      if(u.status==='Ù…Ø¤Ø¬Ø±Ø©'){
        const opt = document.createElement('option');
        opt.value = JSON.stringify({t:u.tenant, u:u.name, c:u.contractNo, rent:u.rent});
        opt.textContent = `${u.tenant} - (${u.name})`;
        sel.appendChild(opt);
      }
    }));
  }

  function closePaymentModal(){
    document.getElementById('payment-modal').classList.add('hidden');
  }

  document.getElementById('payment-form').addEventListener('submit', e=>{
    e.preventDefault();
    const data = JSON.parse(document.getElementById('pay-contract').value);
    const amt = parseFloat(document.getElementById('pay-amount').value);
    const payObj = {
      id: 'PAY-'+Date.now(),
      date: document.getElementById('pay-date').value,
      tenant: data.t,
      unit: data.u,
      contract: data.c,
      due: data.rent,
      type: document.getElementById('pay-type').value,
      amount: amt,
      desc: document.getElementById('pay-desc').value,
      voucherNo: nextVoucherNumber('receipt')
    };
    payments.push(payObj);
    saveToLocal();
    closePaymentModal();
    renderPayments();
    updateDashboard();
    renderReceiptsHistory();
    logAction(`Ø¯ÙØ¹Ø© ${amt} Ù…Ù† ${data.t}`);
  });

  function renderPayments(){
    const tbody = document.getElementById('payments-table-body');
    tbody.innerHTML='';
    payments.sort((a,b)=> new Date(b.date)-new Date(a.date)).forEach(p=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="text-sm">${p.date}</td>
        <td>
          <div class="font-bold text-sm">${p.tenant}</div>
          <div class="text-xs text-gray-500 dark:text-gray-400">${p.unit}</div>
        </td>
        <td><span class="badge badge-blue">${p.type}</span></td>
        <td class="font-bold text-emerald-700 dark:text-emerald-400 font-mono">${formatAED(p.amount)}</td>
        <td class="text-xs text-gray-500 dark:text-gray-400 font-mono">${formatAED(p.due)} / <span class="text-rose-500 dark:text-rose-400">${formatAED(p.due-p.amount)}</span></td>
        <td>${p.amount>=p.due ? '<span class="badge badge-green">Ù…ÙƒØªÙ…Ù„</span>' : '<span class="badge badge-amber">Ø¬Ø²Ø¦ÙŠ</span>'}</td>
        <td><button onclick="previewReceipt('${p.id}', 'payment')" class="text-purple-600 dark:text-purple-400 hover:underline text-xs">Ø¹Ø±Ø¶ Ø§Ù„Ø³Ù†Ø¯</button></td>
      `;
      tbody.appendChild(tr);
    });
    const total = payments.reduce((s,p)=>s+p.amount,0);
    document.getElementById('payments-total').textContent = formatAED(total);
  }

  // ================= CHEQUES =================
  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      if (!file) {
        resolve(null);
        return;
      }
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = error => reject(error);
      reader.readAsDataURL(file);
    });
  }

  function toggleTenantInput() {
    const selectEl = document.getElementById('cheque-tenant-select');
    const manualEl = document.getElementById('cheque-tenant-manual');
    const unitSel  = document.getElementById('cheque-unit-select');

    const selected = selectEl ? selectEl.value : '';
    if (selected === 'other') {
      manualEl.classList.remove('hidden');
      manualEl.setAttribute('required', 'required');
      if(unitSel){
        unitSel.innerHTML = '<option value="">â€” Ø¨Ø¯ÙˆÙ† Ø±Ø¨Ø· ÙˆØ­Ø¯Ø© â€”</option>';
        unitSel.disabled = true;
      }
    } else {
      manualEl.classList.add('hidden');
      manualEl.removeAttribute('required');
      const tenantName = selected;
      if(unitSel){
        unitSel.innerHTML = '<option value="">â€” Ø¨Ø¯ÙˆÙ† Ø±Ø¨Ø· ÙˆØ­Ø¯Ø© â€”</option>';
        const units = getTenantLeasedUnitsDetailed(tenantName);
        units.forEach(x=>{
          const opt = document.createElement('option');
          opt.value = x.unitId;
          opt.textContent = x.label;
          unitSel.appendChild(opt);
        });
        unitSel.disabled = units.length === 0;
      }
    }
  }

  
  function openChequeModal(chequeId=''){
    const modal = document.getElementById('cheque-modal');
    const form  = document.getElementById('new-cheque-form');
    const title = document.getElementById('cheque-modal-title');
    const saveBtn = document.getElementById('cheque-modal-save-btn');
    if(!modal || !form) return;

    modal.classList.remove('hidden');
    form.reset();

    // Populate tenant select
    const selectEl = document.getElementById('cheque-tenant-select');
    selectEl.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù…Ø³ØªØ£Ø¬Ø± Ø­Ø§Ù„ÙŠ...</option>';
    getTenantNames().forEach(name => {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      selectEl.appendChild(opt);
    });
    selectEl.innerHTML += '<option value="other">-- Ù…Ø³ØªØ£Ø¬Ø± Ø¬Ø¯ÙŠØ¯ / Ø¢Ø®Ø± --</option>';

    // Default (Add)
    editingChequeId = null;
    if(title) title.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø´ÙŠÙƒ Ø¬Ø¯ÙŠØ¯';
    if(saveBtn) saveBtn.textContent = 'Ø­ÙØ¸ Ø§Ù„Ø´ÙŠÙƒ';

    // If edit
    if(chequeId){
      const raw = (cheques||[]).find(c=>c.id===chequeId);
      const ch = raw ? normalizeChequeRecord(raw) : null;
      if(ch){
        editingChequeId = chequeId;
        if(title) title.textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø´ÙŠÙƒ';
        if(saveBtn) saveBtn.textContent = 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';

        // Tenant selection
        const inList = getTenantNames().some(n => tenantKey(n) === tenantKey(ch.tenant));
        if(inList){
          selectEl.value = getTenantNames().find(n => tenantKey(n) === tenantKey(ch.tenant)) || '';
        } else {
          selectEl.value = 'other';
          document.getElementById('cheque-tenant-manual').value = ch.tenant || '';
        }

        // Populate unit list for selected tenant
        toggleTenantInput();

        // Set unit if available
        const unitSel = document.getElementById('cheque-unit-select');
        if(unitSel){
          unitSel.value = ch.unitId || '';
        }

        // Fill fields
        document.getElementById('cheque-number').value = ch.chequeNo || '';
        document.getElementById('cheque-value').value = (ch.value ?? '') === null ? '' : (ch.value ?? '');
        document.getElementById('cheque-due-date').value = ch.dueDate || '';
        document.getElementById('cheque-bank').value = ch.bank || '';
        document.getElementById('cheque-purpose').value = ch.purpose || '';
      } else {
        toggleTenantInput();
      }
    } else {
      toggleTenantInput();
    }
  }
function closeChequeModal(){
    const modal = document.getElementById('cheque-modal');
    if(modal) modal.classList.add('hidden');
    editingChequeId = null;
    pendingChequeAfterEditId = null;
    pendingChequeAfterEditStatus = '';
    const title = document.getElementById('cheque-modal-title');
    const saveBtn = document.getElementById('cheque-modal-save-btn');
    if(title) title.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø´ÙŠÙƒ Ø¬Ø¯ÙŠØ¯';
    if(saveBtn) saveBtn.textContent = 'Ø­ÙØ¸ Ø§Ù„Ø´ÙŠÙƒ';
  }

  document.getElementById('new-cheque-form').addEventListener('submit', async e=>{
    e.preventDefault();

    const tenantSelect = document.getElementById('cheque-tenant-select').value;
    const tenantManual = document.getElementById('cheque-tenant-manual').value;
    const tenantName = tenantSelect === 'other' ? tenantManual : tenantSelect;

    const unitId = (document.getElementById('cheque-unit-select') ? document.getElementById('cheque-unit-select').value : '') || '';

    if (!tenantName) {
      alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø£Ùˆ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±.");
      return;
    }
const newImageFile = document.getElementById('cheque-image').files[0];
    const newImageUrl = await fileToBase64(newImageFile);

    const payload = {
      tenant: tenantName,
      unitId: unitId,
      chequeNo: document.getElementById('cheque-number').value,
      value: parseFloat(document.getElementById('cheque-value').value),
      dueDate: document.getElementById('cheque-due-date').value,
      bank: document.getElementById('cheque-bank').value,
      purpose: document.getElementById('cheque-purpose').value,
    };

    if(editingChequeId){
      const i = cheques.findIndex(c=>c.id===editingChequeId);
      if(i !== -1){
        const old = normalizeChequeRecord(cheques[i]);
        cheques[i] = {
          ...cheques[i],
          ...payload,
          status: old.status || cheques[i].status || 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØµØ±Ù',
          imageUrl: newImageUrl || old.imageUrl || cheques[i].imageUrl || ''
        };
      }
    } else {
      cheques.push({
        id: 'CHQ-'+Date.now(),
        ...payload,
        status: 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØµØ±Ù',
        imageUrl: newImageUrl
      });
    }

    saveToLocal();
    
    // If this edit was triggered to complete a status change (Ù…Ø«Ù„: ØµØ±Ù Ø§Ù„Ø´ÙŠÙƒ)ØŒ Ù†ÙÙ‘Ø°Ù‡Ø§ Ø§Ù„Ø¢Ù† Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø©
    if(editingChequeId && pendingChequeAfterEditId === editingChequeId && pendingChequeAfterEditStatus){
      const updated = (cheques||[]).find(c=>c.id===editingChequeId);
      const info = updated ? resolveChequeUnitInfo(updated) : null;
      if(info && info.unitId){
        const st = pendingChequeAfterEditStatus;
        pendingChequeAfterEditId = null;
        pendingChequeAfterEditStatus = '';
        // Apply status change with the now-known unit
        setTimeout(()=>changeChequeStatus(editingChequeId, st, info.unitId), 0);
      }
    }
closeChequeModal();
    renderCheques();
    logAction(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø´ÙŠÙƒ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ø³ØªØ£Ø¬Ø±: ${tenantName}`);
  });

  
  // ======= Cheque â†” Unit linking (for accurate notices/reports) =======
  let pendingChequeLinkId = null;
  let pendingChequeLinkNextStatus = '';

  function openChequeLinkModal(chequeId, nextStatus=''){
    pendingChequeLinkId = chequeId;
    pendingChequeLinkNextStatus = nextStatus || '';
    const modal = document.getElementById('cheque-link-modal');
    const infoEl = document.getElementById('cheque-link-info');
    const sel = document.getElementById('cheque-link-unit-select');

    const raw = (cheques||[]).find(c=>c.id===chequeId);
    const ch = raw ? normalizeChequeRecord(raw) : null;
    if(!modal || !infoEl || !sel || !ch) return;

    const units = getTenantLeasedUnitsDetailed(ch.tenant);
    sel.innerHTML = '';
    if(units.length === 0){
      sel.innerHTML = '<option value="">â€” Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù…Ø¤Ø¬Ø±Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø± â€”</option>';
      sel.disabled = true;
    } else {
      sel.disabled = false;
      const opts = ['<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„ÙˆØ­Ø¯Ø© â€”</option>']
        .concat(units.map(u=>`<option value="${u.unitId}">${u.label}</option>`));
      sel.innerHTML = opts.join('');
      // preselect
      if(ch.unitId){
        sel.value = ch.unitId;
      } else if(units.length === 1){
        sel.value = units[0].unitId;
      }
    }

    infoEl.textContent = `Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±: ${ch.tenant} â€” Ø§Ù„Ø´ÙŠÙƒ: #${ch.chequeNo||'â€”'} â€” Ø§Ù„Ù‚ÙŠÙ…Ø©: ${formatAED(ch.value||0)}`;
    modal.classList.remove('hidden');
  }

  function closeChequeLinkModal(){
    const modal = document.getElementById('cheque-link-modal');
    if(modal) modal.classList.add('hidden');
    pendingChequeLinkId = null;
    pendingChequeLinkNextStatus = '';
  }

  function confirmChequeLink(){
    const chequeId = pendingChequeLinkId;
    const nextStatus = pendingChequeLinkNextStatus;
    const sel = document.getElementById('cheque-link-unit-select');
    const unitId = sel ? (sel.value || '') : '';
    if(!chequeId) { closeChequeLinkModal(); return; }

    if(nextStatus === 'Ù…ØµØ±ÙˆÙ' && !unitId){
      alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØ­Ø¯Ø© Ù‚Ø¨Ù„ ØµØ±Ù Ø§Ù„Ø´ÙŠÙƒ Ø­ØªÙ‰ ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„Ù‡ Ø¶Ù…Ù† Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„ÙˆØ­Ø¯Ø©.');
      return;
    }

    const idx = cheques.findIndex(c=>c.id===chequeId);
    if(idx >= 0){
      const hit = findUnitById(unitId);
      const label = hit ? `${hit.unit.name} - ${hit.property.name}` : '';
      cheques[idx] = { ...cheques[idx], unitId: unitId, unitLabel: label };
      migrateChequePaymentsToUnit(chequeId);
      saveToLocal();
      renderCheques();
      renderPayments();
      updateDashboard();
      renderReceiptsHistory();
    }

    closeChequeLinkModal();

    if(nextStatus){
      changeChequeStatus(chequeId, nextStatus, unitId);
    }
  }


function changeChequeStatus(id, newStatus, unitIdOverride='') {
    const chequeIndex = cheques.findIndex(c => c.id === id);
    if (chequeIndex === -1) return;

    const cheque = cheques[chequeIndex];

    if(unitIdOverride){
      cheque.unitId = unitIdOverride;
    }

    // If cashing the cheque, we must know which unit it belongs to (to record payment correctly)
    if (newStatus === 'Ù…ØµØ±ÙˆÙ') {
      const info = resolveChequeUnitInfo(cheque);
      if(!info.unitId){
        // Ask user to link the cheque first
        pendingChequeAfterEditId = id; pendingChequeAfterEditStatus = 'Ù…ØµØ±ÙˆÙ'; alert('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ­Ø¯Ø© Ù„Ù„Ø´ÙŠÙƒ Ø«Ù… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„ÙŠØªÙ… ØµØ±ÙÙ‡ ÙˆØªØ³Ø¬ÙŠÙ„Ù‡ ÙƒØ¯ÙØ¹Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.'); openChequeModal(id);
        return;
      }

      cheque.unitId = info.unitId;
      cheque.unitLabel = info.unitLabel || cheque.unitLabel || '';

      const paymentExists = payments.some(p => p.chequeId === id);

      if (!paymentExists) {
        payments.push({
          id: 'PAY-CHQ-'+Date.now(),
          chequeId: id,
          date: new Date().toISOString().substring(0, 10),
          tenant: cheque.tenant,
          unit: info.unitLabel || 'Ø´ÙŠÙƒ Ù…ØµØ±Ù',
          unitId: info.unitId,
          contract: info.contractNo || cheque.chequeNo,
          due: cheque.value,
          type: 'Ø´ÙŠÙƒ Ù…ØµØ±Ù',
          amount: cheque.value,
          desc: cheque.purpose || `ØªØ­ØµÙŠÙ„ Ø§Ù„Ø´ÙŠÙƒ Ø±Ù‚Ù… ${cheque.chequeNo} (${info.unitLabel||''}) Ù…Ù† ${cheque.tenant}`,
          voucherNo: nextVoucherNumber('receipt')
        });
        logAction(`ØªÙ… ØµØ±Ù Ø§Ù„Ø´ÙŠÙƒ Ø±Ù‚Ù… ${cheque.chequeNo} ÙˆØªÙ… ØªØ³Ø¬ÙŠÙ„Ù‡ ÙƒØ¯ÙØ¹Ø© Ù…Ù‚Ø¨ÙˆØ¶Ø© Ù„Ù„ÙˆØ­Ø¯Ø©: ${info.unitLabel||info.unitId}.`);
      } else {
        // Ensure existing payment record is linked to the unit (older versions)
        migrateChequePaymentsToUnit(id);
      }

      cheque.status = newStatus;
    } else {
      // If status was changed away from "Ù…ØµØ±ÙˆÙ", remove the linked payment (to avoid double counting)
      cheque.status = newStatus;
      payments = payments.filter(p => p.chequeId !== id);
    }

    saveToLocal();
    renderCheques();
    updateDashboard();
    renderPayments();
    renderReceiptsHistory();
  }


  function viewChequeImage(imageUrl) {
    if (!imageUrl) return;
    const w = window.open('', '_blank');
    w.document.write(`
      <!DOCTYPE html>
      <html lang="ar" dir="rtl">
      <head><title>ØµÙˆØ±Ø© Ø§Ù„Ø´ÙŠÙƒ</title>
      <style>
        body{margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh;background:#111;}
        img{max-width:90vw;max-height:90vh;border:10px solid white;box-shadow:0 0 20px rgba(0,0,0,0.5);}
      </style>
      </head>
      <body><img src="${imageUrl}" alt="ØµÙˆØ±Ø© Ø§Ù„Ø´ÙŠÙƒ"></body>
      </html>
    `);
    w.document.close();
  }

  function renderCheques(){
    const tbody = document.getElementById('cheques-table-body');
    tbody.innerHTML='';
    cheques.sort((a,b)=> new Date(b.dueDate)-new Date(a.dueDate)).forEach(c=>{
      let statusClass = 'badge-amber';
      if (c.status === 'Ù…ØµØ±ÙˆÙ') statusClass = 'badge-green';
      else if (c.status === 'Ø±Ø§Ø¬Ø¹') statusClass = 'badge-red';

      const statusOptions = ['Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØµØ±Ù', 'Ù…ØµØ±ÙˆÙ', 'Ø±Ø§Ø¬Ø¹'];
      const selectOptions = statusOptions.map(s =>
        `<option value="${s}" ${c.status === s ? 'selected' : ''}>${s}</option>`
      ).join('');

      const tr = document.createElement('tr');
      tr.innerHTML=`
        <td><span class="badge ${statusClass}">${c.status}</span></td>
        <td class="font-mono">${c.dueDate}</td>
        <td>${c.tenant}</td>
        <td class="text-xs text-gray-600 dark:text-gray-300">${escHtml(getUnitDisplayById(c.unitId) || '-') }</td>
        <td class="font-bold">${formatAED(c.value)}</td>
        <td class="text-xs text-gray-500 dark:text-gray-400">${c.bank} - #${c.chequeNo}</td>
        <td>
          ${c.imageUrl ? `<button onclick="viewChequeImage('${c.imageUrl}')" class="text-purple-600 dark:text-purple-400 hover:underline text-xs">Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø©</button>` : '-'}
        </td>
        <td>
          <select onchange="changeChequeStatus('${c.id}', this.value)" class="text-sm border p-1 rounded bg-white dark:bg-gray-800 dark:text-white">
            ${selectOptions}
          </select>
          <button type="button" onclick="openChequeModal('${c.id}')" class="text-xs px-2 py-1 rounded border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-800 ml-2" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´ÙŠÙƒ">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
          <button onclick="deleteCheque('${c.id}')" class="text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 p-1 rounded transition ml-2" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function deleteCheque(id){
    if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø´ÙŠÙƒØŸ Ø³ÙŠØªÙ… Ø­Ø°ÙÙ‡ Ù…Ù† Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØµØ±ÙˆÙØ§Ù‹.')) return;
    cheques = cheques.filter(c => c.id !== id);
    payments = payments.filter(p => p.chequeId !== id);
    saveToLocal();
    renderCheques();
    renderPayments();
    updateDashboard();
    renderReceiptsHistory();
    logAction(`ØªÙ… Ø­Ø°Ù Ø§Ù„Ø´ÙŠÙƒ ${id}`);
  }

  // ================= EXPENSES =================
  function renderExpenses(){
    const tbody = document.getElementById('expenses-table-body');
    if(!tbody) return;
    tbody.innerHTML='';
    expenses.sort((a,b)=> new Date(b.date)-new Date(a.date)).forEach((e,i)=>{
      const tr = document.createElement('tr');
      tr.className = "hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors";
      tr.innerHTML=`
        <td class="text-sm font-mono">${e.date}</td>
        <td class="text-sm font-bold text-indigo-700 dark:text-indigo-400">${e.type}</td>
        <td class="font-bold text-rose-600 dark:text-rose-400">${formatAED(e.amount)}</td>
        <td class="text-sm text-gray-600 dark:text-gray-300">${e.details}</td>
        <td class="text-center">
          <div class="flex items-center justify-center gap-2">
            <button onclick="previewReceipt('${e.id}', 'expense')" class="text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/30 px-2 py-1 rounded text-xs font-bold hover:bg-blue-100">ğŸ–¨ï¸ Ø³Ù†Ø¯ ØµØ±Ù</button>
            <button onclick="deleteExpense(${i})" class="text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 p-1 rounded transition" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function deleteExpense(index){
    if(!confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙØŸ')) return;
    expenses.splice(index, 1);
    saveToLocal();
    renderExpenses();
    renderReceiptsHistory();
  }

  document.getElementById('new-expense-form').addEventListener('submit', e=>{
    e.preventDefault();
    expenses.push({
      id: 'EXP-'+Date.now(),
      date: document.getElementById('expense-date').value,
      type: document.getElementById('expense-type').value,
      amount: parseFloat(document.getElementById('expense-amount').value),
      details: document.getElementById('expense-details').value,
      voucherNo: nextVoucherNumber('expense')
    });
    saveToLocal();
    renderExpenses();
    renderReceiptsHistory();
    e.target.reset();
    logAction(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ù†ÙˆØ¹: ${document.getElementById('expense-type').value}`);
  });

  // ================= SALARIES =================
  function initSalaryYears(){
    const yearSel = document.getElementById('sal-year');
    if(!yearSel) return;
    const currentYear = new Date().getFullYear();
    yearSel.innerHTML = `
      <option value="${currentYear-1}">${currentYear-1}</option>
      <option value="${currentYear}" selected>${currentYear}</option>
      <option value="${currentYear+1}">${currentYear+1}</option>
    `;
  }

  function renderSalaries(){
    initSalaryYears();
    const tbody = document.getElementById('salaries-table-body');
    if(!tbody) return;
    tbody.innerHTML = '';

    let total = 0;
    salaries.sort((a,b)=> new Date(b.date) - new Date(a.date)).forEach((s,index)=>{
      total += (s.amount || 0);
      const tr = document.createElement('tr');
      tr.className = "hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors";
      tr.innerHTML = `
        <td class="px-4 py-3 text-sm font-mono text-gray-600 dark:text-gray-300">${s.date}</td>
        <td class="px-4 py-3 font-bold text-gray-800 dark:text-white">${s.name}</td>
        <td class="px-4 py-3 font-mono font-bold text-emerald-600 dark:text-emerald-400">${formatAED(s.amount)}</td>
        <td class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400">${s.notes || '-'}</td>
        <td class="px-4 py-3 text-center">
          <button onclick="previewReceipt('${s.id}', 'salary')" class="text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/30 px-2 py-1 rounded text-xs font-bold hover:bg-blue-100">ğŸ–¨ï¸ Ø³Ù†Ø¯ ØµØ±Ù Ø±Ø§ØªØ¨</button>
        </td>
        <td class="px-4 py-3 text-center">
          <button onclick="deleteSalary(${index})" class="text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/30 p-1 rounded transition">ğŸ—‘ï¸</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
    document.getElementById('total-salaries').textContent = formatAED(total);
    document.getElementById('count-salaries').textContent = salaries.length;
  }

  document.getElementById('salary-form')?.addEventListener('submit', function(e){
    e.preventDefault();

    const month = document.getElementById('sal-month').value;
    const year = document.getElementById('sal-year').value;
    const notes = `Ø±Ø§ØªØ¨ Ø´Ù‡Ø± ${month} Ù„Ø³Ù†Ø© ${year}`;

    const newSalary = {
      id: 'SAL-'+Date.now(),
      name: document.getElementById('sal-name').value,
      role: document.getElementById('sal-role').value,
      amount: parseFloat(document.getElementById('sal-amount').value),
      date: document.getElementById('sal-date').value,
      notes: notes,
      voucherNo: nextVoucherNumber('salary')
    };
    salaries.push(newSalary);
    saveToLocal();
    renderSalaries();
    renderReceiptsHistory();
    this.reset();
    logAction(`ØªÙ… ØµØ±Ù Ø±Ø§ØªØ¨ Ù„Ù„Ù…ÙˆØ¸Ù: ${newSalary.name}`);

    initSalaryYears();
    document.getElementById('sal-month').selectedIndex = 0;
  });

  function deleteSalary(index){
    if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‚ÙŠØ¯ Ø§Ù„Ø±Ø§ØªØ¨ Ù‡Ø°Ø§ØŸ')) return;
    salaries.splice(index, 1);
    saveToLocal();
    renderSalaries();
    renderReceiptsHistory();
  }

  // ================= RECEIPTS HISTORY & PREVIEW =================
  function renderReceiptsHistory(){
    const tbody = document.getElementById('receipts-history-table-body');
    tbody.innerHTML = '';

    let allVouchers = [];
    let totalReceipts = 0;
    let totalSalariesAmt = 0;
    let totalExpensesAmt = 0;

    payments.forEach(p => {
      totalReceipts += p.amount;
      allVouchers.push({
        id: p.id,
        type: 'Ù‚Ø¨Ø¶',
        date: p.date,
        amount: p.amount,
        party: p.tenant,
        desc: p.desc || `Ø¯ÙØ¹Ø© Ø¥ÙŠØ¬Ø§Ø± ÙˆØ­Ø¯Ø© ${p.unit}`,
        sourceType: 'payment'
      });
    });

    salaries.forEach(s => {
      totalSalariesAmt += s.amount;
      allVouchers.push({
        id: s.id,
        type: 'ØµØ±Ù Ø±Ø§ØªØ¨',
        date: s.date,
        amount: s.amount,
        party: s.name,
        desc: s.notes,
        sourceType: 'salary'
      });
    });

    expenses.forEach(e => {
      totalExpensesAmt += e.amount;
      allVouchers.push({
        id: e.id,
        type: 'ØµØ±Ù',
        date: e.date,
        amount: e.amount,
        party: e.type,
        desc: `${e.type}: ${e.details}`,
        sourceType: 'expense'
      });
    });

    allVouchers.sort((a,b)=> new Date(b.date) - new Date(a.date));

    allVouchers.forEach(v => {
      const isReceipt = v.sourceType === 'payment';
      const typeClass = isReceipt ? 'badge-green' : 'badge-red';
      const amountClass = isReceipt ? 'text-emerald-700 dark:text-emerald-400' : 'text-rose-700 dark:text-rose-400';
      const tr = document.createElement('tr');
      tr.className = "hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors";
      tr.innerHTML = `
        <td class="text-sm font-mono">${v.date}</td>
        <td><span class="badge ${typeClass}">${v.type}</span></td>
        <td class="font-bold font-mono ${amountClass}">${formatAED(v.amount)}</td>
        <td class="text-sm font-bold text-gray-700 dark:text-gray-300">${v.party}</td>
        <td class="text-xs text-gray-500 dark:text-gray-400 truncate-text max-w-[200px]" title="${v.desc}">${v.desc}</td>
        <td>
          <button onclick="previewReceipt('${v.id}', '${v.sourceType}')" class="text-purple-600 dark:text-purple-400 hover:underline text-xs">Ø¹Ø±Ø¶</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById('total-receipt-vouchers').textContent = formatAED(totalReceipts);
    document.getElementById('total-payment-vouchers').textContent = formatAED(totalSalariesAmt + totalExpensesAmt);
    document.getElementById('total-vouchers-count').textContent = allVouchers.length;
  }

  function findPropertyForPayment(payment){
    if(!payment) return null;
    for(const p of properties){
      for(const u of p.units){
        if(payment.unit && u.name === payment.unit) return p;
        if(payment.contract && u.contractNo === payment.contract) return p;
      }
    }
    return null;
  }

  function setReceiptHeaderByProperty(prop){
    const nameEl = document.getElementById('rv-building-name');
    const locEl  = document.getElementById('rv-building-location');
    const phoneEl= document.getElementById('rv-building-phone');
    if(prop){
      nameEl.textContent = prop.name || defaultHeader.name;
      locEl.textContent  = prop.location || defaultHeader.location;
    } else {
      nameEl.textContent = defaultHeader.name;
      locEl.textContent  = defaultHeader.location;
    }
    phoneEl.textContent = defaultHeader.phone;
  }

  function previewReceipt(id, type='payment'){
    showView('receipt');

    const titleEl    = document.getElementById('rv-title');
    const subTitleEl = document.getElementById('rv-subtitle');
    const partyLabelEl = document.getElementById('rv-party-label');
    const mainTitleEl = document.getElementById('receipt-main-title');

    const btnBack = document.getElementById('back-to-source-btn');
    btnBack.onclick = function(){ showView('receipts-history'); };

    if(type === 'salary'){
      const item = salaries.find(x => x.id === id);
      if(!item) return;

      titleEl.textContent = "Ø³Ù†Ø¯ ØµØ±Ù Ø±Ø§ØªØ¨";
      titleEl.className = "text-3xl font-black text-rose-700 tracking-wider";
      subTitleEl.textContent = "Salary Payment Voucher";
      partyLabelEl.textContent = "Ø§ØµØ±ÙÙˆØ§ Ù„Ù„Ø³ÙŠØ¯/Ø©:";
      mainTitleEl.textContent = "Ø³Ù†Ø¯ ØµØ±Ù Ø±Ø§ØªØ¨";

      setReceiptHeaderByProperty(null);

      document.getElementById('rv-no').textContent = item.voucherNo || '';
      document.getElementById('rv-date-out').textContent = item.date;
      document.getElementById('rv-tenant-out').textContent = `${item.name} (${item.role})`;
      document.getElementById('rv-amount-out').textContent = parseFloat(item.amount).toLocaleString();
      document.getElementById('rv-method-out').textContent = "Ù†Ù‚Ø¯ÙŠ / ØªØ­ÙˆÙŠÙ„";
      document.getElementById('rv-for-out').textContent = item.notes;

    } else if(type === 'expense'){
      const item = expenses.find(x => x.id === id);
      if(!item) return;

      titleEl.textContent = "Ø³Ù†Ø¯ ØµØ±Ù";
      titleEl.className = "text-3xl font-black text-rose-700 tracking-wider";
      subTitleEl.textContent = "Payment Voucher";
      partyLabelEl.textContent = "Ø§ØµØ±ÙÙˆØ§ Ù„Ù„Ø¬Ù‡Ø©:"; 
      mainTitleEl.textContent = "Ø³Ù†Ø¯ ØµØ±Ù";

      setReceiptHeaderByProperty(null);

      document.getElementById('rv-no').textContent = item.voucherNo || '';
      document.getElementById('rv-date-out').textContent = item.date;
      document.getElementById('rv-tenant-out').textContent = item.type;
      document.getElementById('rv-amount-out').textContent = parseFloat(item.amount).toLocaleString();
      document.getElementById('rv-method-out').textContent = "Ù†Ù‚Ø¯ÙŠ";
      document.getElementById('rv-for-out').textContent = `Ø¯ÙØ¹ Ù…Ø¨Ù„Øº ${item.amount.toLocaleString()} Ø¹Ù† ${item.type}: ${item.details}`;

    } else {
      const item = payments.find(x => x.id === id || x.chequeId === id);
      if(!item) return;

      titleEl.textContent = "Ø³Ù†Ø¯ Ù‚Ø¨Ø¶";
      titleEl.className = "text-3xl font-black text-emerald-700 tracking-wider";
      subTitleEl.textContent = "Receipt Voucher";
      partyLabelEl.textContent = "Ø§Ø³ØªÙ„Ù…Ù†Ø§ Ù…Ù†:";
      mainTitleEl.textContent = "Ø³Ù†Ø¯ Ù‚Ø¨Ø¶";

      const prop = findPropertyForPayment(item);
      setReceiptHeaderByProperty(prop);

      document.getElementById('rv-no').textContent = item.voucherNo || '';
      document.getElementById('rv-date-out').textContent = item.date;
      document.getElementById('rv-tenant-out').textContent = item.tenant;
      document.getElementById('rv-amount-out').textContent = parseFloat(item.amount).toLocaleString();
      document.getElementById('rv-method-out').textContent = item.type;
      document.getElementById('rv-for-out').textContent = item.desc || `Ø¯ÙØ¹Ø© Ø¥ÙŠØ¬Ø§Ø± ÙˆØ­Ø¯Ø© ${item.unit}`;
    }
  }

  function downloadReceiptPDF(){
    const element = document.getElementById('printable-receipt');
    const opt = {
      margin: 10,
      filename: 'Voucher.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().set(opt).from(element).save();
  }

  // ================= REPORTS =================
  function renderReports(){
    const date = new Date().toLocaleDateString('ar-AE');
    document.getElementById('report-date').textContent = date;

    const tenants = getTenantsData();

    // Full contract value â€” rent amount is treated as the full contract amount (not annual) inside reports
    const contractTotals = {};
    properties.forEach(p=>p.units.forEach(u=>{
      if(u.status==='Ù…Ø¤Ø¬Ø±Ø©' && u.tenant){
        if(!contractTotals[u.tenant]) contractTotals[u.tenant] = 0;
        contractTotals[u.tenant] += calcUnitContractValue(u);
      }
    }));
    const tenantsR = tenants.map(t=>{
      const contractValue = Number(contractTotals[t.name] ?? t.rent) || 0;
      const paid = Number(t.paid) || 0;
      return {...t, contractValue, contractBalance: contractValue - paid};
    });

    const list = document.getElementById('tenants-summary-list');
    list.innerHTML='';
    tenantsR.forEach(t=>{
      const div = document.createElement('div');
      div.className = "border p-3 rounded bg-gray-50 flex justify-between";
      div.innerHTML = `<span><strong>${t.name}</strong> (${t.units.join(', ')})</span>
        <span class="font-bold text-emerald-700">${formatAED(t.contractValue)}</span>`;
      list.appendChild(div);
    });

    const lateList = document.getElementById('late-tenants-list');
    lateList.innerHTML='';
    const late = tenantsR.filter(t=>t.contractBalance>0);
    if(late.length===0) lateList.innerHTML = '<li class="text-green-700">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªØ£Ø®Ø±Ø§Øª ÙˆÙ„Ù„Ù‡ Ø§Ù„Ø­Ù…Ø¯</li>';
    else late.forEach(t=>{
      const li = document.createElement('li');
      li.innerHTML = `âš ï¸ <strong>${t.name}</strong> - Ù…ØªØ¨Ù‚ÙŠ Ø¹Ù„ÙŠÙ‡: <span class="font-bold text-red-700">${formatAED(t.contractBalance)}</span>`;
      lateList.appendChild(li);
    });
  
    renderLeaseArchiveReport();
}

  // ================= SETTINGS & BACKUP =================
  function exportBackupJSON(){
    const data = { properties, cheques, expenses, payments, tenantsContacts, salaries };
    const blob = new Blob([JSON.stringify(data)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url;
    a.download='realestate_backup.json';
    a.click();
  }

  function exportBackupExcel(){
    const wb = XLSX.utils.book_new();
    const unitsData = [];
    properties.forEach(p=>p.units.forEach(u=> unitsData.push({...u, Property:p.name})));
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(unitsData), "Units");
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(payments), "Payments");
    if(salaries.length > 0) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(salaries), "Salaries");
    if(expenses.length > 0) XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(expenses), "Expenses");
    XLSX.writeFile(wb, "RealEstate_Data.xlsx");
  }

  function importBackup(e){
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(evt){
      try{
        const data = JSON.parse(evt.target.result);
        if(data.properties) properties = data.properties;
        if(data.payments) payments = data.payments;
        if(data.cheques) cheques = data.cheques;
        if(data.salaries) salaries = data.salaries;
        if(data.expenses) expenses = data.expenses;
        if(data.tenantsContacts) tenantsContacts = data.tenantsContacts;

        expenses = expenses.map(e => ({
          id: e.id || 'EXP-' + Date.now() + Math.floor(Math.random()*1000),
          date: e.date,
          type: e.type || 'Ø£Ø®Ø±Ù‰',
          amount: e.amount,
          details: e.details,
          voucherNo: e.voucherNo || null
        }));
        cheques = (cheques||[]).map(normalizeChequeRecord);
        cheques = cheques.map(c=>{
          const nc = normalizeChequeRecord(c);
          if(!nc.unitId){
            const inferred = inferSingleLeasedUnitIdForTenant(nc.tenant);
            if(inferred) nc.unitId = inferred;
          }
          if(nc.unitId && !nc.unitLabel){
            nc.unitLabel = getUnitDisplayById(nc.unitId);
          }
          return nc;
        });
        (payments||[]).forEach(p=>{ if(p && p.chequeId){ migrateChequePaymentsToUnit(p.chequeId); } });
        saveToLocal();
        ensureVoucherNumbers();
        document.getElementById('backup-msg').textContent = "âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!";
        setTimeout(()=>location.reload(), 1500);
      } catch(err){
        console.error(err);
        document.getElementById('backup-msg').textContent = "âŒ Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­";
      }
    };
    reader.readAsText(file);
  }

  function clearAllData(){
    properties = [];
    cheques = [];
    expenses = [];
    payments = [];
    tenantsContacts = {};
    salaries = [];
    saveToLocal();
    location.reload();
  }

  // ================= THEME =================
  function toggleDarkMode(){
    const willBeDark = !document.body.classList.contains('dark-mode');

    if (willBeDark) {
      document.body.classList.add('dark-mode');
      document.documentElement.classList.add('dark');
      localStorage.setItem('re_dark_mode', '1');
    } else {
      document.body.classList.remove('dark-mode');
      document.documentElement.classList.remove('dark');
      localStorage.setItem('re_dark_mode', '0');
    }
    updateDashboard();
  }

  function initTheme(){
    const saved = localStorage.getItem('re_dark_mode');
    if (saved === '1') {
      document.body.classList.add('dark-mode');
      document.documentElement.classList.add('dark');
    } else {
      document.body.classList.remove('dark-mode');
      document.documentElement.classList.remove('dark');
    }
  }

  
  // Bind once: mark arrears details as "user edited" so auto-fill won't overwrite unless forced
  function initNoticeArrearsAutogenTracking(){
    const details = document.getElementById('notice-arrears-details');
    if(details && details.dataset.bound !== '1'){
      details.dataset.bound = '1';
      details.addEventListener('input', ()=>{ details.dataset.autogen = '0'; });
    }
  }

// ================= INIT =================
  window.onload = function(){
    initTheme();
    loadRentBasisSetting();
    loadFromLocal();
    initNoticeArrearsAutogenTracking();
    showView('dashboard');
  };
</script>

</body>
</html>
